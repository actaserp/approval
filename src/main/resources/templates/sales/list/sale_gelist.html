<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">

<head>
    <style>
        #theGrid2.wj-flexgrid .wj-cell {
            padding: 12px;
        }

        #theGrid2.wj-flexgrid .downloads {
            padding-top: 0px;
        }

    </style>
</head>

<th:block layout:fragment="content">

    <!--- (레이아웃) Contents 영역 -->
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>기간별 발전량 조회</h2><a id="toggleButton" onclick="toggleSearchWrap()"><img src="/images/icon/ico-down.png" alt="알람 아이콘"></a>
                <a title="북마크" class="bookmark toggle">
                    내메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>서비스 분석</li>
                <li>매출 관리</li>
                <li>기간별 발전량 조회</li>
            </ul>
        </div>

        <!-- Select -->
        <div class="search-wrap" id="searchWrap" style="display: none">
            <ul>
                <li>
                    <select title="지역" id="spworkcd" name="spworkcd"
                            onchange="updateCompcdOptions(); saveSelectedSandanData(); ">
                        <!-- 지역 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spworknm" name="spworknm">
                </li>
                <li>
                    <select title="산단" id="spcompcd" name="spcompcd"
                            onchange="updatePlancdOptions(); saveSelectedSandanData();">
                        <!-- 산단 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spcompnm" name="spcompnm">
                </li>
                <li>
                    <select title="시설" id="spplancd" name="spplancd" onchange="updatePlannm(); saveSelectedSandanData()">
                        <!-- 시설 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spplannm" name="spplannm">
                </li>
            </ul>
        </div>

        <div class="tab-wrap">
            <ul class="tab-links">
                <li>
                    <a href="#tab1" title="기간별조회">기간별 조회</a>
                </li>
                <li>
                    <a href="#tab2" title="기간별대비">기간별 대비</a>
                </li>
            </ul>

            <div class="tab-contents">
                <!-- tab1 -->
                <section class="tab-item" id="tab1" style="height: 800px;">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    <label for="periodType">
                                        기간유형<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="periodType" name="periodType" onchange="updatePeriodInputs()">
                                                <option value="hourly">시간별</option>
                                                <option value="monthly" selected>월별</option>
                                                <option value="quarterly">분기별</option>
                                                <option value="halfyearly">반기별</option>
                                                <option value="yearly">연도별</option>
                                            </select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    조회연도<span class="eq">*</span>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="yearSelectTab1" name="yearSelectTab1">
                                            </select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    조회기간<span class="eq">*</span>
                                </dt>
                                <dd>
                                    <ul class="date-box" id="dateBoxContainer">
                                        <li id="startDateContainer">
                                            <input type="month" id="startDate" name="startDate">
                                        </li>
                                        <li id="endDateContainer">
                                            <input type="month" id="endDate" name="endDate">
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label for="genename">
                                        발전기명<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="genename" name="genename">
                                                <!-- 동적으로 발전기명을 가져와서 옵션으로 추가 -->
                                            </select>
                                        </li>
                                        <li>
                                            <a class="btn btn-delete" title="검색" id="btn-search" onclick="searchDataTab1()">
                                                <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                                검색
                                            </a>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                        </div>

                        <!--<div class="button-wrap">
                            <ul>
                                <li>
                                    <a class="btn btn-excell" title="엑셀다운로드">
                                        <img src="/images/icon/ico-excell.svg" alt="엑셀 아이콘">
                                        엑셀다운로드
                                    </a>
                                </li>
                            </ul>
                        </div>-->
                    </div> <!--//section-top end -->

                    <div class="row row-2">
                        <section class="wp50" style="border-radius: 15px;">
                            <!-- 슬라이드 차트 -->
                            <div id="chartHolder1" style="width:600px; height:640px;">
                            </div>
                        </section>
                        <section class="wp50">
                            <!-- 그리드 -->
                            <div class="container-fluid">
                                <p id="selectedItem"></p>
                                <div id="theGrid" style="max-height: 640px;"></div>
                            </div>
                        </section>
                    </div>
                </section>

                <!-- tab2 -->
                <section class="tab-item" id="tab2" style="height: 800px;">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    <label for="comparisonType">
                                        비교유형<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="comparisonType" name="comparisonType">
                                                <option value="YoY">YoY</option>
                                                <option value="QoQ">QoQ</option>
                                                <option value="MoM">MoM</option>
                                                <option value="YTD">YTD</option>
                                            </select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    조회기간<span class="eq">*</span>
                                </dt>
                                <dd>
                                    <ul class="date-box" id="dateBoxContainerTab2">
                                        <li id="startDateContainerTab2">
                                            <select id="startDateTab2" name="startDateTab2"></select>
                                        </li>
                                        <li id="endDateContainerTab2">
                                            <select id="endDateTab2" name="endDateTab2"></select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    <label for="genename2">
                                        발전기명<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="genename2" name="genename">
                                                <!-- 동적으로 발전기명을 가져와서 옵션으로 추가 -->
                                            </select>
                                        </li>
                                        <li>
                                            <a class="btn btn-delete" title="검색" id="btn-searchTab2" onclick="searchDataTab2()">
                                                <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                                검색
                                            </a>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                        </div>

                        <!--<div class="button-wrap">
                            <ul>
                                <li>
                                    <a class="btn btn-excell" title="엑셀다운로드">
                                        <img src="/images/icon/ico-excell.svg" alt="엑셀 아이콘">
                                        엑셀다운로드
                                    </a>
                                </li>
                            </ul>
                        </div>-->
                    </div> <!--//section-top end -->

                    <div class="row row-2">
                        <section class="wp50" style="border-radius: 15px;">
                            <!-- 단일 차트 -->
                            <div id="chartHolder2" style="width:600px; height:640px;"></div>
                        </section>
                        <section class="wp50">
                            <!-- 그리드 -->
                            <div class="container-fluid">
                                <p id="selectedItem"></p>
                                <div id="theGrid2" style="max-height: 640px;"></div>
                            </div>
                        </section>
                    </div>
                </section>
            </div><!--//tab-contents end -->
        </div>
    </div> <!--//layout-contents end -->

</th:block>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
    <th:block th:replace="/common/approve_box :: approve_box"></th:block>
    <th:block th:replace="/common/ax5_uploader :: ax5_uploader" ></th:block>
    <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box" ></th:block>
    <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>

    <script type="text/javascript">

        // 페이지 로드 시
        function init() {

            document.getElementById("periodType").value = "monthly"; // 기본으로 월별이 선택되도록 설정

            loadYearlyData(); // tab1 연도 데이터를 로드
            loadYearlyDataTab2(); // tab2 연도 데이터를 로드

            updateYearInPeriod(); // 조회연도 변경 시 조회기간의 연도도 동기화
            updatePeriodInputs(); // 페이지 로드 시 startDate와 endDate 초기화
            loadGeneratorNames(); // 발전기명을 서버에서 로드
            loadMonthlyData(); // 페이지 로드 시 월별 데이터 자동 로드

            // 슬라이드 차트 초기화
            chartReadyHandler("chart1", "chartHolder1", []); // 초기에는 빈 데이터로 초기화
            chartReadyHandler2("chart2", "chartHolder2", []);



            // chartReadyHandler2("chart2", "chartHolder2", []);

            // chart1 = rMateChartH5.create("chart1", "chartHolder1", "", "120%", "120%");
            // chart2 = rMateChartH5.create("chart2", "chartHolder2", "", "100%", "100%");

            // tab1 그리드 초기화
            theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                autoGenerateColumns: false, // 그리드 초기화 시 자동 생성된 열을 비활성화
                columns: [] // 초기 열 설정
            });

            // tab2 그리드 초기화
            theGrid2 = new wijmo.grid.FlexGrid('#theGrid2', {
                autoGenerateColumns: false, // 그리드 초기화 시 자동 생성된 열을 비활성화
                columns: [] // 초기 열 설정
            });

            // Tab2 차트 초기화를 setTimeout으로 지연
            // setTimeout(() => {
            //     chartReadyHandler2("chart2", "chartHolder2", []);
            // }, 0);

            // loadInitialDataTab2(); // Tab2 초기 데이터 로드
        }

        // DOM이 준비되었을 때 초기화 함수를 실행
        $(document).ready(function (e) {
            init();

            initializeSelections();  //위에 산단, 발전소명 관련 함수

            // 초기 활성화된 탭에 대해서만 차트를 초기화
            rMateChartH5.create("chart1", "chartHolder1", "rMateOnLoadCallFunction=chartReadyHandler", "120%", "100%");
            $('#chartHolder1').data('initialized', true);


            $('ul.tab-links li a').on('click', function () {
                var currentAttrValue = $(this).attr('href');

                if (currentAttrValue === '#tab1') {
                    if (!$('#chartHolder1').data('initialized')) {
                        rMateChartH5.create("chart1", "chartHolder1", "rMateOnLoadCallFunction=chartReadyHandler", "120%", "100%");
                        $('#chartHolder1').data('initialized', true);
                    } else {
                        updateChart('chart1', 'chartHolder1');
                    }
                }

                if (currentAttrValue === '#tab2') {
                    if (!$('#chartHolder2').data('initialized')) {
                        rMateChartH5.create("chart2", "chartHolder2", "rMateOnLoadCallFunction=chartReadyHandler2", "120%", "100%");
                        $('#chartHolder2').data('initialized', true);
                        loadInitialDataTab2(); // Tab2 초기 데이터 로드 및 차트 생성
                    } else {
                        updateChart('chart2', 'chartHolder2');
                    }
                }
            });



            document.getElementById("comparisonType").addEventListener("change", updateComparisonType);

            loadInitialDataTab2();

        });


        // ===============================================================================
        //  =====================================차트=====================================


        // tab1 차트
        function chartReadyHandler(id, chartHolderId, gridData) {
            // id에 해당하는 차트가 생성되었는지 확인
            var chart = document.getElementById(id);
            if (!chart) {
                // console.error("차트가 생성되지 않았습니다: " + id);
                return;
            }

            if (!gridData) {
                // console.error("그리드 데이터가 정의되지 않았습니다.");
                return;
            }

            // 그리드 데이터를 슬라이드 차트의 형식에 맞게 변환
            var transformedData = transformDataForChart(gridData);

            // 각 차트의 레이아웃 정의
            var layout1 = getCartesianLayout("Column2D", "2D Column Chart - MultiSeries", transformedData.fields);
            var layout2 = getCartesianLayout("Line2D", "Line Chart with ItemRenderer", transformedData.fields,
                ["CircleItemRenderer", "TriangleItemRenderer", "RectangleItemRenderer"] // 각 필드에 대한 itemRenderer 설정
            );
            var radarLayout = getRadarLayout(transformedData.fields);

            // 슬라이드 차트에 적용할 레이아웃과 데이터 배열 설정
            var layoutSet = [layout1, layout2, radarLayout];
            var dataSet = [transformedData.data, transformedData.data, transformedData.data];

            // 슬라이드 차트 레이아웃 및 데이터 설정
            document.getElementById(id).setSlideLayoutSet(layoutSet);
            document.getElementById(id).setSlideDataSet(dataSet);
        }

        // tab2 차트
        function chartReadyHandler2(id, chartHolderId, gridData) {
            var chart = document.getElementById(id);
            if (!chart) {
                // console.error("차트가 생성되지 않았습니다: " + id);
                return;
            }

            if (!gridData) {
                // console.error("그리드 데이터가 정의되지 않았습니다.");
                return;
            }

            // 데이터 변환
            var transformedData = transformDataForChartTab2(gridData);

            // 레이아웃
            var layout1 = getCartesianLayout("Column2D", "2D Column Chart - MultiSeries", transformedData.fields);
            var layout2 = getCartesianLayout("Line2D", "Line Chart - Comparison", transformedData.fields, ["CircleItemRenderer", "TriangleItemRenderer", "RectangleItemRenderer"]);

            // 슬라이드 차트에 적용할 레이아웃과 데이터 배열 설정
            var layoutSet = [layout1, layout2];
            var dataSet = [transformedData.data, transformedData.data];

            // chart.setSlideLayoutSet(layoutSet);
            // chart.setSlideDataSet(dataSet);
            document.getElementById(id).setSlideLayoutSet(layoutSet);
            document.getElementById(id).setSlideDataSet(dataSet);
        }




        function updateChart(id, holderId) {
            var chart = document.getElementById(id);
            if (!chart) return;

            const gridData = (id === 'chart1') ? theGrid.itemsSource.items : theGrid2.itemsSource.items;
            const transformedData = (id === 'chart1') ? transformDataForChart(gridData) : transformDataForChartTab2(gridData);
            chartReadyHandler(id, holderId, transformedData);
        }


        // 차트 디자인 가이드 색상 코드
        const chartColors = [
            "#62b2fd",
            "#01dbab",
            "#ffa336",
            "#f99bab",
            "#55667f",
            "#82e8e8",
            "#909bff",
            "#f36f40"
        ];

        // 차트마다 형식이 다르기 때문에 다른 레이아웃 함수를 만들어야 합니다.
        // 다른 유형의 차트 이용시, layout 함수 추가해서 사용하세요.

        // Cartesian 차트 레이아웃 정의
        function getCartesianLayout(type, title, dataFields, itemRenderers = []) {
            var layout = "<rMateChart borderStyle='none'>"
                + "<Options><Caption text='" + "' />" // 차트 제목
                + "<SubCaption text='' textAlign='center' paddingBottom='20'/>" // 차트 부제목
                + "<Legend defaultMouseOverAction='true' useVisibleCheck='true'/>" // 범례
                + "<NumberFormatter id='numfmt' useThousandsSeparator='true'/></Options>"
                + "<" + type + "Chart showDataTips='true'>"
                + "<series>";

            for (var i = 0; i < dataFields.length; ++i) {
                var itemRenderer = itemRenderers[i] ? " itemRenderer='" + itemRenderers[i] + "'" : "";
                var color = chartColors[i % chartColors.length]; // 색상을 순서대로 할당

                if (type === "Line2D") {
                    layout += "<" + type + "Series yField='" + dataFields[i] + "' displayName='" + dataFields[i] + "' " + itemRenderer + ">"
                        + "<showDataEffect><SeriesInterpolate duration='700'/></showDataEffect>"
                        + "<lineStroke><Stroke color='" + color + "'/></lineStroke>" // 선 색상 적용
                        + "</" + type + "Series>";
                } else {
                    layout += "<" + type + "Series yField='" + dataFields[i] + "' displayName='" + dataFields[i] + "' " + itemRenderer + ">"
                        + "<showDataEffect><SeriesSlide direction='up' duration='700'/></showDataEffect>"
                        + "<fill>"
                        + "<SolidColor color='" + color + "'/>" // 색상 적용
                        + "</fill>"
                        + "</" + type + "Series>";
                }
            }

            layout += "</series>"
                + "<horizontalAxis>"
                + "<CategoryAxis categoryField='period'/>"
                + "</horizontalAxis>"
                + "<verticalAxis>"
                + "<LinearAxis formatter='{numfmt}'/>"
                + "</verticalAxis>"
                + "</" + type + "Chart>"
                + "</rMateChart>";

            return layout;
        }


        // Radar 차트 레이아웃 정의
        function getRadarLayout(dataFields) {
            var radarLayout =
                "<rMateChart borderStyle='none'>"
                + "<Options>"
                + "<Caption text='' />"
                + "<Legend defaultMouseOverAction='true' useVisibleCheck='true'/>" // 범례
                + "</Options>"
                + "<NumberFormatter id='numfmt' useThousandsSeparator='true'/>"
                + "<RadarChart type='polygon' paddingTop='20' paddingBottom='20' showDataTips='true'>"
                + "<radialAxis>"
                + "<LinearAxis id='rAxis' formatter='{numfmt}'/>"
                + "</radialAxis>"
                + "<radialAxisRenderers>"
                + "<Axis2DRenderer axis='{rAxis}' horizontal='true' tickPlacement='outside' tickLength='4'>"
                + "<axisStroke>"
                + "<Stroke color='#555555'/>"
                + "</axisStroke>"
                + "</Axis2DRenderer>"
                + "</radialAxisRenderers>"
                + "<angularAxis>"
                + "<CategoryAxis categoryField='period' displayName='Year'/>"
                + "</angularAxis>"
                + "<series>";

            for (var i = 0; i < dataFields.length; ++i) {
                var color = chartColors[i % chartColors.length]; // 색상 순서대로 적용

                radarLayout += "<RadarSeries field='" + dataFields[i] + "' displayName='" + dataFields[i] + "' fillLineArea='false'>"
                    + "<showDataEffect>"
                    + "<SeriesInterpolate duration='700'/>"
                    + "</showDataEffect>"
                    + "<lineStroke><Stroke color='" + color + "'/></lineStroke>" // 선 색상 적용
                    + "</RadarSeries>";
            }

            radarLayout += "</series>"
                + "</RadarChart>"
                + "</rMateChart>";

            return radarLayout;
        }

        // 콤비네이션 차트 레이아웃
        function getCombinationChartLayout() {
            return `<rMateChart backgroundColor="#FFFFFF" borderStyle="none">
    <Options>
        <Caption text=""/>
        <Legend defaultMouseOverAction="true"/>
    </Options>
    <NumberFormatter id="numFmt" useThousandsSeparator="true"/>
    <Combination2DChart showDataTips="true">
        <horizontalAxis>
            <CategoryAxis categoryField="period"/>
        </horizontalAxis>
        <verticalAxis>
            <LinearAxis id="vAxis1" interval="500" formatter="{numFmt}"/>
        </verticalAxis>
        <series>
            <Column2DSet type="clustered">
                <series>
                    <Column2DSeries yField="value1" displayName="2023" fill="#62b2fd">
                        <showDataEffect><SeriesInterpolate/></showDataEffect>
                    </Column2DSeries>
                    <Column2DSeries yField="value2" displayName="2024" fill="#01dbab">
                        <showDataEffect><SeriesInterpolate/></showDataEffect>
                    </Column2DSeries>
                </series>
            </Column2DSet>
            <Line2DSeries yField="growth" displayName="증감율 (%)" itemRenderer="DiamondItemRenderer">
                <lineStroke><Stroke color="#ffa336" weight="2"/></lineStroke>
                <showDataEffect><SeriesInterpolate/></showDataEffect>
                <verticalAxis>
                    <LinearAxis id="vAxis2" interval="10" maximum="100"/>
                </verticalAxis>
            </Line2DSeries>
        </series>
        <verticalAxisRenderers>
            <Axis2DRenderer axis="{vAxis1}" showLine="true"/>
            <Axis2DRenderer axis="{vAxis2}" showLine="true" side="right"/>
        </verticalAxisRenderers>
    </Combination2DChart>
</rMateChart>`;
        }

        function getLineChartLayout() {
            return `<rMateChart backgroundColor="#FFFFFF" borderStyle="none">
    <Options>
        <Caption text=""/>
        <Legend defaultMouseOverAction="true"/>
    </Options>
    <NumberFormatter id="numFmt" useThousandsSeparator="true"/>
    <Line2DChart showDataTips="true">
        <horizontalAxis>
            <CategoryAxis categoryField="period"/>
        </horizontalAxis>
        <verticalAxis>
            <LinearAxis id="vAxis1" interval="500" formatter="{numFmt}"/>
        </verticalAxis>
        <series>
            <Line2DSeries yField="value1" displayName="2023" itemRenderer="CircleItemRenderer">
                <lineStroke><Stroke color="#62b2fd" weight="2"/></lineStroke>
                <showDataEffect><SeriesInterpolate/></showDataEffect>
            </Line2DSeries>
            <Line2DSeries yField="value2" displayName="2024" itemRenderer="DiamondItemRenderer">
                <lineStroke><Stroke color="#01dbab" weight="2"/></lineStroke>
                <showDataEffect><SeriesInterpolate/></showDataEffect>
            </Line2DSeries>
        </series>
    </Line2DChart>
</rMateChart>`;
        }


        // 그리드 데이터를 차트에 맞게 변환 (tab1)
        function transformDataForChart(gridData) {
            // if (!gridData) {
            //     // console.error("그리드 데이터가 null 또는 정의되지 않았습니다.");
            //     return { fields: [], data: [] };
            // }

            const dataFields = [];
            const chartData = [];

            // 데이터를 변환하여 차트에 사용할 수 있도록 변환
            gridData.forEach(row => {
                const dataItem = { period: row.period };
                for (const key in row) {
                    if (key !== 'period' && key !== 'powernm') {
                        if (!dataFields.includes(key)) {
                            dataFields.push(key);
                        }
                        dataItem[key] = row[key];
                    }
                }
                chartData.push(dataItem);
            });

            return {
                fields: dataFields,
                data: chartData
            };
        }

        // 그리드 데이터를 차트에 맞게 변환 (tab2)
        function transformDataForChartTab2(gridData) {
            if (!gridData) {
                // console.error("그리드 데이터가 null 또는 정의되지 않았습니다.");
                return { fields: [], data: [] };
            }

            // 조회기간에 들어간 년도를 기반으로 필드명을 설정
            const firstYear = document.getElementById("startDateTab2").value.split("-")[0];
            const secondYear = document.getElementById("endDateTab2").value.split("-")[0];
            const dataFields = [firstYear, secondYear];
            const chartData = [];

            // 데이터를 변환하여 차트에 사용할 수 있도록 변환
            gridData.forEach(row => {
                const dataItem = { period: row.period || `${row.month}월` };
                dataItem[firstYear] = parseFloat(row.value1) || 0;
                dataItem[secondYear] = parseFloat(row.value2) || 0;
                chartData.push(dataItem);
            });

            return {
                fields: dataFields,
                data: chartData
            };
        }


        // ===============================================================================
        //  =====================================그리드=====================================

        //  그리드 컬럼 생성 (tab1)
        function buildGridColumnsTab1(data) {
            const columns = [
                {binding: 'period', header: '기간', width: 180, align: 'center'},
            ];

            // 모든 powernm(발전기명)을 확인하여 열을 동적으로 생성
            const powerNames = [...new Set(data.map(item => item.powernm))];
            powerNames.forEach(powerName => {
                columns.push({
                    binding: powerName,
                    header: powerName,
                    width: "*",
                    align: 'right',
                    format: 'n0'
                });
            });

            return columns;
        }

        //  그리드 컬럼 생성 (tab2)
        function buildGridColumnsTab2(data, comparisonType) {
            const columns = [
                {binding: 'period', header: '기간', width: 180, align: 'center'},
            ];

            // mom, ytd 때 수정
            const firstYear = document.getElementById("startDateTab2").value;
            const secondYear = document.getElementById("endDateTab2").value;
            const valueColums = ['value1', 'value2']; // 비교할 값들을 바인딩할 필드명

            valueColums.forEach((col, index) => {
                const header = index === 0 ? `${firstYear}년` : `${secondYear}년`;
                columns.push({
                    binding: col,
                    header: header,
                    width: "*",
                    align: 'right',
                    format: 'n0'
                });
            });

            return columns;
        }

        // 데이터 변환 + 그리드 업데이트 (tab1)
        function transformDataForGridTab1(data, periodType) {
            const gridData = {};

            data.forEach(row => {
                const period = row.period ? row.period.toString() : ''; // 기간 데이터가 없는 경우 빈 문자열로 설정
                const powernm = row.powernm ? row.powernm.toString() : ''; // 발전기명이 없는 경우 빈 문자열로 설정

                if (periodType === 'hourly') {
                    // 시간별 데이터를 처리하는 로직
                    for (let i = 1; i <= 24; i++) {
                        const hourKey = `hour${i.toString().padStart(2, '0')}`;
                        if (row[hourKey] !== undefined) {
                            const periodWithHour = `${period} ${i.toString().padStart(2, '0')}시`;
                            if (!gridData[periodWithHour]) {
                                gridData[periodWithHour] = { period: periodWithHour };
                            }
                            gridData[periodWithHour][powernm] = row[hourKey] ? parseFloat(row[hourKey].toString().replace(/,/g, '')) : 0;
                        }
                    }
                } else {
                    // 월별, 분기별, 반기별, 연도별 데이터를 처리하는 로직
                    if (!gridData[period]) {
                        gridData[period] = { period: period };
                    }
                    Object.keys(row).forEach(key => {
                        if (key !== 'period' && key !== 'powernm') {
                            // 쉼표 제거 후 숫자로 변환
                            gridData[period][powernm] = row[key] ? parseFloat(row[key].toString().replace(/,/g, '')) : 0;
                        }
                    });
                }
            });

            return Object.values(gridData);
        }

        // 데이터 변환 + 그리드 업데이트 (tab2)
        function transformDataForGridTab2(data, comparisonType) {
            return data.map(row => {
                // QoQ일 경우 '월' 대신 '분기'로 표시
                const period = (comparisonType === "QoQ") ? `Q${row.quarter}` : `${row.month}월`;

                return {
                    period: period,
                    value1: parseFloat(row.value1) || 0,
                    value2: parseFloat(row.value2) || 0,
                    value1_year: row.value1_year,
                    value2_year: row.value2_year
                };
            });
        }

        // 그리드 생성
        function updateGridTab1(grid, data, periodType) {
            // console.log("Updating grid with data:", data); // 디버깅을 위한 로그 추가
            // console.log("Period Type:", periodType); // periodType이 올바르게 전달되었는지 확인

            const columns = buildGridColumnsTab1(data); // 그리드의 컬럼을 동적으로 생성
            const transformedData = transformDataForGridTab1(data, periodType); // 데이터를 그리드에 맞게 변환

            // console.log("Transformed Data:", transformedData); // 변환된 데이터 확인!

            // 그리드를 초기화하고 데이터를 설정
            grid.initialize({
                autoGenerateColumns: false,
                columns: columns,
                itemsSource: new wijmo.collections.CollectionView(transformedData), // 변환된 데이터를 소스로 설정
                showMarquee: true,
                isReadOnly: true,
                headersVisibility: wijmo.grid.HeadersVisibility.Column // 컬럼 헤더만 보이도록 설정 (행 헤더는 숨김)
            });

            // 이전 데이터를 완전히 초기화 후 새 데이터 적용
            grid.itemsSource = new wijmo.collections.CollectionView(transformedData);


            // 헤더 중앙 정렬을 위해 formatItem 이벤트 핸들러 추가
            grid.formatItem.addHandler((s, e) => {
                if (e.panel === s.columnHeaders) {
                    e.cell.style.textAlign = 'center';
                }
            });

            // 그리드 데이터를 차트에 전달하여 슬라이드 차트를 업데이트
            chartReadyHandler("chart1", "chartHolder1", transformedData);
        }

        // =======================================================================================
        // 검색 기능 미완

        // 검색
        function searchDataTab1() {
            const periodType = document.getElementById("periodType").value;
            let startDate, endDate, startHour, endHour;
            const generator = document.getElementById("genename").value; // 발전기명 선택

            // console.log("Selected powerid:", document.getElementById("genename").value);

            if (periodType === "hourly") {
                startDate = document.getElementById("startDate").value;
                startHour = document.getElementById("startHour").value;
                endHour = document.getElementById("endHour").value;
                endDate = startDate; // 시간별 조회에서는 시작 날짜와 종료 날짜가 동일

            } else if (periodType === "monthly") {
                startDate = document.getElementById("startDate").value;
                endDate = document.getElementById("endDate").value;

            } else if (periodType === "quarterly") {
                const startQuarter = document.getElementById("startQuarter").value;
                const endQuarter = document.getElementById("endQuarter").value;
                const selectedYear = document.getElementById("yearSelectTab1").value;

                // 분기 값을 연도와 함께 날짜 범위로 변환
                [startDate, endDate] = convertQuarterToDateRange(startQuarter, endQuarter, selectedYear);

            } else if (periodType === "halfyearly"){
                const startHalf = document.getElementById("startHalf").value;
                const endHalf = document.getElementById("endHalf").value;
                const selectedYear = document.getElementById("yearSelectTab1").value;

                // 반기 값을 연도와 함께 날짜 범위로 변환
                [startDate, endDate] = convertHalfYearToDateRange(startHalf, endHalf, selectedYear);
            } else  if (periodType === "yearly") {
                const startYear = document.getElementById("startYear").value;
                const endYear = document.getElementById("endYear").value;

                startDate = `${startYear}-01-01`; // 시작 연도의 1월 1일
                endDate = `${endYear}-12-31`; // 종료 연도의 12월 31일
            }

            let query = `/api/gene/upload/periodSearch?periodType=${periodType}&startdt=${startDate}&enddt=${endDate}&powerid=${generator}`;

            if (periodType === "hourly") {
                query += `&startHour=${startHour}&endHour=${endHour}`;
            }

            fetch(query)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        Alert.alert("", "데이터가 존재하지 않습니다.");
                    } else {
                        updateGridTab1(theGrid, data, periodType); // periodType 전달
                    }
                })
                .catch(error => console.error('Error fetching search data:', error));
        }


        // 분기별 기간을 날짜 범위로 변환
        function convertQuarterToDateRange(startQuarter, endQuarter, year) {
            const quarterToMonth = {
                Q1: ['01', '03'],
                Q2: ['04', '06'],
                Q3: ['07', '09'],
                Q4: ['10', '12']
            };

            const startMonth = quarterToMonth[startQuarter][0];
            const endMonth = quarterToMonth[endQuarter][1];

            const startDate = `${year}-${startMonth}-01`;
            const endDate = new Date(year, parseInt(endMonth), 0).toISOString().split('T')[0]; // 해당 월의 마지막 날짜 계산

            return [startDate, endDate];
        }

        // 반기별 기간을 날짜 범위로 변환
        function convertHalfYearToDateRange(startHalf, endHalf, year) {
            const halfToMonth = {
                H1: ['01', '06'],  // 상반기: 1월 ~ 6월
                H2: ['07', '12']   // 하반기: 7월 ~ 12월
            };

            const startMonth = halfToMonth[startHalf][0];
            const endMonth = halfToMonth[endHalf][1];

            const startDate = `${year}-${startMonth}-01`;
            const endDate = new Date(year, parseInt(endMonth), 0).toISOString().split('T')[0]; // 해당 월의 마지막 날짜 계산

            return [startDate, endDate];
        }


        // ===================================================================================================


        // 월별 데이터
        function loadMonthlyData() {
            const generator = 'all';  // 기본적으로 전체 발전기명에 대해 로드

            // 최소/최대 날짜를 서버에서 받아오는 API 호출
            fetch('/api/gene/upload/dateRange')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(dateRange => {
                    const startDate = dateRange.startdt;  // 서버에서 받은 최소 날짜
                    const endDate = dateRange.enddt;      // 서버에서 받은 최대 날짜

                    let query = `/api/gene/upload/periodSearch?periodType=monthly&startdt=${startDate}&enddt=${endDate}&powerid=${generator}`;

                    return fetch(query);
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // console.log('Received data:', data); // 데이터 확인
                    // 서버로부터 데이터를 받아서 처리
                    if (!data || data.length === 0) {
                        // console.warn('No data received.');
                        // Alert.alert("", "데이터가 존재하지 않습니다.\n발전량 업로드 페이지를 확인해 주세요.")
                        return;
                    }

                    chartReadyHandler("chart1", "chartHolder1", data); // 차트 업데이트
                    updateGridTab1(theGrid, data); // 그리드 업데이트
                })
                .catch(error => console.error('Error fetching initial monthly data:', error));
        }


        // 발전기명
        function loadGeneratorNames(callback) {
            fetch('/api/gene/upload/generatornames')
                .then(response => response.json())
                .then(generatorNames => {
                    // Tab1의 발전기명 선택 요소
                    const selectElementTab1 = document.getElementById('genename');
                    // Tab2의 발전기명 선택 요소
                    const selectElementTab2 = document.getElementById('genename2');

                    // 두 요소가 존재하는지 확인한 후에 발전기명 옵션 추가
                    if (selectElementTab1) {
                        selectElementTab1.innerHTML = '<option value="all">전체</option>';
                        generatorNames.forEach(name => {
                            selectElementTab1.innerHTML += `<option value="${name}">${name}</option>`;
                        });
                    }

                    // Tab2의 발전기명 선택 요소에는 `all` 옵션을 추가하지 않음
                    if (selectElementTab2) {
                        selectElementTab2.innerHTML = '';  // Tab2에서는 '전체' 옵션을 제외
                        generatorNames.forEach(name => {
                            selectElementTab2.innerHTML += `<option value="${name}">${name}</option>`;
                        });
                    }

                    // 콜백 함수 호출
                    if (callback) callback();
                })
                .catch(error => console.error('Error loading generator names:', error));
        }

        // 조회기간 변동 함수 -> 입력 필드를 동적으로 업데이트
        function updatePeriodInputs() {
            const periodType = document.getElementById("periodType").value;
            const selectedYear = document.getElementById("yearSelectTab1").value;
            const dateBoxContainer = document.getElementById("dateBoxContainer").closest('dl');
            const yearSelectContainer = Array.from(document.querySelectorAll('dl')).find(dl => {
                const dt = dl.querySelector('dt');
                return dt && dt.textContent.includes("조회연도");
            });

            // 모든 기간 유형에 대해 초기화
            if (yearSelectContainer) yearSelectContainer.style.display = "block";
            dateBoxContainer.style.display = "block";

            if (periodType === "yearly") {
                // 연도별 선택 시 조회기간 필드를 완전히 제거
                dateBoxContainer.style.display = "none";
            } else if (periodType === "hourly" || periodType === "monthly") {
                // 시간별, 월별 선택 시 조회연도 필드 숨김
                if (yearSelectContainer) yearSelectContainer.style.display = "none";

                const startDateContainer = document.getElementById("startDateContainer");
                const endDateContainer = document.getElementById("endDateContainer");

                if (periodType === "hourly") {
                    const currentDate = new Date();
                    const defaultMonth = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                    const defaultDay = currentDate.getDate().toString().padStart(2, '0');

                    startDateContainer.innerHTML = `<input type="date" id="startDate" name="startDate" value="${currentDate.getFullYear()}-${defaultMonth}-${defaultDay}">`;
                    endDateContainer.innerHTML = `
                <select id="startHour" name="startHour" style="width: 60px;">${generateHourOptions()}</select>
                -
                <select id="endHour" name="endHour" style="width: 60px;">${generateHourOptions(true)}</select>
            `;
                } else if (periodType === "monthly") {
                    const currentYear = new Date().getFullYear();
                    startDateContainer.innerHTML = `<input type="month" id="startDate" name="startDate" value="${currentYear}-01">`;
                    endDateContainer.innerHTML = `<input type="month" id="endDate" name="endDate" value="${currentYear}-12">`;
                }
            } else {
                // 분기별, 반기별 선택 시
                const startDateContainer = document.getElementById("startDateContainer");
                const endDateContainer = document.getElementById("endDateContainer");

                if (periodType === "quarterly") {
                    const options = `
                <option value="Q1">1분기</option>
                <option value="Q2">2분기</option>
                <option value="Q3">3분기</option>
                <option value="Q4">4분기</option>
            `;
                    startDateContainer.innerHTML = `<select id="startQuarter">${options}</select>`;
                    endDateContainer.innerHTML = `<select id="endQuarter">${options}</select>`;
                } else if (periodType === "halfyearly") {
                    const options = `
                <option value="H1">상반기</option>
                <option value="H2">하반기</option>
            `;
                    startDateContainer.innerHTML = `<select id="startHalf">${options}</select>`;
                    endDateContainer.innerHTML = `<select id="endHalf">${options}</select>`;
                }
            }

            // 레이아웃 조정을 위해 부모 컨테이너 갱신
            dateBoxContainer.closest('.search-wrap').style.display = 'flex';
            dateBoxContainer.closest('.search-wrap').style.flexWrap = 'wrap';
        }



        // 조회연도 변경 시 조회기간의 연도도 동기화
        function updateYearInPeriod() {
            const selectedYear = document.getElementById("yearSelectTab1").value;

            const startDateInput = document.getElementById("startDate");
            const endDateInput = document.getElementById("endDate");

            if (startDateInput && endDateInput) {
                startDateInput.value = `${selectedYear}-01`;
                endDateInput.value = `${selectedYear}-12`;
            }
        }

        // 조회연도 선택 요소에 이벤트 리스너 추가
        document.getElementById("yearSelectTab1").addEventListener("change", function() {
            updateYearInPeriod(); // 조회연도 변경 시 startDate와 endDate 갱신
            updatePeriodInputs(); // 연도 변경 시 기간 입력 필드 초기화
        });

        // 연도를 로드하고 기존 UI를 업데이트
        function loadYearlyData() {
            fetch('/api/gene/upload/distinctYears')
                .then(response => response.json())
                .then(years => {
                    const yearSelectTab1 = document.getElementById("yearSelectTab1");

                    // 기존 옵션 삭제
                    yearSelectTab1.innerHTML = '';

                    // 서버에서 가져온 연도 목록을 <option>으로 추가
                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearSelectTab1.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading years:', error));
        }


        // 시간 옵션 생성 함수
        function generateHourOptions(isEnd = false) {
            return Array.from({length: 24}, (_, i) => {
                const hour = (i + 1).toString().padStart(2, '0');
                return `<option value="${hour}"${isEnd && hour === '24' || !isEnd && hour === '01' ? ' selected' : ''}>${hour}</option>`;
            }).join('');
        }

        //     ============================================================================================================

        // tab2 관련 함수

        // Tab2 초기 데이터를 로드
        /*function loadInitialDataTab2() {
            // 발전기명 목록을 로드한 후 초기 값 설정
            loadGeneratorNames(function() {
                const generatorSelect = document.getElementById("genename2");
                if (generatorSelect.options.length > 0) {
                    generatorSelect.value = generatorSelect.options[0].value;
                }
                // 현재 연도 및 이전 연도 계산
                const currentYear = new Date().getFullYear();
                const lastYear = currentYear - 1;

                // 기본 연도 및 비교 유형 설정
                document.getElementById("comparisonType").value = "YoY";
                document.getElementById("startDateTab2").value = lastYear.toString();
                document.getElementById("endDateTab2").value = currentYear.toString();

                // 초기 데이터 로드
                searchDataTab2();
            });
        }*/
        function loadInitialDataTab2() {
            // 발전기명 목록을 로드한 후 초기 값 설정
            loadGeneratorNames(function() {
                const generatorSelect = document.getElementById("genename2");
                if (generatorSelect.options.length > 0) {
                    // kt대구물류센터 연료전지를 기본값으로 설정
                    const ktDaeguOption = Array.from(generatorSelect.options).find(option => option.text === "kt대구물류센터 연료전지");
                    if (ktDaeguOption) {
                        generatorSelect.value = ktDaeguOption.value;
                    } else {
                        generatorSelect.value = generatorSelect.options[0].value;
                    }
                }

                // 현재 연도 및 이전 연도 계산
                const currentYear = new Date().getFullYear();
                const lastYear = currentYear - 1;

                // 기본 연도 및 비교 유형 설정
                document.getElementById("comparisonType").value = "YoY";
                document.getElementById("startDateTab2").value = lastYear.toString();
                document.getElementById("endDateTab2").value = currentYear.toString();

                // 초기 데이터 로드 및 차트 생성
                searchDataTab2();
            });
        }

        // 연도 데이터
        function loadYearlyDataTab2() {
            fetch('/api/gene/upload/distinctYears')
                .then(response => response.json())
                .then(years => {
                    const startDateTab2 = document.getElementById("startDateTab2");
                    const endDateTab2 = document.getElementById("endDateTab2");

                    // 기존 옵션 삭제
                    startDateTab2.innerHTML = '';
                    endDateTab2.innerHTML = '';

                    // 서버에서 가져온 연도 목록을 <option>으로 추가
                    years.forEach(year => {
                        const optionStart = document.createElement('option');
                        optionStart.value = year;
                        optionStart.textContent = year;
                        startDateTab2.appendChild(optionStart);

                        const optionEnd = document.createElement('option');
                        optionEnd.value = year;
                        optionEnd.textContent = year;
                        endDateTab2.appendChild(optionEnd);
                    });
                })
                .catch(error => console.error('Error loading years for Tab2:', error));
        }

        // MoM 선택시, 월 선택 셀렉트 생성
        function createMonthSelect(id) {
            const monthSelect = document.createElement('select');
            monthSelect.id = id;
            monthSelect.name = id;
            monthSelect.style.width = '70px';

            const months = [
                "01", "02", "03", "04", "05", "06",
                "07", "08", "09", "10", "11", "12"
            ];

            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = `${month}월`;
                monthSelect.appendChild(option);
            });

            return monthSelect;
        }

        // 비교유형 변경 시 실행될 함수
        function updateComparisonType() {
            const comparisonType = document.getElementById("comparisonType").value;
            const startDateContainerTab2 = document.getElementById("startDateContainerTab2");
            const endDateContainerTab2 = document.getElementById("endDateContainerTab2");

            // 기존 월 선택 셀렉트를 제거
            const existingStartMonthSelect = document.getElementById("startMonthTab2");
            const existingEndMonthSelect = document.getElementById("endMonthTab2");

            if (existingStartMonthSelect) startDateContainerTab2.removeChild(existingStartMonthSelect);
            if (existingEndMonthSelect) endDateContainerTab2.removeChild(existingEndMonthSelect);

            // "MoM"이 선택된 경우에만 새로운 월 셀렉트 추가
            if (comparisonType === "MoM") {
                const startMonthSelect = createMonthSelect("startMonthTab2");
                const endMonthSelect = createMonthSelect("endMonthTab2");

                // 첫 번째 셀렉트가 변경될 때 두 번째 셀렉트도 동일한 값으로 설정
                startMonthSelect.addEventListener("change", function() {
                    endMonthSelect.value = startMonthSelect.value;
                });

                startDateContainerTab2.appendChild(startMonthSelect);
                endDateContainerTab2.appendChild(endMonthSelect);
            }
        }

        function searchDataTab2() {
            const comparisonType = document.getElementById("comparisonType").value;
            let startDate = document.getElementById("startDateTab2").value;
            let endDate = document.getElementById("endDateTab2").value;
            const generator = document.getElementById("genename2").value; // 발전기명 선택

            // comparisonType에 따라 다른 API 엔드포인트로 요청을 보냄
            let query;

            if (comparisonType === "YoY") {
                // YoY의 경우, startDate와 endDate는 연도 형식이어야 함
                startDate = startDate.split("-")[0]; // 연도만 추출
                endDate = endDate.split("-")[0]; // 연도만 추출
                query = `/api/genesearch/comparison/yoy?powerid=${generator}&startYear=${startDate}&endYear=${endDate}`;
            } else if (comparisonType === "QoQ") {
                // QoQ의 경우, startDate와 endDate는 연도 형식이어야 함
                startDate = startDate.split("-")[0]; // 연도만 추출
                endDate = endDate.split("-")[0]; // 연도만 추출
                query = `/api/genesearch/comparison/qoq?powerid=${generator}&startYear=${startDate}&endYear=${endDate}`;
            } else if (comparisonType === "MoM") {
            } else if (comparisonType === "MoM") {
                // MoM의 경우, startDate와 endDate는 월 형식이어야 함
                startDate = startDate.split("-")[1]; // 월만 추출
                endDate = endDate.split("-")[1]; // 월만 추출
                query = `/api/genesearch/comparison/mom?powerid=${generator}&startMonth=${startDate}&endMonth=${endDate}`;
            } else if (comparisonType === "YTD") {
                // YTD의 경우, startDate와 endDate는 날짜 형식이어야 함
                query = `/api/genesearch/comparison/ytd?powerid=${generator}&startDate=${startDate}&endDate=${endDate}`;
            }

            fetch(query)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        Alert.alert("", "데이터가 존재하지 않습니다.");
                    } else {
                        updateGridTab2(theGrid2, data, comparisonType);
                    }
                })
                .catch(error => console.error('Error fetching search data:', error));
        }

        function updateChartTab2(data) {
            chartReadyHandler2("chart2", "chartHolder2", data);
        }

        // Tab2 그리드 업데이트
        function updateGridTab2(grid, data, comparisonType) {
            const columns = buildGridColumnsTab2(data);
            const transformedData = transformDataForGridTab2(data, comparisonType);

            grid.initialize({
                autoGenerateColumns: false,
                columns: columns,
                itemsSource: new wijmo.collections.CollectionView(transformedData),
                // itemsSource: new wijmo.collections.CollectionView(data),
                showMarquee: true,
                isReadOnly: true,
                headersVisibility: wijmo.grid.HeadersVisibility.Column
            });

            // 이전 데이터를 완전히 초기화 후 새 데이터 적용
            grid.itemsSource = new wijmo.collections.CollectionView(transformedData);

            grid.formatItem.addHandler((s, e) => {
                if (e.panel === s.columnHeaders) {
                    e.cell.style.textAlign = 'center';
                }
            });

            // 그리드 데이터를 차트에 전달하여 슬라이드 차트를 업데이트
            chartReadyHandler2("chart2", "chartHolder2", transformedData);
        }

    </script>
</th:block>
</html>