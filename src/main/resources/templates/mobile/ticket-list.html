<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[KTFOMS] AI 기반 연료전지 인프라 구축 - 모바일</title>
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/> <!-- Slide css -->
    <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css">
    <link rel="stylesheet" type="text/css" href="/assets_mobile/css/import.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>


    <script src="/assets_mobile/js/ui.js"></script> <!-- Common js -->
    <script th:inline="javascript">
        var sandanData = /*[[${session.sandanList}]]*/ [];
    </script>


    <script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js?v=1000"></script>

    <script type="text/javascript" src="/js/ax5commUtil.js?v=1070"></script>

    <script src="/js/common.js?v=1060"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script> <!-- Slide js -->
</head>

<body>
<div class="mobile-wrapper page-ticket-list"><!-- ★페이지 Class명 -->
    <!-- [모바일] 헤더  -->
    <div class="mobile-layout-header">
        <header>
            <div class="left">
                <a href="#" title="전체메뉴" class="logo">
                </a>
            </div>
            <div class="center" style="margin-left:-50px;">
                <h2>생산현황</h2>
            </div>
            <div class="right">
                <a href="#" title="전체메뉴" class="btn-menu">
                    <img src="/assets_mobile/images/icon/btn-menu.svg" alt="전체메뉴 아이콘">
                </a>
            </div>
        </header>
    </div> <!-- //mobile-layout-header end-->

    <!-- [모바일] 메뉴  -->
    <div th:insert="~{mobile/mobile_menu :: mobile_menu}"></div>
    <!-- [모바일] 컨덴츠  -->
    <div class="mobile-layout-contents">
        <!--- (레이아웃) Contents 영역 -->
        <div class="layout-contents">
            <!-- 검색 영역  -->
            <div class="search-wrap">
                <div class="srch-tit aco-hd">
                    <p>기본검색</p>
                    <a href="#" title="열기/닫기" class="btn-aco">
                        <img src="/assets_mobile/images/icon/ico-up.svg" alt="열기/닫기">
                    </a>
                </div>
                <div class="srch-cont aco-cont">
                    <dl>
                        <dt>
                            조회일자<span class="eq">*</span>
                        </dt>
                        <dd>
                            <ul class="date-box">
                                <li>
                                    <input type="date" id="startDate" name="startDate">
                                    <label for="startDate" class="hide">시작일</label>
                                </li>
                                <li>
                                    <input type="date" id="endDate" name="endDate">
                                    <label for="endDate" class="hide">종료일</label>
                                </li>
                            </ul>
                        </dd>
                    </dl>
                    <dl>
                        <dt>거래처</dt>
                        <dd>
                            <div style="display: flex; gap: 10px">
                                <div style="width: 100%">
                                    <input type="text" id="searchcltcd" placeholder="거래처를 입력해주세요">
                                </div>
                                <div>
                                    <a href="#" class="btn" title="검색" onclick="searchCltcd()"
                                       style="background-color: #022D60; color: #fff; text-decoration: none; border-radius: 4px; width: 80px;">
                                        검색
                                    </a>
                                </div>
                            </div>
                        </dd>
                    </dl>
                    <dl>
                        <dt>품목</dt>
                        <dd>
                            <div style="display: flex; gap: 10px">
                                <div style="width: 100%">
                                    <input type="text" id="searchproduct" placeholder="품목을 입력해주세요">
                                </div>
                                <div>
                                    <a href="#" class="btn" title="검색" onclick="searchProduct()"
                                       style="background-color: #022D60; color: #fff; text-decoration: none; border-radius: 4px; width: 80px;">
                                        검색
                                    </a>
                                </div>
                            </div>
                        </dd>
                    </dl>
                    <div class="srch-btn">
                        <button class="btn-dark" onclick="fetchListData()">조회</button>
                    </div>
                </div>
            </div>
            <!-- 컨텐츠 영역  -->
            <div class="contents-wrap">
                <div class="list-top-wrap">
                    <div class="list-num">
                        목록 <span class="blue">- 건</span>
                    </div>
                    <a href="#" title="범례정보" class="btn-question">
                        <img src="/assets_mobile/images/icon/ico-question.svg" alt="범례정보 아이콘">
                    </a>
                </div>
                <div class="list-card-wrap" id="cardWrap">
                    <!-- ★ status : green(생성) / blue(진행) / black(완료) / red(취소) -->
                    <div class="card-box">
                        <div class="card-cont">
                            <dl>
                                <dt>계획일자</dt>
                                <dd>24.11.05 / PR-2024-0001</dd>
                            </dl>
                            <dl>
                                <dt>품목명</dt>
                                <dd>평코일-4(검정스톤)</dd>
                            </dl>
                            <dl>
                                <dt>수주량</dt>
                                <dd>270</dd>
                            </dl>
                            <dl>
                                <dt>계획량</dt>
                                <dd>270</dd>
                            </dl>
                            <dl>
                                <dt>작업공정</dt>
                                <dd>적재공정</dd>
                            </dl>
                            <dl>
                                <dt>작업일자</dt>
                                <dd>2024-10-22</dd>
                            </dl>
                            <dl>
                                <dt>작업량</dt>
                                <dd>253</dd>
                            </dl>
                        </div>
                        <div class="card-btn">
                            <button class="btn btn-popup-open" data-popup="popup_mob" title="작업이력">작업이력</button>
                        </div>
                    </div>
                    <!--임시 하드코딩-->
                </div> <!--//card-wrap end-->
            </div> <!--// contents-wrap end-->
        </div> <!--//layout-contents end -->

    </div> <!-- //mobile-layout-contents end-->

    <div class="mobile-layout-popup" id="popup-history">
        <div class="popup-overlay"></div>
        <div class="popup-wrapper">
            <div class="popup-title">
                <h3>작업이력</h3>
                <a href="#a" title="팝업닫기" class="btn-popup-close">
                    <img src="/assets_mobile/images/icon/btn-popup-close.svg" alt="닫기">
                </a>
            </div>
            <div class="popup-contents">
                <div class="ticket-tit">
                    <dl>
                        <dt>티켓명</dt>
                        <dd>전지부품교체</dd>
                    </dl>
                </div>
                <div class="list-card-wrap">
                    <!-- ★ 상태배지 : green(생성) / blue(진행) / black(완료) / red(취소) -->

                </div>
            </div>
            <div class="popup-button">
                <button class="btn-popup-close btn-navy">확인</button>
            </div>
        </div>
    </div>
</div> <!-- //page-wrapper end-->

<script th:inline="javascript">
    // // Thymeleaf에서 값 설정: Null 체크와 기본값 처리
    // var groupid = [[${session.groupid != null ? session.groupid : 'null'}]];
    // var id = /*[[${id != null ? id : 'null'}]]*/;
    // var groupname = /*[[${groupname != null ? groupname : 'null'}]]*/;
    // var username = /*[[${username != null ? username : 'null'}]]*/;
    //
    // // 로컬스토리지에 값 유지 (null 또는 빈 문자열은 저장하지 않음)
    // if (groupid && groupid !== 'null') localStorage.setItem('groupid', groupid);
    // if (id && id !== 'null') localStorage.setItem('id', id);
    // if (username && username !== 'null') localStorage.setItem('username', username);
    // if (groupname && groupname !== 'null') localStorage.setItem('groupname', groupname);
</script>


<script type="text/javascript">

    document.readyState === 'complete' ? init() : window.onload = init;

    function init() {

        fetchListData();
        // fetchListData_ticket();
        // fetchListData_action();
        // clearForm();
        // clearForm_action();
    }


    function renderCards(data) {
        const listCardWrap = document.getElementById('cardWrap');
        const availableColors = ['card-blue', 'card-green', 'card-black', 'card-red', 'card-yellow', 'card-purple'];
        listCardWrap.innerHTML = ''; // 기존 내용을 초기화

        data.forEach(item => {

            let hasWorkdt = false;
            let actionsHtml = '';
            if (item.actions && item.actions.length > 0) {
                item.actions.forEach(action => {
                    const workdt = action.workdt || ''; // 조치일자
                    const workrm = action.workrm || ''; // 조치내용
                    const ordertext = action.ordertext || ''; // 요청사항

                    // workdt가 있을 때
                    if (workdt) {
                        hasWorkdt = true;
                        actionsHtml += `
                                <dl>
                                    <dt>조치일자</dt>
                                    <dd>${workdt}</dd>
                                </dl>
                            `;

                        // workrm이 있을 경우에만 추가 출력
                        if (workrm) {
                            actionsHtml += `
                                    <dl>
                                        <dt>조치내용</dt>
                                        <dd>${workrm.replace(/\r\n/g, '<br>')}</dd>
                                    </dl>
                                `;
                        }
                    }

                    // ordertext가 있을 경우 추가 출력
                    if (ordertext) {
                        actionsHtml += `
                                <dl>
                                    <dt>요청사항</dt>
                                    <dd>${ordertext.replace(/\r\n/g, '<br>')}</dd>
                                </dl>
                            `;
                    }
                });
            }

            // 버튼 처리
            let buttonsHtml = '';

            buttonsHtml += `
                        <button>첨부파일</button>
                        <button class="btn btn-popup-open" data-popup="popup_mob" title="작업이력">작업이력</button>
                    `;


            const cardHtml = `
                        <div class="card-box ${cardClass}" data-tketnum="${item.tketnum}">
                            <div class="card-tit">
                                <h3>${item.tketnm}</h3>
                                <div class="status-tag">
                                    <span class="sta-${cardClass.split('-')[1]}">${item.tketflag}</span>
                                    <span class="sta-bgnavy">${item.tkettypecd || ''}</span>
                                </div>
                            </div>
                            <div class="card-cont">
                                <dl>
                                    <dt>발생일자 / 요청자</dt>
                                    <dd>${item.tketcrdtm || ''} / ${item.tketrusernm || ''}</dd>
                                </dl>
                                <dl>
                                    <dt>소속사 / 연락처</dt>
                                    <dd>${item.tketrcpnm || ''} / ${item.requesterhp || ''}</dd>
                                </dl>
                                <dl>
                                    <dt>작업내용</dt>
                                    <dd>${item.tketrem.replace(/\r\n/g, '<br>')}</dd>
                                </dl>
                                ${actionsHtml}
                            </div>
                            <div class="card-btn">
                                <button class="btn btn-popup-open" data-popup="popup_mob" title="작업이력">작업이력</button>
                            </div>
                        </div>
                    `;
            listCardWrap.insertAdjacentHTML('beforeend', cardHtml);
            // 작업이력 버튼에 클릭 이벤트 추가
            const historyButton = listCardWrap.querySelector(
                `.card-box[data-tketnum="${item.tketnum}"] .btn-popup-open[data-popup="popup-history"]`
            );
            attachPopupEvent(historyButton, item, 'popup-history');
        });
    }
    function attachPopupEvent(button, item, popupType) {
        if (!button) return;
        button.addEventListener('click', () => {
                fetchListData_action(item);
        });
    }
    // 작업이력 불러오기
    function fetchListData_action(item) {
        // wono 작지번호
        let wono = item.wono;
        let wdate = item.wdate;

        $.ajax({
            url: '/api/mobile_production/read_work',
            type: 'GET',
            data: {
                wono: wono,
                wdate: wdate
            },
            success: function (data) {
                renderActionHistory(data.data);
            }
        });
    }
    function renderActionHistory(data) {
        const listCardWrap = document.getElementById('cardWrap');
        const availableColors = ['card-blue', 'card-green', 'card-black', 'card-red', 'card-yellow', 'card-purple'];
        listCardWrap.innerHTML = ''; // 기존 내용을 초기화

        data.forEach(item => {

            let hasWorkdt = false;
            let actionsHtml = '';
            if (item.actions && item.actions.length > 0) {
                item.actions.forEach(action => {
                    const workdt = action.workdt || ''; // 조치일자
                    const workrm = action.workrm || ''; // 조치내용
                    const ordertext = action.ordertext || ''; // 요청사항

                    // workdt가 있을 때
                    if (workdt) {
                        hasWorkdt = true;
                        actionsHtml += `
                                <dl>
                                    <dt>조치일자</dt>
                                    <dd>${workdt}</dd>
                                </dl>
                            `;

                        // workrm이 있을 경우에만 추가 출력
                        if (workrm) {
                            actionsHtml += `
                                    <dl>
                                        <dt>조치내용</dt>
                                        <dd>${workrm.replace(/\r\n/g, '<br>')}</dd>
                                    </dl>
                                `;
                        }
                    }

                    // ordertext가 있을 경우 추가 출력
                    if (ordertext) {
                        actionsHtml += `
                                <dl>
                                    <dt>요청사항</dt>
                                    <dd>${ordertext.replace(/\r\n/g, '<br>')}</dd>
                                </dl>
                            `;
                    }
                });
            }

            // 버튼 처리
            let buttonsHtml = '';

            buttonsHtml += `
                        <button>첨부파일</button>
                        <button class="btn btn-popup-open" data-popup="popup_mob" title="작업이력">작업이력</button>
                    `;


            const cardHtml = `
                        <div class="card-box ${cardClass}" data-tketnum="${item.tketnum}">
                            <div class="card-tit">
                                <h3>${item.tketnm}</h3>
                                <div class="status-tag">
                                    <span class="sta-${cardClass.split('-')[1]}">${item.tketflag}</span>
                                    <span class="sta-bgnavy">${item.tkettypecd || ''}</span>
                                </div>
                            </div>
                            <div class="card-cont">
                                <dl>
                                    <dt>발생일자 / 요청자</dt>
                                    <dd>${item.tketcrdtm || ''} / ${item.tketrusernm || ''}</dd>
                                </dl>
                                <dl>
                                    <dt>소속사 / 연락처</dt>
                                    <dd>${item.tketrcpnm || ''} / ${item.requesterhp || ''}</dd>
                                </dl>
                                <dl>
                                    <dt>작업내용</dt>
                                    <dd>${item.tketrem.replace(/\r\n/g, '<br>')}</dd>
                                </dl>
                                ${actionsHtml}
                            </div>
                            <div class="card-btn">
                                <button class="btn btn-popup-open" data-popup="popup_mob" title="작업이력">작업이력</button>
                            </div>
                        </div>
                    `;
            listCardWrap.insertAdjacentHTML('beforeend', cardHtml);
            // 작업이력 버튼에 클릭 이벤트 추가
            const historyButton = listCardWrap.querySelector(
                `.card-box[data-tketnum="${item.tketnum}"] .btn-popup-open[data-popup="popup-history"]`
            );
            attachPopupEvent(historyButton, item, 'popup-history');
        });
    }

    // 데이터를 받아와 카드 렌더링
    function fetchListData() {

        $.ajax({
            url: '/api/mobile_production/read_all',
            type: 'GET',
            data: {
                'startDate': $('#startDate').val(),
                'endDate': $('#endDate').val(),
                'searchcltcd': $('#searchcltcd').val(),
                'searchproduct': $('#searchproduct').val(),
            },
            success: function (data) {
                console.log("작업목록 : ",data.data);
                //renderCards(data.data);
                const historyButton = document.getElementById('cardWrap').querySelector(
                    `.btn-popup-open[data-popup="popup-history"]`
                );
            }
        });
    }
    // $(document).ready(function () {
    //
    //     $('#logout').on('click', function (e) {
    //         e.preventDefault();
    //         Alert.confirm('', '로그아웃하시겠습니까?', function () {
    //             i18n.resetData();
    //             location.href = '/logout';
    //         });
    //     });
    // });
    // 거래처명 검색 팝업
    function searchCltcd() {
        $.ajax({
            url: '/api/mobile_production/searchcltcd',
            type: 'GET',
            data: {
                'searchcltcd': $('#searchcltcd').val(),
            },
            success: function (data) {
                console.log(data.data);
            }
        });
    }
    // 품목명 검색 팝업
    function searchProduct() {
        $.ajax({
            url: '/api/mobile_production/searchproduct',
            type: 'GET',
            data: {
                'searchproduct': $('#searchproduct').val(),
            },
            success: function (data) {
                console.log(data.data);
            }
        });
    }


</script>
</body>
</html>
