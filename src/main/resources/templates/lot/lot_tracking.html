<html layout:decorate="~{layout_page}">

<th:block layout:fragment="content">
<div class="content_wrap">

    <section>
        <div class="title_box ">
            <div class="left_align">
                <h3 data-labelCd="LOT 트래킹">LOT 트래킹</h3>
            </div>
            <button type="button" class="btn-default pull-right " id="btnHedaerFilter" title="필터 보이기/감추기"><i class="fas fa-filter"></i></button>
            <button type="button" class="btn-default pull-right mr-1" id="btnHeaderCompress" title="화면 확대/축소"><i class="fas fa-compress" id="iCompress"></i></button>
        </div>

        <div class="table_box search" >
            <div class="row">
                <div class="col-6 col-md-3 col-xl-2">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text fit_box_sm" data-labelCd="LOT번호">LOT번호</span>
                        </div>
                        <input class="form-control2" type="text" id="LotNumber" name="LotNumber" placeholder="scan or 입력" value='' />
                    </div>
                </div>
                <div class="col-1">
                    <button type="button" class="btn-default" id="btnMainSearch"><i class="fas fa-search"></i></button>
                </div>
            </div>
        </div>
    </section>
    <section>
        <div class="title_box">
            <span class="left_align" id="spanLotNumber"></span>
        </div>
        <div class="table_box sub">
            <form id="lotForm">
                <div class="row">
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_md" data-labelCd="LOT생성일">LOT생성일</span>
                            </div>
                            <input type="text" class="form-control2" id="InputDateTime" name="InputDateTime" readonly />
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_md" data-labelCd="초기수량">초기수량</span>
                            </div>
                            <input type="text" class="form-control2" id="InputQty" name="InputQty" readonly />
                        </div>
                    </div>

                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_md" data-labelCd="현재고량">현재고량</span>
                            </div>
                            <input type="text" class="form-control2" id="CurrentStock" name="CurrentStock" readonly />
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_md" data-labelCd="단위">단위</span>
                            </div>
                            <input type="text" class="form-control2" id="unit_name" name="unit_name" readonly />
                        </div>
                    </div>

                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_md" data-labelCd="품목구분">품목구분</span>
                            </div>
                            <input type="hidden" id="mat_type" name="mat_type" />
                            <input type="text" class="form-control2" id="mat_type_name" name="mat_type_name" readonly />
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_md" data-labelCd="품목그룹">품목그룹</span>
                            </div>
                            <input type="text" class="form-control2" id="mat_group_name" name="mat_group_name" readonly />
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_md" data-labelCd="품목명">품목명</span>
                            </div>
                            <input type="text" class="form-control2" id="mat_name" name="mat_name" readonly />
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-xl-2">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_md" data-labelCd="유효기간">유효기간</span>
                            </div>
                            <input type="text" class="form-control2" id="EffectiveDate" name="EffectiveDate" readonly />
                        </div>
                    </div>

                </div>
            </form>
        </div>
    </section>
    <section>
        <div class="title_box">
            <label class="switch">
                <input type="checkbox" checked id="btnMaterialToggle"><span class="slider round"></span>
            </label>
            재료추적 보기/감추기
        </div>
        <div class="tabs" data-tab="tabWrap" id="divMaterialTracking">
            <div class="title_box">
                <div class="left_align">
                    <ul class="tab_links">
                        <li><a href="#" data-tablink="#tab_mat_tracking" name="tab_mat_tracking" class="tab" data-labelCd="재료추적">재료추적</a></li>
                        <li><a href="#" data-tablink="#tab_mat_inout" name="tab_mat_inout" class="tab" data-labelCd="원재료입고정보">원재료입고정보</a></li>
                    </ul>
                </div>
            </div>
            <div class="tab-content">
                <div class="tab" id="tab_mat_tracking">
                    <div class="grid_box">
                        <div class="title_box">
                            <span class="right_align rpt" data-labelCd="재료추적">재료추적</span>
                        </div>
                        <div class="h-300" data-ax5grid="mat-tracking-grid"></div>
                    </div>
                </div>
                <div class="tab" id="tab_mat_inout">
                    <div class="grid_box">
                        <div class="title_box">
                            <span class="right_align rpt" data-labelCd="원재료 입고정보">원재료 입고정보</span>
                        </div>
                        <div class="h-300" data-ax5grid="mat-inout-grid"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="title_box">
            <label class="switch">
                <input type="checkbox" checked id="btnProductToggle"><span class="slider round"></span>
            </label>
            제품추적 보기/감추기
        </div>
        <div class="tabs" data-tab="tabWrap" id="divProductTracking">
            <div class="title_box">
                <div class="left_align">
                    <ul class="tab_links">
                        <li><a href="#" data-tablink="#tab_product_tracking" name="tab_product_tracking" class="tab" data-labelCd="제품추적">제품추적</a></li>
                        <li><a href="#" data-tablink="#tab_product_shipment" name="tab_product_shipment" class="tab" data-labelCd="제품출하정보">제품출하정보</a></li>
                    </ul>
                </div>
            </div>
            <div class="tab-content">
                <div class="tab" id="tab_product_tracking">
                    <div class="grid_box">
                        <div class="title_box">
                            <span class="right_align rpt" data-labelCd="제품추적">제품추적</span>
                        </div>
                        <div class="h-300" data-ax5grid="product-tracking-grid"></div>
                    </div>
                </div>
                <div class="tab" id="tab_product_shipment">
                    <div class="grid_box">
                        <div class="title_box">
                            <span class="right_align rpt" data-labelCd="제품출하정보">제품출하정보</span>
                        </div>
                        <div class="h-300" data-ax5grid="product-shipment-grid"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
</th:block>


<th:block layout:fragment="scripts">
<script type="text/javascript">
    class LotTrackingPage {
        constructor() {
            this.url = '/api/lot/lot_tracking';
            this.matTrackingGrid = null;
            this.inoutGrid = null;
            this.productTrackingGrid = null;
            this.shipmentGrid = null;
        }

        init() {
            let _this = this;

            this.initMatTracking();
            this.initProductTracking();

            this.$spanLotNumber = $('#spanLotNumber');
            this.$LotNumber = $('#LotNumber');
            this.$lotForm = $('#lotForm');

            // 일반 바코드 스캐너 이벤트
            this.$LotNumber.keydown(function (e) {
                if (e.keyCode == 9) {
                    _this.loadLotDetail();
                }
            });

            // 검색버튼
            $('#btnMainSearch').click(function (e) {
                let lot_number = _this.$LotNumber.val();
                if (lot_number != '') {
                    _this.loadLotDetail();
                }
            });
        }

        // 재료추적, 원재료 입고정보
        initMatTracking() {
            let config = {
                target: $('[data-ax5grid="mat-tracking-grid"]'),
                frozenColumnIndex: 0, // 열 고정
                frozenRowIndex: 0,    // 행 고정
                showLineNumber: false, // 열의 번호 보이기 여부
                showRowSelector: false,  // checkbox(선택) 보이기 여부
                multipleSelect: false, // 여러행 선택 가능 여부 (false시 단독 선택)
                sortable: false, // 모든 컬럼에 정렬 아이콘 표시 (columns에서 컬럼별 소팅여부 재설정 가능)
                multiSort: false, // 다중 정렬 여부
                header: {
                    align: 'center',  // 헤더의 기본 정렬
                    columnHeight: 30  // 헤더 높이
                },
                body: {
                    columnHeight: 25, // body의 기본 높이
                    onClick: function (e) {
                        //_this.grid.select(this.dindex);
                        //_this.showDetail(e.item.id);
                    }
                },
                page: {
                    display: true,  // 페이징 보이기 여부
                    statusDisplay: true,
                },
                columns: [
                    { key: 'mat_name', label: '품목(재료)', width: 250, align: 'left' },
                    { key: 'p_mat_name', label: '생산품', width: 250, align: 'left' },
                    { key: 'lot_number', label: '품목LOT(재료)', width: 250, align: 'left', treeControl: true },
                    { key: 'p_lot_number', label: '생산품LOT', width: 150, align: 'center' },
                    
                    { key: 'unit_name', label: '단위', width: 80, align: 'center' },
                    { key: 'lot_consume_qty', label: 'LOT투입수량', width: 100, align: 'right', formatter: 'money' },
                    { key: 'WorkOrderNumber', label: '작업지시번호', width: 120, align: 'center' },
                ],
                tree: {
                    use: true,
                    indentWidth: 15,
                    arrowWidth: 15,
                    iconWidth: 18,
                    icons: {
                        openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
                        collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                        groupIcon: '<i class="fa fa-minus-square" aria-hidden="true"></i>',
                        collapsedGroupIcon: '<i class="fa fa-plus-square" aria-hidden="true"></i>',
                        itemIcon: '-'
                    },
                    columnKeys: {
                        parentKey: 'p_lot_number',
                        selfKey: 'lot_number'
                    }
                },
            };
            this.matTrackingGrid = new ax5.ui.grid(config);


            let configMatinout = {
                target: $('[data-ax5grid="mat-inout-grid"]'),
                showLineNumber: false, // 열의 번호 보이기 여부
                showRowSelector: false,  // checkbox(선택) 보이기 여부
                multipleSelect: false, // 여러행 선택 가능 여부 (false시 단독 선택)
                sortable: false, // 모든 컬럼에 정렬 아이콘 표시 (columns에서 컬럼별 소팅여부 재설정 가능)
                multiSort: false, // 다중 정렬 여부
                header: {
                    align: 'center',  // 헤더의 기본 정렬
                    columnHeight: 30  // 헤더 높이
                },
                body: {
                    columnHeight: 25, // body의 기본 높이
                    onClick: function (e) {
                        //_this.grid.select(this.dindex);
                        //_this.showDetail(e.item.id);
                    }
                },
                page: {
                    display: true,  // 페이징 보이기 여부
                    statusDisplay: true,
                },
                columns: [                    
                    { key: 'lot_number', label: '품목LOT', width: 150, align: 'center' },
                    { key: 'mat_name', label: '품목', width: 250, align: 'left' },
                    { key: 'InoutDate', label: '입고일', width: 150, align: 'center' },
                    { key: 'InputQty', label: '입고량', width: 150, align: 'right', formatter:'money' },
                    { key: 'company_name', label: '매입처', width: 150, align: 'center' },
                    { key: 'EffectiveDate', label: '유효일자', width: 150, align: 'center' },
                    { key: 'input_type_name', label: '입고구분', width: 150, align: 'center' },
                ],
            };

            this.inoutGrid = new ax5.ui.grid(configMatinout);
        }

        // 제품추적, 제품출하정보
        initProductTracking() {
            let _this = this;
            let config = {
                target: $('[data-ax5grid="product-tracking-grid"]'),
                frozenColumnIndex: 0, // 열 고정
                frozenRowIndex: 0,    // 행 고정
                showLineNumber: false, // 열의 번호 보이기 여부
                showRowSelector: false,  // checkbox(선택) 보이기 여부
                multipleSelect: false, // 여러행 선택 가능 여부 (false시 단독 선택)
                sortable: false, // 모든 컬럼에 정렬 아이콘 표시 (columns에서 컬럼별 소팅여부 재설정 가능)
                multiSort: false, // 다중 정렬 여부
                header: {
                    align: 'center',  // 헤더의 기본 정렬
                    columnHeight: 30  // 헤더 높이
                },
                body: {
                    columnHeight: 25, // body의 기본 높이
                    onClick: function (e) {
                        //_this.grid.select(this.dindex);
                        //_this.showDetail(e.item.id);
                    }
                },
                page: {
                    display: true,  // 페이징 보이기 여부
                    statusDisplay: true,
                },
                columns: [
                    { key: 'mat_name', label: '생산품', width: 250, align: 'left' },
                    { key: 'p_mat_name', label: '품목(재료)', width: 250, align: 'left' },
                    { key: 'lot_number', label: '생산품LOT', width: 250, align: 'left', treeControl: true },
                    { key: 'p_lot_number', label: '재료LOT', width: 150, align: 'center' },
                    
                    { key: 'unit_name', label: '단위', width: 80, align: 'center' },
                    { key: 'lot_consume_qty', label: 'LOT투입수량', width: 100, align: 'right', formatter: 'money' },
                    { key: 'wo', label: '작업지시번호', width: 120, align: 'center' },

                ],
                tree: {
                    use: true,
                    indentWidth: 15,
                    arrowWidth: 15,
                    iconWidth: 18,
                    icons: {
                        openedArrow: '<i class="fa fa-caret-down" aria-hidden="true"></i>',
                        collapsedArrow: '<i class="fa fa-caret-right" aria-hidden="true"></i>',
                        groupIcon: '<i class="fa fa-minus-square" aria-hidden="true"></i>',
                        collapsedGroupIcon: '<i class="fa fa-plus-square" aria-hidden="true"></i>',
                        itemIcon: '-'
                    },
                    columnKeys: {
                        parentKey: 'p_lot_number',
                        selfKey: 'lot_number'
                    }
                },
            };

            this.productTrackingGrid = new ax5.ui.grid(config);


            let configShipment = {
                target: $('[data-ax5grid="product-shipment-grid"]'),
                showLineNumber: false, // 열의 번호 보이기 여부
                showRowSelector: false,  // checkbox(선택) 보이기 여부
                multipleSelect: false, // 여러행 선택 가능 여부 (false시 단독 선택)
                sortable: false, // 모든 컬럼에 정렬 아이콘 표시 (columns에서 컬럼별 소팅여부 재설정 가능)
                multiSort: false, // 다중 정렬 여부
                header: {
                    align: 'center',  // 헤더의 기본 정렬
                    columnHeight: 30  // 헤더 높이
                },
                body: {
                    columnHeight: 25, // body의 기본 높이
                    onClick: function (e) {
                        //_this.grid.select(this.dindex);
                        //_this.showDetail(e.item.id);
                    }
                },
                page: {
                    display: true,  // 페이징 보이기 여부
                    statusDisplay: true,
                },
                columns: [                    
                    { key: 'lot_number', label: '품목LOT', width: 150, align: 'center' },
                    { key: 'mat_name', label: '품목', width: 250, align: 'left' },
                    { key: 'ShipDate', label: '출하일', width: 150, align: 'center' },
                    { key: 'company_name', label: '고객사', width: 150, align: 'left' },
                    { key: 'Qty', label: '출하량', width: 100, align: 'right', formatter:'money' },
                    { key: 'shipment_state', label: '출하상태', width: 150, align: 'center' },
                ],
            };

            this.shipmentGrid = new ax5.ui.grid(configShipment);
        }

        loadLotDetail() {
            let _this = this;
            let lot_number = this.$LotNumber.val();
            let data = { action: 'lot_detail', lot_number: lot_number };

            this.lot_detail = null;
            this.$lotForm[0].reset();

            // 그리드 초기화
            this.matTrackingGrid.setData([]);
            this.productTrackingGrid.setData([]);
            this.productTrackingGrid.setData([]);
            this.shipmentGrid.setData([]);

            let fnsuccess = function (result) {
                if (result.data.length > 0) {
                    _this.lot_detail = result.data[0];
                    FormUtil.BindDataForm(result.data[0], _this.$lotForm);
                    _this.$spanLotNumber.text("LOT : " + _this.lot_detail.LotNumber);
                    _this.loadHistory();
                } else {
                    Alert.alert('LOT추적오류', '해당 LOT정보가 없습니다.');
                }
            };
            let fnfailure = function (req, status, error) {
            };
            AjaxUtil.getAsyncData(this.url + '/lot_detail', data, fnsuccess, fnfailure);
        }

        loadHistory() {
            let _this = this;
            let mat_type = this.lot_detail.mat_type;
            let lot_number = _this.lot_detail.LotNumber;

            let data = {
                action: 'lot_history',
                mat_type: mat_type,
                lot_number: lot_number
            }
            let fnsuccess = function (result) {
                if (result.success) {
                    _this.matTrackingGrid.setData(result.data.m_item);
                    _this.productTrackingGrid.setData(result.data.p_item);

                    //추후 개발
                    //_this.drawLotCavas(result.m_item, result.p_item);
                    _this.inoutGrid.setData(result.data.inout_list);
                    _this.shipmentGrid.setData(result.data.shipment_list);
                }
            };

            AjaxUtil.getAsyncData(this.url + '/lot_history', data, fnsuccess);
        }

        drawLotCavas(leftItems, rightItems) {
            //_this.lot_detail;
        }
    }

    $(document.body).ready(function (e) {
        let page = new LotTrackingPage();
        page.init();

        // 보기/감추기 버튼
        $('#btnMaterialToggle').click(function (e) {
            $("#divMaterialTracking").toggle(300);
        });

        $('#btnProductToggle').click(function (e) {
            $("#divProductTracking").toggle(300);
        });
    });

</script>
</th:block>
</html>