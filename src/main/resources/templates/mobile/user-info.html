<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>[KTFOMS] AI 기반 연료전지 인프라 구축 - 모바일</title>
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/> <!-- Slide css -->
  <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css">
  <link rel="stylesheet" type="text/css" href="/assets_mobile/css/import.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>


  <script src="/assets_mobile/js/ui.js"></script> <!-- Common js -->
  <script th:inline="javascript">
    var sandanData = /*[[${session.sandanList}]]*/ [];
  </script>


  <script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js?v=1000"></script>

  <script type="text/javascript" src="/js/ax5commUtil.js?v=1070"></script>

  <script src="/js/common.js?v=1060"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script> <!-- Slide js -->
  <script src="/js/Mobile.js"></script>
  <style>
    .new-fl-ac{

    }
    .sd-select{
      margin-top: 6px;
    }

    .toggle-password {
      position: absolute;
      right: 10px; /* 오른쪽 여백 */
      top: 50%; /* 수직 가운데 정렬 */
      transform: translateY(-50%); /* 가운데 정렬 보정 */
      width: 24px; /* 아이콘 너비 */
      height: 24px; /* 아이콘 높이 */
      background: url('/images/icon/btn-show.svg') no-repeat center;
      background-size: contain; /* 아이콘 크기 조정 */
      cursor: pointer; /* 클릭 가능 표시 */
      z-index: 2; /* 인풋 필드 위에 표시 */
      pointer-events: auto; /* 클릭 가능 */
    }
  </style>
</head>

<body>
<div class="mobile-wrapper page-ticket-list"><!-- ★페이지 Class명 -->
  <!-- [모바일] 헤더  -->
  <div class="mobile-layout-header">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    <header>
      <div class="left">
        <a href="#" title="전체메뉴" class="logo">
          <img src="/images/logo/logo-new.png" alt="로고" style="width: 90px;">
        </a>
      </div>
      <div class="center" style="margin-left:-50px;">
        <h2>사용자정보</h2>
      </div>
      <div class="right">
        <a href="#" title="전체메뉴" class="btn-menu">
          <img src="/assets_mobile/images/icon/btn-menu.svg" alt="전체메뉴 아이콘">
        </a>
      </div>
    </header>
  </div> <!-- //mobile-layout-header end-->

  <!-- [모바일] 메뉴  -->
  <div th:insert="~{mobile/mobile_menu :: mobile_menu}"></div>

  <!-- [모바일] 컨덴츠  -->
  <div class="mobile-layout-contents">
    <!--- (레이아웃) Contents 영역 -->
    <div class="layout-contents">
      <!-- 컨텐츠 영역  -->
      <div class="contents-wrap">
        <div class="write-wrap">
          <dl>
            <dt>
              <label for="userid">
                ID
              </label>
            </dt>
            <dd>
              <div class="input-clear">
                <input type="text" id="userid" name="userid" readonly>
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              <label for="agencycd">
                소속사
              </label>
            </dt>
            <dd>
              <select title="전체" id="agencycd" name="agencycd">
              </select>
            </dd>
          </dl>
          <dl>
            <dt>
              <label for="divinm2">
                부서명
              </label>
            </dt>
            <dd>
              <div class="input-clear">
                <input type="text" id="divinm2" name="divinm2">
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              <label for="usernm">
                성명
              </label>
            </dt>
            <dd>
              <div class="input-clear">
                <input type="text" id="usernm" name="usernm">
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              <label>
                비밀번호
              </label>
            </dt>
            <dd>
              <div class="input-clear">
                <input type="password" id="pw" autocomplete="new-password" name="pw" value="">
                <i class="toggle-password" data-target="pw"></i>
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              <label>
                비밀번호 확인
              </label>
            </dt>
            <dd>
              <div class="input-clear">
                <input type="password" id="pw2" autocomplete="new-password" name="pw2" value="">
                <i class="toggle-password" data-target="pw2"></i>
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              <label for="tel">
                핸드폰
              </label>
            </dt>
            <dd>
              <input type="text" id="tel" name="tel">
            </dd>
          </dl>
          <dl>
            <dt>
              <label for="email">
                이메일
              </label>
            </dt>
            <dd>
              <div class="input-clear">
                <input type="text" id="email" name="email">
              </div>
            </dd>
          </dl>
          <dl>
            <dt>
              <label>
                발전시설
              </label>
            </dt>
            <dd>
              <ul style="width: 100%" id="dataList">
                <li class="new-fl-ac">
                  <select class="sd-select" id="firstSelect" name="spworkcd" onchange="updateNextSelect(this)">
                    <option></option>
                  </select>
                  <select class="sd-select" id="secondSelect" name="spcompcd" onchange="updateNextSelect2(this)">
                    <option></option>
                  </select>
                  <select class="sd-select" id="thirdSelect" name="spplancd">
                    <option></option>
                  </select>
                  <button type="button" style="margin-top: 5px" onclick="addselectField(this)">발전시설 추가</button>
                </li>
              </ul>
            </dd>
          </dl>
        </div>
      </div> <!--// contents-wrap end-->
      <div class="button-wrap">
        <button class="btn-navy" id="btnSaveAuth">수정</button>
      </div>
    </div> <!--//layout-contents end -->

  </div> <!-- //mobile-layout-contents end-->
</div> <!-- //page-wrapper end-->

<script th:inline="javascript">
  // Thymeleaf에서 값 설정: Null 체크와 기본값 처리
  var groupid = [[${session.groupid != null ? session.groupid : 'null'}]];
  var id = /*[[${id != null ? id : 'null'}]]*/;
  var groupname = /*[[${groupname != null ? groupname : 'null'}]]*/;
  var username = /*[[${username != null ? username : 'null'}]]*/;

  // 로컬스토리지에 값 유지 (null 또는 빈 문자열은 저장하지 않음)
  if (groupid && groupid !== 'null') localStorage.setItem('groupid', groupid);
  if (id && id !== 'null') localStorage.setItem('id', id);
  if (username && username !== 'null') localStorage.setItem('username', username);
  if (groupname && groupname !== 'null') localStorage.setItem('groupname', groupname);
  //saveSelectedSandanData();
</script>


<script type="text/javascript">

  const requiredFields = [{id: 'userid', name: '사용자ID'}, {id: 'usernm', name: '사용자명'},
    {id: 'email', name: '이메일'}, {id: 'agencycd', name: '소속사'},]
  const nameBasedFields = [
    {name: 'spworkcd', displayName: '관할지역'},
    {name: 'spcompcd', displayName: '발전산단'},
    {name: 'spplancd', displayName: '발전소'}
  ];


  $(document).ready(function () {

    userinformLoad();

  });


  function userinformLoad(){
    $.ajax({
      url: '/account/myinfo',
      type: 'GET',
      dataType: 'json',
      success: function (response){
        if(response && response.data){
          const data = response.data;
          successCallback(data);
        }
      },
      error: function (xhr, status, error){
        Alert.alert('', '조회에 실패하였습니다.');
      }
    });

  }

  function successCallback(data){
    const item = data[0];
    const sandanitem = data[1];

    console.log('item', item);

    $('#userid').val(item.username);
    document.getElementById('agencycd').value = item.agencycd;
    $('#divinm2').val(item.divinm);
    $('#usernm').val(item.usernm);
    $('#tel').val(item.tel); // 소속사
    $('#email').val(item.email); // 소속부서

    const parent = $('#dataList');
    parent.empty();

    const listLen = sandanitem.length;

    for (let i = 0; i < listLen; i++) {
      const li = $('<li>');

      if (i !== 0) {
        li.addClass('new-fl-ac');
      }

      li.css('marginTop', '2px');


      const firstSelectId = i === 0 ? 'firstSelect' : `firstSelect${i}`;
      const secondSelectId = i === 0 ? 'secondSelect' : `secondSelect${i}`;
      const thirdSelectId = i === 0 ? 'thirdSelect' : `thirdSelect${i}`;

      const filrstSelect = createSelectElement(firstSelectId, 'spworkcd', 'updateNextSelect(this)', '8');
      const secondSelect = createSelectElement(secondSelectId, 'spcompcd', 'updateNextSelect2(this)', '9');
      const thirdSelect = createSelectElement(thirdSelectId, 'spplancd', null, '7');

      if (i === 0) {
        const button = createButtonElement('test', '발전시설 추가', 'black', '107px', 'addselectField(this)');
        li.append(filrstSelect).append(secondSelect).append(thirdSelect).append(button);
      } else {
        const button = createButtonElement('test', '발전시설 삭제', 'red', '107px', 'deleteSelectField(this)');
        li.append(filrstSelect).append(secondSelect).append(thirdSelect).append(button);
      }

      parent.append(li);
      $.ajax({
        url: '/user-codes/parent',
        type: 'GET',
        async: false,   // 기본값: true
        data: {parentId: 110},
        success: function (response) {
          console.log('Response from /user-codes/parent:', response);
          let selectElement = $('#' + firstSelectId);
          selectElement.empty(); // 이전 옵션 제거

          $.each(response, function (index, item) {
            selectElement.append($('<option>', {
              value: item.code,
              text: item.value
            }));

            selectElement.val();

          });
        },
        error: function (jqXHR, textStatus, errorThrown) {
          console.error('Error:', textStatus, errorThrown);
        }
      });

      $('#' + firstSelectId).val(sandanitem[i].spworkcd);
      $('#' + firstSelectId).trigger('change');
      $('#' + secondSelectId).val(sandanitem[i].spcompcd);
      $('#' + secondSelectId).trigger('change');
//                                console.log('thirdSelectId', thirdSelectId);
      console.log('산단정보', sandanitem[i].spplancd);

      $('#' + thirdSelectId).val(sandanitem[i].spplancd);

    }
  }


  $(document).ready(function () {

    $('#logout').on('click', function (e) {
      e.preventDefault();
      Alert.confirm('', '로그아웃하시겠습니까?', function () {
        i18n.resetData();
        location.href = '/logout';
      });
    });


  });

  $('#btnSaveAuth').click(function(){
    let spworkcdString = extractSelectValues('spworkcd');
    let spcompcdString = extractSelectValues('spcompcd');
    let spplancdString = extractSelectValues('spplancd');

    let spworknm = extractSelectTexts('spworkcd');
    let spcompnm = extractSelectTexts('spcompcd');
    let spplannm = extractSelectTexts('spplancd');

    const emailInput = document.getElementById('email');
    const emailValue = emailInput.value.trim();
    if (!validateFields()) {
      return false;
    }

    if (!emailValidate(emailValue)) {
      Alert.alert('', '유효한 이메일 형식을 입력하세요.');
      return false;
    }

    let data = {
      'userid': $('#userid').val(),
      'agc': $('#agencycd').val(),
      'divinm' : $('#divinm2').val(),
      'name' : $('#usernm').val(),
      'pw' : $('#pw').val(),
      'pw2' : $('#pw2').val(),
      'tel' : $('#tel').val(),
      'email' : $('#email').val(),
      'swcd' : spworkcdString,
      'sccd' : spcompcdString,
      'spcd' : spplancdString,
      'swnm' : spworknm,
      'scnm' : spcompnm,
      'spnm' : spplannm
    }
    $.ajax({
      url: '/account/myinfosave',
      type: 'POST',
      async: true,   // 기본값: true
      data: JSON.stringify(data),
      contentType: 'application/json',
      headers: {
        'X-CSRF-Token': $('[name=_csrf]').val()
      },
      success: function(response){
        Alert.alert('', response.message,
                function(){
                  if(response.success){
                    location.href = '/logout';
                  }
                });

      },
      error: function(jqXHR, textStatus, errorThrown) {
        Alert.alert('', '에러가 발생하였습니다.');
      }
    });
  })


  initializeSelect({
    url: '/user-codes/parent',
    params: {parentId: 154},
    elementId: 'agencycd',
    valueField: "id"
  });

  function updateNextSelect(param) {
    let code = param.value;

    // param의 다음 형제 요소를 찾습니다.
    let nextSelect = $(param).next('select');



    if (nextSelect.length) {
      $.ajax({
        url: '/user-codes/code_spcompcd',
        type: 'GET',
        async: false,
        data: { code: code },
        success: function (data) {
          nextSelect.empty();
          nextSelect.append('<option value="">선택하세요</option>');
          data.forEach(function (item) {
            nextSelect.append('<option value="' + item.dtlcd + '">' + item.spcompnm + '</option>');
          });
        },
        error: function (xhr, status, error) {
          // 통신 실패 시 처리


          // 선택 옵션을 비우거나 기본 옵션을 설정할 수 있습니다.
          nextSelect.empty();
          nextSelect.append('<option value=""></option>');
        }
      });
    } else {
      console.error('다음 select 요소를 찾을 수 없습니다.');
    }
  }


  function updateNextSelect2(param) {
    let code = param.value;

    // param의 다음 형제 요소를 찾습니다.
    let nextSelect = $(param).next('select');

    if (nextSelect.length) {

      $.ajax({
        url: '/user-codes/code_spplancd',
        type: 'GET',
        data: { code: code },
        async: false,
        success: function(data) {
          nextSelect.empty();
          nextSelect.append('<option value="">선택하세요</option>');

          if(data.length === 0){
            Alert.alert('', '해당 지역은 발전소가 없습니다.');
          }


          data.forEach(function(item) {
            nextSelect.append('<option value="' + item.spplancd + '">' + item.spplannm + '</option>');
          });
        },
        error: function(xhr, status, error) {
          // 통신 실패 시 처리


          // 선택 옵션을 비우거나 기본 옵션을 설정할 수 있습니다.
          nextSelect.empty();
          nextSelect.append('<option value=""></option>');
        }
      });
    } else {
      console.error('다음 select 요소를 찾을 수 없습니다.');
    }
  }

  function addselectField(button) {
    // 새로운 td 요소를 생성합니다.
    var newTd = document.createElement('li');
    newTd.className = 'new-fl-ac';

    if (!window.cloneCounter) {
      window.cloneCounter = 1;
    } else {
      window.cloneCounter++;
    }

    // 새로운 input 요소를 생성합니다.
    var originalSelect1 = document.getElementById('firstSelect');
    var newInput = originalSelect1.cloneNode(true);
    newInput.name = 'spworkcd';
    newInput.id = originalSelect1.id + window.cloneCounter;
    //newInput.style.setProperty('margin-right', '8px', 'important');
    newInput.value = '';
    newInput.type = 'select';

    var originalSelect2 = document.getElementById('secondSelect');
    var newInput2 = originalSelect2.cloneNode(true);
    newInput2.name = 'spcompcd';
    //newInput2.style.setProperty('margin-right', '10px', 'important');
    newInput2.type = 'select';
    newInput2.id = originalSelect2.id + window.cloneCounter;

    var originalSelect3 = document.getElementById('thirdSelect');
    var newInput3 = originalSelect3.cloneNode(true);
    newInput3.name = 'spplancd';
    //newInput3.style.setProperty('margin-right', '7px', 'important');
    // newInput2.className = 'wp100';
    newInput3.type = 'select';
    newInput3.id = originalSelect3.id + window.cloneCounter;

    // 삭제 버튼을 생성합니다.
    var deleteButton = document.createElement('button');
    deleteButton.textContent = '발전시설 삭제';
    deleteButton.onclick = function () {
      deleteSelectField(newInput); // 삭제 버튼을 클릭하면 해당 입력 필드를 삭제하는 함수 호출
      deleteSelectField(newInput2);
      deleteSelectField(newInput3);
    };
    deleteButton.className = 'btn';
    //deleteButton.style.width = '107px';
    deleteButton.style.color = 'red';
    deleteButton.style.marginTop = '5px';
    // 새로운 td에 input 요소와 삭제 버튼을 추가합니다.
    newTd.appendChild(newInput);
    newTd.appendChild(newInput2);
    newTd.appendChild(newInput3);
    newTd.appendChild(deleteButton);

    // 클릭된 버튼의 부모 td 요소를 찾습니다.
    var parentTd = button.parentElement;

    // 부모 td 요소 다음에 새로운 td 요소를 추가합니다.
    parentTd.parentElement.insertBefore(newTd, parentTd.nextSibling);
  }

  // 입력 필드 삭제 함수
  function deleteSelectField(inputField) {
    // 입력 필드의 부모 요소(td)를 찾아서 삭제합니다.
    var tdToDelete = inputField.parentElement;
    tdToDelete.parentElement.removeChild(tdToDelete);
  }


  function createSelectElement(id, name, onChange, margin) {
    return $('<select>', {
      id: id,
      name: name,
      onchange: onChange
    }).append('<option></option>')
            .attr('style', `margin-right: ${margin}px !important;`);
  }

  function createButtonElement(name, text, color, width, onClick) {
    return $('<button>', {
      type: 'button',
      name: name,
      text: text,
      css: {
        color: color,
        width: width,
        marginBottom: '5px'
      },
      onclick: onClick
    });
  }

  //이메일 정규식
  function emailValidate(emailVal){
    const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

    return emailPattern.test(emailVal);
  }

  //같은 name값의 select요소 value 추출
  function extractSelectValues(selectName) {
    let inputs = document.querySelectorAll(`select[name="${selectName}"]`);
    return Array.from(inputs).map(input => input.value).join(',');
  }

  //같은 name값의 select요소 텍스트 추출
  function extractSelectTexts(selectName) {
    let inputs = document.querySelectorAll(`select[name="${selectName}"]`);
    return Array.from(inputs).map(input => input.options[input.selectedIndex].text).join(',');
  }

  // 유효성 검사
  function validateFields() {
    for (let field of requiredFields) {
      if (!validateFieldById(field.id, field.name)) {
        return false;
      }
    }

    for (let field of nameBasedFields) {
      if (!validateFieldsByName(field.name, field.displayName)) {
        return false;
      }
    }

    return true;  // 모든 유효성 검사를 통과했을 경우
  }

  // ID로 유효성 검사 함수
  function validateFieldById(id, fieldName) {
    const value = document.getElementById(id)?.value.trim();

    if (!value) {
      Alert.alert('', `${fieldName}이(가) 입력되지 않았습니다.`);
      return false;
    }

    return true;
  }

  // name 속성으로 유효성 검사 함수
  function validateFieldsByName(name, fieldName) {
    const elements = document.getElementsByName(name);

    if (elements.length === 0) {
      console.error(`이름이 ${name}인 요소를 찾을 수 없습니다.`);
      return false;
    }

    for (let element of elements) {
      const value = element.value.trim();
      if (!value) {
        Alert.alert('', `${fieldName}이(가) 입력되지 않았습니다.`);
        return false;
      }
    }

    return true;
  }

  document.querySelectorAll('.toggle-password').forEach(icon => {
    icon.addEventListener('click', () => {
      const targetId = icon.getAttribute('data-target');
      const inputField = document.getElementById(targetId);

      if (inputField.type === 'password') {
        inputField.type = 'text';
        icon.style.backgroundImage = "url('/images/icon/btn-hidden.svg')"; // 비밀번호 보임 상태
      } else {
        inputField.type = 'password';
        icon.style.backgroundImage = "url('/images/icon/btn-show.svg')"; // 비밀번호 숨김 상태
      }
    });
  });
</script>


</body>

</html>
