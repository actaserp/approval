<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">

<head>
    <style>
        #theGrid2.wj-flexgrid .wj-cell {
            padding: 12px;
        }

        #theGrid2.wj-flexgrid .downloads {
            padding-top: 0px;
        }

    </style>
</head>

<th:block layout:fragment="content">

    <!--- (레이아웃) Contents 영역 -->
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>순회점검 통계</h2><a id="toggleButton" onclick="toggleSearchWrap()"><img src="/images/icon/ico-down.png" alt="알람 아이콘"></a>
                <a title="북마크" class="bookmark toggle">
                    내메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>순회점검 관리</li>
                <li>순회점검 통계</li>
            </ul>
        </div>

        <!-- Select -->
        <div class="search-wrap" id="searchWrap" style="display: none">
            <ul>
                <li>
                    <select title="지역" id="spworkcd" name="spworkcd"
                            onchange="updateCompcdOptions(); saveSelectedSandanData(); ">
                        <!-- 지역 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spworknm" name="spworknm">
                </li>
                <li>
                    <select title="산단" id="spcompcd" name="spcompcd"
                            onchange="updatePlancdOptions(); saveSelectedSandanData();">
                        <!-- 산단 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spcompnm" name="spcompnm">
                </li>
                <li>
                    <select title="시설" id="spplancd" name="spplancd" onchange="updatePlannm(); saveSelectedSandanData()">
                        <!-- 시설 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spplannm" name="spplannm">
                </li>
            </ul>
        </div>

        <div class="tab-wrap" style="margin-bottom: 30px">
            <ul class="tab-links">
                <li>
                    <a href="#tab1" title="기간별조회">기간별 조회</a>
                </li>
                <li>
                    <a href="#tab2" title="기간별대비">기간별 대비</a>
                </li>
            </ul>

            <div class="tab-contents">
                <!-- tab1 -->
                <section class="tab-item" id="tab1">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl id="searchYear" style="display: none">
                                <dt>
                                    조회연도<span class="eq">*</span>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="yearSelectTab1" name="yearSelectTab1" onchange="WijmoGrid()">
                                            </select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label for="periodType">
                                        점검구분<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="inspecType" name="inspecType" onchange="WijmoGrid()">
                                                <option value="wm_inspec_month_list" selected>순회점검</option>
                                                <option value="wm_hap_list">합동안전점검</option>
                                                <option value="wm_elecsafe_list">전기안전점검</option>
                                                <option value="wm_emergency_plan">비상훈련계획</option>
                                                <option value="wm_emergency_result">비상훈련결과</option>
                                                <option value="wm_safety_health">안전보건교육</option>
                                                <option value="wm_inspec_field_list">Fieldservice</option>
                                            </select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label for="periodType">
                                        기간유형<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="periodType" name="periodType" onchange="updatePeriodInputs()">
                                                <option value="monthly" selected>월별</option>
                                                <option value="quarterly">분기별</option>
                                                <option value="halfyearly">반기별</option>
                                                <option value="yearly">연도별</option>
                                            </select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    조회기간<span class="eq">*</span>
                                </dt>
                                <dd>
                                    <ul class="date-box" id="dateBoxContainer">
                                        <li id="startDateContainer">
                                            <input type="month" id="startDate" name="startDate" value="2024-01" onchange="WijmoGrid()">
                                        </li>
                                        <li id="endDateContainer">
                                            <input type="month" id="endDate" name="endDate" value="2024-12" onchange="WijmoGrid()">
                                        </li>
                                    </ul>
                                </dd>
                            </dl>


                            <dl>
                                <dt style="visibility: hidden">
                                    조회기간<span class="eq">*</span>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <a class="btn btn-delete" title="검색" id="btn-search" onclick="searchData()">
                                                <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                                검색
                                            </a>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                        </div>

                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a class="btn btn-excell" title="엑셀다운로드">
                                        <img src="/images/icon/ico-excell.svg" alt="엑셀 아이콘">
                                        엑셀다운로드
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div> <!--//section-top end -->

                    <div class="row row-2">
                        <section class="wp50" style="height: 530px; border-radius: 15px;">
                            <!-- 그래프 -->
                            <div id="chartHolder1" style="width:600px; height:400px;">
                            </div>
                        </section>
                        <section class="wp50" style="height: 530px">
                            <div class="container-fluid">
                                <p id="selectedItem"></p>
                                <div id="theGrid" style="max-height: 485px;"></div>
                            </div>
                        </section>
                    </div>
                </section>

                <!-- tab2 -->
                <section class="tab-item" id="tab2">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    조회연도<span class="eq">*</span>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="yearSelectTab2" name="yearSelectTab2">
                                                <!-- 연도 목록이 동적으로 추가될 것입니다 -->
                                            </select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    <label for="generatorSelect">
                                        발전기명<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="generatorSelect" name="generatorSelect">
                                                <option value="all">전체</option>
                                                <option value="AJ380">AJ380</option>
                                                <option value="AJ390">AJ390</option>
                                            </select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    <label for="comparisonType">
                                        비교 유형<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="comparisonType" name="comparisonType">
                                                <option value="YoY">YoY</option>
                                                <option value="QoQ">QoQ</option>
                                                <option value="MoM">MoM</option>
                                                <option value="YTD">YTD</option>
                                            </select>
                                        </li>

                                        <li>
                                            <a class="btn btn-navy" title="차트설정초기화" id="btn-reset-chart2">
                                                차트설정 초기화
                                            </a>
                                        </li>

                                        <li>
                                            <a class="btn btn-delete" title="검색" id="btn-search2" onclick="searchComparisonData()">
                                                <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                                검색
                                            </a>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                        </div>

                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a class="btn btn-excell" title="엑셀다운로드">
                                        <img src="/images/icon/ico-excell.svg" alt="엑셀 아이콘">
                                        엑셀다운로드
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div> <!--//section-top end -->

                    <div class="row row-2">
                        <section class="wp50" style="height: 530px; border-radius: 15px;">
                            <div id="chartHolder2" style="width:600px; height:400px;"></div>
                        </section>
                        <section class="wp50" style="height: 530px;">
                            <div class="container-fluid">
                                <p id="selectedItem"></p>
                                <div id="theGrid2" style="max-height: 485px;"></div>
                            </div>
                        </section>
                    </div>
                </section>
            </div><!--//tab-contents end -->
        </div>
    </div> <!--//layout-contents end -->

</th:block>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
    <th:block th:replace="/common/approve_box :: approve_box"></th:block>
    <th:block th:replace="/common/ax5_uploader :: ax5_uploader" ></th:block>
    <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box" ></th:block>
    <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>

    <script type="text/javascript">

        // 배열 데이터로 정의
        var chartData =
            [{"Month":"Jan","Profit":1100},
                {"Month":"Feb","Profit":1400},
                {"Month":"Mar","Profit":1450},
                {"Month":"Apr","Profit":2300},
                {"Month":"May","Profit":2100},
                {"Month":"Jun","Profit":1520},
                {"Month":"Jul","Profit":1360},
                {"Month":"Aug","Profit":1420},
                {"Month":"Sep","Profit":1150},
                {"Month":"Oct","Profit":1300},
                {"Month":"Nov","Profit":1300},
                {"Month":"Dec","Profit":1650}];

        // 배열 데이터로 정의
        var chartData2 =
            [{"Month":"Jan", "Profit":5000, "Cost":1700},
                {"Month":"Feb", "Profit":8000, "Cost":1600},
                {"Month":"Mar", "Profit":6000, "Cost":1200},
                {"Month":"Apr", "Profit":6000, "Cost":1400},
                {"Month":"May", "Profit":4800, "Cost":1700},
                {"Month":"Jun", "Profit":7000, "Cost":1400},
                {"Month":"Jul", "Profit":5200, "Cost":1600}];

        // XML 구조의 스트링으로 정의
        var chartData3 = [
            {
                "Year": "2024",
                "건수": 320,
                "Cost": 250
            },
            {
                "Year": "2025",
                "건수": 250,
                "Cost": 150
            },
            {
                "Year": "2026",
                "Profit": 350,
                "Cost": 140
            },
            {
                "Year": "2027",
                "건수": 250,
                "Cost": 130
            },
            {
                "Year": "2028",
                "건수": 400,
                "Cost": 230
            },
            {
                "Year": "2029",
                "건수": 350,
                "Cost": 140
            }
        ];

        //3D막대, 라인차트 레이아웃 정의
        function getCartesianLayout(type, title, dataField)
        {
            var layout="<rMateChart borderStyle='none'>"
                +"<Options><Caption text='" + title +"' paddingBottom='50'/></Options>"
                +"<NumberFormatter id='numfmt' useThousandsSeparator='true'/>"
                +"<" + type + "Chart showDataTips='true'>"
                +"<series>";

            var category = type == "Column3D" ? 'Year' : 'Month';

            for(var i=0; i<dataField.length; ++i)
            {
                layout += "<" + type +"Series yField='" + dataField[i] + "' displayName='" + dataField[i] + "'>"
                    +"<showDataEffect><SeriesSlide direction='up' duration='700'/></showDataEffect>"
                    +"</" + type +"Series>"
            }

            layout +="</series>"
                +"<horizontalAxis>"
                +    "<CategoryAxis categoryField='" + category + "'/>"
                +"</horizontalAxis>"
                +"<verticalAxis>"
                +"<LinearAxis formatter='{numfmt}'/>"
                +"</verticalAxis>"
                +"</" + type + "Chart>"
                +"</rMateChart>";
            return layout;
        }

        // 레이더 차트 레이아웃.
        var radarLayout =
            "<rMateChart borderStyle='none'>"
            +"<Options>"
            +"<Caption text='레이더 차트 표현' fontFamily='맑은 고딕' paddingBottom='50'/>"
            +"</Options>"
            +"<NumberFormatter id='numfmt' useThousandsSeparator='true'/>"
            +"<RadarChart type='polygon' paddingTop='20' paddingBottom='20' showDataTips='true'>"
            +"<radialAxis>"
            +"<LinearAxis id='rAxis' formatter='{numfmt}'/>"
            +"</radialAxis>"
            +"<radialAxisRenderers>"
            +"<Axis2DRenderer axis='{rAxis}' horizontal='true' tickPlacement='outside' tickLength='4'>"
            +'<axisStroke>'
            +'<Stroke color="#555555"/>'
            +'</axisStroke>'
            +'</Axis2DRenderer>'
            +"</radialAxisRenderers>"
            +"<angularAxis>"
            +"<CategoryAxis categoryField='Year' displayName='Year'/>"
            +"</angularAxis>"
            +"<series>"
            +"<RadarSeries field='Profit' displayName='Profit' fillLineArea='false'>"
            +"<showDataEffect>"
            +"<SeriesInterpolate duration='700'/>"
            +"</showDataEffect>"
            +"</RadarSeries>"
            +"<RadarSeries field='Cost' displayName='Cost' fillLineArea='false'>"
            +"<showDataEffect>"
            +"<SeriesInterpolate duration='700'/>"
            +"</showDataEffect>"
            +"</RadarSeries>"
            +"</series>"
            +"</RadarChart>"
            +"</rMateChart>";

        //rMate 불러오기
        function rMateCall(RmaTeData){

            rMateChartH5.create("chart1", "chartHolder1", "", "120%", "120%");

            var layout1 = getCartesianLayout("Column2D","칼럼 차트로 표현",["Profit"]);
            var layout2 = getCartesianLayout("Line2D","라인 차트로 표현",["Profit"]);
            var layout3 = getCartesianLayout("Column3D","칼럼 3D 멀티 데이터 표현",["건수"]);


            var layoutSet = [layout3, layout2, radarLayout];
            var dataSet = [RmaTeData, rmateData, RmaTeData];

            rMateChartH5.calls("chart1", {
                "setSlideLayoutSet" : layoutSet,
                "setSlideDataSet" : dataSet
            });
        }


        // ===============================================================================Rmate

        let theGrid;


        function WijmoGrid(){

            let dataSet = AjaxGetBodyParameter();

            let url = getServerEndpoint();

            let data2 = DataLoad(url, dataSet, 'wijmo');

            let columns = getColumnsType();

            viewdata = new wijmo.collections.CollectionView(data2);
            // 데이터 그리드에 바인딩

            if(!theGrid){
                theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    columns: columns,
                    allowSorting: 'MultiColumn',
                    selectionMode: 'ListBox',
                    itemsSource: viewdata
                });

                theGrid.rowHeaders.columns.splice(0, 1);
                //rMateCall();
            }else{
                theGrid.columns.clear();
                theGrid.autoGenerateColumns = false;
                for (var i = 0; i < columns.length; i++) {
                    var col = new wijmo.grid.Column(columns[i]);
                    theGrid.columns.push(col);
                }
                theGrid.itemsSource = viewdata;
                //rMateCall();
            }

        }


        //////////////////////////////////////////////////////////////////////////////////////////////// Wijmo


        document.addEventListener('DOMContentLoaded', function(){
            initializeSelections();  //위에 산단, 발전소명 관련 함수
            loadYearlyData();        //조회연도 항목 불러오기
            WijmoGrid();
        })


        function getColumnsType(){
            let columnType = $('#inspecType').val();
            let columns = [];


            switch (columnType){
                case 'wm_inspec_month_list':
                    columns = [{ binding: 'checkarea', header: '장소', align: 'center', width: '0.5*', minWidth: 200},
                        { binding: 'hour', header: '시간', align: 'center', width: '*', minWidth: 200 },
                        { binding: 'checkusr', header: '점검자', align: 'center', width: '0.5*', minWidth: 200 }]
                    break;
                case 'wm_hap_list':
                    columns = [{ binding: 'checkarea', header: '장소', align: 'center', width: '0.5*', minWidth: 200},
                        { binding: 'checkrem', header: '결과', align: 'center', width: '*', minWidth: 200 },
                        { binding: 'checkusr', header: '점검자', align: 'center', width: '0.5*', minWidth: 200 }]
                    break;
                case 'wm_elecsafe_list':
                    columns = [{ binding: 'checkarea', header: '장소', align: 'center', width: '0.5*', minWidth: 200},
                        { binding: 'checkresult', header: '결과', align: 'center', width: '*', minWidth: 200 },
                        { binding: 'checktitle', header: '점검명', align: 'center', width: '0.5*', minWidth: 200 }]
                    break;
            }
            return columns;
        }

        function getServerEndpoint(){
            let type = $('#inspecType').val();
            let url;

            switch (type){
                case 'wm_inspec_month_list':
                    url = '/api/inspec_statics/RP710/read'
                    break;
                case 'wm_hap_list':
                    url = '/api/inspec_statics/RP720/read'
                    break;
                case 'wm_elecsafe_list':
                    url = '/api/inspec_statics/RP750/read'
                    break;
            }
            return url;
        }

        function searchData(){
            let dataSet = AjaxGetBodyParameter();

            let data2 = DataLoad('/api/inspec_statics/RP710/read', dataSet, 'wijmo');
            WijmoGrid();
        }


        function AjaxGetBodyParameter(){
            let dataSet;
            let periodType = $('#periodType').val();

            if(periodType === 'monthly'){
                dataSet = {
                    'searchfrdate' : $('#startDate').val(),
                    'searchtodate' : $('#endDate').val(),
                    'searchType' : periodType
                };
            }
            else if(periodType === 'quarterly'){


                dataSet = {
                    'searchYear' : $('#yearSelectTab1').val(),
                    'searchfrQuarter' : $('#startSelect').val(),
                    'searchtoQuarter' : $('#endSelect').val(),
                    'searchType' : periodType
                };
            }
            else if(periodType === 'halfyearly'){

                dataSet = {
                    'searchYear' : $('#yearSelectTab1').val(),
                    'searchfrHalfYear' : $('#startSelect').val(),
                    'searchtoHalfYear' : $('#endSelect').val(),
                    'searchType' : periodType
                }
            }
            else if(periodType === 'yearly')
            {
                dataSet = {
                    'searchfrYear' : $('#startSelect').val(),
                    'searchtoYear' : $('#endSelect').val(),
                    'searchType' : periodType
                };


            }
            return dataSet;
        }



        // 조회기간 변동 함수 -> 입력 필드를 동적으로 업데이트
        function updatePeriodInputs() {
            const periodType = document.getElementById("periodType").value;
            const selectedYear = document.getElementById("yearSelectTab1").value; // 선택된 조회연도 가져오기
            const startDateContainer = document.getElementById("startDateContainer");
            const endDateContainer = document.getElementById("endDateContainer");

            // 기존 내용을 초기화
            startDateContainer.innerHTML = "";
            endDateContainer.innerHTML = "";

            // 'searchYear' 요소의 표시 여부 제어
            if (periodType === "monthly" || periodType === "yearly") {
                $('#searchYear').hide();
            } else if (periodType === "quarterly" || periodType === "halfyearly") {
                $('#searchYear').show();
            }

            if (periodType === "monthly") { // 월별 조회가 선택된 경우
                const startDate = `${selectedYear}-01`; // 선택된 연도의 1월
                const endDate = `${selectedYear}-12`; // 선택된 연도의 12월

                startDateContainer.innerHTML = `<input type="month" id="startDate" name="startDate" value="${startDate}" onchange="WijmoGrid()">`;
                endDateContainer.innerHTML = `<input type="month" id="endDate" name="endDate" value="${endDate}" onchange="WijmoGrid()">`;
            }
            else if (periodType === "quarterly" || periodType === "halfyearly" || periodType === "yearly") {
                const options = periodType === "quarterly" ? `
            <option value="Q1">1분기</option>
            <option value="Q2">2분기</option>
            <option value="Q3">3분기</option>
            <option value="Q4">4분기</option>
        ` : periodType === "halfyearly" ? `
            <option value="H1">상반기</option>
            <option value="H2">하반기</option>
        ` : '';

                startDateContainer.innerHTML = `<select id="startSelect" onchange="WijmoGrid()">${options}</select>`;
                endDateContainer.innerHTML = `<select id="endSelect" onchange="WijmoGrid()">${options}</select>`;

                if (periodType === "yearly") {
                    // 연도별일 경우 연도를 동적으로 로드하여 추가
                    loadYearlyData();
                }
            }
        }

        // 조회연도 변경 시 조회기간의 연도도 동기화
        function updateYearInPeriod() {
            const selectedYear = document.getElementById("yearSelectTab1").value;

            const startDateInput = document.getElementById("startDate");
            const endDateInput = document.getElementById("endDate");

            if (startDateInput && endDateInput) {
                startDateInput.value = `${selectedYear}-01`;
                endDateInput.value = `${selectedYear}-12`;
            }
        }

        // 조회연도 선택 요소에 이벤트 리스너 추가
        document.getElementById("yearSelectTab1").addEventListener("change", function() {
            //updateYearInPeriod(); // 조회연도 변경 시 startDate와 endDate 갱신
            //updatePeriodInputs(); // 연도 변경 시 기간 입력 필드 초기화
        });

        // 연도를 로드하고 기존 UI를 업데이트
        function loadYearlyData() {
            fetch('/api/inspec_statics/distinctYears')
                .then(response => response.json())
                .then(years => {
                    const yearSelectTab1 = document.getElementById("yearSelectTab1");
                    const yearSelectTab2 = document.getElementById("yearSelectTab2");

                    // 기간유형이 연도별일 때 조회기간에 사용될 startSelect와 endSelect
                    const startSelect = document.getElementById("startSelect");
                    const endSelect = document.getElementById("endSelect");

                    // 기존 옵션 삭제
                    yearSelectTab1.innerHTML = '';
                    yearSelectTab2.innerHTML = '';
                    if (startSelect) startSelect.innerHTML = '';
                    if (endSelect) endSelect.innerHTML = '';

                    // 서버에서 가져온 연도 목록을 <option>으로 추가
                    years.forEach(year => {
                        const option1 = document.createElement('option');
                        option1.value = year;
                        option1.textContent = year;

                        yearSelectTab1.appendChild(option1);
                        yearSelectTab2.appendChild(option1.cloneNode(true));

                        if (startSelect && endSelect) {
                            const option2 = document.createElement('option');
                            option2.value = year;
                            option2.textContent = year;

                            startSelect.appendChild(option2);
                            endSelect.appendChild(option2.cloneNode(true));
                        }
                    });
                })
                .catch(error => console.error('Error loading years:', error));
        }
    </script>
</th:block>
</html>
