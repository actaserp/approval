<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>
    #theGrid {
        width: 100%;
        height: 400px;
        overflow: auto; /* 스크롤 활성화 */
    }

    .wj-flexgrid .wj-header {
        position: sticky;
        top: 0;
        z-index: 10;
        overflow: auto;
    }

</style>
<th:block layout:fragment="content">
  <div class="layout-contents">
    <!-- Page Title -->
    <div class="page-title-wrap">
      <div class="left">
        <h2>결재 내역</h2><a id="toggleButton" onclick="toggleSearchWrap()"><img src="/images/icon/ico-down.png" alt="알람 아이콘"></a>
        <!--<a title="북마크" class="bookmark toggle">
            내메뉴
        </a>-->
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
        <li>결재목록</li>
        <li>결재내역</li>
      </ul>
    </div>
    <!-- Select -->
    <div class="search-wrap" id="searchWrap" style="display: none; padding-top:10px">
      <ul>
        <li>
          <select title="사업장코드" id="search_spjangcd" name="search_sjangcd"
                  onchange="init()">
            <option value="" hidden selected disabled>선택</option>
            <option value="ZZ">대한럭비협회</option>
            <option value="PP"></option>
            <!-- 지역 옵션을 JavaScript에서 동적으로 채움 -->
          </select>
        </li>
      </ul>
    </div>
    <div class="tab-contents">
      <section class="tab-item" id="tab2" style="height: 830px; overflow: hidden;">
        <div class="section-top">
          <div class="search-wrap">
            <dl>
              <dt>
                <label for="searchUserNm">
                  작성일자<span class="eq">*</span>
                </label>
              </dt>
              <dd>
                <ul class="date-box">
                  <li>
                    <input type="date" id="startDate" name="startDate">
                    <label for="startDate" class="hide">시작일</label>
                  </li>
                  <li>
                    <input type="date" id="endDate" name="endDate">
                    <label for="endDate" class="hide">종료일</label>
                  </li>
                </ul>
              </dd>
            </dl>
            <dl>
              <dt>
                <label for="SearchPayment">
                  진행구분<span class="eq"></span>
                </label>
              </dt>
              <dd>
                <div class="srch-box">
                  <select id="SearchPayment" name="SearchPayment">
                    <option value="all"></option>
                  </select>
                </div>
              </dd>
            </dl>
            <dl>
              <dt>
                <label for="searchUserNm">
                  제목<span class="eq">*</span>
                </label>
              </dt>
              <dd>
                <div class="srch-box">
                  <input type="text" id="searchUserNm" name="searchUserNm" class="input-srch"
                         placeholder="제목" style="border-radius: 5px;">
                </div>
              </dd>
            </dl>
            <dl>
              <dt>&nbsp;</dt>
              <dd>
                <li>
                  <a class="btn btn-delete" title="검색" id="searchButton1" onclick="fetchListData()">
                    <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                    검색
                  </a>
                </li>
              </dd>
            </dl>
          </div>
          <!--<div class="button-wrap" style="border-top:none;">
            <ul>
              <li>
                <a class="btn btn-excell" title="신규등록" id="Newbtn" onclick="NewSave()">
                  <img src="/images/icon/ico-plus.svg" alt="등록 아이콘">
                  신규등록
                </a>
              </li>
              <li>
                <a class="btn btn-delete" title="삭제" id="btnDelete" onclick="deleteData()">
                  <img src="/images/icon/ico-delete.svg" alt="엑셀 아이콘">
                  삭제
                </a>
              </li>
            </ul>
          </div>-->
        </div>

        <div class="container-fluid">
          <p id="selectedItem"></p>
          <div id="theGrid1" style="max-height:200px"></div>
          <div id="theGrid" style="max-height: 570px"></div>
        </div>
      </section>
    </div> <!--//tab-wrap end-->
  </div> <!--//layout-contents end -->
  <footer>
    <p>ⓒ factCheck corp.All rights reserved.</p>
  </footer>

  <div class="dashboard-layout-popup">
    <div class="popup-overlay" id="popup1"></div>
    <div class="popup-wrapper" id="wrapper1">
      <div class="popup-title">
        <h3>신규 등록</h3>
        <a onclick="NewClose()" title="팝업닫기" class="btn-popup-close">
          <img src="/images/icon/btn-popup-close.svg" alt="닫기">
        </a>
      </div>
      <div class="popup-contents">
        <form id="MarketingForm" autocomplete="off">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <div class="table-wrap">
            <table class="view-table" id="selectedData" style="max-height: 740px;">
              <caption>마케팅관리 신규 등록 테이블</caption>
              <colgroup>
                <col class="wp20">
                <col class="wauto">
              </colgroup>
              <tbody>
              <tr>
                <th><label for="makcltnm"> 기관명</label></th>
                <td colspan="3">
                  <input id="makcltnm" name="makcltnm" class="wp100" placeholder="기관명"/>
                  <input id="makseq" type="hidden">
                </td>
              </tr>
              <tr>
                <th><label for="title">제목</label></th>
                <td colspan="3">
                  <input id="title" name="title" class="wp100" placeholder="제 목"/>
                </td>
              </tr>
              <tr>
                <th>
                  <label for="makcondyul">추출조건</label>
                </th>
                <td colspan="3">
                  <input type="text" id="makcondyul" name="makcondyul" class="wp100" placeholder=" 추출조건 (숫자만 입력)"
                         oninput="addPercentageSign(this)"/>
                </td>
              </tr>
              <tr>
                <th><label for="makuseyul">활용수지</label></th>
                <td colspan="3">
                  <input type="text" id="makuseyul" name="makuseyul" class="wp100" placeholder="활용 수치 (숫자만 입력)"
                         oninput="addPercentageSign(this)"/>
                </td>
              </tr>
              <tr>
                <th><label for="fileInput2">첨부파일</label></th>
                <td colspan="3">
                  <div id="uploadComponent2" class="upload-component2">
                    <div class="upload-filebox2">
                      <img src="/images/icon/ico-fileupload.svg" alt="업로드아이콘">
                      <a class="btn" title="파일업로드">파일 업로드</a>
                      <input type="file" id="fileInput2" class="fileInput2" multiple>
                      <p>Maximun upload file size <span>1GiB</span></p>
                    </div>

                    <div class="upload-filelist2">
                      <div class="title">
                        <h5>Files (0)</h5>
                        <a title="Delete all" class="btn-file-deleteall2">Delete all</a>
                      </div>
                      <ul class="filelist2" id="filelist2">
                      </ul>
                    </div>
                  </div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </form>
      </div>
      <div class="popup-button">
        <button class="btn-popup-close" onclick="NewClose()">취소</button>
        <button class="btn-navy" id="btnSaveAuth" onclick="SaveForm()"> 저장</button>
      </div>
    </div>
  </div>

</th:block>
<th:block layout:fragment="scripts">
  <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="text/javascript">
    let theGrid;
    let theGrid1;
    let isBindSpjangcdCalled = false;

    $(document).ready(function () {
      // 현재 날짜 설정
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();

      // 시작일
      const startOfYear = new Date(year, 0, 1);
      const startYearFormatted = `${startOfYear.getFullYear()}-${String(startOfYear.getMonth() + 1).padStart(2, '0')}-${String(startOfYear.getDate()).padStart(2, '0')}`;
      $('#startDate').val(startYearFormatted);

      // 종료일
      const endOfMonth = new Date(year, month + 1, 0);
      const endMonthFormatted = `${endOfMonth.getFullYear()}-${String(endOfMonth.getMonth() + 1).padStart(2, '0')}-${String(endOfMonth.getDate()).padStart(2, '0')}`;
      $('#endDate').val(endMonthFormatted);
      init();
    });

    document.getElementById('searchUserNm').addEventListener('keydown', function (event) {
      if (event.key === 'Enter') {
        fetchListData(); // 엔터 키를 눌렀을 때 실행할 함수
      }
    })

    function init() {
      if (!isBindSpjangcdCalled) {
        bindSpjangcd();
        isBindSpjangcdCalled = true; // 플래그 업데이트
      }
      fetchListData();
      fetchListData1();
    }

    function fetchListData() {
      let data = [];

      const params = {
        search_spjangcd: $('#search_spjangcd').val(),
        startDate: $('#startDate').val(),
        endDate: $('#endDate').val(),
        SearchPayment:$('#SearchPayment').val(),
        searchUserNm: $('#searchUserNm').val()
      };

      console.log("수집 데이터(결재 목록)",params);

      // 서버에서 데이터 가져오기
      $.ajax({
        url: '/api/PaymentDetail/read',
        type: 'GET',
        data: params,
        async: false,
        success: function (response) {
          console.log("서버에서 받은 데이터 :", response);
          // 응답이 올바르게 도착했고, data 속성이 배열인지 확인
          if (response && Array.isArray(response.data)) {
            console.log("서버에서 받은 데이터 목록:", response.data); //실제 데이터 확인
          }
          if (response && Array.isArray(response.data)) {
            data = response.data.map((item, index) => ({
              rownum: index + 1,
              appdate: item.appdate ||'',
              appgubun : item.appgubun || '',
              appgubun_display: item.appgubun_display ||'',
              appnum: item.appnum || '',
              appperid: item.appperid||'',
              papercd: item.papercd || '',
              remark :item.remark ||'',
              repodate: item.repodate || '' ,
              repoperid: item.repoperid || '' ,
              repopernm : item.repopernm||'',
              title: item.title ||''
            }));
          }
        },
        error: function () {
          console.error("데이터를 가져오는 중 오류가 발생했습니다.");
        }
      });

      while (data.length < 15) {
        data.push({
          rownum: data.length + 1,
          appdate: '',
          appgubun:'',
          appgubun_display:'',
          appnum:'',
          appperid:'',
          papercd:'',
          remark:'',
          repodate:'',
          repoperid:'',
          repopernm:'',
          title:''
        });
      }

      const viewdata = new wijmo.collections.CollectionView(data);

      if (!theGrid) {
        theGrid = new wijmo.grid.FlexGrid('#theGrid', {
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          selectionMode: 'ListBox',
          virtualizationThreshold: 1,
          columns: [
            {binding: 'rownum', header: '순번', width: 70, align: 'center'},
            {binding: 'appnum', header: '문서번호', width: '*', minWidth: 100, align: 'center'},
            {binding: 'repodate', header: '상신일자', width: '*', minWidth: 110, align: 'center'},
            {binding: 'repopernm', header: '작성자명', width: '*', minWidth: 100, align: 'center'},
            {binding: 'papercd', header: '문서명', width: '*', minWidth: 120, align: 'center'},
            {binding: 'appgubun', header: '결재구분', width: '*', minWidth: 100, align: 'center', visible: false},
            {binding: 'appgubun_display', header: '결재구분', width: '*', minWidth: 100, align: 'center'},
            {binding: 'appdate', header: '결재일자', width: '*', minWidth: 110, align: 'center'},
            {binding: 'title', header: '제목', width: '*', align: 'center', minWidth: 100},
            {binding: 'remark', header: '사유', width: '*', align: 'center', minWidth: 100},
            {binding: 'appperid', header: '', visible: false},
            {binding: 'repoperid', header: '', visible: false},
          ],
          itemsSource: viewdata,
        });
        theGrid.rowHeaders.columns.splice(0, 1);
        attachDoubleClickEvent(theGrid); //더블 클릭 이벤트
        new FlexGridContextMenu(theGrid);
        window.downloadFileName = '결재 목록';
      } else {
        theGrid.itemsSource = viewdata;
      }
    }
    function attachDoubleClickEvent(grid) {
      let lastClickTime = 0;
      grid.hostElement.addEventListener('click', function (e) {
        const now = new Date().getTime();

        if (now - lastClickTime < 300) { // 300ms 이내 클릭 -> 더블클릭 처리
          const ht = grid.hitTest(e);

          if (ht.cellType === wijmo.grid.CellType.Cell) {
            const rowData = grid.rows[ht.row].dataItem; // 더블 클릭한 행의 데이터
            console.log('Row Data:', rowData); // 디버깅

            if (rowData) {
              modifyData(rowData); // 데이터 입력 필드 채우기
              NewSave2(); // 팝업 열기
            }
          }
        }
        lastClickTime = now;
      });
    }
    function modifyData(rowData) {
      console.log("✔️ 더블클릭한 행의 데이터:", rowData);
      console.log("✔️ 파일 목록 데이터:", rowData.fileList || "🚨 fileList가 없습니다!");

      document.getElementById('makseq').value = rowData.makseq || "";
      document.getElementById('makcltnm').value = rowData.makcltnm || "";
      document.getElementById('title').value = rowData.maksubject || "";
      document.getElementById('makcondyul').value = rowData.makcondyul || "";
      document.getElementById('makuseyul').value = rowData.makuseyul || "";

      let fileList = document.getElementById('filelist2');
      fileList.innerHTML = "";
      uploadedFiles2 = [];
      deletedFiles2 = [];


    }
    function NewSave2() {
      let popup = document.getElementById('popup1');
      let wrapper = document.getElementById('wrapper1');

      popup.style.display = 'block';
      wrapper.style.display = 'block';
    }

    function NewClose() {
      // 팝업 닫기
      let popup = document.getElementById('popup1');
      let wrapper = document.getElementById('wrapper1');
      clearForm();  // 폼 초기화
      popup.style.display = 'none';
      wrapper.style.display = 'none';
    }

    // 폼 초기화 함수
    function clearForm() {
      // 폼 요소 선택
      const form = document.getElementById('MarketingForm');

      if (form) {
        form.reset(); // 모든 입력 필드 초기화
      }

      // 파일 입력 필드 초기화
      let fileInput = document.getElementById('fileInput2');
      if (fileInput) {
        fileInput.value = "";
      }

      // 파일 목록 UI 초기화
      let fileList = document.getElementById('filelist2');
      if (fileList) {
        fileList.innerHTML = "";
      }

      // 파일 리스트 배열 초기화
      uploadedFiles2 = [];

      // 파일 개수 텍스트 업데이트 (실시간 반영 확인)
      let fileCountText = document.querySelector(".upload-filelist2 h5");
      if (fileCountText) {
        fileCountText.textContent = `Files (${uploadedFiles2.length})`;
      }
      let clearButton = document.querySelector(".btn-clear");
      if (clearButton) {
        clearButton.remove();  // 요소 자체를 삭제
      }
    }

    function fetchListData1() {
      let data = [];

      const params = {
        search_spjangcd: $('#search_spjangcd').val(),
        startDate: $('#startDate').val(),
        endDate: $('#endDate').val(),
        searchUserNm: $('#searchUserNm').val()
      };

      // 서버에서 데이터 가져오기
      $.ajax({
        url: '/api/PaymentDetail/read1',
        type: 'GET',
        data: params,
        async: false,
        success: function (response) {
          console.log("서버에서 받은 데이터 :", response);
          // 응답이 올바르게 도착했고, data 속성이 배열인지 확인
          if (response && Array.isArray(response.data)) {
            console.log("서버에서 받은 데이터 목록:", response.data); //실제 데이터 확인
          }
          if (response && Array.isArray(response.data)) {
            data = response.data.map((item, index) => ({
              appgubun1: (item.appgubun1 || '0') + "건",
              appgubun2: (item.appgubun2 || '0') + "건",
              appgubun3: (item.appgubun3 || '0') + "건"
            }));
          }
        },
        error: function () {
          console.error("데이터를 가져오는 중 오류가 발생했습니다.");
        }
      });

      while (data.length < 1) {
        data.push({
          appgubun1: '',
          appgubun2: '',
          appgubun3: ''
        });
      }

      const viewdata = new wijmo.collections.CollectionView(data);

      if (!theGrid1) {
        theGrid1 = new wijmo.grid.FlexGrid('#theGrid1', {
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          columns: [
            {binding: 'appgubun1', header: '결재대기', width: '*', minWidth: 100, align: 'center'},
            {binding: 'appgubun2', header: '결재문서', width: '*', minWidth: 100, align: 'center'},
            {binding: 'appgubun3', header: '반려문서', width: '*', minWidth: 100, align: 'center'},
          ],
          itemsSource: viewdata,
        });
        theGrid1.rowHeaders.columns.splice(0, 1);
        new FlexGridContextMenu(theGrid1);
        window.downloadFileName = '문서 현황';
      } else {
        theGrid1.itemsSource = viewdata;
      }
    }

    //공통코드
    const selectConfigs = [
      {parentCode: 'Payment', elementId: 'SearchPayment'},
    ];

    selectConfigs.forEach(config => {
      initializeSelect3({
        url: '/api/PaymentList/payType',
        params: {parentCode: config.parentCode},
        elementId: config.elementId,
        valueField: "code",
        textField: "value",
        includeAllOption: true, // "전체" 옵션 사용
        // defaultValue: "001" // 기본 선택값 [대기]
      });
    });

    //사업장 코드
    function bindSpjangcd() {
      $.ajax({
        url: '/api/PaymentList/bindSpjangcd',
        type: 'GET',
        async: false,
        success: function (data) {
          data2 = data.data;
          const selectElement = document.getElementById('search_spjangcd');
          if (selectElement) {
            selectElement.value = data2; // value 속성으로 선택
          }
        }
      })
    }


  </script>
</th:block>
</html>