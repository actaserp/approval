<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>

</style>

<th:block layout:fragment="content">
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>ì‚¬ìš©ì ê´€ë¦¬</h2>
                <!--                <a title="ë¶ë§ˆí¬" class="bookmark toggle">-->
                <!--                    ë‚´ë©”ë‰´-->
                <!--                </a>-->
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
                <li>ì‹œìŠ¤í…œì„¤ì •</li>
                <li>ì‚¬ìš©ìê´€ë¦¬</li>
            </ul>
        </div>
        <!-- Select -->

        <div class="tab-wrap">
            <!--            <ul class="tab-links">-->
            <!--                <li>-->
            <!--                    <a href="#tab1" title="ëª©ë¡" id="listTabLink">ëª©ë¡</a>-->
            <!--                </li>-->
            <!--                <li>-->
            <!--                    <a href="#tab2" title="ë“±ë¡" id="inputTabLink">ë“±ë¡</a>-->
            <!--                </li>-->
            <!--            </ul>-->
            <div class="tab-contents">
                <!-- Section -->
                <section class="tab-item" id="tab1">

                    <div class="section-top">
                        <div class="title-wrap">
                            <h3>ì‚¬ìš©ì ë“±ë¡</h3>
                        </div>
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a class="btn btn-excell" title="ì‹ ê·œë“±ë¡" onclick="clearForm()">
                                        <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜">
                                        ì‹ ê·œë“±ë¡
                                    </a>
                                </li>
                                <!--<li>
                                    <a  class="btn btn-delete" title="ì‚­ì œ" id="btnDelete2">
                                        <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜">
                                        ì‚­ì œ
                                    </a>
                                </li>-->
                                <li>
                                    <a class="btn btn-edit" id="btnSave" title="ì €ì¥">
                                        <img src="/images/icon/ico-save.svg" alt="ì €ì¥ ì•„ì´ì½˜">
                                        ì €ì¥
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table class="write-table">
                            <caption>ì‚¬ìš©ìë“±ë¡ í…Œì´ë¸”</caption>
                            <colgroup>
                                <col class="wp20">
                                <col class="wp30">
                                <col class="wp20">
                                <col class="wp30">
                            </colgroup>
                            <tbody>
                            <tr>
                                <th>
                                    <label for="first_name">
                                        ì´ë¦„
                                    </label>
                                </th>
                                <td>
                                    <div class="input-clear">
                                        <input type="text" id="first_name" name="first_name" placeholder="ì´ë¦„"
                                               style="width: 400px !important;" readonly>
                                        <input type="hidden" id="id">
                                    </div>
                                </td>
                                <th>
                                    <label for="perid">
                                        ì‚¬ì›ì½”ë“œ
                                    </label>
                                </th>
                                <td>
                                    <div class="input-clear">
                                        <input type="text" id="perid" name="perid" placeholder="ì‚¬ì›ì½”ë“œ"
                                               style="width: 400px !important;" readonly>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    <label for="divinm">
                                        ë¶€ì„œ
                                    </label>
                                </th>
                                <td>
                                    <div class="input-clear">
                                        <input type="text" id="divinm" name="divinm" placeholder="ë¶€ì„œ"
                                               style="width: 400px !important;" readonly>
                                    </div>
                                </td>
                                <th>
                                    <label for="rspnm">
                                        ì§ê¸‰
                                    </label>
                                </th>
                                <td>
                                    <div class="input-clear">
                                        <input type="text" id="rspnm" name="rspnm" placeholder="ì§ê¸‰"
                                               style="width: 400px !important;" readonly>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    <label for="userid">
                                        ì•„ì´ë””
                                    </label>
                                </th>
                                <td>
                                    <div class="input-clear">
                                        <input type="text" id="userid" name="userid" placeholder="ì•„ì´ë””"
                                               style="width: 400px !important;" readonly>
                                    </div>
                                </td>
                                <th><label for="is_active">ì‚¬ìš©ì—¬ë¶€</label></th>
                                <td style="text-align: center; vertical-align: middle;">
                                    <input type="checkbox" id="is_active" name="is_active"
                                           style="display: block; margin: auto;">
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    <label for="PasswordChange">
                                        ë¹„ë°€ë²ˆí˜¸
                                    </label>
                                </th>
                                <td>
                                    <div class="input-clear">
                                        <input type="password" id="PasswordChange" name="PasswordChange"
                                               placeholder="ë³€ê²½ì‹œì— ì…ë ¥í•˜ì„¸ìš”."
                                               autocomplete="off" style="width: 400px !important;">
                                        <i class="toggle-password" data-target="PasswordChange"></i>
                                    </div>
                                </td>
                                <th>
                                    <label for="PasswordChangeChk">
                                        ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                                    </label>
                                </th>
                                <td>
                                    <div class="input-clear">
                                        <input type="password" id="PasswordChangeChk" name="PasswordChangeChk"
                                        placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" autocomplete="off" style="width: 400px !important;">
                                        <i class="toggle-password" data-target="PasswordChangeChk"></i>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>
                                    ì‚¬ì—…ì²´ëª…
                                </th>
                                <td>
                                    <select id="spjType" name="spjType" class="wp30">
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="ZZ">ëŒ€í•œëŸ­ë¹„í˜‘íšŒ</option>
                                    </select>
                                </td>
                                <th>
                                    ì‚¬ìš©ìê·¸ë£¹
                                </th>
                                <td>
                                    <select id="authType" name="authType" class="wp30">
                                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="1">ì‹œìŠ¤í…œê´€ë¦¬ì</option>
                                        <option value="14">ì£¼ë¬¸ ë‹´ë‹¹ì</option>
                                        <option value="35">ì¼ë°˜ê±°ë˜ì²˜</option>
                                    </select>
                                </td>
                            </tr>

                            </tbody>
                        </table>
                    </div>
                    <div class="section-top" style="margin-top: 24px;">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    ì‚¬ìš©ìê·¸ë£¹
                                </dt>
                                <dd>
                                    <select class="mg-r5" id="cboUserGroup" name="cboUserGroup" style="width: 100%">
                                        <option></option>
                                    </select>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label for="keyword">
                                        ì´ë¦„</label></dt>
                                <dd>
                                    <div class="input-clear"><input type="text" id="keyword" name="keyword"
                                                                    class="wp100" maxlength="50" placeholder="ì´ë¦„"></div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <div class="input-clear"></div>
                                        <a style="margin-left: 10px" class="btn btn-delete" title="ê²€ìƒ‰" id="searchgrid"
                                           onclick="fetchListData()">
                                            <!--                                        class ì“°ì´ëŠ” ê³³ ì°¾ê³  ì—†ìœ¼ë©´ í´ë˜ìŠ¤ëª… ìˆ˜ì •í•˜ê¸°-->
                                            <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                                            ê²€ìƒ‰
                                        </a>
                                    </div>
                                </dd>
                            </dl>
                        </div>
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a class="btn btn-delete" title="ì‚­ì œ" id="btnDelete">
                                        <img src="/images/icon/ico-delete.svg" alt="ì—‘ì…€ ì•„ì´ì½˜">
                                        ì‚­ì œ
                                    </a>
                                </li>
                            </ul>
                        </div>

                    </div>
                    <!--//section-top end -->
                    <div class="container-fluid">
                        <p id="selectedItem"></p>
                        <div id="theGrid" style="max-height: 450px;"></div>
                    </div>
                    <div class="btn-wrap">
                    </div>
                </section>
            </div> <!--//tab-contens end-->
        </div> <!--//tab-wrap end-->
    </div> <!--//layout-contents end -->

    <footer>
        <p>Copyrightâ“’ 0000 corp. All rights reserved.</p>
    </footer>
    <!--ì‚¬ì›ì •ë³´ ëª¨ë‹¬-->
    <div class="modal">
        <div id="CltnmModal" style="display: none;">
            <div class="modal-content">
                <h2 style="text-align: center;">ì‚¬ì› ì •ë³´</h2>
                <a title="íŒì—…ë‹«ê¸°" onclick="closePopup('CltnmModal')" class="btn-popup-close">
                    <img src="/images/icon/btn-popup-close.svg" style=" float: right; right: 30px;" alt="ë‹«ê¸°">
                </a>
                <form id="CltnmFindForm">
                    <div id="modalGrid" style="height: 350px;width: 100%; margin-right:0px;  margin-top: 20px;"></div>
                </form>
            </div>
        </div>
    </div>
</th:block>
<th:block layout:fragment="scripts">
    <th:block th:replace="/common/approve_box :: approve_box"></th:block>
    <th:block th:replace="/common/ax5_uploader :: ax5_uploader"></th:block>
    <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box"></th:block>
    <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script type="text/javascript">

        var theGrid;
        let modalGrid;
        var viewdata;
        let csrfToken = $("[name=_csrf]").val();

        //ìœ íš¨ì„± ê²€ì‚¬
        const requiredFields = [
            {id: 'userid', name: 'ì•„ì´ë””'},
            {id: 'first_name', name: 'ì´ë¦„'},
            {id: 'perid', name: 'ì‚¬ì›ì½”ë“œ'},
            {id: 'divinm', name: 'ë¶€ì„œ'},
            {id: 'rspnm', name: 'ì§ê¸‰'}
        ]

        document.readyState === 'complete' ? init() : window.onload = init;

        <!-- ì´ˆë°˜ í˜ì´ì§€ ì§„ì…ì‹œ ê·¸ë¦¬ë“œ ë°”ì¸ë”© ë-->
        function init() {
            fetchListData();

            // ì²´í¬ë°•ìŠ¤ í´ë¦­ í›„ ê°’ì´ ë³€ê²½ë  ë•Œ í•¨ìˆ˜ ì‹¤í–‰
            theGrid.cellEditEnded.addHandler(function(s, e) {
                var col = s.columns[e.col];
                var item = s.rows[e.row].dataItem;

                // is_active ì»¬ëŸ¼ì¼ ê²½ìš° ì²˜ë¦¬
                if (col.binding === 'is_active' && !item.is_superuser) {
                    var newValue = item.is_active;

                    var IdValue = item.id;

                    console.log('item23', item);

                    console.log('idvalue: ', IdValue);


                    let data = {
                        is_active: newValue,
                        id : IdValue
                    }

                    let fnSuccess = function (res){
                        if(res.success){
                            Alert.alert('', res.message);
                        }else{
                            Alert.alert('', res.message);
                        }
                    }

                    AjaxUtil.postAsyncData('/api/system/user/activate', data, fnSuccess);
                }
            });
        }

        function fetchListData() {
            let data2 = [];

            // ê²€ìƒ‰ ì¡°ê±´ ìˆ˜ì§‘
            const userGroup = document.getElementById('cboUserGroup').value;
            const name = document.getElementById('keyword').value.trim();

            // ê²€ìƒ‰ ì¡°ê±´ì„ ê°ì²´ë¡œ ì •ë¦¬
            const searchParams = {
                userGroup: userGroup,
                name: name,
            };
            console.log("ğŸ” ë³´ë‚¼ íŒŒë¼ë¯¸í„°:", searchParams);  // âœ… ì—¬ê¸°ê°€ í•µì‹¬

            // ì„œë²„ë¡œë¶€í„° ë°ì´í„°ë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ê°€ì ¸ì˜´
            $.ajax({
                url: '/api/system/user/read',
                type: 'GET',
                async: false,
                data: searchParams,
                success: function (response) {
                    console.log("API Response:", response); // ì‘ë‹µ ë°ì´í„°ë¥¼ ì¶œë ¥
                    if (response && Array.isArray(response.data)) {
                        data2 = response.data;

                    }
                },
                error: function () {
                    console.error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });

            // ìˆœë²ˆ ì¶”ê°€ ë° ìµœì†Œ í–‰ ìˆ˜ ìœ ì§€
            const minimumRows = 5;
            data2.forEach((item, index) => {
                item.rownum = index + 1; // ìˆœë²ˆ ì¶”ê°€
            });

            if (data2.length < minimumRows) {
                const additionalRows = minimumRows - data2.length;
                for (let i = 0; i < additionalRows; i++) {
                    data2.push({
                        id: '',
                        userid: '',
                        first_name:'',
                        group_id:'',
                        spjangcd:'',
                        spjangnm:'',
                        perid:'',
                        group_name:'',
                        lang_code:'',
                        is_active:'',
                        pernm:'',
                        divinm:'',
                        rspnm:'',
                        date_joined: '',
                    });
                }
            }

            // viewdataì™€ ê·¸ë¦¬ë“œ ì´ˆê¸°í™” ë° ì—…ë°ì´íŠ¸
            if (!viewdata) {
                viewdata = new wijmo.collections.CollectionView(data2);
            } else {
                viewdata.sourceCollection = data2;
                viewdata.refresh();
            }

            if (!theGrid) {
                theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    allowSorting: 'MultiColumn',
                    selectionMode: wijmo.grid.SelectionMode.Row,
                    columns: [
                        {binding: 'id', header: 'id', width: '*', align: 'center', visible: false, isReadOnly: false},
                        {binding: 'userid', header: 'ì‚¬ìš©ìID', width: '*', align: 'center', isReadOnly: true},
                        {binding: 'first_name', header: 'ì´ë¦„', width: '*', align: 'center', isReadOnly: true},
                        {binding: 'perid', header: 'ì‚¬ì›ì½”ë“œ', width: '*', align: 'center', isReadOnly: true},
                        {binding: 'divinm', header: 'ë¶€ì„œ', width: '*', align: 'center', isReadOnly: true},
                        {binding: 'rspnm', header: 'ì§ê¸‰', width: '*', align: 'center', isReadOnly: true},
                        {binding: 'group_name', header: 'ì‚¬ìš©ìê·¸ë£¹', width: '*', align: 'center', isReadOnly: true},
                        {binding: 'group_id', header: 'ì‚¬ìš©ìê·¸ë£¹', width: '*', align: 'center', visible: false},
                        {binding: 'is_active', header: 'í™œì„±í™”', width: '*', align: 'center', isReadOnly: false,},
                        {binding: 'spjangcd', header: 'ì‚¬ì—…ì²´ì½”ë“œ', width: '*', align: 'center', isReadOnly: true, visible: false},
                        {binding: 'spjangnm', header: 'ì‚¬ì—…ì²´ëª…', width: '*', align: 'center', isReadOnly: true},
                        {binding: 'date_joined', header: 'ìƒì„±ì¼', width: '*', align: 'center', isReadOnly: true},
                    ],
                    itemsSource: viewdata,
                });
                theGrid.rowHeaders.columns.splice(0, 1);
                new FlexGridContextMenu(theGrid);
            } else {
                theGrid.itemsSource = viewdata; // ê°±ì‹ ëœ CollectionViewë¡œ ì—…ë°ì´íŠ¸
                theGrid.refresh(); // ê·¸ë¦¬ë“œ ìƒˆë¡œê³ ì¹¨
            }

            // ê·¸ë¦¬ë“œ ë”ë¸” í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            let lastClickTime = 0;
            theGrid.hostElement.addEventListener('click', function (e) {
                const now = new Date().getTime();

                if (now - lastClickTime < 300) {
                    const ht = theGrid.hitTest(e);

                    if (ht.cellType === wijmo.grid.CellType.Cell) {
                        const rowData = theGrid.rows[ht.row].dataItem;
                        showUserInfo(rowData);
                    }
                }
                lastClickTime = now;
            });
        }//fetchListData

        <!-- ì´ˆë°˜ í˜ì´ì§€ ì§„ì…ì‹œ ê·¸ë¦¬ë“œ ë°”ì¸ë”© ë-->
        function showUserInfo(rowData) {
            // í•„ë“œ ì¤‘ í•˜ë‚˜ë¼ë„ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ì¶”ê°€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ì§€ ê²°ì •
            const hasMissingFields = !rowData ||!rowData.userid ;

            if (hasMissingFields) {
                // ë°ì´í„°ê°€ ë¶ˆì™„ì „í•˜ê±°ë‚˜ ë¹„ì–´ ìˆì„ ë•Œ
                if (rowData && rowData.id) {
                    // ì¶”ê°€ ë°ì´í„°ê°€ í•„ìš”í•œ ê²½ìš° AJAX ìš”ì²­ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
                    $.ajax({
                        url: '/api/system/user/detail',
                        type: 'GET',
                        data: { id: rowData.id },
                        success: function (response) {
                            if (response && response.data) {
                                populateFields(response.data); // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ í¼ ì±„ìš°ê¸°
                            } else {
                                populateFields({}); // ë°ì´í„°ê°€ ì—†ì„ ê²½ìš° ë¹ˆ í•„ë“œë¡œ ì±„ìš°ê¸°
                            }
                        },
                        error: function () {
                            console.error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                            populateFields({}); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹ˆ í•„ë“œë¡œ ì±„ìš°ê¸°
                        }
                    });
                } else {
                    // rowDataê°€ ì—†ê±°ë‚˜ IDê°€ ì—†ëŠ” ê²½ìš° ë¹ˆ í•„ë“œë¡œ ì±„ìš°ê¸°
                    populateFields({});
                }
            } else {
                // ë°ì´í„°ê°€ ì™„ì „í•œ ê²½ìš°
                populateFields(rowData);
            }
        }

        function populateFields(data) {
            // ê° í•„ë“œì— ë°ì´í„°ë¥¼ ì±„ì›€
            document.getElementById("id").value = data.id || '';
            document.getElementById("userid").value = data.userid || '';
            document.getElementById("first_name").value = data.first_name || '';
            document.getElementById("perid").value = data.perid || '';
            document.getElementById("divinm").value = data.divinm || '';
            document.getElementById("rspnm").value = data.rspnm || '';

            // authType(ì‚¬ìš©ì ê·¸ë£¹) ì„¤ì •
            document.getElementById('authType').value = data.group_id;

            // ì²´í¬ë°•ìŠ¤ ì„¤ì •
            document.getElementById("is_active").checked = data.is_active || false;

            //ì‚¬ì—…ì²´ëª…
            document.getElementById('spjType').value = data.spjangcd;

            $('#userid').prop('readonly', true);
            $('#perid').prop('readonly', true);
            $('#first_name').prop('readonly', true);
            $('#divinm').prop('readonly', true);
            $('#rspnm').prop('readonly', true);
        }

        function clearForm() {
            ['id', 'userid', 'rspnm', 'divinm', 'first_name', 'perid'].forEach(id => {
                const element = document.getElementById(id);
                if (element) { // ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ ì‹¤í–‰
                    element.value = '';
                }
            });

            // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™” (ì²´í¬ í•´ì œ)
            const isActiveCheckbox = document.getElementById('is_active');
            if (isActiveCheckbox) {
                isActiveCheckbox.checked = true;
            }

            const selectAuthType = document.getElementById('authType');
            if (selectAuthType) {
                selectAuthType.value = '35'; //ì¼ë°˜ê±°ë˜ì²˜
            }

            const selectSpjType = document.getElementById('spjType');
            if (selectSpjType) {
                selectSpjType.value = 'ZZ';
            }

            $('#userid').prop('readonly', false);
            $('#perid').prop('readonly', false);
            $('#first_name').prop('readonly', false);
            $('#divinm').prop('readonly', false);
            $('#rspnm').prop('readonly', false);

            $('.new-fl-ac').remove();
        }

        function initializeSelect2({
                                       url,               // API ì—”ë“œí¬ì¸íŠ¸ URL
                                       params = {},       // ìš”ì²­ ë§¤ê°œë³€ìˆ˜ (ê¸°ë³¸ê°’ì€ ë¹ˆ ê°ì²´)
                                       elementId,         // ì…€ë ‰íŠ¸ ìš”ì†Œì˜ ID
                                       defaultOption = "ì„ íƒí•˜ì„¸ìš”",  // ê¸°ë³¸ ì˜µì…˜ í…ìŠ¤íŠ¸
                                       valueField = "code",    // ë°ì´í„°ì˜ ê°’ í•„ë“œ ì´ë¦„
                                       textField = "value"     // ë°ì´í„°ì˜ í‘œì‹œ í•„ë“œ ì´ë¦„
                                   }) {
            $.get(url, params, function(data){
                console.log('í™•ì¸: ', data);
                let selectElement = $(`#${elementId}`);
                selectElement.empty();
                selectElement.append(`<option value="">${defaultOption}</option>`);
                // ë™ì ìœ¼ë¡œ ì˜µì…˜ ì¶”ê°€
                data.forEach(function(item) {
                    selectElement.append(`<option value="${item[valueField]}">${item[textField]}</option>`);
                });
            });
        }


        $(document).ready(function (e) {

            //ê²€ìƒ‰ ì‚¬ìš©ì ê·¸ë£¹
            initializeSelect({
                url: '/user-auth/type',
                params: {},
                elementId: 'cboUserGroup',
                valueField: "id",
                textField: "name"
            })

            initializeSelect({
                url: '/user-auth/type',
                params: {},
                elementId: 'authType',
                valueField: "id",
                textField: "name"
            })

            initializeSelect({
                url: '/user-codes/parent',
                params: {parentId: 154},
                elementId: 'agencycd',
                valueField: "id"
            })
            initializeSelect2({
                url: '/user-auth/type',
                params: {},
                elementId: 'authType',
                valueField: "id",
                textField: "name"
            })

            initializeSelect2({
                url: '/user-codes/parent',
                params: {parentId: 154},
                elementId: 'agencycd',
                valueField: "id"
            })



            $('#userid').on('input', function () {
                let userid = $(this).val();
                if (userid) {
                    checkUserId(userid);
                } else {
                    $('#userid-check-message').hide();
                }
            });

            document.querySelectorAll('.toggle-password').forEach(icon => {
                icon.addEventListener('click', () => {
                    const targetId = icon.getAttribute('data-target');
                    const inputField = document.getElementById(targetId);

                    if (inputField.type === 'password') {
                        inputField.type = 'text';
                        icon.style.backgroundImage = "url('/images/icon/btn-hidden.svg')"; // ë¹„ë°€ë²ˆí˜¸ ë³´ì„ ìƒíƒœ
                    } else {
                        inputField.type = 'password';
                        icon.style.backgroundImage = "url('/images/icon/btn-show.svg')"; // ë¹„ë°€ë²ˆí˜¸ ìˆ¨ê¹€ ìƒíƒœ
                    }
                });
            });
        });

        function checkUserId(userid) {
            $.ajax({
                url: '/api/system/user/checkUserId',
                type: 'GET',
                data: {userid: userid},
                success: function (response) {
                    if (response.exists) {
                        $('#userid-check-message').text('ì¤‘ë³µëœ ì•„ì´ë”” ì…ë‹ˆë‹¤.').show();
                    } else {
                        $('#userid-check-message').hide();
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('ì¤‘ë³µ ì²´í¬ ì˜¤ë¥˜:', textStatus, errorThrown);
                }
            });
        }

        // ì €ì¥
        $('#btnSave').click(function (e) {
            Alert.confirm('', 'ì €ì¥ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
                let formData = new FormData();

                // ì…ë ¥ í•„ë“œ ê°’ì„ formDataì— ì¶”ê°€
                formData.append("userid", $('#userid').val() || '');
                formData.append("first_name", $('#first_name').val() || '');
                formData.append("perid", $('#perid').val() || '');
                formData.append("divinm", $('#divinm').val() || '');
                formData.append("rspnm", $('#rspnm').val() || '');
                formData.append("Password", $('#PasswordChange').val() || '');
                formData.append("spjangcd", $('#spjType').val() || '');

                // ì²´í¬ë°•ìŠ¤ ê°’ ì¶”ê°€
                const isActiveCheckbox = document.getElementById("is_active");
                formData.append("is_active", isActiveCheckbox ? isActiveCheckbox.checked : false);

                // ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
                $.ajax({
                    url: '/api/system/user/save',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: { 'X-CSRF-TOKEN': csrfToken },
                    success: function (response) {
                        console.log("ì €ì¥ ì„±ê³µ:", response);
                        fetchListData(); // ëª©ë¡ ê°±ì‹ 
                        clearForm(); // í¼ ì´ˆê¸°í™”
                    },
                    error: function (xhr, status, error) {
                        console.error("ì €ì¥ ì‹¤íŒ¨:", error);
                        Alert.alert('', "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    }
                });
            });
        });

        // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        $('#btnDelete').click(function () {
            let selectedItems = theGrid.selectedItems;
            let auth = selectedItems[0].is_superuser? 'true' : 'false';

            // ìŠˆí¼ìœ ì € ê³„ì • ì—¬ë¶€ í™•ì¸
            if (auth === true) {
                Alert.alert('', 'ìŠˆí¼ìœ ì € ê³„ì •ì€ ìˆ˜ì • ë° ì‚­ì œê°€ ë¶ˆê°€í•©ë‹ˆë‹¤.');
                return false;
            }

            // ì‚­ì œí•  í•­ëª©ì´ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (selectedItems.length === 0 || selectedItems[0].id === undefined) {
                Alert.alert('', 'ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            let delList = SelectItemPush(selectedItems, 'id');
            let deltbXClientList = SelectItemPush(selectedItems, 'login_id');

            Alert.confirm('', 'ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
                // ë°ì´í„° ê°ì²´ë¥¼ URL ì¸ì½”ë”© í˜•ì‹ìœ¼ë¡œ êµ¬ì„±
                let data = {
                    'id': delList[0],         // delList ë°°ì—´ì˜ ì²« ë²ˆì§¸ í•­ëª©ë§Œ ì „ì†¡
                    'username': deltbXClientList[0], // deltbXClientList ë°°ì—´ì˜ ì²« ë²ˆì§¸ í•­ëª©ë§Œ ì „ì†¡
                    '_csrf': csrfToken,
                    'auth': auth
                };

                $.ajax({
                    url: '/api/system/user/delete',
                    type: 'POST',
                    contentType: 'application/x-www-form-urlencoded',  // URL ì¸ì½”ë”©ìœ¼ë¡œ ì „ì†¡
                    data: $.param(data),  // URL ì¸ì½”ë”© í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
                    success: function (response) {
                        console.log("ì‚­ì œ ì„±ê³µ:", response);
                        Alert.alert('', 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        fetchListData();  // ëª©ë¡ ê°±ì‹ 
                        clearForm();      // í¼ ì´ˆê¸°í™”
                    },
                    error: function (xhr, status, error) {
                        Alert.alert('', 'ì‚­ì œ ì‹¤íŒ¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        console.error("ì‚­ì œ ì‹¤íŒ¨:", xhr.responseText);
                        console.log("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒíƒœ ì½”ë“œ: " + xhr.status + "\nì˜¤ë¥˜ ë©”ì‹œì§€: " + xhr.responseText);
                        console.log(status, error);
                    }
                });
            });
        });

        // ì‚¬ì›ì½”ë“œ input í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
        document.getElementById('perid').addEventListener('click', function () {
            const input = this;

            // readonly ì†ì„±ì´ ì—†ì„ ë•Œë§Œ ì‹¤í–‰
            if (!input.hasAttribute('readonly')) {
                console.log('ğŸ“Œ ì‚¬ì›ì½”ë“œ input í´ë¦­ë¨ â†’ ì‚¬ì› ëª¨ë‹¬ ì˜¤í”ˆ');
                showPopupById('CltnmModal');
            } else {
                console.log('âš ï¸ readonly ìƒíƒœì´ë¯€ë¡œ ëª¨ë‹¬ì„ ì—´ì§€ ì•ŠìŒ');
            }
        });

        const modalDataLoaders = {
            'CltnmModal': loadEmpModalData,
        };

        function showPopupById(popupId, rowIndex = null) {
            const popup = document.getElementById(popupId);
            if (popup) {
                const modal = popup.closest('.modal');
                if (modal) {
                    modal.style.display = 'block';
                    requestAnimationFrame(() => modal.classList.add('show'));
                }
                popup.style.display = 'block';
                requestAnimationFrame(() => popup.classList.add('show'));

                // ëª¨ë‹¬ì´ ì—´ë¦¬ë©´ì„œ í•´ë‹¹ ëª¨ë‹¬ì˜ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ
                const loadDataFunction = modalDataLoaders[popupId];
                if (typeof loadDataFunction === 'function') {
                    try {
                        // rowIndexê°€ í•„ìš”í•  ê²½ìš°ì—ë§Œ ì „ë‹¬
                        if (popupId === 'OrdtextModal' && rowIndex !== null) {
                            loadDataFunction(rowIndex);
                        } else {
                            loadDataFunction();
                        }
                    } catch (error) {
                        console.error(`Error loading data for modal '${popupId}':`, error);
                    }
                } else {
                    console.log(`No data load function defined for modal with ID: ${popupId}`);
                }

                console.log(`Showing modal with ID: ${popupId}`);
            } else {
                console.warn(`Popup with ID '${popupId}' not found.`);
            }
        }
        function loadEmpModalData() {
            let data = [];

            // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            $.ajax({
                url: '/api/system/user/read2',
                type: 'GET',
                async: false,
                success: function (response) {
                    console.log("ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°:", response);
                    if (response && Array.isArray(response.data)) {
                        data = response.data.map((item, index) => ({
                            userid:  item.userid || '',
                            perid: item.perid || '' ,
                            rnum: item.rnum || '',
                            pernm: item.pernm || '',
                            useyn: item.useyn || '',
                            rspnm : item.rspnm ||'',
                            rspnm : item.rspnm || '',
                            divinm : item.divinm || ''
                        }));
                    }
                },
                error: function () {
                    console.error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });

            // ë°ì´í„°ê°€ ë¹„ì–´ ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì¶”ê°€ (ê·¸ë¦¬ë“œê°€ ê¹¨ì§€ì§€ ì•Šë„ë¡)
            for (let i = data.length; i < 15; i++) {
                data.push({
                    userid:  '',
                    perid:'',
                    rnum:'',
                    pernm:'',
                    useyn:'',
                    rspnm : '',
                    divinm:''
                });
            }

            const viewdata = new wijmo.collections.CollectionView(data);

            if (!modalGrid) {
                modalGrid = new wijmo.grid.FlexGrid('#modalGrid', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    isReadOnly: true,
                    columns: [
                        {binding: 'userid', header: 'ì•„ì´ë””', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'perid', header: 'ì‚¬ì›ì½”ë“œ', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'rnum', header: 'rnum', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'pernm', header: 'ì´ë¦„', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'useyn', header: 'ì‚¬ìš©ì—¬ë¶€', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'divinm', header: 'ë¶€ì„œëª…', width: '*', minWidth: 100, align: 'center'},
                        {binding: 'rspnm', header: 'ì§ê¸‰', width: '*', minWidth: 100, align: 'center'},
                    ],
                    itemsSource: viewdata,
                });
                modalGrid.rowHeaders.columns.splice(0, 1);
                attachDoubleClickEvent(modalGrid); //ë”ë¸” í´ë¦­ ì´ë²¤íŠ¸
                new FlexGridContextMenu(modalGrid);
                window.downloadFileName = 'ì‚¬ì› ì •ë³´';
            } else {
                modalGrid.itemsSource = viewdata;
            }
        }

        function attachDoubleClickEvent(grid) {
            let lastClickTime = 0;
            grid.hostElement.addEventListener('click', function (e) {
                const now = new Date().getTime();

                if (now - lastClickTime < 300) { // 300ms ì´ë‚´ í´ë¦­ -> ë”ë¸”í´ë¦­ ì²˜ë¦¬
                    const ht = grid.hitTest(e);
                    if (ht.cellType === wijmo.grid.CellType.Cell) {
                        const clickedItem = modalGrid.rows[ht.row].dataItem;

                        if (clickedItem && clickedItem.perid) { // í´ë¦­ëœ í–‰ì— 'perid' ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
                            $('#perid').val(clickedItem.perid);
                            $('#userid').val(clickedItem.userid);
                            $('#divinm').val(clickedItem.divinm);
                            $('#rspnm').val(clickedItem.rspnm);
                            $('#first_name').val(clickedItem.pernm);
                            $('#is_active').prop('checked', clickedItem.useyn === '1');

                        }
                        $('#userid').prop('readonly', true);
                        $('#perid').prop('readonly', true);
                        $('#first_name').prop('readonly', true);
                        $('#divinm').prop('readonly', true);
                        $('#rspnm').prop('readonly', true);
                        closePopup('CltnmModal'); // ëª¨ë‹¬ ì°½ ë‹«ê¸°
                    }
                }
                lastClickTime = now;
            });
        }

        function closePopup(popupId) {
            const popup = document.getElementById(popupId);
            if (popup) {
                const modal = popup.closest('.modal');
                if (modal) {
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                }
                popup.style.display = 'none';
                popup.classList.remove('show');
                console.log(`Closing modal with ID: ${popupId}`);
            }
        }


    </script>
</th:block>
</html>