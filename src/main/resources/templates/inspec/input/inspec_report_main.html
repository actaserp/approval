<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>

</style>
<th:block layout:fragment="content">

    <!--<a><img src="/images/icon/ico-userdetail.svg" alt="알람 아이콘"></a>-->
    <div class="layout-contents" style="margin-bottom: 50px">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>순회점검 현황</h2><a id="toggleButton" onclick="toggleSearchWrap()"><img src="/images/icon/ico-down.png" alt="알람 아이콘"></a>
                <a title="북마크" class="bookmark toggle">
                    내메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>점검 관리</li>
                <li>순회점검 현황</li>
            </ul>
        </div>
        <!-- Search -->
        <div class="search-wrap" id="searchWrap" style="display: none">
            <ul>
                <li>
                    <select title="지역" id="spworkcd" name="spworkcd"
                            onchange="updateCompcdOptions(); saveSelectedSandanData(); ">
                        <!-- 지역 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spworknm" name="spworknm">
                </li>
                <li>
                    <select title="산단" id="spcompcd" name="spcompcd"
                            onchange="updatePlancdOptions(); saveSelectedSandanData();">
                        <!-- 산단 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spcompnm" name="spcompnm">
                </li>
                <li>
                    <select title="시설" id="spplancd" name="spplancd" onchange="updatePlannm(); saveSelectedSandanData()">
                        <!-- 시설 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spplannm" name="spplannm">
                </li>
            </ul>
        </div>
        <div class="row row-1">
            <section class="wp50" style="height: 830px">
                <div class="title-wrap">
                    <h3>점검캘린더</h3>
                    <div class="btn-wrap">
                    </div>
                </div>
                <div class="calendar-wrap">
                    <div id="calendar"></div>
                </div>
            </section>
            <div class="col wp30 mg-r24">
                <!-- Section -->
                <section style="margin-bottom: 5px">
                    <div class="title-wrap">
                        <h3 id="StatusTitle"></h3>
                        <div class="btn-wrap">
                        </div>
                    </div>
                    <div class="status-inspect">
                        <dl>
                            <dt>등록</dt>
                            <dd id="totalCount">1</dd>
                        </dl>
                        <dl>
                            <dt>결제</dt>
                            <dd id="yCount">3</dd>
                        </dl>
                        <dl>
                            <dt>미결제</dt>
                            <dd id="nCount">1</dd>
                        </dl>
                    </div>
                </section>
                <!-- Section -->
                <section style="margin-bottom: 5px">
                    <div class="title-wrap">
                        <h3 id="InspectionDetails">점검내역</h3>
                        <div class="btn-wrap">
                        </div>
                    </div>

                        <div class="container-fluid">
                            <p id="selectedItem"></p>
                            <div id="theGrid" style="height: 200px; width: 440px"></div>
                        </div>

                    <!--<div class="table-wrap h200">
                        <table class="list-table">
                            <caption>점검내역 테이블</caption>
                            <colgroup>
                                <col class="wp33">
                                <col class="wp33">
                                <col class="wp33">
                            </colgroup>
                            <thead>
                            <tr>
                                <th>점검일자</th>
                                <th>점검시간</th>
                                <th>점검자</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>순회</td>
                                <td>대구물류</td>
                                <td>홍길동</td>
                            </tr>
                            <tr>
                                <td>순회</td>
                                <td>대구물류</td>
                                <td>홍길동</td>
                            </tr>
                            <tr>
                                <td>순회</td>
                                <td>대구물류</td>
                                <td>홍길동</td>
                            </tr>
                            <tr>
                                <td>순회</td>
                                <td>대구물류</td>
                                <td>홍길동</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>-->
                </section>
                <!-- Section -->
                <section>
                    <div class="title-wrap">
                        <h3>현장 실시간 CCTV</h3>
                        <div class="btn-wrap">

                        </div>
                    </div>
                    <div class="thumb-wrap">
                        <!--<div>
                            <img src="/images/sample/sample-cctv.svg" alt="cctv sample" class="wp105">
                        </div>
                        <div>
                            <img src="/images/sample/sample-cctv.svg" alt="cctv sample" class="wp105">
                        </div>-->
                        <!--<canvas style="width: 300px;"></canvas>-->

                        <div class="section">
                            <input type="radio" name="slide" id="slide01" checked>
                            <input type="radio" name="slide" id="slide02">
                            <input type="radio" name="slide" id="slide03">
                            <input type="radio" name="slide" id="slide04">
                            <div class="slidewrap">
                                <ul class="slidelist">
                                    <li>

                                        <a>
                                            <!--<img src="/images/sample/sample-cctv.svg" style="width: 100%">-->
                                            <!--<canvas id="canvas1" style="width: 100%; height: 360px"></canvas>-->
                                            <video id="video" class="video-js vjs-default-skin" width="440" height="248" controls autoplay></video>
                                        </a>
                                    </li>
                                    <li>
                                        <a>
                                            <!-- 두 번째 CCTV 스트림 -->
                                            <!--<canvas id="canvas2" style="width: 300px;"></canvas>-->
                                            <!--<canvas id="canvas2" style="width: 100%; height: 360px;"></canvas>-->
                                            <video id="video2" class="video-js vjs-default-skin" width="440" height="248" controls autoplay></video>
                                        </a>
                                    </li>
                                    <li>
                                        <a>
                                            <!--<canvas id="canvas3" style="width: 100%; height: 360px;"></canvas>-->
                                            <video id="video3" class="video-js vjs-default-skin" width="440" height="248" controls autoplay></video>
                                        </a>
                                    </li>
                                    <li>
                                        <a>
                                            <!--<canvas id="canvas4" style="width: 100%; height: 360px;"></canvas>-->
                                            <video id="video4" class="video-js vjs-default-skin" width="440" height="248" controls autoplay></video>
                                        </a>
                                    </li>
                                </ul>

                                <div class="slide-control">
                                    <div class="control01">
                                        <label for="slide04" class="left"></label>
                                        <label for="slide02" class="right"></label>
                                    </div>
                                    <div class="control02">
                                        <label for="slide01" class="left"></label>
                                        <label for="slide03" class="right"></label>
                                    </div>
                                    <div class="control03">
                                        <label for="slide02" class="left"></label>
                                        <label for="slide04" class="right"></label>
                                    </div>
                                    <div class="control04">
                                        <label for="slide03" class="left"></label>
                                        <label for="slide01" class="right"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <section class="wp25" style="height: 830px">
                <div class="title-wrap">
                    <h3 id="MonthInpsecTitle"></h3>
                    <div class="btn-wrap">
                        <a title="더보기" class="btn-plus"></a>
                    </div>
                </div>
                <div class="table-wrap">

                    <div class="container-fluid">
                        <div id="theGrid2"></div>
                    </div>
                    <!--<table class="list-table">
                        <caption>당일 점검일지 현황 테이블</caption>
                        <colgroup>
                            <col class="wp33">
                            <col class="wp33">
                            <col class="wp33">
                        </colgroup>
                        <thead>
                        <tr>
                            <th>점검일자</th>
                            <th>점검시간</th>
                            <th>상태정보</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>2024.07.08</td>
                            <td>13:00~15:00</td>
                            <td>등록</td>
                        </tr>
                        <tr>
                            <td>2024.07.08</td>
                            <td>13:00~15:00</td>
                            <td>등록</td>
                        </tr>
                        <tr>
                            <td>2024.07.08</td>
                            <td>13:00~15:00</td>
                            <td>등록</td>
                        </tr>
                        <tr>
                            <td>2024.07.08</td>
                            <td>13:00~15:00</td>
                            <td>결재완료</td>
                        </tr>
                        <tr>
                            <td>2024.07.08</td>
                            <td>13:00~15:00</td>
                            <td>등록</td>
                        </tr>
                        <tr>
                            <td>2024.07.08</td>
                            <td>13:00~15:00</td>
                            <td>결재완료</td>
                        </tr>
                        <tr>
                            <td>2024.07.08</td>
                            <td>13:00~15:00</td>
                            <td>결재완료</td>
                        </tr>
                        <tr>
                            <td>2024.07.08</td>
                            <td>13:00~15:00</td>
                            <td>결재완료</td>
                        </tr>
                        <tr>
                            <td>2024.07.08</td>
                            <td>13:00~15:00</td>
                            <td>결재완료</td>
                        </tr>
                        <tr>
                            <td>2024.07.08</td>
                            <td>13:00~15:00</td>
                            <td>등록</td>
                        </tr>
                        <tr>
                            <td>2024.07.08</td>
                            <td>13:00~15:00</td>
                            <td>등록</td>
                        </tr>
                        <tr>
                            <td>2024.07.08</td>
                            <td>13:00~15:00</td>
                            <td>등록</td>
                        </tr>
                        <tr>
                            <td>2024.07.08</td>
                            <td>13:00~15:00</td>
                            <td>등록</td>
                        </tr>
                        </tbody>
                    </table>-->
                </div>
            </section>
        </div>
    </div> <!--//layout-contents end -->
    <footer>
        <p>Copyrightⓒ 0000 corp. All rights reserved.</p>
    </footer>


    <script>

        var player = videojs('video', {
            autoplay: true,
            controls: true,
            muted: true,  // 비디오를 무음으로 설정
            preload: 'auto'
        });
        player.src({
            src: 'http://121.78.112.192:9000/hls/stream1.m3u8',
            type: 'application/x-mpegURL'
        });

        var player2 = videojs('video2', {
            autoplay: true,
            controls: true,
            muted: true,  // 비디오를 무음으로 설정
            preload: 'auto'
        });
        player2.src({
            src: 'http://121.78.112.192:9000/hls/streaming1.m3u8',
            type: 'application/x-mpegURL'
        });

        var player3 = videojs('video3', {
            autoplay: true,
            controls: true,
            muted: true,  // 비디오를 무음으로 설정
            preload: 'auto'
        });
        player3.src({
            src: 'http://121.78.112.192:9000/hls/streamer.m3u8',
            type: 'application/x-mpegURL'
        });

        var player4 = videojs('video4', {
            autoplay: true,
            controls: true,
            muted: true,  // 비디오를 무음으로 설정
            preload: 'auto'
        });
        player4.src({
            src: 'http://121.78.112.192:9000/hls/streamute.m3u8',
            type: 'application/x-mpegURL'
        });

       /* // WebSocket 연결 설정
        var client = new WebSocket('ws://localhost:9999');
        var canvas = document.querySelector('canvas');
        var player = new jsmpeg(client, {
            canvas: canvas
        });

        // 두 번째 WebSocket 연결
        var client2 = new WebSocket('ws://localhost:10000');
        var canvas2 = document.getElementById('canvas2');
        var player2 = new jsmpeg(client2, {
            canvas: canvas2
        });

        // 두 번째 WebSocket 연결
        var client3 = new WebSocket('ws://localhost:10001');
        var canvas3 = document.getElementById('canvas3');
        var player3 = new jsmpeg(client3, {
            canvas: canvas3
        });

        // 두 번째 WebSocket 연결
        var client4 = new WebSocket('ws://localhost:10002');
        var canvas4 = document.getElementById('canvas4');
        var player4 = new jsmpeg(client4, {
            canvas: canvas4
        });*/


        let theGrid;
        let theGrid2;


        let columns = [
            { binding: 'inspectypeCode', header: '점검구분', visible: false },
            { binding: 'inspectype', header: '점검구분', width: '0.5*', minWidth: 150, align: 'center' },
            { binding: 'inspecarea', header: '점검장소', width: '0.5*', minWidth: 150, align: 'center' },
            { binding: 'checkusr', header: '점검자', width: '*',minWidth: 150, align: 'center' },
            { binding: 'checkdt', header: '점검자', width: '*',minWidth: 150, align: 'center' },

        ]
        let columns2 = [
            { binding: 'inspectypeCode', header: '점검구분', visible: false },
            { binding: 'checkdt', header: '점거일자', width: '0.5*', minWidth: 150, align: 'center' },
            { binding: 'inspectype', header: '점검구분', width: '*', minWidth: 150, align: 'center' },
            { binding: 'inspecarea', header: '점검장소', width: '*', minWidth: 150, align: 'center' },
            { binding: 'checkhour', header: '점검시간', width: '*', minWidth: 150, align: 'center' },

        ]

        function BlankOpen(dicType, checkdt) {

            // 절대 경로 URL
            var url = `/gui/${dicType}/default?hideBookmark=true&checkdt=${checkdt}`;

            // 팝업 옵션 설정
            var options = "width=1400,height=700,scrollbars=yes,resizable=yes";

            // 새 창 열기
            var newWindow = window.open(url, "_blank", options);

            // 새 창이 로드되면 북마크 버튼을 숨기기 위한 스타일 추가
            newWindow.addEventListener('load', function () {
                // 북마크를 숨길지 여부를 URL의 파라미터로부터 확인
                var urlParams = new URLSearchParams(newWindow.location.search);
                if (urlParams.get('hideBookmark') === 'true') {
                    var style = newWindow.document.createElement('style');
                    style.innerHTML = '.bookmark.toggle { display: none; }';
                    newWindow.document.head.appendChild(style);
                }
            });
        }

        function init(date){
            let data2 = [];
            $.ajax({
                url: '/api/reportEvents/read',
                type: 'GET',
                data: { date: date },
                async: false,
                success: function (data) {
                    let DataLength = 10 - data.data.length;

                    if(data.data.length < 10){
                        for(let i=0; i < DataLength; i++){
                            data.data.push('empty');
                        }
                    }
                    data2 = data.data;
                }
            })

            viewdata = new wijmo.collections.CollectionView(data2);
            // 데이터 그리드에 바인딩

            if(!theGrid) {
                theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                    autoGenerateColumns: false,
                    isReadOnly: true,
                    showMarquee: true,
                    allowSorting: 'MultiColumn',
                    columns: columns,  //홀짝 로우 음영주기
                    selectionMode: wijmo.grid.SelectionMode.Row, // 행 단위 선택
                    itemsSource: viewdata,

                });
                //맨 앞에 헤더부분 없애기
                theGrid.rowHeaders.columns.splice(0, 1);

                // 더블클릭 이벤트 추가
                theGrid.hostElement.addEventListener('dblclick', function(e) {
                    let hitTest = theGrid.hitTest(e);
                    if (hitTest.cellType === wijmo.grid.CellType.Cell) {
                        let row = hitTest.row;
                        let item = theGrid.rows[row].dataItem;

                        BlankOpen(item.inspectypecode, item.checkdt);
                    }
                });


            } else {
                theGrid.itemsSource = viewdata;
            }

        }

        function init2(date){

            let data2 = [];
            $.ajax({
                url: '/api/reportEvents/MonthAllRead',
                type: 'GET',
                data: { date: date },
                async: false,
                success: function (data) {
                    let DataLength = 15 - data.data.length;

                    if(data.data.length < 15){
                        for(let i=0; i < DataLength; i++){
                            data.data.push('empty');
                        }
                    }
                    data2 = data.data;
                }
            })

            viewdata2 = new wijmo.collections.CollectionView(data2);
            // 데이터 그리드에 바인딩

            if(!theGrid2) {
                theGrid2 = new wijmo.grid.FlexGrid('#theGrid2', {
                    autoGenerateColumns: false,
                    isReadOnly: true,
                    showMarquee: true,
                    allowSorting: 'MultiColumn',
                    columns: columns2,  //홀짝 로우 음영주기
                    selectionMode: wijmo.grid.SelectionMode.Row, // 행 단위 선택
                    itemsSource: viewdata2,

                });

                theGrid2.rowHeaders.columns.splice(0, 1);  //맨 앞에 헤더부분 없애기

                // 더블클릭 이벤트 추가
                theGrid2.hostElement.addEventListener('dblclick', function(e) {
                    let hitTest = theGrid2.hitTest(e);
                    if (hitTest.cellType === wijmo.grid.CellType.Cell) {
                        let row = hitTest.row;
                        let item = theGrid2.rows[row].dataItem;

                        BlankOpen(item.inspectypecode, item.checkdt);
                    }
                });
            } else {
                theGrid2.itemsSource = viewdata2;
            }

        }

        document.addEventListener('DOMContentLoaded', function () {

            initializeSelections();

            init(getDateYYYYMMDD().replaceAll("-",""));  //TODO: 고치셈 ㅋ
            init2(getDateYYYYMMDD());


            const today = new Date();
            const specificMonth = getMonth(today);

            $('#StatusTitle').text(specificMonth + '월 순회점검현황');
            $('#MonthInpsecTitle').text(specificMonth + '월 점검현황');


            let fnsuccess = function(res){

                $('#totalCount').text(res.data[0].total_count ? res.data[0].total_count : '0');
                $('#yCount').text(res.data[0].flag_y_count ? res.data[0].flag_y_count : '0');
                $('#nCount').text(res.data[0].flag_n_count ? res.data[0].flag_n_count : '0');



            };
            let fnfailure = function(res){
                Alert.alert('', '서버통신실패');

            };

            var calendarEl = document.getElementById('calendar');

            // 서버에서 데이터를 가져옴
            fetch('/api/reportEvents/Calendar')
                .then(response => response.json())
                .then(data => {

                    let events=  [];

                    data.data.forEach(function(item, index){
                        events.push({
                            title: item.inspection_type + '(' + item.count + ')',
                            start: item.checkdt,
                            /*extendedProps: {
                                message: '',
                                action: function(){

                                }
                            }*/
                        });
                    });

                    // FullCalendar 설정
                    var calendar = new FullCalendar.Calendar(calendarEl, {
                        locale: 'ko',  // 한국어 로케일 설정
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,timeGridDay'
                        },
                        initialView: 'dayGridMonth',
                        height: 720,
                        dayHeaderFormat: {weekday: 'short'}, // 요일 형식 설정
                        events: events,
                        views: {
                            dayGridMonth: {
                                dayCellContent: function (arg) {
                                    // '일' 텍스트 제거
                                    return arg.dayNumberText.replace('일', '');
                                }
                            }
                        },
                        /*eventClick: function(info) {
                            // 이벤트 클릭 시 alert 창 띄우기
                            if(typeof info.event.extendedProps.action === 'function'){
                                info.event.extendedProps.action();
                            } else {
                                console.log('5일이나 안녕하세요 클릭한듯 ㅋ');
                            }
                        },*/
                        datesSet: function(dateInfo){
                            let currentDate = calendar.getDate();
                            let currentYear = currentDate.getFullYear();
                            let currentMonth = currentDate.getMonth() + 1;




                            $('#StatusTitle').text(currentMonth + '월 순회점검 현황');

                            let data = { year: currentYear, month: currentMonth }

                            AjaxUtil.getAsyncData('/api/reportEvents/Inspection/status', data, fnsuccess, fnfailure);

                            $('#MonthInpsecTitle').text(currentMonth + '월 점검현황');

                            let monthString = '';

                            if(currentMonth.toString().length < 2){
                                monthString = '0' + currentMonth.toString();
                            }else{
                                monthString = currentMonth.toString();
                            }

                            init2(currentYear.toString() + monthString + "15");



                        },
                        dateClick: function(info) {

                            document.querySelectorAll('.fc-daygrid-day').forEach(function(cell) {
                                cell.classList.remove('selected-date');
                            });

                            // 클릭한 날짜 셀에 'selected-date' 클래스 추가
                            info.dayEl.classList.add('selected-date');
                            let date = info.dateStr;

                            $('#InspectionDetails').text(date.substring(8,10) + '일 점검현황');

                            init(date.replaceAll('-',''));
                        }
                    });

                    calendar.render();
                })
                .catch(error => console.error('Error fetching events:', error));
        });

    </script>

</th:block>

</html>