<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>

</style>

<th:block layout:fragment="content">


    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>사용자그룹</h2>
                <a title="북마크" class="bookmark toggle">
                    내메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>시스템설정</li>
                <li>사용자정보</li>
            </ul>
        </div>
        <!-- Select -->

        <div class="tab-wrap">
            <ul class="tab-links">
                <li>
                    <a href="#tab1" title="목록" id="listTabLink">목록</a>
                </li>
                <li>
                    <a href="#tab2" title="등록" id="inputTabLink">등록</a>
                </li>
            </ul>
            <div class="tab-contents">
                <!-- Section -->
                <section class="tab-item" id="tab1">
                    <div class="section-top" style="float: right">
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a  class="btn btn-edit" title="수정" onclick="modifyData()">
                                        <img src="/images/icon/ico-edit.svg" alt="엑셀 아이콘">
                                        수정
                                    </a>
                                </li>
                                <li>
                                    <a  class="btn btn-delete" title="삭제" id="btnDelete">
                                        <img src="/images/icon/ico-delete.svg" alt="엑셀 아이콘">
                                        삭제
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div> <!--//section-top end -->
                    <div class="container-fluid">
                        <p id="selectedItem"></p>
                        <div id="theGrid" style=" height: 500px"></div>
                    </div>
                </section>
                <!-- Section -->
                <section class="tab-item" id="tab2">
                    <div class="section-top">
                        <div class="title-wrap">
                            <h3>사용자 등록</h3>
                        </div>
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a class="btn btn-excell" title="엑셀다운로드" onclick="clearForm()">
                                        <img src="/images/icon/ico-plus.svg" alt="등록 아이콘">
                                        신규등록
                                    </a>
                                </li>
                                <li>
                                    <a class="btn btn-edit" id="btnSave" title="저장">
                                        <img src="/images/icon/ico-save.svg" alt="저장 아이콘">
                                        저장
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table class="write-table">
                            <caption>점검등록 테이블</caption>
                            <colgroup>
                                <col class="wp12">
                                <col class="wp40">
                                <col class="wp12">
                                <col class="wp40">
                            </colgroup>
                            <tbody>
                            <tr>
                                <th>
                                    <label for="code">
                                        코드
                                    </label>
                                </th>
                                <td>
                                    <input type="text" id="code" name="code" class="wp100" maxlength="30" placeholder="코드">
                                    <input type="hidden" id="id" name="id" class="wp100" maxlength="30" placeholder="id">
                                </td>
                                <th>
                                    <label for="name">
                                        그룹명
                                    </label>
                                </th>
                                <td>
                                    <input type="text" id="name" name="name" class="wp100" maxlength="50" placeholder="그룹명">
                                </td>

                            </tr>
                            <tr>
                                <th>
                                    설명
                                </th>
                                <td>
                                    <input type="text" id="description" name="description" maxlength="100" class="wp100" placeholder="설명">
                                </td>
                                <th>
                                    <label for="name">
                                        기본화면
                                    </label>
                                </th>
                                <td>
                                    <select class="mg-r5" id="gmenu" name="gmenu" style="width: 100%">
                                        <option></option>
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                        </table>
                    </div>
                </section>
            </div> <!--//tab-contens end-->
        </div> <!--//tab-wrap end-->
    </div> <!--//layout-contents end -->




</th:block>
<th:block layout:fragment="scripts">
    <th:block th:replace="/common/approve_box :: approve_box"></th:block>
    <th:block th:replace="/common/ax5_uploader :: ax5_uploader" ></th:block>
    <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box" ></th:block>
    <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>

    <script type="text/javascript">

        var theGrid;
        var viewdata;
        let selectedFiles = [];
        let SelectItem;
        let csrfToken = $("[name=_csrf]").val();

        document.readyState === 'complete' ? init() : window.onload = init;


        let columns = [
            { binding: 'id', header: 'id', width: '*', align: 'center', visible: false },
            { binding: 'code', header: '코드', width: '*', align: 'center' },
            { binding: 'name', header: '그룹명', width: '*', align: 'center' },
            { binding: 'description', header: '설명', width: '*', align: 'center' },
            { binding: 'gmenu', header: 'Dashboard', width: '*', align: 'center' },
        ]

        <!-- 초반 페이지 진입시 그리드 바인딩 끝-->
        function init() {
            let data2 = [];


            $.ajax({
                url: '/api/system/usergroup/read',
                type: 'GET',
                data: {

                },
                async: false,
                success: function(data){
                    let DataLength = 10 - data.data.length;

                    if(data.data.length < 10){
                        for(let i=0; i < DataLength; i++){
                            data.data.push('empty');
                        }
                    }
                    data2 = data.data;
                }
            })

            viewdata = new wijmo.collections.CollectionView(data2);
            // 데이터 그리드에 바인딩
            theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                autoGenerateColumns: false,
                showMarquee: true,
                isReadOnly: true,
                columns: columns,  //홀짝 로우 음영주기
                itemsSource: viewdata
            });
            let selector = new wijmo.grid.selector.Selector(theGrid, {
                itemChecked: (e, ctx) => {
                    SelectItem = theGrid.rows.filter(r => r.isSelected);

                }
            })

            // 선택이 변경될 때, 현재 항목 업데이트
        }
        <!-- 초반 페이지 진입시 그리드 바인딩 끝-->


        function searchData(){

            let result =  AjaxUtil.getSyncData('/api/system/usergroup/read', {});

            if(result.success){
                console.log(result.data);

                let DataLength = 10 - result.data.length;

                if(result.data.length < 10){
                    for(let i=0; i < DataLength; i++){
                        result.data.push('empty');
                    }
                }
                grid_binding(result.data);
            }
        }

        function grid_binding(data){
            var inspecDto = data;
            var inspecData = [];
            var cnt = 1;
            for (let i = 0; i < inspecDto.length; i++) {
                inspecData.push({
                    id: inspecDto[i]["id"],
                    code: inspecDto[i]["code"],
                    name: inspecDto[i]["name"],
                    description: inspecDto[i]["description"],
                    gmenu: inspecDto[i]["gmenu"]
                });
                cnt++;
            }

            theGrid.columns.clear();
            theGrid.autoGenerateColumns = false;
            viewdata.sourceCollection = inspecData;


            for (let i = 0; i < columns.length; i++) {
                let col = new wijmo.grid.Column(columns[i]);
                theGrid.columns.push(col);
            }
            SelectItem = undefined;
        }


        function clearForm(){
            ['id', 'code', 'name', 'description', 'gmenu'].forEach(id => {
                document.getElementById(id).value = '';
            });

            updateTabLink('id');
        }

        //수정
        function modifyData(){
            if(SelectItem === undefined || SelectItem.length === 0){
                Alert.alert('', '수정할 항목을 선택하세요.');
                return;
            }else if(SelectItem.length > 1){
                Alert.alert('', '하나의 항목만 선택해주세요');
                return;
            }
            let selectedItem = SelectItem[0];

            let id = selectedItem._data.id;

            Alert.confirm('', '수정하시겠습니까?', function(){
                if(!selectedItem._data.id){
                    Alert.alert('', '수정할 게시물이 없습니다.',);
                    return false;
                }
                let jsonId = JSON.stringify(id);

                $('#inputTabLink').click();

                document.getElementById('code').value = selectedItem._data.code;
                document.getElementById('name').value = selectedItem._data.name;
                document.getElementById('id').value = selectedItem._data.id;
                document.getElementById('description').value = selectedItem._data.description;
                document.getElementById('gmenu').value = selectedItem._data.gmenu;

                updateTabLink('id');

            })

        }

       $(document).ready(function (e) {

        initializeSelect({ url: '/api/system/usergroup/defaultMenu', params: {}, elementId: 'gmenu', valueField: "menuCode", textField: "menuName" });



        $('#btnSave').click(function(){

            Alert.confirm('', '저장하시겠습니까?', function(){

                const id = $('#id').val().trim();
                const code = $('#code').val().trim();
                const name = $('#name').val().trim();
                const description = $('#description').val().trim();
                const gmenu = $('#gmenu').val();

                if(!code){
                    Alert.alert('', '코드를 입력해주세요.');
                    $('#code').focus();
                    return;
                }
                if(!name){
                    Alert.alert('', '그룹명을 입력해주세요.');
                    $('#name').focus();
                    return;
                }
                if(!gmenu){
                    Alert.alert('', '기본화면 설정을 해주세요.');
                    $('#gmenu').focus();
                    return;
                }
                const data = { code: code, name: name, description: description, id: id, gmenu: gmenu };
                const fnSuccess = function (res) {
                    Alert.alert('', res.message);
                    $('#listTabLink').click();
                    searchData();
                    clearForm();
                };
                AjaxUtil.postAsyncData("/api/system/usergroup/save", data, fnSuccess, function(){
                    Alert.alert('', '서버통신실패');
                })
            })
        })

        //삭제
        $('#btnDelete').click(function(){

            if(SelectItem === undefined || SelectItem.length === 0){
                Alert.alert('', '삭제할 항목을 선택하세요.');
                return;
            }


            let delList = [];

            delList = SelectItemPush(SelectItem, '_data.id');
            Alert.confirm('', '삭제하시겠습니까?', function () {
                let data = {
                    'id': JSON.stringify(delList),
                    '_csrf': csrfToken
                }
                let fnSuccess = function (res) {
                    if (res.success) {
                        Alert.alert('', '삭제되었습니다.');
                        searchData();
                    }
                }
                AjaxUtil.postAsyncData('/api/system/usergroup/delete', data, fnSuccess);
            })
        })

        });
    </script>
</th:block>
</html>