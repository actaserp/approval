<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>
    #theGrid {
        width: 100%;
        height: 400px;
        overflow: auto; /* ìŠ¤í¬ë¡¤ í™œì„±í™” */
    }

    .wj-flexgrid .wj-header {
        position: sticky;
        top: 0;
        z-index: 10;
        overflow: auto;
    }

</style>
<th:block layout:fragment="content">
  <div class="layout-contents">
    <!-- Page Title -->
    <div class="page-title-wrap">
      <div class="left">
        <h2>ê²°ì¬ ë‚´ì—­</h2><a id="toggleButton" onclick="toggleSearchWrap()"><img src="/images/icon/ico-down.png" alt="ì•ŒëŒ ì•„ì´ì½˜"></a>
        <!--<a title="ë¶ë§ˆí¬" class="bookmark toggle">
            ë‚´ë©”ë‰´
        </a>-->
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>ê²°ì¬ëª©ë¡</li>
        <li>ê²°ì¬ë‚´ì—­</li>
      </ul>
    </div>
    <!-- Select -->
    <div class="search-wrap" id="searchWrap" style="display: none; padding-top:10px">
      <ul>
        <li>
          <select title="ì‚¬ì—…ì¥ì½”ë“œ" id="search_spjangcd" name="search_sjangcd"
                  onchange="init()">
            <option value="" hidden selected disabled>ì„ íƒ</option>
            <option value="ZZ">ëŒ€í•œëŸ­ë¹„í˜‘íšŒ</option>
            <option value="PP"></option>
            <!-- ì§€ì—­ ì˜µì…˜ì„ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì±„ì›€ -->
          </select>
        </li>
      </ul>
    </div>
    <div class="tab-contents">
      <section class="tab-item" id="tab2" style="height: 830px; overflow: hidden;">
        <div class="section-top">
          <div class="search-wrap">
            <dl>
              <dt>
                <label for="searchUserNm">
                  ì‘ì„±ì¼ì<span class="eq">*</span>
                </label>
              </dt>
              <dd>
                <ul class="date-box">
                  <li>
                    <input type="date" id="startDate" name="startDate">
                    <label for="startDate" class="hide">ì‹œì‘ì¼</label>
                  </li>
                  <li>
                    <input type="date" id="endDate" name="endDate">
                    <label for="endDate" class="hide">ì¢…ë£Œì¼</label>
                  </li>
                </ul>
              </dd>
            </dl>
            <dl>
              <dt>
                <label for="SearchPayment">
                  ì§„í–‰êµ¬ë¶„<span class="eq"></span>
                </label>
              </dt>
              <dd>
                <div class="srch-box">
                  <select id="SearchPayment" name="SearchPayment">
                    <option value="all"></option>
                  </select>
                </div>
              </dd>
            </dl>
            <dl>
              <dt>
                <label for="searchUserNm">
                  ì œëª©<span class="eq">*</span>
                </label>
              </dt>
              <dd>
                <div class="srch-box">
                  <input type="text" id="searchUserNm" name="searchUserNm" class="input-srch"
                         placeholder="ì œëª©" style="border-radius: 5px;">
                </div>
              </dd>
            </dl>
            <dl>
              <dt>&nbsp;</dt>
              <dd>
                <li>
                  <a class="btn btn-delete" title="ê²€ìƒ‰" id="searchButton1" onclick="fetchListData()">
                    <img src="/images/icon/btn-srch.svg" alt="ê²€ìƒ‰ ì•„ì´ì½˜">
                    ê²€ìƒ‰
                  </a>
                </li>
              </dd>
            </dl>
          </div>
         <!-- <div class="button-wrap" style="border-top:none;">
            <ul>
              <li>
                <a class="btn btn-excell" title="ì‹ ê·œë“±ë¡" id="Newbtn" onclick="NewSave()">
                  <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜">
                  ì‹ ê·œë“±ë¡
                </a>
              </li>
              <li>
                <a class="btn btn-delete" title="ì‚­ì œ" id="btnDelete" onclick="deleteData()">
                  <img src="/images/icon/ico-delete.svg" alt="ì—‘ì…€ ì•„ì´ì½˜">
                  ì‚­ì œ
                </a>
              </li>
            </ul>
          </div>-->
        </div>

        <div class="container-fluid">
          <p id="selectedItem"></p>
          <div id="theGrid1" style="max-height:200px"></div>
          <div id="theGrid" style="max-height: 570px"></div>
        </div>
      </section>
    </div> <!--//tab-wrap end-->
  </div> <!--//layout-contents end -->
  <footer>
    <p>â“’ factCheck corp.All rights reserved.</p>
  </footer>

  <div class="dashboard-layout-popup">
    <div class="popup-overlay" id="popup1"></div>
    <div class="popup-wrapper" id="wrapper1">
      <div class="popup-title">
        <h3>ê²°ì¬ ìŠ¹ì¸</h3>
        <a onclick="NewClose()" title="íŒì—…ë‹«ê¸°" class="btn-popup-close">
          <img src="/images/icon/btn-popup-close.svg" alt="ë‹«ê¸°">
        </a>
      </div>
      <div class="popup-contents">
        <form id="MarketingForm" autocomplete="off">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <div class="table-wrap">
            <table class="view-table" id="selectedData" style="max-height: 740px;">
              <caption>ê²°ì¬ìŠ¹ì¸ í…Œì´ë¸”</caption>
              <colgroup>
                <col class="wp20">
                <col class="wauto">
              </colgroup>
              <button class="btn-download btn-navy" id="btnDownloadPdf" onclick="downloadPdf()">ë‹¤ìš´ë¡œë“œ</button>
              <tbody>
              <tr>
                <th colspan="2">PDF ë³´ê¸°</th>
              </tr>
              <tr>
                <td colspan="2">
                  <div id="pdfView" class="tab-item" style="display: block;">
                    <div id="pdfContainer" style="
                              width: 100%;
                              height: auto;
                              padding: 10px;
                              background: #f8f9fa;
                              overflow-y: auto;
                              max-height: 600px;">
                      <!-- PDF í˜ì´ì§€ê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <th><label for="remark"> ì‚¬ìœ </label></th>
                <td colspan="3">
                  <input id="remark" name="remark" class="wp100" placeholder="ì‚¬ìœ "/>
                  <input id="appnum" type="hidden">
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </form>
      </div>
      <div class="popup-button">
        <button class="btn-navy" id="" onclick=""> ë°˜ë ¤</button>
        <button class="btn-navy" id="" onclick="">ë³´ë¥˜</button>
        <button class="btn-navy" id="" onclick=""> ìŠ¹ì¸</button>
        <button class="btn-popup-close" onclick="NewClose()">ì¢…ë£Œ</button>
      </div>
    </div>
  </div>

</th:block>
<th:block layout:fragment="scripts">
  <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script><!-- PDF.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
  <script type="text/javascript">
    let theGrid;
    let theGrid1;
    let isBindSpjangcdCalled = false;

    $(document).ready(function () {
      // í˜„ì¬ ë‚ ì§œ ì„¤ì •
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();

      // ì‹œì‘ì¼
      const startOfYear = new Date(year, 0, 1);
      const startYearFormatted = `${startOfYear.getFullYear()}-${String(startOfYear.getMonth() + 1).padStart(2, '0')}-${String(startOfYear.getDate()).padStart(2, '0')}`;
      $('#startDate').val(startYearFormatted);

      // ì¢…ë£Œì¼
      const endOfMonth = new Date(year, month + 1, 0);
      const endMonthFormatted = `${endOfMonth.getFullYear()}-${String(endOfMonth.getMonth() + 1).padStart(2, '0')}-${String(endOfMonth.getDate()).padStart(2, '0')}`;
      $('#endDate').val(endMonthFormatted);
      init();
    });

    document.getElementById('searchUserNm').addEventListener('keydown', function (event) {
      if (event.key === 'Enter') {
        fetchListData(); // ì—”í„° í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ ì‹¤í–‰í•  í•¨ìˆ˜
      }
    })

    function init() {
      if (!isBindSpjangcdCalled) {
        bindSpjangcd();
        isBindSpjangcdCalled = true; // í”Œë˜ê·¸ ì—…ë°ì´íŠ¸
      }
      fetchListData();
      fetchListData1();
    }

    function fetchListData() {
      let data = [];

      const params = {
        search_spjangcd: $('#search_spjangcd').val(),
        startDate: $('#startDate').val(),
        endDate: $('#endDate').val(),
        SearchPayment:$('#SearchPayment').val(),
        searchUserNm: $('#searchUserNm').val()
      };

      console.log("ìˆ˜ì§‘ ë°ì´í„°(ê²°ì¬ ëª©ë¡)",params);

      // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      $.ajax({
        url: '/api/PaymentDetail/read',
        type: 'GET',
        data: params,
        async: false,
        success: function (response) {
          console.log("ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° :", response);
          // ì‘ë‹µì´ ì˜¬ë°”ë¥´ê²Œ ë„ì°©í–ˆê³ , data ì†ì„±ì´ ë°°ì—´ì¸ì§€ í™•ì¸
          if (response && Array.isArray(response.data)) {
            console.log("ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° ëª©ë¡:", response.data); //ì‹¤ì œ ë°ì´í„° í™•ì¸
          }
          if (response && Array.isArray(response.data)) {
            data = response.data.map((item, index) => ({
              rownum: index + 1,
              appdate: item.appdate ||'',
              appgubun : item.appgubun || '',
              appgubun_display: item.appgubun_display ||'',
              appnum: item.appnum || '',
              appperid: item.appperid||'',
              papercd: item.papercd || '',
              remark :item.remark ||'',
              repodate: item.repodate || '' ,
              repoperid: item.repoperid || '' ,
              repopernm : item.repopernm||'',
              title: item.title ||''
            }));
          }
        },
        error: function () {
          console.error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });

      while (data.length < 15) {
        data.push({
          rownum: data.length + 1,
          appdate: '',
          appgubun:'',
          appgubun_display:'',
          appnum:'',
          appperid:'',
          papercd:'',
          remark:'',
          repodate:'',
          repoperid:'',
          repopernm:'',
          title:''
        });
      }

      const viewdata = new wijmo.collections.CollectionView(data);

      if (!theGrid) {
        theGrid = new wijmo.grid.FlexGrid('#theGrid', {
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          selectionMode: 'ListBox',
          virtualizationThreshold: 1,
          columns: [
            {binding: 'rownum', header: 'ìˆœë²ˆ', width: 70, align: 'center'},
            {binding: 'appnum', header: 'ë¬¸ì„œë²ˆí˜¸', width: '*', minWidth: 100, align: 'center'},
            {binding: 'repodate', header: 'ìƒì‹ ì¼ì', width: '*', minWidth: 110, align: 'center'},
            {binding: 'repopernm', header: 'ì‘ì„±ìëª…', width: '*', minWidth: 100, align: 'center'},
            {binding: 'papercd', header: 'ë¬¸ì„œëª…', width: '*', minWidth: 120, align: 'center'},
            {binding: 'appgubun', header: 'ê²°ì¬êµ¬ë¶„', width: '*', minWidth: 100, align: 'center', visible: false},
            {binding: 'appgubun_display', header: 'ê²°ì¬êµ¬ë¶„', width: '*', minWidth: 100, align: 'center'},
            {binding: 'appdate', header: 'ê²°ì¬ì¼ì', width: '*', minWidth: 110, align: 'center'},
            {binding: 'title', header: 'ì œëª©', width: '*', align: 'center', minWidth: 100},
            {binding: 'remark', header: 'ì‚¬ìœ ', width: '*', align: 'center', minWidth: 100},
            {binding: 'appperid', header: '', visible: false},
            {binding: 'repoperid', header: '', visible: false},
          ],
          itemsSource: viewdata,
        });
        theGrid.rowHeaders.columns.splice(0, 1);
        attachDoubleClickEvent(theGrid); //ë”ë¸” í´ë¦­ ì´ë²¤íŠ¸
        new FlexGridContextMenu(theGrid);
        window.downloadFileName = 'ê²°ì¬ ëª©ë¡';
      } else {
        theGrid.itemsSource = viewdata;
      }
    }
    function attachDoubleClickEvent(grid) {
      let lastClickTime = 0;
      grid.hostElement.addEventListener('click', function (e) {
        const now = new Date().getTime();

        if (now - lastClickTime < 300) { // 300ms ì´ë‚´ í´ë¦­ -> ë”ë¸”í´ë¦­ ì²˜ë¦¬
          const ht = grid.hitTest(e);

          if (ht.cellType === wijmo.grid.CellType.Cell) {
            const rowData = grid.rows[ht.row].dataItem; // ë”ë¸” í´ë¦­í•œ í–‰ì˜ ë°ì´í„°
            console.log('Row Data:', rowData); // ë””ë²„ê¹…

            if (rowData) {
              modifyData(rowData);
              NewSave2(); // íŒì—… ì—´ê¸°
            }
          }
        }
        lastClickTime = now;
      });
    }


    function modifyData(rowData) {
      console.log("âœ”ï¸ ë”ë¸”í´ë¦­í•œ í–‰ì˜ ë°ì´í„°:", rowData);
      let container = document.getElementById("pdfContainer");

      // âœ… appnum ê°’ì„ currentRealIdë¡œ ì„¤ì •
      currentRealId = rowData.appnum || "";

      document.getElementById('appnum').value = currentRealId;

      let params = { appnum: rowData.appnum };

      console.log("ğŸ“‚ ìš”ì²­í•  ë°ì´í„°:", params);

      $.ajax({
        url: '/api/PaymentDetail/pdf',  // âœ… PDF íŒŒì¼ì„ ìš”ì²­í•˜ëŠ” API
        type: 'GET',
        data: params,
        xhrFields: { responseType: 'blob' },  // âœ… ì‘ë‹µì„ Blob í˜•ì‹ìœ¼ë¡œ ë°›ìŒ
        success: function (response) {
          console.log("ğŸ“‚ PDF ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œ");

          let filepath = URL.createObjectURL(response); // âœ… Blob ë°ì´í„°ë¥¼ URLë¡œ ë³€í™˜
          console.log("ğŸ“‚ PDF URL ìƒì„±ë¨:", filepath);

          container.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
          showPdf(filepath);  // âœ… PDF ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ
        },
        error: function () {
          console.error("ğŸš¨ ë°ì´í„° ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
          container.innerHTML = "<p style='color:red;'>PDF íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
        }
      });
    }
    function showPdf(filepath) {
      console.log(" PDF.jsë¥¼ ì‚¬ìš©í•˜ì—¬ PDF ë Œë”ë§:", filepath);

      let container = document.getElementById("pdfContainer");
      container.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

      // ğŸ›  PDF.jsë¥¼ ì´ìš©í•˜ì—¬ PDF ë¶ˆëŸ¬ì˜¤ê¸°
      pdfjsLib.getDocument({ url: filepath }).promise.then(pdf => {  // âœ… PDF.jsëŠ” Blob URLì„ ê°ì²´ í˜•íƒœë¡œ ë°›ì•„ì•¼ í•¨.
        console.log(" PDF ë¡œë“œ ì™„ë£Œ. ì´ í˜ì´ì§€ ìˆ˜:", pdf.numPages);

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          pdf.getPage(pageNum).then(page => {
            let viewport = page.getViewport({ scale: 1.5 }); // ê¸°ë³¸ ìŠ¤ì¼€ì¼

            // ğŸ›  ì»¨í…Œì´ë„ˆ ë„ˆë¹„ì— ë§ì¶° PDFë¥¼ ìë™ í™•ëŒ€
            let scale = container.clientWidth / viewport.width;
            let scaledViewport = page.getViewport({ scale: scale });

            // í˜ì´ì§€ë³„ <canvas> ìƒì„±
            let canvas = document.createElement("canvas");
            canvas.classList.add("pdf-page");
            container.appendChild(canvas);

            let context = canvas.getContext("2d");

            // ğŸ›  PDF í¬ê¸°ë¥¼ ì»¨í…Œì´ë„ˆì— ë§ê²Œ ì„¤ì •
            let scaleFactor = 3; // 3ë°° í™•ëŒ€
            canvas.width = scaledViewport.width * scaleFactor;
            canvas.height = scaledViewport.height * scaleFactor;
            canvas.style.width = "100%"; // ì»¨í…Œì´ë„ˆì— ë§ê²Œ ê½‰ ì±„ìš°ê¸°
            canvas.style.height = "auto"; // ì„¸ë¡œ ë¹„ìœ¨ ìœ ì§€

            // ê³ í•´ìƒë„ ë Œë”ë§ (í…ìŠ¤íŠ¸ ì„ ëª…í•˜ê²Œ)
            let renderContext = {
              canvasContext: context,
              viewport: scaledViewport,
              transform: [scaleFactor, 0, 0, scaleFactor, 0, 0]
            };

            page.render(renderContext);
          });
        }
      }).catch(error => {
        console.error("âŒ PDF ë Œë”ë§ ì˜¤ë¥˜:", error);
        Alert.alert(''," PDFë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      });
    }

    /*function downloadPdf() {
      if (!currentRealId) {
        console.error("ë‹¤ìš´ë¡œë“œí•  PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        alert("ë‹¤ìš´ë¡œë“œí•  PDF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      console.log("ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ ì‹œì‘: realId=", currentRealId);

      let downloadUrl = `/api/PaymentDetail/pdfDownload?appnum=${currentRealId}`;
      console.log("ğŸ“Œ ë‹¤ìš´ë¡œë“œ URL:", downloadUrl);

      fetch(downloadUrl)
        .then(response => {
          if (!response.ok) throw new Error("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
          return response.blob();
        })
        .then(blob => {
          const link = document.createElement("a");
          link.href = window.URL.createObjectURL(blob);
          link.download = currentRealId + ".pdf";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        })
        .catch(error => {
          console.error("ğŸš¨ PDF ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:", error);
          alert("PDF ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }*/

    // ë‹¤ìš´ë¡œë“œ
    // ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    function downloadPdf() {
      let appnum = document.getElementById("appnum").value; // âœ… `appnum` ê°’ ê°€ì ¸ì˜¤ê¸°

      if (!appnum) {
        console.warn("ğŸ“Œ `appnum` ê°’ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        alert("ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      console.log("ğŸ“„ ë‹¤ìš´ë¡œë“œ ìš”ì²­: appnum =", appnum);

      // ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ ì •ë³´ ë¦¬ìŠ¤íŠ¸ (íŒŒì¼ ê²½ë¡œ, ì„œë²„ ì €ì¥ëª…, ì›ë³¸ íŒŒì¼ëª…)
      let fileList = [{
        filepath: "C:/Temp/APP/S_KRU/",  // âœ… íŒŒì¼ì´ ì €ì¥ëœ ê²½ë¡œ (ë°±ì—”ë“œì—ì„œ ë³€ê²½ ê°€ëŠ¥)
        filesvnm: appnum + ".pdf",       // âœ… ì„œë²„ì— ì €ì¥ëœ íŒŒì¼ëª… (ì˜ˆ: 202502110034ZZ.pdf)
        fileornm: appnum + ".pdf"        // âœ… ë‹¤ìš´ë¡œë“œë  ì›ë³¸ íŒŒì¼ëª… (ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤„ ì´ë¦„)
      }];

      let downloadUrl = "/api/PaymentDetail/downloader";

      // âœ… íŒŒì¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ì„œë²„ì— ì „ì†¡í•˜ì—¬ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
      downloadFiles(fileList, downloadUrl);
    }

    // ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    function downloadPdf() {
      let appnum = document.getElementById("appnum").value; // âœ… `appnum` ê°’ ê°€ì ¸ì˜¤ê¸°

      if (!appnum) {
        console.warn("ğŸ“Œ `appnum` ê°’ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        alert("ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      console.log("ğŸ“„ ë‹¤ìš´ë¡œë“œ ìš”ì²­: appnum =", appnum);

      // ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ ì •ë³´ ë¦¬ìŠ¤íŠ¸ (íŒŒì¼ ê²½ë¡œ, ì„œë²„ ì €ì¥ëª…, ì›ë³¸ íŒŒì¼ëª…)
      let fileList = [{
        filepath: "C:/Temp/APP/S_KRU/",  // âœ… íŒŒì¼ì´ ì €ì¥ëœ ê²½ë¡œ (ë°±ì—”ë“œì—ì„œ ë³€ê²½ ê°€ëŠ¥)
        filesvnm: appnum + ".pdf",       // âœ… ì„œë²„ì— ì €ì¥ëœ íŒŒì¼ëª… (ì˜ˆ: 202502110034ZZ.pdf)
        fileornm: appnum + ".pdf"        // âœ… ë‹¤ìš´ë¡œë“œë  ì›ë³¸ íŒŒì¼ëª… (ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤„ ì´ë¦„)
      }];

      let downloadUrl = "/api/PaymentDetail/downloader";

      // âœ… íŒŒì¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ì„œë²„ì— ì „ì†¡í•˜ì—¬ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
      downloadFiles(fileList, downloadUrl);
    }

    // âœ… AJAX ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    function downloadFiles(fileList, url) {
      fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(fileList)  // âœ… JSON ë°ì´í„°ë¥¼ ì„œë²„ë¡œ ì „ë‹¬
      })
        .then(response => {
          if (!response.ok) {
            throw new Error("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
          }
          return response.blob();
        })
        .then(blob => {
          let contentDisposition = response.headers.get("Content-Disposition");
          let filename = "download.pdf";  // ê¸°ë³¸ íŒŒì¼ëª…

          if (contentDisposition) {
            let match = contentDisposition.match(/filename\*?=['"]?([^;'\"]+)/);
            if (match && match.length > 1) {
              filename = decodeURIComponent(match[1]);
            }
          }

          // âœ… Blob ë°ì´í„°ë¥¼ ì´ìš©í•˜ì—¬ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
          const link = document.createElement("a");
          link.href = window.URL.createObjectURL(blob);
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        })
        .catch(error => {
          console.error("ğŸš¨ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          alert("íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }

    // ë‹¤ìš´ë¡œë“œ
    function downloadFile_order(fileList) {
      if (!fileList || fileList.length === 0) {
        console.warn("ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      console.log("ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ ëª©ë¡:", fileList);

      let downloadList = fileList.map(file => ({
        filepath: "C:/Temp/APP/S_KRU/",  // âœ… íŒŒì¼ì´ ì €ì¥ëœ ê²½ë¡œ (ë°±ì—”ë“œì—ì„œ ë³€ê²½ ê°€ëŠ¥)
        filesvnm: appnum + ".pdf",       // âœ… ì„œë²„ì— ì €ì¥ëœ íŒŒì¼ëª… (ì˜ˆ: 202502110034ZZ.pdf)
        fileornm: appnum + ".pdf"        // âœ… ë‹¤ìš´ë¡œë“œë  ì›ë³¸ íŒŒì¼ëª… (ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤„ ì´ë¦„)
      }));

      let downloadUrl = '/api/announcement/downloader';

      // íŒŒì¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ì„œë²„ì— ì „ì†¡í•˜ì—¬ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
      downloadFiles(downloadList, downloadUrl);
    }



    // ë‹¤ìš´ë¡œë“œ
    /*function downloadPdf() {
         let downloadList = [];

      // ì„ íƒëœ í•­ëª©ì—ì„œ ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ ëª©ë¡ ìƒì„±

        downloadList.push({
          appnum: currentRealId
        });

      // ë‹¤ìš´ë¡œë“œ URL ì§€ì •
      let downloadUrl = '/api/PaymentDetail/pdfDownload';

      // Jung.jsì—ì„œ ì •ì˜í•œ downloadFiles í•¨ìˆ˜ í˜¸ì¶œ
      downloadFiles(downloadList, downloadUrl);
    }*/

    function NewSave2() {
      let popup = document.getElementById('popup1');
      let wrapper = document.getElementById('wrapper1');

      popup.style.display = 'block';
      wrapper.style.display = 'block';
    }

    function NewClose() {
      // íŒì—… ë‹«ê¸°
      let popup = document.getElementById('popup1');
      let wrapper = document.getElementById('wrapper1');
      clearForm();  // í¼ ì´ˆê¸°í™”
      popup.style.display = 'none';
      wrapper.style.display = 'none';
    }

    // í¼ ì´ˆê¸°í™” í•¨ìˆ˜
    function clearForm() {
      // í¼ ìš”ì†Œ ì„ íƒ
      const form = document.getElementById('MarketingForm');

      if (form) {
        form.reset(); // ëª¨ë“  ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      }

      // íŒŒì¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      let fileInput = document.getElementById('fileInput2');
      if (fileInput) {
        fileInput.value = "";
      }

    }

    function fetchListData1() {
      let data = [];

      const params = {
        search_spjangcd: $('#search_spjangcd').val(),
        startDate: $('#startDate').val(),
        endDate: $('#endDate').val(),
        searchUserNm: $('#searchUserNm').val()
      };

      // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      $.ajax({
        url: '/api/PaymentDetail/read1',
        type: 'GET',
        data: params,
        async: false,
        success: function (response) {
          console.log("ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°:", response);

          if (response && response.data) {
            const userName = response.data.userName || ''; // ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
            const paymentList = response.data.paymentList || []; // ê²°ì¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°

            if (Array.isArray(paymentList)) {
              console.log("ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° ëª©ë¡:", paymentList);

              data = paymentList.map((item) => ({
                userName: userName, // ëª¨ë“  í•­ëª©ì— ë™ì¼í•œ ì‚¬ìš©ì ì´ë¦„ ì¶”ê°€
                appgubun1: (item.appgubun1 || '0') + "ê±´",
                appgubun2: (item.appgubun2 || '0') + "ê±´",
                appgubun3: (item.appgubun3 || '0') + "ê±´",
                appgubun4: (item.appgubun4 || '0') + "ê±´"
              }));
            }
          }
        },
        error: function () {
          console.error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });

      // ë°ì´í„°ê°€ ë¹„ì–´ ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì¶”ê°€ (ê·¸ë¦¬ë“œê°€ ê¹¨ì§€ì§€ ì•Šë„ë¡)
      if (data.length < 1) {
        data.push({
          userName: '',
          appgubun1: '',
          appgubun2: '',
          appgubun3: '',
          appgubun4: ''
        });
      }

      const viewdata = new wijmo.collections.CollectionView(data);

      if (!theGrid1) {
        theGrid1 = new wijmo.grid.FlexGrid('#theGrid1', {
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          columns: [
            { binding: 'userName', header: 'ê²°ì¬ìëª…', width: '*', minWidth: 100, align: 'center' },
            { binding: 'appgubun1', header: 'ê²°ì¬ëŒ€ê¸°', width: '*', minWidth: 100, align: 'center' },
            { binding: 'appgubun2', header: 'ê²°ì¬ë¬¸ì„œ', width: '*', minWidth: 100, align: 'center' },
            { binding: 'appgubun4', header: 'ë³´ë¥˜ë¬¸ì„œ', width: '*', minWidth: 100, align: 'center' },
            { binding: 'appgubun3', header: 'ë°˜ë ¤ë¬¸ì„œ', width: '*', minWidth: 100, align: 'center' },
          ],
          itemsSource: viewdata,
        });
        theGrid1.rowHeaders.columns.splice(0, 1);
        new FlexGridContextMenu(theGrid1);
        window.downloadFileName = 'ë¬¸ì„œ í˜„í™©';
      } else {
        theGrid1.itemsSource = viewdata;
      }
    }

    //ê³µí†µì½”ë“œ
    const selectConfigs = [
      {parentCode: 'Payment', elementId: 'SearchPayment'},
    ];

    selectConfigs.forEach(config => {
      initializeSelect3({
        url: '/api/PaymentList/payType',
        params: {parentCode: config.parentCode},
        elementId: config.elementId,
        valueField: "code",
        textField: "value",
        includeAllOption: true, // "ì „ì²´" ì˜µì…˜ ì‚¬ìš©
        // defaultValue: "001" // ê¸°ë³¸ ì„ íƒê°’ [ëŒ€ê¸°]
      });
    });

    //ì‚¬ì—…ì¥ ì½”ë“œ
    function bindSpjangcd() {
      $.ajax({
        url: '/api/PaymentList/bindSpjangcd',
        type: 'GET',
        async: false,
        success: function (data) {
          data2 = data.data;
          const selectElement = document.getElementById('search_spjangcd');
          if (selectElement) {
            selectElement.value = data2; // value ì†ì„±ìœ¼ë¡œ ì„ íƒ
          }
        }
      })
    }


  </script>
</th:block>
</html>