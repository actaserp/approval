<html layout:decorate="~{layout_page}">

<th:block layout:fragment="content">
<div class="content_wrap">

    <section class="section">

        <div class="title_box">
            <div class="left_align">
                <h3 data-labelCd="워크센터">워크센터</h3>
            </div>
            <button type="button" class="btn-default pull-right " id="btnHedaerFilter" title="필터 보이기/감추기"><i class="fas fa-filter"></i></button>
            <button type="button" class="btn-default pull-right mr-1" id="btnHeaderCompress" title="화면 확대/축소"><i class="fas fa-compress" id="iCompress"></i></button>        
        </div>

        <div class="table_box search" >

            <div class="row" >

                <div class="col-6 col-lg-3 col-xl-2" >
                    <div class="input-group" >
                        <div class="input-group-prepend">
                            <span class="input-group-text fit_box_md"data-labelCd="워크센터명">워크센터명</span>
                        </div>
                        <input class="form-control2" value="" id="txtWorkCenter" name="txtWorkCenter" />
                    </div>
                </div>
                <div class="col-1" >
                        <button type="button" class="btn-default" id="btnSearch" title="조회"><i class="fas fa-search"></i></button>
                </div> 
            </div>

        </div>
    </section>

    <section class="section">

        <div class="grid_box">
            <div class="title_box">
                <span class="right_align rpt" data-labelCd="워크센터 정보">워크센터 정보</span>
                <button type="button" class="btn-default" id="btnExcel"><i class="fas fa-file-excel"></i></button> 
                <button type="button" class="btn-default" id="btnGridSetting" style="visibility:hidden"><i class="fas fa-cog"></i> Setting</button>
            </div>
            <div class="h-350" data-ax5grid="workcenter-grid" ></div>  
        </div>

    </section>
    <section class="section">
                    
        <div class="tabs" data-tab="tabWrap">
            <div class="title_box">
                <div class="left_align">
                    <ul class="tab_links">
                        <li><a href="#" data-tablink="#tabs_first_tab" id="tabs_first" class="tab" data-labelCd="워크센터기본정보">워크센터기본정보</a></li>
                        <li><a href="#" data-tablink="#tabs_second_tab" id="tabs_second" class="tab" data-labelCd="설비정보">설비정보</a></li>
                    </ul>
                </div>
            </div>

            <div class="tab-content">
                <div class="tab"id="tabs_first_tab">
                    <div class="tab_con_box">

                        <div class="title_box mb-2">
                            <span class="right_align rpt" data-labelCd="상세정보">상세정보</span>
                            <button type="button" class="btn-default" id="btnNewWorkcenter" name="btnNew"><i class="fas fa-plus"></i></button>
                            <button type="button" class="btn-danger" id="btnDelWorkcenter" ><i class="fas fa-trash"></i></button>
                            <button disabled type="button" class="btn-default" id="btnSaveWorkcenter" ><i class="fas fa-save"></i></button>
                        </div>

                        <div class="table_box sub">
                            <form id="workcenterForm">
                            <div class="row">

                                <!--<div class="col-6 col-md-3" >
                                    <div class="input-group" >
                                        <div class="input-group-prepend">
                                            <span class="input-group-text fit_box_t7" >번호</span>
                                        </div>-->
                                        <input class="form-control2"  type="text" id="id" name="id" hidden/>
                                <!--
                                    </div>
                                </div>-->

                                <div class="col-6 col-md-3" >
                                    <div class="input-group" >
                                        <div class="input-group-prepend">
                                            <span class="input-group-text fit_box_t7" data-labelCd="*공장">*공장</span>
                                        </div>
                                        <select class="form-control2" id="factory_id" name="factory_id" ></select>

                                    </div>
                                </div>

                                <div class="col-6 col-md-3" >
                                    <div class="input-group" >
                                        <div class="input-group-prepend">
                                            <span class="input-group-text fit_box_t7" data-labelCd="에어리어">에어리어</span>
                                        </div>
                                        <select class="form-control2" type="text"id="area_id" name="area_id"></select>

                                    </div>
                                </div>

                                <div class="col-6 col-md-3" >
                                    <div class="input-group" >
                                        <div class="input-group-prepend">
                                            <span class="input-group-text fit_box_t7" data-labelCd="*공정">*공정</span>
                                        </div>
                                        <select class="form-control2" type="text"id="Process_id" name="Process_id"></select>

                                    </div>
                                </div>

                                <div class="col-6 col-md-3" >
                                    <div class="input-group" >
                                        <div class="input-group-prepend">
                                            <span class="input-group-text fit_box_t7" data-labelCd="*워크센터 코드">*워크센터 코드</span>
                                        </div>
                                       <input class="form-control2" type="text" id="code"  name="code" value="" required>

                                    </div>
                                </div>

                                <div class="col-6 col-md-3" >
                                    <div class="input-group" >
                                        <div class="input-group-prepend">
                                            <span class="input-group-text fit_box_t7" data-labelCd="*워크센터명">*워크센터명</span>
                                        </div>
                                        <input type="text" class="form-control2"id="name" name="name" required />

                                    </div>
                                </div>

                                <div class="col-6 col-md-3" >
                                    <div class="input-group" >
                                        <div class="input-group-prepend">
                                            <span class="input-group-text fit_box_t7" data-labelCd="공정창고">공정창고</span>
                                        </div>
                                        <select class="form-control2" id="process_storehouse_id" name="process_storehouse_id" ></select>
                                    </div>
                                </div>

                                <div class="col-6 col-md-3 col-lg-2 mt-5 " >
                                        <input type="checkbox" id="outsourcing_yn" name="outsourcing_yn" value="Y" disabled />
                                    외주 여부
                                </div>

                            </div>
                            </form>
                        </div>
                    </div>
                </div> 
                <div class="tab" id="tabs_second_tab">
                    <div class="tab_con_box mb-2">

                        <div class="grid_box">
                            <div class="title_box">
                                 <span class="right_align rpt" data-labelCd="설비 목록">설비 목록</span>
                                <button disabled type="button" class="btn-default" id="btnNewEquip" name="btnNew" ><i class="fas fa-plus"></i></button>
                                <button disabled type="button" class="btn-danger" id="btnDelEquip" style="float:none" ><i class="fas fa-trash"></i></button>                            </div>
                            <div class="h-200" data-ax5grid="workcenter-equip-grid" ></div>  
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>

</div>
</th:block>

<th:block layout:fragment="scripts">
<th:block th:replace="/common/columns_setting :: columns_setting" ></th:block>
<th:block th:replace="/common/popup_equipment :: popup_equipment" ></th:block>
<script type="text/javascript">


    class WorkCenterPage {
        constructor() {
            this.grid = null;
            this.equipGrid = null;
            this.url = '/api/definition/workcenter';
            this.init();
        }

        init() {
            let _this = this;
            let config = {
                target: $('[data-ax5grid="workcenter-grid"]'),
                sortable: true,
                frozenColumnIndex: 0, // 열 고정
                frozenRowIndex: 0,    // 행 고정
                showLineNumber: false, // 열의 번호 보이기 여부
                showRowSelector: false,  // checkbox(선택) 보이기 여부
                multipleSelect: false, // 여러행 선택 가능 여부 (false시 단독 선택)
                sortable: true, // 모든 컬럼에 정렬 아이콘 표시 (columns에서 컬럼별 소팅여부 재설정 가능)
                multiSort: true, // 다중 정렬 여부
                header: {
                    align: 'center',  // 헤더의 기본 정렬
                    columnHeight: 38  // 헤더 높이
                },
                body: {
                    columnHeight: 25, // body의 기본 높이
                    onClick: function (e) {
                        _this.grid.select(this.dindex);
                        _this.showDetail(e.item.id);
                    },
                },
                page: {
                    display: true,  // 페이징 보이기 여부
                    statusDisplay: true,
                },
                columns: [
                    { key: 'factory_name', label: '공장', width: 150, align: 'left', },
                    { key: 'area_name', label: '에어리어', width: 150, align: 'left', },
                    { key: 'code', label: '워크센터코드', width: 150, align: 'left' },
                    { key: 'name', label: '워크센터명', width: 200, align: 'left' },
                    { key: 'ProcessName', label: '공정', width: 150, align: 'left', },                    
                    { key: 'process_storehouse_id', label: '창고구분', width: 100, align: 'left' },
                    { key: 'outsourcing_yn', label: '외주여부', width: 100, align: 'center', },
                ],
            };

            let equipConfig = {
                target: $('[data-ax5grid="workcenter-equip-grid"]'),
                sortable: false,
                frozenColumnIndex: 0, // 열 고정
                frozenRowIndex: 0,    // 행 고정
                showLineNumber: false, // 열의 번호 보이기 여부
                showRowSelector: true,  // checkbox(선택) 보이기 여부
                multipleSelect: false, // 여러행 선택 가능 여부 (false시 단독 선택)
                sortable: true, // 모든 컬럼에 정렬 아이콘 표시 (columns에서 컬럼별 소팅여부 재설정 가능)
                multiSort: true, // 다중 정렬 여부
                header: {
                    align: 'center',  // 헤더의 기본 정렬
                    columnHeight: 38  // 헤더 높이
                },
                body: {
                    columnHeight: 25, // body의 기본 높이
                    onClick: function (e) {
                        _this.equipGrid.select(this.dindex);
                        $('#btnDelEquip').removeAttr('disabled');
                    },
                },
                page: {
                    display: true,  // 페이징 보이기 여부
                    statusDisplay: true,
                },
                columns: [
                    { key: 'EquipmentCode', label: '설비코드', width: 150, align: 'left' },
                    { key: 'EquipmentName', label: '설비명', width: 200, align: 'left' },
                    { key: '_created', label: '생성일', width: 200, align: 'center' },
                ],
            };

            this.grid = new ax5.ui.grid(config);
            this.equipGrid = new ax5.ui.grid(equipConfig);
            this.grid_config = config; 
        }

        clickContextMenu(action, param) {
            let _this = this;
            let pk = param.item.id;
            let $workcenterForm = $('#workcenterForm');

            if (action == 'create') {
                let newItem = {
                    'id': '',
                    'code': '',
                    'name': '',
                    'factory_id': '',
                    'outsourcing_yn': 'N',
                }
                FormUtil.BindDataForm(newItem, $workcenterForm);
                $('#outsourcing_yn').prop('checked', false);
            } else if (action == 'delete') {
                Alert.confirm('', 
                    '삭제하시겠습니까?',
                    function () { _this.deleteWorkCenter(pk) },
                    function () { }
                );
            }
        }

        showDetail(workcenter_id) {
            let _this = this;
            let param = { 'id': workcenter_id };
            let result = AjaxUtil.getSyncData(this.url+"/detail", param);

            if (result.success) {
                FormUtil.BindDataForm(result.data[0], $('#workcenterForm'));
                $('#factory_id').trigger('change');

                let outYn = result.data[0].outsourcing_yn;

                if (outYn == 'Y') {
                    $('#outsourcing_yn').prop('checked', true);
                } else {
                    $('#outsourcing_yn').prop('checked', false);
                }
                
                if (result.data[1] != null) { // 조회된 설비정보 없을 경우 오류발생
					let count = result.data[1].length;
		            _this.equipGrid.setData({
		                list: result.data[1],
		                page: {
		                    display: true,
		                    totalElements: count,
		                }
		            });
				}
            }
            page.setButtonState();
            $('#btnNewEquip').removeAttr('disabled');
            $('#btnDelEquip').removeAttr('disabled');
        }

        showEquipmentList(workcenter_id) {
            let _this = this;
            let param = { 'id': workcenter_id};
            let result = AjaxUtil.getSyncData(this.url+"/equipment_list", param);
            if (result.success) {
                let recordsTotal = result.data.length;
                _this.equipGrid.setData({
                    list: result.data,
                    page: {
                        display: true,
                        totalElements: recordsTotal,
                    }
                });
            }
        }

        addEquipment(workcenter_id, equipment_id) {
            let _this = this;
            let data = { workcenter_id: workcenter_id, equipment_id: equipment_id };
            let fnsuccess = function (result) {
                if (result.success) {
                    Notify.success('저장했습니다.');
                } else {
					Alert.alert('', result.message);
				}
                _this.showEquipmentList(workcenter_id);

            };

            AjaxUtil.postAsyncData(this.url+"/add_equipment", data, fnsuccess);

        }

        resetForm(disableFlag) {
            $('#workcenterForm')[0].reset();

            let fndisable = function (obj) {
                if (disableFlag == true) {
                    if ($(obj).is(':disabled') == false) {
                        $(obj).attr('disabled', true);
                    }
                }
                else {
                    if ($(obj).is(':disabled')) {
                        $(obj).removeAttr('disabled');
                    }
                }
            };


            $('#workcenterForm select').each(function () {
                fndisable(this);
            });

            $('#workcenterForm input').each(function () {
                fndisable(this);
            });

            $('#workcenterForm checkbox').each(function () {
                fndisable(this);
            });
        }

        searchMainData() {
            let _this = this;
            let param ={keyword : $('#txtWorkCenter').val() }

            let result = AjaxUtil.getSyncData(this.url+"/read", param);
            

            if (result.success) {
                let recordsTotal = result.data.length;
                _this.grid.setData({
                    list: result.data,
                    page: {
                        display: true,
                        totalElements: recordsTotal,
                    }
                });
            }
            
            _this.resetForm(true);
            _this.equipGrid.setData([]);

            page.setButtonState();
            $('#btnNewEquip').prop('disabled', true);
            $('#btnDelEquip').prop('disabled', true);
        }

        saveWorkCenter() {
            let _this = this;
            //데이터입력체크루틴 누락

            let $form = $('#workcenterForm');
            let data = FormUtil.extractForm($form);

            if (!data.factory_id) {
                Alert.alert('', '공장을 선택해주세요.');
                return false;
            } else if (!data.code) {
                Alert.alert('', '워크센터 코드를 입력해주세요.');
                return false;
            } else if (!data.name) {
                Alert.alert('', '워크센터 명을 입력해주세요.');
                return false;
            } else if (!data.Process_id) {
                Alert.alert('', '공정을 선택해주세요.');
                return false;
            }

            let fnSuccess = function (res) {
				if(res.success) {
	               Notify.success('저장되었습니다.');
	               _this.searchMainData();
				} else {
					Alert.alert('',res.message);
				}
            };

            AjaxUtil.postAsyncData(this.url+"/save", data, fnSuccess);
        }

        deleteWorkCenter(id) {
            let _this = this;
            let data = { id: id };
            let fnSuccess = function (res) {
                Notify.success('삭제되었습니다.');
                _this.searchMainData();
            };
            AjaxUtil.postAsyncData(this.url+"/delete", data, fnSuccess);
        }

        deleteEquipment(item) {
            let _this = this;
            let fnsuccess = function (result) {
                if (result.success) {
                    Notify.success('삭제되었습니다.');
                }
                _this.showEquipmentList(item.WorkCenter_id);
            };

            let data = { 'equipment_id': item.Equipment_id, 'workcenter_id': item.WorkCenter_id, id: item.id };
            AjaxUtil.postAsyncData(this.url+"/delete_equipment", data, fnsuccess);
        }

        //버튼 활성화 
        setButtonState() {
            let pk = $('#id').val();
            $('#btnNewWorkcenter').prop('disabled', false);
            $('#btnSaveWorkcenter').prop('disabled', false);

            if (pk) {
                $('#btnDelWorkcenter').prop('disabled', false);
            } else {
                $('#btnDelWorkcenter').prop('disabled', true);
            }
            
        }

    }

    let page = null;

    $(document).ready(function (e) {
        page = new WorkCenterPage();

		//그리드 컬럼 설정
        page.popColSetting = new popColSetting();
        let columns = page.popColSetting.loadColumnData(gui.gui_code, gui.template_key, 'grid',  page.grid);
		
        if (userinfo.group_code == 'admin') {
            $('#btnGridSetting').css('visibility','visible');  
        }		
	
        $('#btnGridSetting').click(function (e) {
            let _this = this;
            let fix_cols = page.grid_config.frozenColumnIndex;
            page.popColSetting.show(gui.gui_code, gui.template_key, 'grid', page.grid_config.columns, page.grid, { 'order_fix':false,  'fix_cols' : fix_cols });
        });	

        page.searchMainData();

        AjaxUtil.fillSelectOptions($('#factory_id'), 'factory', 'choose', false);
        AjaxUtil.fillSelectOptions($('#area_id'), 'area', 'choose', false);
        AjaxUtil.fillSelectOptions($('#Process_id'), 'process', 'choose', false);
        AjaxUtil.fillSelectOptions($('#process_storehouse_id'), 'store_house', 'choose', false, 'process');

        $('#factory_id').change(function (ex) {
            let area_pk = $('#area_id').val();
            AjaxUtil.fillSelectOptions($('#area_id'), 'area', 'choose', area_pk, $('#factory_id').val());
        });

        $('#btnSearch').click(function (ex) {
            page.searchMainData();
        });

        $('#btnNewWorkcenter').click(function (e) {
            page.resetForm(false);
            page.setButtonState();
        });

        $('#btnSaveWorkcenter').click(function (e) {

            Alert.confirm('', 
                '저장하시겠습니까?',
                function () { page.saveWorkCenter() },
                function () { }
            );
        });

        $('#btnDelWorkcenter').click(function (e) {
            let id = $('#workcenterForm').find('#id').val();

            if (id == '') {
                Alert.alert('', '선택된 데이터가 없습니다.');
                return;
            }

            Alert.confirm('', 
                '삭제하시겠습니까?',
                function () { page.deleteWorkCenter(id) },
                function () { }
            );
        });

        $('#btnNewEquip').click(function (e) {
            let workcenter_id = $('#id').val();
            if (workcenter_id != '') {
                popupPage = new PopupEquipmentPage();
                selectCallback = function (item) {
                    let equipment_id = item.id;
                    page.addEquipment(workcenter_id, equipment_id);
                    popupPage.close();
                };
                popupPage.show(selectCallback);
            }
        });

        $('#btnDelEquip').click(function (e) {
            let items = page.equipGrid.getList("selected");
            if (items.length == 0) {
                return false;
            }
            let data = items[0];
            Alert.confirm('', '삭제하시겠습니가?', function () {
                page.deleteEquipment(data);
            });
        });

        // 엑셀 다운로드
        $('#btnExcel').click(function (e) {
            page.grid.exportExcel('워크센터정보.xls');
        });

    });
</script>
</th:block>
</html>