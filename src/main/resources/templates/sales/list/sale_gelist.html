<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">

<head>
    <style>
        #theGrid2.wj-flexgrid .wj-cell {
            padding: 12px;
        }

        #theGrid2.wj-flexgrid .downloads {
            padding-top: 0px;
        }

    </style>
</head>

<th:block layout:fragment="content">

    <!--- (레이아웃) Contents 영역 -->
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>기간별 발전량 조회</h2>
                <a title="북마크" class="bookmark toggle">
                    내메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>서비스 분석</li>
                <li>매출 관리</li>
                <li>기간별 발전량 조회</li>
            </ul>
        </div>

        <!-- Select -->
        <div class="search-wrap">
            <ul>
                <li>
                    <select title="지역" id="spworkcd" name="spworkcd" onchange="updateSelect('spworkcd', 'spworknm')">
                        <option value="001">대구</option>
                        <input type="hidden" id="spworknm" name="spworknm">
                    </select>
                </li>
                <li>
                    <select title="구" id="spcompcd" name="spcompcd" onchange="updateSelect('spcompcd', 'spcompnm')">
                        <option value="001">성서산단</option>
                        <input type="hidden" id="spcompnm" name="spcompnm">
                    </select>
                </li>
                <li>
                    <select title="시설" id="spplancd" name="spplancd" onchange="updateSelect('spplancd', 'spplannm')">
                        <option value="001">대구물류센터</option>
                        <input type="hidden" id="spplannm" name="spplannm">
                    </select>
                </li>
            </ul>
        </div>

        <div class="tab-wrap">
            <ul class="tab-links">
                <li>
                    <a href="#tab1" title="기간별조회">기간별 조회</a>
                </li>
                <li>
                    <a href="#tab2" title="기간별대비">기간별 대비</a>
                </li>
            </ul>

            <div class="tab-contents">
                <!-- tab1 -->
                <section class="tab-item" id="tab1">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    조회연도<span class="eq">*</span>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="yearSelectTab1" name="yearSelectTab1">
                                            </select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label for="periodType">
                                        기간유형<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="periodType" name="periodType" onchange="updatePeriodInputs()">
                                                <option value="hourly">시간별</option>
                                                <option value="monthly" selected>월별</option>
                                                <option value="quarterly">분기별</option>
                                                <option value="halfyearly">반기별</option>
                                                <option value="yearly">연도별</option>
                                            </select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    조회기간<span class="eq">*</span>
                                </dt>
                                <dd>
                                    <ul class="date-box" id="dateBoxContainer">
                                        <li id="startDateContainer">
                                            <input type="month" id="startDate" name="startDate">
                                        </li>
                                        <li id="endDateContainer">
                                            <input type="month" id="endDate" name="endDate">
                                        </li>
                                    </ul>
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    <label for="genename">
                                        발전기명<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="genename" name="genename">
                                                <!-- 동적으로 발전기명을 가져와서 옵션으로 추가 -->
                                            </select>
                                        </li>
                                        <li>
                                            <a class="btn btn-navy" title="차트설정초기화" id="btn-reset-chart">
                                                차트설정 초기화
                                            </a>
                                        </li>

                                        <li>
                                            <a class="btn btn-delete" title="검색" id="btn-search" onclick="searchData()">
                                                <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                                검색
                                            </a>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                        </div>

                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a class="btn btn-excell" title="엑셀다운로드">
                                        <img src="/images/icon/ico-excell.svg" alt="엑셀 아이콘">
                                        엑셀다운로드
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div> <!--//section-top end -->

                    <div class="row row-2">
                        <section class="wp50" style="height: 530px; border-radius: 15px;">
                            <!-- 슬라이드 차트 -->
                            <div id="chartHolder1" style="width:600px; height:400px;">
                            </div>
                        </section>
                        <section class="wp50" style="height: 530px">
                            <!-- 그리드 -->
                            <div class="container-fluid">
                                <p id="selectedItem"></p>
                                <div id="theGrid" style="max-height: 485px"></div>
                            </div>
                        </section>
                    </div>
                </section>

                <!-- tab2 -->
                <section class="tab-item" id="tab2">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    조회연도<span class="eq">*</span>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="yearSelectTab2" name="yearSelectTab2">
                                                <!-- 연도 목록이 동적으로 추가될 것입니다 -->
                                            </select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    <label for="generatorSelect">
                                        발전기명<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="generatorSelect" name="generatorSelect">
                                                <option value="all">전체</option>
                                                <option value="AJ380">AJ380</option>
                                                <option value="AJ390">AJ390</option>
                                            </select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    <label for="comparisonType">
                                        비교 유형<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="comparisonType" name="comparisonType">
                                                <option value="YoY">YoY</option>
                                                <option value="QoQ">QoQ</option>
                                                <option value="MoM">MoM</option>
                                                <option value="YTD">YTD</option>
                                            </select>
                                        </li>

                                        <li>
                                            <a class="btn btn-navy" title="차트설정초기화" id="btn-reset-chart2">
                                                차트설정 초기화
                                            </a>
                                        </li>

                                        <li>
                                            <a class="btn btn-delete" title="검색" id="btn-search2" onclick="searchComparisonData()">
                                                <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                                검색
                                            </a>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                        </div>

                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a class="btn btn-excell" title="엑셀다운로드">
                                        <img src="/images/icon/ico-excell.svg" alt="엑셀 아이콘">
                                        엑셀다운로드
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div> <!--//section-top end -->

                    <div class="row row-2">
                        <section class="wp50" style="height: 530px; border-radius: 15px;">
                            <div id="chartHolder2" style="width:600px; height:400px;"></div>
                        </section>
                        <section class="wp50" style="height: 530px;">
                            <div class="container-fluid">
                                <p id="selectedItem"></p>
                                <div id="theGrid2" style="max-height: 485px;"></div>
                            </div>
                        </section>
                    </div>
                </section>
            </div><!--//tab-contents end -->
        </div>
    </div> <!--//layout-contents end -->

</th:block>

<th:block layout:fragment="scripts">
    <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>
    <th:block th:replace="/common/approve_box :: approve_box"></th:block>
    <th:block th:replace="/common/ax5_uploader :: ax5_uploader" ></th:block>
    <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box" ></th:block>
    <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>

    <script type="text/javascript">

        // 슬라이드 차트 생성
        var chartVars = "rMateOnLoadCallFunction=chartReadyHandler";

        // 차트 초기화
        rMateChartH5.create("chart1", "chartHolder1", chartVars, "120%", "120%");

        function chartReadyHandler(id, chartHolderId, gridData) {
            // id에 해당하는 차트가 생성되었는지 확인
            var chart = document.getElementById(id);
            if (!chart) {
                // console.error("차트가 생성되지 않았습니다: " + id);
                return;
            }

            if (!gridData) {
                // console.error("그리드 데이터가 정의되지 않았습니다.");
                return;
            }

            // 그리드 데이터를 슬라이드 차트의 형식에 맞게 변환
            var transformedData = transformDataForChart(gridData);

            // 각 차트의 레이아웃 정의
            var layout1 = getCartesianLayout("Column3D", "3D Column Chart - MultiSeries", transformedData.fields);
            var layout2 = getCartesianLayout("Line2D", "Line Chart with ItemRenderer", transformedData.fields,
                ["CircleItemRenderer", "TriangleItemRenderer", "RectangleItemRenderer"] // 각 필드에 대한 itemRenderer 설정
            );
            var radarLayout = getRadarLayout(transformedData.fields);

            // 슬라이드 차트에 적용할 레이아웃과 데이터 배열 설정
            var layoutSet = [layout1, layout2, radarLayout];
            var dataSet = [transformedData.data, transformedData.data, transformedData.data];

            // 슬라이드 차트 레이아웃 및 데이터 설정
            document.getElementById(id).setSlideLayoutSet(layoutSet);
            document.getElementById(id).setSlideDataSet(dataSet);
        }

        // 차트 디자인 가이드 색상 코드
        const chartColors = [
            "#62b2fd",
            "#01dbab",
            "#ffa336",
            "#f99bab",
            "#55667f",
            "#82e8e8",
            "#909bff",
            "#f36f40"
        ];

        // 차트마다 형식이 다르기 때문에 다른 레이아웃 함수를 만들어야 합니다.
        // 다른 유형의 차트 이용시, layout 함수 추가해서 사용하세요.

        // Cartesian 차트 레이아웃 정의
        function getCartesianLayout(type, title, dataFields, itemRenderers = []) {
            var layout = "<rMateChart borderStyle='none'>"
                + "<Options><Caption text='" + title + "' fontFamily='Malgun Gothic'/>" // 차트 제목
                + "<SubCaption text='' textAlign='center' paddingBottom='20'/>" // 차트 부제목
                + "<Legend defaultMouseOverAction='true' useVisibleCheck='true'/>" // 범례
                + "<NumberFormatter id='numfmt' useThousandsSeparator='true'/></Options>"
                + "<" + type + "Chart showDataTips='true'>"
                + "<series>";

            for (var i = 0; i < dataFields.length; ++i) {
                var itemRenderer = itemRenderers[i] ? " itemRenderer='" + itemRenderers[i] + "'" : "";
                var color = chartColors[i % chartColors.length]; // 색상을 순서대로 할당

                if (type === "Line2D") {
                    layout += "<" + type + "Series yField='" + dataFields[i] + "' displayName='" + dataFields[i] + "' " + itemRenderer + ">"
                        + "<showDataEffect><SeriesInterpolate duration='700'/></showDataEffect>"
                        + "<lineStroke><Stroke color='" + color + "'/></lineStroke>" // 선 색상 적용
                        + "</" + type + "Series>";
                } else {
                    layout += "<" + type + "Series yField='" + dataFields[i] + "' displayName='" + dataFields[i] + "' " + itemRenderer + ">"
                        + "<showDataEffect><SeriesSlide direction='up' duration='700'/></showDataEffect>"
                        + "<fill>"
                        + "<SolidColor color='" + color + "'/>" // 색상 적용
                        + "</fill>"
                        + "</" + type + "Series>";
                }
            }

            layout += "</series>"
                + "<horizontalAxis>"
                + "<CategoryAxis categoryField='period'/>"
                + "</horizontalAxis>"
                + "<verticalAxis>"
                + "<LinearAxis formatter='{numfmt}'/>"
                + "</verticalAxis>"
                + "</" + type + "Chart>"
                + "</rMateChart>";

            return layout;
        }


        // Radar 차트 레이아웃 정의
        function getRadarLayout(dataFields) {
            var radarLayout =
                "<rMateChart borderStyle='none'>"
                + "<Options>"
                + "<Caption text='Radar Chart' fontFamily='Malgun Gothic'/>"
                + "<Legend defaultMouseOverAction='true' useVisibleCheck='true'/>" // 범례
                + "</Options>"
                + "<NumberFormatter id='numfmt' useThousandsSeparator='true'/>"
                + "<RadarChart type='polygon' paddingTop='20' paddingBottom='20' showDataTips='true'>"
                + "<radialAxis>"
                + "<LinearAxis id='rAxis' formatter='{numfmt}'/>"
                + "</radialAxis>"
                + "<radialAxisRenderers>"
                + "<Axis2DRenderer axis='{rAxis}' horizontal='true' tickPlacement='outside' tickLength='4'>"
                + "<axisStroke>"
                + "<Stroke color='#555555'/>"
                + "</axisStroke>"
                + "</Axis2DRenderer>"
                + "</radialAxisRenderers>"
                + "<angularAxis>"
                + "<CategoryAxis categoryField='period' displayName='Year'/>"
                + "</angularAxis>"
                + "<series>";

            for (var i = 0; i < dataFields.length; ++i) {
                var color = chartColors[i % chartColors.length]; // 색상 순서대로 적용

                radarLayout += "<RadarSeries field='" + dataFields[i] + "' displayName='" + dataFields[i] + "' fillLineArea='false'>"
                    + "<showDataEffect>"
                    + "<SeriesInterpolate duration='700'/>"
                    + "</showDataEffect>"
                    + "<lineStroke><Stroke color='" + color + "'/></lineStroke>" // 선 색상 적용
                    + "</RadarSeries>";
            }

            radarLayout += "</series>"
                + "</RadarChart>"
                + "</rMateChart>";

            return radarLayout;
        }



        // 그리드 데이터를 차트에 맞게 변환
        function transformDataForChart(gridData) {
            if (!gridData) {
                // console.error("그리드 데이터가 null 또는 정의되지 않았습니다.");
                return { fields: [], data: [] };
            }

            const dataFields = [];
            const chartData = [];

            // 데이터를 변환하여 차트에 사용할 수 있도록 변환
            gridData.forEach(row => {
                const dataItem = { period: row.period };
                for (const key in row) {
                    if (key !== 'period' && key !== 'powernm') {
                        if (!dataFields.includes(key)) {
                            dataFields.push(key);
                        }
                        dataItem[key] = row[key];
                    }
                }
                chartData.push(dataItem);
            });

            return {
                fields: dataFields,
                data: chartData
            };
        }


        // ===============================================================================


        //  그리드의 열 동적으로 생성
        function buildGridColumns(data) {
            const columns = [
                {binding: 'period', header: '기간', width: 180, align: 'center'},
            ];

            // 모든 powernm(발전기명)을 확인하여 열을 동적으로 생성
            const powerNames = [...new Set(data.map(item => item.powernm))];
            powerNames.forEach(powerName => {
                columns.push({
                    binding: powerName,
                    header: powerName,
                    width: "*",
                    align: 'right',
                    format: 'n0'
                });
            });

            return columns;
        }

        // 데이터 변환 + 그리드 업데이트
        function transformDataForGrid(data, periodType) {
            const gridData = {};

            data.forEach(row => {
                const period = row.period ? row.period.toString() : ''; // 기간 데이터가 없는 경우 빈 문자열로 설정
                const powernm = row.powernm ? row.powernm.toString() : ''; // 발전기명이 없는 경우 빈 문자열로 설정

                if (periodType === 'hourly') {
                    // 시간별 데이터를 처리하는 로직
                    for (let i = 1; i <= 24; i++) {
                        const hourKey = `hour${i.toString().padStart(2, '0')}`;
                        if (row[hourKey] !== undefined) {
                            const periodWithHour = `${period} ${i.toString().padStart(2, '0')}시`;
                            if (!gridData[periodWithHour]) {
                                gridData[periodWithHour] = { period: periodWithHour };
                            }
                            gridData[periodWithHour][powernm] = row[hourKey] ? parseFloat(row[hourKey].toString().replace(/,/g, '')) : 0;
                        }
                    }
                } else {
                    // 월별, 분기별, 반기별, 연도별 데이터를 처리하는 로직
                    if (!gridData[period]) {
                        gridData[period] = { period: period };
                    }
                    Object.keys(row).forEach(key => {
                        if (key !== 'period' && key !== 'powernm') {
                            // 쉼표 제거 후 숫자로 변환
                            gridData[period][powernm] = row[key] ? parseFloat(row[key].toString().replace(/,/g, '')) : 0;
                        }
                    });
                }
            });

            return Object.values(gridData);
        }

        // 그리드 생성
        function updateGrid(grid, data, periodType) {
            // console.log("Updating grid with data:", data); // 디버깅을 위한 로그 추가
            // console.log("Period Type:", periodType); // periodType이 올바르게 전달되었는지 확인

            const columns = buildGridColumns(data); // 그리드의 컬럼을 동적으로 생성
            const transformedData = transformDataForGrid(data, periodType); // 데이터를 그리드에 맞게 변환

            // console.log("Transformed Data:", transformedData); // 변환된 데이터 확인!

            // 그리드를 초기화하고 데이터를 설정
            grid.initialize({
                autoGenerateColumns: false,
                columns: columns,
                itemsSource: new wijmo.collections.CollectionView(transformedData), // 변환된 데이터를 소스로 설정
                showMarquee: true,
                isReadOnly: true,
                headersVisibility: wijmo.grid.HeadersVisibility.Column // 컬럼 헤더만 보이도록 설정 (행 헤더는 숨김)
            });

            // 이전 데이터를 완전히 초기화 후 새 데이터 적용
            grid.itemsSource = new wijmo.collections.CollectionView(transformedData);


            // 헤더 중앙 정렬을 위해 formatItem 이벤트 핸들러 추가
            grid.formatItem.addHandler((s, e) => {
                if (e.panel === s.columnHeaders) {
                    e.cell.style.textAlign = 'center';
                }
            });

            // 그리드 데이터를 차트에 전달하여 슬라이드 차트를 업데이트
            chartReadyHandler("chart1", "chartHolder1", transformedData);
        }

        // =======================================================================================
        // 검색 기능 미완

        // 검색
        function searchData() {
            const periodType = document.getElementById("periodType").value;
            let startDate, endDate, startHour, endHour;
            const generator = document.getElementById("genename").value; // 발전기명 선택

            // console.log("Selected powerid:", document.getElementById("genename").value);

            if (periodType === "hourly") {
                startDate = document.getElementById("startDate").value;
                startHour = document.getElementById("startHour").value;
                endHour = document.getElementById("endHour").value;
                endDate = startDate; // 시간별 조회에서는 시작 날짜와 종료 날짜가 동일

            } else if (periodType === "monthly") {
                startDate = document.getElementById("startDate").value;
                endDate = document.getElementById("endDate").value;

            } else if (periodType === "quarterly") {
                const startQuarter = document.getElementById("startQuarter").value;
                const endQuarter = document.getElementById("endQuarter").value;
                const selectedYear = document.getElementById("yearSelectTab1").value;

                // 분기 값을 연도와 함께 날짜 범위로 변환
                [startDate, endDate] = convertQuarterToDateRange(startQuarter, endQuarter, selectedYear);

            } else if (periodType === "halfyearly"){
                const startHalf = document.getElementById("startHalf").value;
                const endHalf = document.getElementById("endHalf").value;
                const selectedYear = document.getElementById("yearSelectTab1").value;

                // 반기 값을 연도와 함께 날짜 범위로 변환
                [startDate, endDate] = convertHalfYearToDateRange(startHalf, endHalf, selectedYear);
            } else  if (periodType === "yearly") {
                const startYear = document.getElementById("startYear").value;
                const endYear = document.getElementById("endYear").value;

                startDate = `${startYear}-01-01`; // 시작 연도의 1월 1일
                endDate = `${endYear}-12-31`; // 종료 연도의 12월 31일
            }

            let query = `/api/gene/upload/periodSearch?periodType=${periodType}&startdt=${startDate}&enddt=${endDate}&powerid=${generator}`;

            if (periodType === "hourly") {
                query += `&startHour=${startHour}&endHour=${endHour}`;
            }

            fetch(query)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        Alert.alert("", "데이터가 존재하지 않습니다.");
                    } else {
                        updateGrid(theGrid, data, periodType); // periodType 전달
                    }
                })
                .catch(error => console.error('Error fetching search data:', error));
        }


        // 분기별 기간을 날짜 범위로 변환
        function convertQuarterToDateRange(startQuarter, endQuarter, year) {
            const quarterToMonth = {
                Q1: ['01', '03'],
                Q2: ['04', '06'],
                Q3: ['07', '09'],
                Q4: ['10', '12']
            };

            const startMonth = quarterToMonth[startQuarter][0];
            const endMonth = quarterToMonth[endQuarter][1];

            const startDate = `${year}-${startMonth}-01`;
            const endDate = new Date(year, parseInt(endMonth), 0).toISOString().split('T')[0]; // 해당 월의 마지막 날짜 계산

            return [startDate, endDate];
        }

        // 반기별 기간을 날짜 범위로 변환
        function convertHalfYearToDateRange(startHalf, endHalf, year) {
            const halfToMonth = {
                H1: ['01', '06'],  // 상반기: 1월 ~ 6월
                H2: ['07', '12']   // 하반기: 7월 ~ 12월
            };

            const startMonth = halfToMonth[startHalf][0];
            const endMonth = halfToMonth[endHalf][1];

            const startDate = `${year}-${startMonth}-01`;
            const endDate = new Date(year, parseInt(endMonth), 0).toISOString().split('T')[0]; // 해당 월의 마지막 날짜 계산

            return [startDate, endDate];
        }


        function searchComparisonData() {
            const year = document.getElementById("yearSelect").value;
            const generator = document.getElementById("generatorSelect").value;
            const comparisonType = document.getElementById("comparisonType").value;

            let query = `/api/gene/upload/searchComparison?year=${year}&generator=${generator}&comparisonType=${comparisonType}`;

            fetch(query)
                .then(response => response.json())
                .then(data => {
                    // updateChart(chart2, data); // 차트 업데이트
                    updateGrid(theGrid2, data); // 그리드 업데이트
                })
                .catch(error => console.error('Error fetching comparison data:', error));
        }

        // ===================================================================================================


        // 페이지 로드 시
        function init() {

            document.getElementById("periodType").value = "monthly"; // 기본으로 월별이 선택되도록 설정

            loadYearlyData(); // 연도 데이터를 로드
            updateYearInPeriod(); // 조회연도 변경 시 조회기간의 연도도 동기화
            updatePeriodInputs(); // 페이지 로드 시 startDate와 endDate 초기화
            loadGeneratorNames(); // 발전기명을 서버에서 로드
            loadMonthlyData(); // 페이지 로드 시 월별 데이터 자동 로드

            // 슬라이드 차트 초기화
            chartReadyHandler("chart1", "chartHolder1", []); // 초기에는 빈 데이터로 초기화
            // chart1 = rMateChartH5.create("chart1", "chartHolder1", "", "120%", "120%");
            // chart2 = rMateChartH5.create("chart2", "chartHolder2", "", "100%", "100%");

            // 그리드 초기화
            theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                autoGenerateColumns: false, // 그리드 초기화 시 자동 생성된 열을 비활성화
                columns: [] // 초기 열 설정
            });


        }

        // DOM이 준비되었을 때 초기화 함수를 실행
        $(document).ready(function (e) {
            init();
        });

        // 월별 데이터
        function loadMonthlyData() {
            const generator = 'all';  // 기본적으로 전체 발전기명에 대해 로드

            // 최소/최대 날짜를 서버에서 받아오는 API 호출
            fetch('/api/gene/upload/dateRange')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(dateRange => {
                    const startDate = dateRange.startdt;  // 서버에서 받은 최소 날짜
                    const endDate = dateRange.enddt;      // 서버에서 받은 최대 날짜

                    let query = `/api/gene/upload/periodSearch?periodType=monthly&startdt=${startDate}&enddt=${endDate}&powerid=${generator}`;

                    return fetch(query);
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // console.log('Received data:', data); // 데이터 확인
                    // 서버로부터 데이터를 받아서 처리
                    if (!data || data.length === 0) {
                        // console.warn('No data received.');
                        // Alert.alert("", "데이터가 존재하지 않습니다.\n발전량 업로드 페이지를 확인해 주세요.")
                        return;
                    }

                    chartReadyHandler("chart1", "chartHolder1", data); // 차트 업데이트
                    updateGrid(theGrid, data); // 그리드 업데이트
                })
                .catch(error => console.error('Error fetching initial monthly data:', error));
        }


        // 발전기명
        function loadGeneratorNames() {
            fetch('/api/gene/upload/generatornames')
                .then(response => response.json())
                .then(generatorNames => {
                    const selectElement = document.getElementById('genename');
                    if (selectElement) {
                        selectElement.innerHTML = '<option value="all">전체</option>';
                        generatorNames.forEach(name => {
                            selectElement.innerHTML += `<option value="${name}">${name}</option>`;
                        });
                    }
                })
                .catch(error => console.error('Error loading generator names:', error));
        }

        // 조회기간 변동 함수 -> 입력 필드를 동적으로 업데이트
        function updatePeriodInputs() {
            const periodType = document.getElementById("periodType").value;
            const selectedYear = document.getElementById("yearSelectTab1").value; // 선택된 조회연도 가져오기
            const startDateContainer = document.getElementById("startDateContainer");
            const endDateContainer = document.getElementById("endDateContainer");

            // 기존 내용을 초기화
            startDateContainer.innerHTML = "";
            endDateContainer.innerHTML = "";
            
            if (periodType === "hourly") { // 시간별 조회가 선택된 경우
                const currentDate = new Date();
                const defaultMonth = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                const defaultDay = currentDate.getDate().toString().padStart(2, '0');

                startDateContainer.innerHTML = `
            <input type="date" id="startDate" name="startDate" value="${selectedYear}-${defaultMonth}-${defaultDay}">
        `;

                endDateContainer.innerHTML = `
            <select id="startHour" name="startHour" style="width: 60px;">
                ${generateHourOptions()}
            </select>
            -
            <select id="endHour" name="endHour" style="width: 60px;">
                ${generateHourOptions(true)}
            </select>
        `;
            } else if (periodType === "monthly") { // 월별 조회가 선택된 경우
                const startDate = `${selectedYear}-01`; // 선택된 연도의 1월
                const endDate = `${selectedYear}-12`; // 선택된 연도의 12월

                startDateContainer.innerHTML = `<input type="month" id="startDate" name="startDate" value="${startDate}">`;
                endDateContainer.innerHTML = `<input type="month" id="endDate" name="endDate" value="${endDate}">`;
            } else if (periodType === "quarterly") { // 분기별 조회가 선택된 경우
                const options = `
            <option value="Q1">1분기</option>
            <option value="Q2">2분기</option>
            <option value="Q3">3분기</option>
            <option value="Q4">4분기</option>
        `;
                startDateContainer.innerHTML = `<select id="startQuarter">${options}</select>`;
                endDateContainer.innerHTML = `<select id="endQuarter">${options}</select>`;
            } else if(periodType === "halfyearly") { // 반기별 조회가 선택된 경우
                const options = `
            <option value="H1">상반기</option>
            <option value="H2">하반기</option>
        `;
                startDateContainer.innerHTML = `<select id="startHalf">${options}</select>`;
                endDateContainer.innerHTML = `<select id="endHalf">${options}</select>`;
            } else if (periodType === "yearly") { // 연도별 조회가 선택된 경우
                // 조회연도에서 연도 목록을 가져와서 사용
                const yearSelectTab1 = document.getElementById("yearSelectTab1");
                const yearOptions = yearSelectTab1.innerHTML; // 이미 로드된 연도 옵션을 그대로 사용

                startDateContainer.innerHTML = `<select id="startYear">${yearOptions}</select>`;
                endDateContainer.innerHTML = `<select id="endYear">${yearOptions}</select>`;
            }
        }

        // 조회연도 변경 시 조회기간의 연도도 동기화
        function updateYearInPeriod() {
            const selectedYear = document.getElementById("yearSelectTab1").value;

            const startDateInput = document.getElementById("startDate");
            const endDateInput = document.getElementById("endDate");

            if (startDateInput && endDateInput) {
                startDateInput.value = `${selectedYear}-01`;
                endDateInput.value = `${selectedYear}-12`;
            }
        }

        // 조회연도 선택 요소에 이벤트 리스너 추가
        document.getElementById("yearSelectTab1").addEventListener("change", function() {
            updateYearInPeriod(); // 조회연도 변경 시 startDate와 endDate 갱신
            updatePeriodInputs(); // 연도 변경 시 기간 입력 필드 초기화
        });

        // 연도를 로드하고 기존 UI를 업데이트
        function loadYearlyData() {
            fetch('/api/gene/upload/distinctYears')
                .then(response => response.json())
                .then(years => {
                    const yearSelectTab1 = document.getElementById("yearSelectTab1");
                    const yearSelectTab2 = document.getElementById("yearSelectTab2");

                    // 기간유형이 연도별일 때 조회기간에 사용될 startSelect와 endSelect
                    const startSelect = document.getElementById("startSelect");
                    const endSelect = document.getElementById("endSelect");

                    // 기존 옵션 삭제
                    yearSelectTab1.innerHTML = '';
                    yearSelectTab2.innerHTML = '';
                    if (startSelect) startSelect.innerHTML = '';
                    if (endSelect) endSelect.innerHTML = '';

                    // 서버에서 가져온 연도 목록을 <option>으로 추가
                    years.forEach(year => {
                        const option1 = document.createElement('option');
                        option1.value = year;
                        option1.textContent = year;

                        yearSelectTab1.appendChild(option1);
                        yearSelectTab2.appendChild(option1.cloneNode(true));

                        if (startSelect && endSelect) {
                            const option2 = document.createElement('option');
                            option2.value = year;
                            option2.textContent = year;

                            startSelect.appendChild(option2);
                            endSelect.appendChild(option2.cloneNode(true));
                        }
                    });
                })
                .catch(error => console.error('Error loading years:', error));
        }


        // 시간 옵션 생성 함수
        /*function generateHourOptions(isEnd = false) {
            let options = '';
            for (let i = 1; i < 25; i++) { // 01~24
                const hour = i.toString().padStart(2, '0');
                options += `<option value="${hour}">${hour}</option>`;
            }
            // 시작 시간과 종료 시간을 기본 선택값으로 설정
            if (isEnd) {
                options = options.replace(`value="24"`, `value="24" selected`);
            } else {
                options = options.replace(`value="01"`, `value="01" selected`);
            }
            return options;
        }*/
        function generateHourOptions(isEnd = false) {
            return Array.from({length: 24}, (_, i) => {
                const hour = (i + 1).toString().padStart(2, '0');
                return `<option value="${hour}"${isEnd && hour === '24' || !isEnd && hour === '01' ? ' selected' : ''}>${hour}</option>`;
            }).join('');
        }
    </script>
</th:block>
</html>