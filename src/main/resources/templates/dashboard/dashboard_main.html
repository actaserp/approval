<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml" xmlns="http://www.w3.org/1999/html">
<style>
    #noticeModal .modal-content {
        width: 80vw;
        height: 80vh;
        max-width: 800px; /
    max-height: 600px;
    }
    #noticeHolder {
        width: 100%;
        height: 100%;
    }

    .popup-overlay,
    .popup-wrapper {
        display: none;
    }
</style>
<th:block layout:fragment="content">

    <!--- (레이아웃) Contents 영역 -->
    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap" style="margin-bottom:0">
            <div class="left">
                <h2>관리자 Dashboard</h2><a id="toggleButton" onclick="toggleSearchWrap()"><img
                    src="/images/icon/ico-down.png"
                    alt="알람 아이콘"></a>
                <!--                <a title="북마크" class="bookmark toggle">-->
                <!--                    내 메뉴-->
                <!--                </a>-->
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
            </ul>
        </div>
        <!-- Select -->
        <div class="search-wrap" id="searchWrap" style="display: none; padding-top:10px">
            <ul>
                <li>
                    <select title="사업장" id="search_spjangcd" name="search_sjangcd"
                            onchange="init()">
                        <option value="" hidden selected disabled>선택</option>
                        <option value="ZZ">성우에스피(주)</option>
                        <option value="PP">성우피앤비(주)</option>
                    </select>
                </li>
            </ul>
        </div>
        <div class="row row-1" style="margin-bottom: 0;">
            <div class="card-wrap swiper card-swiper">
                <div class="swiper-wrapper">
                    <div class="swiper-slide" data-index="1">
                        <section class="waitPayment">
                            <div class="title">
                                <h3>결재 대기</h3>
                                <a href="#" title="더보기" class="btn-plus"></a>
                            </div>
                            <dl>
                                <dd>
                                     - <span class="unit">건</span>
                                </dd>
                            </dl>
                        </section>
                    </div>
                    <div class="swiper-slide" data-index="2">
                        <section class="paymentProgress">
                            <div class="title">
                                <h3>결재</h3>
                                <a href="#" title="더보기" class="btn-plus"></a>
                            </div>
                            <dl>
                                <dd>
                                     - <span class="unit">건</span>
                                </dd>
                            </dl>
                            <!--                            <dl>-->
                            <!--                                <dt>전일대비</dt>-->
                            <!--                                <dd>-->
                            <!--                                    <span class="down"></span> 1.20 <span class="unit">%</span>-->
                            <!--                                </dd>-->
                            <!--                            </dl>-->
                        </section>
                    </div>
                    <div class="swiper-slide" data-index="3">
                        <section class="companion">
                            <div class="title">
                                <h3>반려</h3>
                                <a href="#" title="더보기" class="btn-plus"></a>
                            </div>
                            <dl>
                                <dd>
                                     - <span class="unit">건</span>
                                </dd>
                            </dl>
                            <!--                            <dl>-->
                            <!--                                <dt>전일대비</dt>-->
                            <!--                                <dd>-->
                            <!--                                    <span class="down"></span> 1.20 <span class="unit">%</span>-->
                            <!--                                </dd>-->
                            <!--                            </dl>-->
                        </section>
                    </div>
                    <div class="swiper-slide" data-index="4">
                        <section class="hold">
                            <div class="title">
                                <h3>보류</h3>
                                <a href="#" title="더보기" class="btn-plus"></a>
                            </div>
                            <dl>
                                <dd>
                                     - <span class="unit">건</span>
                                </dd>
                            </dl>
                            <!--                            <dl>-->
                            <!--                                <dt>전일대비</dt>-->
                            <!--                                <dd>-->
                            <!--                                    <span class="up"></span> 2.20 <span class="unit">%</span>-->
                            <!--                                </dd>-->
                            <!--                            </dl>-->
                        </section>
                    </div>
                    <div class="swiper-slide" data-index="5">
                        <section class="complete">
                            <div class="title">
                                <h3>완료</h3>
                                <a href="#" title="더보기" class="btn-plus"></a>
                            </div>
                            <dl>
                                <dd>
                                     - <span class="unit">건</span>
                                </dd>
                            </dl>
                            <!--                            <dl>-->
                            <!--                                <dt>전일대비</dt>-->
                            <!--                                <dd>-->
                            <!--                                    <span class="down"></span> 1.20 <span class="unit">%</span>-->
                            <!--                                </dd>-->
                            <!--                            </dl>-->
                        </section>
                    </div>
                </div> <!--//swiper-wrapper end -->
            </div> <!--//main-card-wrap end -->
        </div>

        <div class="col wp100">
            <section style="padding-top: 5px; padding-bottom: 5px; margin-bottom: 0;">
                <div class="title-wrap">
                    <ul class="tab-links-sub">
                        <li>
                            <a href="#tab1" title="주문의뢰 건수"></a>
                        </li>
                        <li>
                            <a href="#tab2" title="전년대비 건수"></a>
                        </li>
                        <li>
                            <a href="#tab3" title="당월 건수"></a>
                        </li>
                        <li>
                            <a href="#tab4" title="전월 건수"></a>
                        </li>
                    </ul>
                </div>

                <div class="tab-contents">
                    <div class="tab-row" style="display: flex; width: 100%; gap: 20px; margin-bottom: 3px;">
                        <section style="width: 50%; height: 260px; padding: 10px;">
                            <div class="tab-item-sub" id="tab1" style="height: 100%">
                                <h5>결재요청받은(일별) 데이터</h5>
                                <!--<div class="chart-wrap">
                                 &lt;!&ndash; <div id="chartHolder1"  style="width: 100%; height: 420px; padding-top: 13px"></div>&ndash;&gt;
                                    <canvas id="revenueChart"></canvas>
                                </div>-->
                                <div class="chart-wrap" style="justify-content: normal;position: relative;height: 210px;">
                                    <canvas id="revenueChart" width="740" height="185" style="width: 740px; height: 185px;"></canvas>
                                    <span class="material-symbols-outlined" style="position: absolute; top: 17px; right: 3px; cursor: pointer; z-index: 10; color: rgb(179, 179, 179);" onclick="openModal('revenueChart')">zoom_out_map</span>
                                </div>
                            </div>
                        </section>
                        <section style="width: 50%; height: 260px; padding: 10px;">
                            <div class="tab-item-sub" id="tab2" style="height: 100%">
                                <h5>결재요청받은(월별) 데이터</h5>
                                <!-- <div class="chart-wrap">
                                   &lt;!&ndash;<div id="chartHolder2"  style="width: 100%; height: 420px; padding-top: 13px"></div>&ndash;&gt;
                                     <canvas id="orderChart"></canvas>
                                 </div>-->
                                <div class="chart-wrap" style="justify-content: normal;position: relative;height: 210px;">
                                    <canvas id="orderChart" width="740" height="185" style="width: 740px; height: 185px;"></canvas>
                                    <span class="material-symbols-outlined" style="position: absolute; top: 17px; right: 3px; cursor: pointer; z-index: 10; color: rgb(179, 179, 179);" onclick="openModal('orderChart')">zoom_out_map</span>
                                </div>
                            </div>
                        </section>
                    </div>
                    <div class="tab-row" style="display: flex; width: 100%; gap: 20px; margin-bottom: 3px;">
                        <section style="width: 50%; height: 260px; padding: 10px;">
                            <div class="tab-item-sub" id="tab3" style="height: 100%">
                                <h5>결재 올린(일별) 데이터</h5>
                                <!--<div class="chart-wrap">
                                  &lt;!&ndash;<div id="chartHolder3"  style="width: 100%; height: 420px; padding-top: 13px"></div>&ndash;&gt;
                                    <canvas id="estimateChart"></canvas>
                                </div>-->
                                <div class="chart-wrap" style="justify-content: normal;position: relative;height: 210px;">
                                    <canvas id="estimateChart" width="740" height="185" style="width: 740px; height: 185px;"></canvas>
                                    <span class="material-symbols-outlined" style="position: absolute; top: 17px; right: 3px; cursor: pointer; z-index: 10; color: rgb(179, 179, 179);" onclick="openModal('estimateChart')">zoom_out_map</span>
                                </div>
                            </div>
                        </section>
                        <section style="width: 50%; height: 260px; padding: 10px;">
                            <div class="tab-item-sub" id="tab4" style="height: 100%">
                                <h5>결재 올린(월별) 데이터</h5>
                                <!--<div class="chart-wrap">
                                  &lt;!&ndash;<div id="chartHolder4"  style="width: 100%; height: 420px; padding-top: 13px"></div>&ndash;&gt;
                                    <canvas id="requestChart"></canvas>
                                </div>-->
                                <div class="chart-wrap" style="justify-content: normal;position: relative;height: 210px;">
                                    <canvas id="requestChart" width="740" height="185" style="width: 740px; height: 185px;"></canvas>
                                    <span class="material-symbols-outlined" style="position: absolute; top: 17px; right: 3px; cursor: pointer; z-index: 10; color: rgb(179, 179, 179);" onclick="openModal('requestChart')">zoom_out_map</span>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </section>
        </div>
    </div> <!--//layout-contents end -->
    <footer>
        <p>Copyrightⓒ 0000 corp. All rights reserved.</p>
    </footer>
    </div>

    <div style="height: 10px"></div>

    <!--공지사항 모달-->
    <div class="dashboard-layout-popup">
        <div class="popup-overlay" id="popup1" style="background-color: rgba(0, 0, 0, 0.6); position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 999;"></div>

        <div class="popup-wrapper" id="wrapper1" style="position: fixed; top: 20%; left: 50%; transform: translateX(-50%); width: 360px; background: #fff; padding: 24px; border-radius: 8px; z-index: 1000; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);">

            <!-- 제목 -->
            <div class="popup-title" style="text-align: center;">
                <h2 id="noticeTitle" style="font-size: 28px; font-weight: bold; color: #333;">공지 제목</h2>
            </div>
            <!-- 등록일 + 입력자 같은 줄에 표시 -->
            <div class="popup-title" style="display: flex; justify-content: space-between; align-items: center; padding: 0 20px; margin-top: 10px;">
                <!-- 등록 날짜 (왼쪽 정렬) -->
                <h4 id="noticePeriod" style="color: #444; font-size: 18px; font-weight: normal; margin: 0;">
                </h4>
                <!-- 입력자 (오른쪽 정렬) -->
                <h4 id="noticePernm" style="color: #444; font-size: 18px; font-weight: normal; margin: 0;">
                </h4>
            </div>
            <div style="border-top: 1px solid #ccc; margin: 16px auto 20px; width: 95%;"></div>
            <!-- 본문 내용 -->
            <div class="popup-contents" style="margin-top: 16px; font-size: 20px; color: #444; text-align: left; line-height: 1.6;">
                <span style="display: block; padding-left: 20px;">공지 내용이 여기에 출력됩니다.</span>
            </div>

            <!-- 버튼 영역 -->
            <div class="popup-button" style="display: flex; justify-content: space-between; margin-top: 24px;">
                <!-- 오늘 하루 보지 않기 버튼 -->
                <button id="fileDownloadArea" style="flex: 1; margin-right: 8px; padding: 10px 0; background-color: #FFFFFF; color: #444; border-radius: 4px; border: 2px solid #ccc;">첨부파일 다운로드</button>
                <button onclick="noticeClose()" style="flex: 1; padding: 10px 0; background-color: #3069B3; color: #fff; border: none; border-radius: 4px;">확인</button>
            </div>
            <span style="display: flex; justify-content: center; align-items: center; margin-top: 20px;">
                <input type="checkbox" id="checkNotice" style="margin: 0;">
                <p style="margin-left: 10px; font-size: 14px;">오늘 하루 보지 않기</p>
            </span>
        </div>
    </div>



</th:block>
<th:block layout:fragment="scripts">
    <th:block th:replace="/common/approve_box :: approve_box"></th:block>
    <th:block th:replace="/common/ax5_uploader :: ax5_uploader"></th:block>
    <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box"></th:block>
    <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/nth-tabs.js"></script>
    <script type="text/javascript">

        var theGrid;
        var viewdata;
        let csrfToken = $("[name=_csrf]").val();

        // 오늘 날짜 가져오기
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}.${month}.${day}`;
        }

        function updateTitle() {
            const titleElement = document.getElementById("requestDate");
            if (titleElement) {
                titleElement.textContent = `주문등록 (${getTodayDate()})`;
            }
        }

        document.addEventListener("DOMContentLoaded", updateTitle);
        // 모달 열기 함수
        function openModal(chartId) {
            // 아이콘 숨기기
            document.querySelector('.material-symbols-outlined').style.display = 'none';

            let chartInstance = $(`#${chartId}`).data('chart'); // 클릭된 차트의 인스턴스 가져오기
            if (!chartInstance) {
                console.error("차트를 찾을 수 없습니다.");
                return;
            }

            // 모달 열기
            let modal = $('#chartModal');
            modal.show();

            // 모달 캔버스 컨텍스트 가져오기
            let modalChartHolder = $('#modalChartHolder')[0].getContext('2d');
            // 기존 모달 차트가 있으면 삭제 후 생성 (중복 생성 방지)
            if (window.modalChartInstance) {
                window.modalChartInstance.destroy();
            }

            // 약간의 지연 후 차트 생성하여 크기 문제 해결
            setTimeout(() => {
                window.modalChartInstance = new Chart(modalChartHolder, {
                    type: chartInstance.config.type,
                    data: chartInstance.config.data,
                    options: {
                        ...chartInstance.config.options,
                        responsive: true,
                        maintainAspectRatio: false // 모달 크기에 맞추도록 설정
                    }
                });

                // 강제로 리사이즈하여 모달의 크기 맞춤
                window.modalChartInstance.resize();
            }, 3); // 지연 시간 조정
        }
        // 페이지 로드 후 모든 차트 생성 및 이벤트 바인딩
        $(document).ready(function () {

            // 모달 닫기 이벤트
            $(document).on('click', '.close', function () {
                $('#chartModal').hide();
                if (window.modalChartInstance) {
                    window.modalChartInstance.destroy();
                    window.modalChartInstance = null; // 인스턴스 초기화
                }
            });

            // 모달 외부 클릭 시 닫기
            $(window).on('click', function (event) {
                if ($(event.target).is('#chartModal')) {
                    $('#chartModal').hide();
                    if (window.modalChartInstance) {
                        window.modalChartInstance.destroy();
                        window.modalChartInstance = null; // 인스턴스 초기화
                    }
                    document.querySelector('.material-symbols-outlined').style.display = 'inline'; // 아이콘 다시 보이기
                }
            });
        });

        var swiper = new Swiper(".card-swiper", {
            slidesPerView: 5,
            spaceBetween: 20,
            loop: true,  // 무한 반복 유지
            speed: 600,
            autoplay: {
                delay: 2500,
                disableOnInteraction: false,
            },
            navigation: {
                nextEl: ".swiper-button-next",
                prevEl: ".swiper-button-prev",
            },
            on: {
                loopFix: function () {
                    // 🔥 Swiper가 복제된 슬라이드를 원래 위치로 조정할 때 실행됨
                    let slides = document.querySelectorAll(".swiper-slide");
                    slides.forEach(slide => {
                        let index = slide.getAttribute("data-index");
                        let originalSlide = document.querySelector(`.swiper-slide[data-index="${index}"]:not(.swiper-slide-duplicate)`);

                        if (originalSlide) {
                            let bgColor = window.getComputedStyle(originalSlide.querySelector("section")).backgroundColor;
                            let textColor = window.getComputedStyle(originalSlide.querySelector("section")).color;

                            slide.querySelector("section").style.backgroundColor = bgColor;
                            slide.querySelector("section").style.color = textColor;
                        }
                    });
                }
            },
            observer: true,         // 변화 감지 활성화
            observeParents: true,   // 부모 요소의 변화도 감지
        });



        document.readyState === 'complete' ? init() : window.onload = init;
        let isBindSpjangcdCalled = false;
        // document.getElementById('search_spjangcd')를 기준으로 페이지 reload
        function init() {
            searchData()
            if (!isBindSpjangcdCalled) {
                bindSpjangcd();
                isBindSpjangcdCalled = true; // 플래그 업데이트
            }
            // 모든 tab에서 아이콘을 숨기기
            const zoomIcons = document.querySelectorAll('.chart-wrap .material-symbols-outlined');
            zoomIcons.forEach(icon => {
                icon.style.display = 'none'; // 또는 icon.style.visibility = 'hidden';
            });
            isNotice();
        }
        // 전체 데이터 불러오기
        function searchData(){
            let data2 = [];
            const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
            const ctxOrder = document.getElementById('orderChart').getContext('2d');
            const ctxEstimate = document.getElementById('estimateChart').getContext('2d');
            const ctxRequest = document.getElementById('requestChart').getContext('2d');

            // 기존 차트 인스턴스가 있으면 제거
            if ($('#revenueChart').data('chart')) {
                $('#revenueChart').data('chart').destroy();
            }
            if ($('#orderChart').data('chart')) {
                $('#orderChart').data('chart').destroy();
            }
            if ($('#estimateChart').data('chart')) {
                $('#estimateChart').data('chart').destroy();
            }
            if ($('#requestChart').data('chart')) {
                $('#requestChart').data('chart').destroy();
            }
            $.ajax({
                url: '/api/dashboard2/LastYearCnt',
                type: 'GET',
                data: {
                    'search_spjangcd': $('#search_spjangcd').val()
                },
                async: false,
                success: function (data) {
                    data2 = data.data;
                    console.log("data2 : ", data2);

                    // 차트작업
                    // 결재요청받은(일별) 데이터
                    // ✅ 데이터 매핑
                    let ThisMonthResCntOfDate = data2.ThisMonthResCntOfDate; // 올해 상태값별 데이터

                    // ✅ X축 레이블: 날짜 (YYYY-MM-DD → MM-DD 형식)
                    const labels = ThisMonthResCntOfDate.map(item => item.repodate.slice(4, 6) + "-" + item.repodate.slice(6, 8));

                    // ✅ 상태값별 데이터 정리 (Stacked Bar)
                    const stackedBarData = {
                        "appgubun001": ThisMonthResCntOfDate.map(item => item.appgubun001),
                        "appgubun101": ThisMonthResCntOfDate.map(item => item.appgubun101),
                        "appgubun131": ThisMonthResCntOfDate.map(item => item.appgubun131),
                        "appgubun201": ThisMonthResCntOfDate.map(item => item.appgubun201),
                        "totalCnt": ThisMonthResCntOfDate.map(item => item.totalCnt),
                    };

                    // ✅ Stacked Bar 데이터 생성
                    const chartData = {
                        labels: labels,
                        datasets: [
                            {
                                label: "대기",
                                type: 'bar',
                                data: stackedBarData["appgubun001"],
                                backgroundColor: 'rgba(98, 178, 253, 0.7)',
                                borderColor: 'rgba(98, 178, 253, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },
                            {
                                label: "결재",
                                type: 'bar',
                                data: stackedBarData["appgubun101"],
                                backgroundColor: 'rgba(253, 98, 98, 0.7)',
                                borderColor: 'rgba(253, 98, 98, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },
                            {
                                label: "반려",
                                type: 'bar',
                                data: stackedBarData["appgubun131"],
                                backgroundColor: 'rgba(255, 206, 86, 0.7)',
                                borderColor: 'rgba(255, 206, 86, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },
                            {
                                label: "보류",
                                type: 'bar',
                                data: stackedBarData["appgubun201"],
                                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },

                        ]
                    };

                    // ✅ 차트 옵션 설정
                    const chartOptions = {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                position: 'left'
                            },
                        }
                    };

                    // ✅ 차트 생성
                    const ctx = document.getElementById('revenueChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar', // 기본 차트 유형
                        data: chartData,
                        options: chartOptions
                    });

                    // 결재요청받은(월별) 데이터
                    // ✅ 데이터 매핑
                    let ThisYearResCntOfMonth = data2.ThisYearResCntOfMonth; // 올해 상태값별 데이터

                    // ✅ X축 레이블: 월 (YYYY-MM → MM월 형식)
                    const labels2 = ThisYearResCntOfMonth.map(item => item.YearMonth.slice(-2) + "월");

                    // ✅ 상태값별 데이터 정리 (Stacked Bar)
                    const stackedBarData2 = {
                        "appgubun001": ThisYearResCntOfMonth.map(item => item.appgubun001),
                        "appgubun101": ThisYearResCntOfMonth.map(item => item.appgubun101),
                        "appgubun131": ThisYearResCntOfMonth.map(item => item.appgubun131),
                        "appgubun201": ThisYearResCntOfMonth.map(item => item.appgubun201),
                        "totalCnt": ThisYearResCntOfMonth.map(item => item.totalCnt),
                    };

                    // ✅ Stacked Bar 데이터 생성
                    const chartData2 = {
                        labels: labels2,
                        datasets: [
                            {
                                label: "대기",
                                type: 'bar',
                                data: stackedBarData2["appgubun001"],
                                backgroundColor: 'rgba(98, 178, 253, 0.7)',
                                borderColor: 'rgba(98, 178, 253, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },
                            {
                                label: "결재",
                                type: 'bar',
                                data: stackedBarData2["appgubun101"],
                                backgroundColor: 'rgba(253, 98, 98, 0.7)',
                                borderColor: 'rgba(253, 98, 98, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },
                            {
                                label: "반려",
                                type: 'bar',
                                data: stackedBarData2["appgubun131"],
                                backgroundColor: 'rgba(255, 206, 86, 0.7)',
                                borderColor: 'rgba(255, 206, 86, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },
                            {
                                label: "보류",
                                type: 'bar',
                                data: stackedBarData2["appgubun201"],
                                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },

                        ]
                    };

                    // ✅ 차트 옵션 설정
                    const chartOptions2 = {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                position: 'left'
                            },
                        }
                    };

                    // ✅ 차트 생성
                    const ctx2 = document.getElementById('orderChart').getContext('2d');
                    new Chart(ctx2, {
                        type: 'bar', // 기본 차트 유형
                        data: chartData2,
                        options: chartOptions2
                    });

                    // 결재올린(일별) 데이터
                    // ✅ 데이터 매핑
                    let ThisMonthReqCntOfDate = data2.ThisMonthReqCntOfDate; // 올해 상태값별 데이터

                    // ✅ X축 레이블: 날짜 (YYYY-MM-DD → MM-DD 형식)
                    const labels3 = ThisMonthReqCntOfDate.map(item => item.repodate.slice(4, 6) + "-" + item.repodate.slice(6, 8));

                    // ✅ 상태값별 데이터 정리 (Stacked Bar)
                    const stackedBarData3 = {
                        "appgubun001": ThisMonthReqCntOfDate.map(item => item.appgubun001),
                        "appgubun101": ThisMonthReqCntOfDate.map(item => item.appgubun101),
                        "appgubun131": ThisMonthReqCntOfDate.map(item => item.appgubun131),
                        "appgubun201": ThisMonthReqCntOfDate.map(item => item.appgubun201),
                        "totalCnt": ThisMonthReqCntOfDate.map(item => item.totalCnt),
                    };

                    // ✅ Stacked Bar 데이터 생성
                    const chartData3 = {
                        labels: labels3,
                        datasets: [
                            {
                                label: "대기",
                                type: 'bar',
                                data: stackedBarData3["appgubun001"],
                                backgroundColor: 'rgba(98, 178, 253, 0.7)',
                                borderColor: 'rgba(98, 178, 253, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },
                            {
                                label: "결재",
                                type: 'bar',
                                data: stackedBarData3["appgubun101"],
                                backgroundColor: 'rgba(253, 98, 98, 0.7)',
                                borderColor: 'rgba(253, 98, 98, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },
                            {
                                label: "반려",
                                type: 'bar',
                                data: stackedBarData3["appgubun131"],
                                backgroundColor: 'rgba(255, 206, 86, 0.7)',
                                borderColor: 'rgba(255, 206, 86, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },
                            {
                                label: "보류",
                                type: 'bar',
                                data: stackedBarData3["appgubun201"],
                                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },

                        ]
                    };

                    // ✅ 차트 옵션 설정
                    const chartOptions3 = {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                position: 'left'
                            },
                        }
                    };

                    // ✅ 차트 생성
                    const ctx3 = document.getElementById('estimateChart').getContext('2d');
                    new Chart(ctx3, {
                        type: 'bar', // 기본 차트 유형
                        data: chartData3,
                        options: chartOptions3
                    });

                    // 결재요청받은(월별) 데이터
                    // ✅ 데이터 매핑
                    let ThisYearReqCntOfMonth = data2.ThisYearReqCntOfMonth; // 올해 상태값별 데이터

                    // ✅ X축 레이블: 월 (YYYY-MM → MM월 형식)
                    const labels4 = ThisYearReqCntOfMonth.map(item => item.YearMonth.slice(-2) + "월");

                    // ✅ 상태값별 데이터 정리 (Stacked Bar)
                    const stackedBarData4 = {
                        "appgubun001": ThisYearReqCntOfMonth.map(item => item.appgubun001),
                        "appgubun101": ThisYearReqCntOfMonth.map(item => item.appgubun101),
                        "appgubun131": ThisYearReqCntOfMonth.map(item => item.appgubun131),
                        "appgubun201": ThisYearReqCntOfMonth.map(item => item.appgubun201),
                        "totalCnt": ThisYearReqCntOfMonth.map(item => item.totalCnt),
                    };

                    // ✅ Stacked Bar 데이터 생성
                    const chartData4 = {
                        labels: labels4,
                        datasets: [
                            {
                                label: "대기",
                                type: 'bar',
                                data: stackedBarData4["appgubun001"],
                                backgroundColor: 'rgba(98, 178, 253, 0.7)',
                                borderColor: 'rgba(98, 178, 253, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },
                            {
                                label: "결재",
                                type: 'bar',
                                data: stackedBarData4["appgubun101"],
                                backgroundColor: 'rgba(253, 98, 98, 0.7)',
                                borderColor: 'rgba(253, 98, 98, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },
                            {
                                label: "반려",
                                type: 'bar',
                                data: stackedBarData4["appgubun131"],
                                backgroundColor: 'rgba(255, 206, 86, 0.7)',
                                borderColor: 'rgba(255, 206, 86, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },
                            {
                                label: "보류",
                                type: 'bar',
                                data: stackedBarData4["appgubun201"],
                                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                stack: 'stacked'
                            },

                        ]
                    };

                    // ✅ 차트 옵션 설정
                    const chartOptions4 = {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                position: 'left'
                            },
                        }
                    };

                    // ✅ 차트 생성
                    const ctx4 = document.getElementById('requestChart').getContext('2d');
                    new Chart(ctx4, {
                        type: 'bar', // 기본 차트 유형
                        data: chartData4,
                        options: chartOptions4
                    });


                    // 카드 작업
                    // 올해 상태값별 데이터
                    let ThisYearCnt = data2.ThisYearCnt;
                    // appgubun 001인 TotalCount 추출
                    const thisYearCountOf0 = ThisYearCnt.find(item => item.appgubun === '001')?.TotalCount || 0;
                    // 결과를 HTML에 업데이트
                    const requestSection = document.querySelector('.waitPayment dl dd');
                    requestSection.innerHTML = `${thisYearCountOf0} <span class="unit">건</span>`;
                    // appgubun가 101인 TotalCount 추출
                    const thisYearCountOf1 = ThisYearCnt.find(item => item.appgubun === '101')?.TotalCount || 0;
                    const checkSection = document.querySelector('.paymentProgress dl dd');
                    checkSection.innerHTML = `${thisYearCountOf1} <span class="unit">건</span>`;
                    // appgubun가 131인 TotalCount 추출
                    const thisYearCountOf2 = ThisYearCnt.find(item => item.appgubun === '131')?.TotalCount || 0;
                    const orderSection = document.querySelector('.companion dl dd');
                    orderSection.innerHTML = `${thisYearCountOf2} <span class="unit">건</span>`;
                    // appgubun가 201인 TotalCount 추출
                    const thisYearCountOf3 = ThisYearCnt.find(item => item.appgubun === '201')?.TotalCount || 0;
                    const productSection = document.querySelector('.hold dl dd');
                    productSection.innerHTML = `${thisYearCountOf3} <span class="unit">건</span>`;
                    //  TotalCount 추출
                    const thisYearCountOf4 = thisYearCountOf1 + thisYearCountOf2 + thisYearCountOf3
                    const deliverySection = document.querySelector('.complete dl dd');
                    deliverySection.innerHTML = `${thisYearCountOf4} <span class="unit">건</span>`;

                }
            })
        }
        function bindSpjangcd() {
            $.ajax({
                url: '/api/dashboard2/bindSpjangcd',
                type: 'GET',
                async: false,
                success: function (data) {
                    data2 = data.data;
                    const selectElement = document.getElementById('search_spjangcd');
                    if (selectElement) {
                        selectElement.value = data2; // value 속성으로 선택
                    }
                }
            })
        }
        // 가이드 web 팝업창 열기
        function openPopup(url) {
            // 새 창 열기
            window.open(url, '_blank',
                'width=1040,height=1000,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes');
        }
        // 주문상태별 카드 클릭시 주문확인 페이지로 이동
        $(document).ready(function () {
            $(".request, .check, .order, .product, .delivery, .cancel").click(function () {
                var section = $(this).attr("class"); // 클릭한 버튼의 클래스 가져오기
                var searchStateValue = getSearchState(section); // 해당 섹션에 맞는 searchState 가져오기

                // sessionStorage에 저장
                sessionStorage.setItem("activeSection", section);
                sessionStorage.setItem("searchState", searchStateValue);

                // postMessage로 탭 추가 요청
                window.parent.postMessage({
                    action: "addTab",
                    id: "order_status",
                    title: "주문현황",
                    url: '/gui/' + "order_status" + '/default',
                    active: true,
                    allowClose: true,
                }, "*");
            });

            // searchState 값을 반환하는 메서드
            function getSearchState(section) {
                var stateMapping = {
                    "request": "0",
                    "check": "1",
                    "order": "2",
                    "product": "3",
                    "delivery": "4",
                    "cancel": "5"
                };
                return stateMapping[section] || "0"; // 매핑된 값이 없으면 default 반환
            }
        });
        // 공지사항 게시기간중일 경우 로그인시 띄우기 및 첨부파일 다운로드, 오늘하루 안보기 체크박스 구현
        function isNotice() {
            $.ajax({
                url: '/api/dashboard2/isNotice',
                type: 'GET',
                data: {
                    'search_spjangcd': $('#search_spjangcd').val()
                },
                async: false,
                success: function (data) {
                    let data2 = data.data;
                    console.log("data2 : ", data2);

                    let cookie = document.cookie;

                    let hasNoticeData = Array.isArray(data2) && data2.length > 0;
                    let hasNoCookie = !document.cookie.includes('noticeCheck=true');

                    if (hasNoticeData && hasNoCookie) {
                        document.querySelector('.popup-contents span').innerText = data2[0].BBSTEXT || "공지 내용이 없습니다.";
                        document.getElementById('noticeTitle').innerHTML =
                            data2[0].BBSSUBJECT;

                        document.getElementById('noticePeriod').innerHTML =
                            data2[0].BBSFRDATE;
                        document.getElementById('noticePernm').innerHTML =
                            data2[0].pernm;

                        const fileArea = document.getElementById("fileDownloadArea");
                        fileArea.innerHTML = '';

                        if (Array.isArray(data2[0].filelist)) {
                                const btn = document.createElement("a");
                                btn.className = "btn-filedown";
                                btn.innerText = `첨부파일다운로드`;
                                btn.onclick = function () {
                                    downloadFile_order(data2);
                                };
                                fileArea.appendChild(btn);
                        }
                        let popup = document.getElementById('popup1');
                        let wrapper = document.getElementById('wrapper1');
                        popup.style.display = 'block';
                        wrapper.style.display = 'block';
                    }
                }
            })
        }
        function noticeClose() {
            let popup = document.getElementById('popup1');
            let wrapper = document.getElementById('wrapper1');
            popup.style.display = 'none';
            wrapper.style.display = 'none';

            let checkbox = document.getElementById('checkNotice');
            if (checkbox && checkbox.checked) {
                // 오늘 자정까지 쿠키 유지
                let expire = new Date();
                expire.setHours(23, 59, 59, 999);
                document.cookie = "noticeCheck=true; path=/; expires=" + expire.toUTCString() + ";";
            }
        }
        // 다운로드
        function downloadFile_order(data) {
            let downloadList = [];

            // 선택된 항목에서 다운로드할 파일 목록 생성
            data.forEach(function (item) {
                // filelist 배열을 순회하여 downloadList에 추가
                if (item.filelist && Array.isArray(item.filelist)) {
                    item.filelist.forEach(function (file) {
                        downloadList.push({
                            filepath: file.filepath, // 개별 파일 경로
                            filesvnm: file.filesvnm, // 개별 저장된 파일 이름 (uuid)
                            fileornm: file.fileornm  // 개별 원본 파일 이름
                        });
                    });
                }
            });

            // 다운로드 URL 지정
            let downloadUrl = '/api/announcement/downloader';

            // Jung.js에서 정의한 downloadFiles 함수 호출
            downloadFiles(downloadList, downloadUrl);
        }



    </script>
</th:block>
</html>