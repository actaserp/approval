<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
    <style>
        .tab-item2.tab-content1 {
            display: block;
            padding-bottom: 0;
            border-radius: 0 15px 0 0 !important;
            border-bottom: 0;
            border-bottom-style: none;
        }

        .tab-contents > section, .tab-item > .row > section:first-child {
            border-radius: 0 0 15px 15px;
            border: 0 !important;
            box-shadow: 0 0 !important;
        }


    </style>
</head>
<th:block layout:fragment="content">

    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>장비 알림 이력</h2><a id="toggleButton" onclick="toggleSearchWrap()"><img src="/images/icon/ico-down.png"
                                                                                        alt="알람 아이콘"></a>
                <a title="북마크" class="bookmark toggle">
                    내메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>모니터링</li>
                <li>종합관제</li>
                <li>장비 알림 이력</li>
            </ul>
        </div>
        <!-- Select -->
        <div class="search-wrap" id="searchWrap" style="display: none">
            <ul>
                <li>
                    <select title="지역" id="spworkcd" name="spworkcd"
                            onchange="updateCompcdOptions(); saveSelectedSandanData(); ">
                        <!-- 지역 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spworknm" name="spworknm">
                </li>
                <li>
                    <select title="산단" id="spcompcd" name="spcompcd"
                            onchange="updatePlancdOptions(); saveSelectedSandanData();">
                        <!-- 산단 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spcompnm" name="spcompnm">
                </li>
                <li>
                    <select title="시설" id="spplancd" name="spplancd"
                            onchange="updatePlannm(); saveSelectedSandanData()">
                        <!-- 시설 옵션을 JavaScript에서 동적으로 채움 -->
                    </select>
                    <input type="hidden" id="spplannm" name="spplannm">
                </li>
            </ul>
        </div>
        <div class="tab-wrap" id="jqueryTabs">
            <ul class="tab-links">
                <li><a href="#tab1" title="통합" class="tab-button">통합</a></li>
                <li><a href="#tab2" title="상세" class="tab-button">상세</a></li>
            </ul>
            <div class="tab-contents" style="margin-bottom: 70px">

                <section class="tab-item2 tab-content1">
                    <!-- 공통 검색 조건 -->
                    <div class="section-top">
                        <div class="search-wrap">
                            <!-- 검색 조건 코드 -->
                            <dl>
                                <dt><label for="division">구분<span class="eq">*</span></label></dt>
                                <dd>
                                    <select id="division" class="w120">
                                        <option selected>전체</option>
                                        <option>Fault</option>
                                        <option>Alarm</option>
                                        <option>통신이상</option>
                                        <option>가스누출</option>
                                        <option>연료전지 고온</option>
                                        <option>계통연계</option>
                                    </select>
                                </dd>
                            </dl>
                            <dl>
                                <dt><label for="periodType">검색조건<span class="eq">*</span></label></dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <select id="periodType" name="periodType" onchange="updatePeriodInputs()">
                                                <option value="byday" selected>일별</option>
                                                <option value="byweek">주간별</option>
                                                <option value="bymonth">월별</option>
                                                <option value="byyear">연도별</option>
                                            </select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                            <dl>
                                <dt>조회기간<span class="eq">*</span></dt>
                                <dd>
                                    <ul class="date-box">
                                        <li id="startDateContainer">
                                        </li>
                                        <li id="endDateContainer">
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                            <dl>
                                <dt><label for="confirm">확인여부</label></dt>
                                <dd>
                                    <select id="confirm" class="w120">
                                        <option>전체</option>
                                        <option>확인</option>
                                        <option>미확인</option>
                                    </select>
                                </dd>
                            </dl>
                            <dl>
                                <dt><label for="btn-search"></label></dt>
                                <dd>
                                    <ul>
                                        <li>
                                            <a class="btn btn-delete" title="검색" id="btn-search" onclick="searchData()">
                                                <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                                검색
                                            </a>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>
                        </div>
                    </div> <!--//section-top end -->
                </section>

                <!-- 통합 영역 -->
                <section class="tab-item tab-content" id="tab1">
                    <div class="row">
                        <div class="row row-2" style="width: 100%">
                            <section class="wp60" style="height: 680px">
                                <!-- 그래프 -->
                                <div class="chart-wrap">
                                    <div id="chartHolder1" style="height:450px; width:100%;"></div>
                                </div>
                            </section>
                            <section class="wp40" style="height: 680px">
                                <div class="chart-wrap">
                                    <div id="chartHolder2" style="height:450px; width:100%;"></div>
                                </div>
                            </section>
                        </div>
                    </div>
                </section>

                <!-- 상세 영역 -->
                <section class="tab-item tab-content" id="tab2">
                    <div class="container-fluid">
                        <p id="selectedItem"></p>
                        <div id="theGrid" style="max-height: 680px"></div>
                    </div>
                </section>
            </div> <!--//tab-contens end-->
        </div> <!--//tab-wrap end-->


    </div> <!--//layout-contents end -->


</th:block>
<th:block layout:fragment="scripts">
    <th:block th:replace="/common/approve_box :: approve_box"></th:block>
    <th:block th:replace="/common/ax5_uploader :: ax5_uploader"></th:block>
    <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box"></th:block>
    <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>


    <script type="text/javascript">


        var theGrid;

        document.readyState === 'complete' ? init() : window.onload = init;


        <!-- 초반 페이지 진입시 그리드 바인딩 끝-->
        function init() {
            fetchListData();
            initializeSelections();
            updatePeriodInputs();
        }

        var columns = [
            {binding: 'occurDateTime', header: '발생일시', align: 'center', width: 190},
            {binding: 'device', header: '장비', align: 'center', width: 190},
            {binding: 'eventContent', header: '이벤트내용', align: 'center', minWidth: 270, width: '*'},
            {binding: 'actionDateTime', header: '조치일시', align: 'center', minWidth: 170, width: '*'},
            {binding: 'actionUser', header: '조치자', align: 'center', width: 210},
            {binding: 'actionContent', header: '조치내용', align: 'center', minWidth: 210, width: '*'},
            {binding: 'confirmed', header: '확인', align: 'center', width: 140},
        ];

        function fetchListData() {
            let data2 = [];
            const categories1 = ['Fault', 'Alarm', '통신이상', '가스누출', '연료전지 고온', '계통연계'];
            const categories2 = ['Fault', 'Alarm', '통신이상', '가스누출', '연료전지 고온', '계통연계'];
            // $.ajax({
            //     url: '/api/inspec_report/read',
            //     type: 'GET',
            //     data: {
            //         'searchusr': 'infinited',
            //
            //     },
            //     async: false,
            //     success: function (data) {
            //         console.log('check1', data.data);
            //         if (data.data.length === 0) {
            //             for (let i = 0; i < 10; i++) {
            //                 data.data.push('example');
            //             }
            //         }
            //         console.log(data.data);
            //         data2 = data.data;
            //     }
            // })

            // 샘플 데이터 생성
            for (let i = 0; i < 20; i++) {
                const category1 = categories1[i % categories1.length];
                data2.push({
                    occurDateTime: `2023-09-${(i+1).toString().padStart(2, '0')} 12:34:56`,
                    device: `FC#1`,
                    eventContent: category1,
                    actionDateTime: `2023-09-${(i+1).toString().padStart(2, '0')} 13:00:00`,
                    actionUser: `관리자`,
                    actionContent: `${category1} 확인`,
                    confirmed: i % 2 === 0 ? 'Yes' : 'No'
                });
            }

            viewdata = new wijmo.collections.CollectionView(data2);
            // 데이터 그리드에 바인딩
            if (!theGrid) {
                theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                    autoGenerateColumns: false,
                    showMarquee: true,
                    columns: columns,
                    itemsSource: viewdata
                });

                // 선택이 변경될 때, 현재 항목 업데이트
                theGrid.rowHeaders.columns.splice(0, 1);  //맨 앞에 헤더부분 없애기
                new FlexGridContextMenu(theGrid);
                window.downloadFileName = '장비알림이력';
            } else {
                // 이미 FlexGrid이 존재하는 경우, 데이터만 업데이트
                theGrid.itemsSource = viewdata;
            }
        }

        // 조회기간 변동 함수 -> 입력 필드를 동적으로 업데이트
        function updatePeriodInputs() {
            const periodType = document.getElementById("periodType").value;
            const startDateContainer = document.getElementById("startDateContainer");
            const endDateContainer = document.getElementById("endDateContainer");
            const currentYear = new Date().getFullYear();

            // 기존 내용을 초기화
            startDateContainer.innerHTML = "";
            endDateContainer.innerHTML = "";

            if (periodType === "byday") { // 월별 조회가 선택된 경우
                const startDate = `${currentYear}-01-01`; // 선택된 연도의 1월
                const endDate = `${currentYear}-12-31`; // 선택된 연도의 12월

                startDateContainer.innerHTML = `<input type="date" id="startDate" name="startDate" value="${startDate}">`;
                endDateContainer.innerHTML = `<input type="date" id="endDate" name="endDate" value="${endDate}">`;
            } else if (periodType === "byweek") { // 주간별 조회가 선택된 경우
                const firstDayOfYear = new Date(currentYear, 0, 1);
                const lastWeekEndDate = getLastDayOfLastISOWeek(currentYear);

                const firstWeek = getISOWeek(firstDayOfYear).toString().padStart(2, '0');
                const startDate = `${currentYear}-W${firstWeek}`;

                const endDate = `${lastWeekEndDate.getFullYear()}-W${getISOWeek(lastWeekEndDate).toString().padStart(2, '0')}`;

                startDateContainer.innerHTML = `<input type="week" id="startDate" name="startDate" value="${startDate}">`;
                endDateContainer.innerHTML = `<input type="week" id="endDate" name="endDate" value="${endDate}">`;
            } else if (periodType === "bymonth") { // 월별 조회가 선택된 경우
                const startDate = `${currentYear}-01`; // 선택된 연도의 1월
                const endDate = `${currentYear}-12`; // 선택된 연도의 12월

                startDateContainer.innerHTML = `<input type="month" id="startDate" name="startDate" value="${startDate}">`;
                endDateContainer.innerHTML = `<input type="month" id="endDate" name="endDate" value="${endDate}">`;
            } else if (periodType === "byyear") { // 연도별 조회가 선택된 경우
                let yearOptions = '';
                for (let i = 0; i < 5; i++) {
                    const year = currentYear - i;
                    yearOptions += `<option value="${year}">${year}년</option>`;
                }

                startDateContainer.innerHTML = `<select id="startYear" name="startYear" style="width: 100px">${yearOptions}</select>`;
                endDateContainer.innerHTML = `<select id="endYear" name="endYear" style="width: 100px">${yearOptions}</select>`;
            }
        }

        function getISOWeek(date) {
            const target = new Date(date);
            const dayNumber = (date.getDay() + 6) % 7;
            target.setDate(target.getDate() - dayNumber + 3);
            const firstThursday = target.valueOf();
            target.setMonth(0, 1);
            if (target.getDay() !== 4) {
                target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - target) / 604800000);
        }

        function getLastDayOfLastISOWeek(year) {
            const date = new Date(year, 11, 28); // 12월 28일은 항상 마지막 주에 포함됩니다.
            const day = date.getDay() || 7;
            if (day !== 7) date.setHours(24 * (7 - day)); // 일요일로 이동
            return date;
        }

        rMateChartH5.create("chart1", "chartHolder1", "", "100%", "100%");

        // 스트링 형식으로 레이아웃 정의.
        var layoutStr1 =
            '<rMateChart backgroundColor="#FFFFFF" borderStyle="none">'
            +'<Options>'
            +'<Caption text="유형별"/>'
            // +'<SubCaption text="( $M )" textAlign="right" paddingBottom="35"/>'
            +'<Legend defaultMouseOverAction="true" useVisibleCheck="true"/>'
            +'</Options>'
            +'<Column2DChart seriesMouseOverAction="series" showDataTips="true" columnWidthRatio="0.4" paddingBottom="25">'
            +'<horizontalAxis>'
            +'<CategoryAxis categoryField="Date"/>'
            +'</horizontalAxis>'
            +'<verticalAxis>'
            +'<LinearAxis maximum="100" interval="10"/>'
            +'</verticalAxis>'
            +'<series>'
            +'<Column2DSet type="stacked" showTotalLabel="true" totalLabelJsFunction="totalFunc" labelYOffset="-5">'
            +'<series>'
            +'<Column2DSeries yField="Fault" displayName="Fault" lineToEachItems="false" showLinkLabels="true">'
            +'<showDataEffect>'
            +'<SeriesInterpolate2/>'
            +'</showDataEffect>'
            +'</Column2DSeries>'
            +'<Column2DSeries yField="Alarm" displayName="Alarm" lineToEachItems="false" showLinkLabels="true" fill="#01dbab">'
            +'<showDataEffect>'
            +'<SeriesInterpolate2/>'
            +'</showDataEffect>'
            +'</Column2DSeries>'
            +'<Column2DSeries yField="통신이상" displayName="통신이상" lineToEachItems="false" showLinkLabels="true" fill="#7d88ff">'
            +'<showDataEffect>'
            +'<SeriesInterpolate2/>'
            +'</showDataEffect>'
            +'</Column2DSeries>'
            +'<Column2DSeries yField="가스누출" displayName="가스누출" lineToEachItems="false" showLinkLabels="true">'
            +'<showDataEffect>'
            +'<SeriesInterpolate2/>'
            +'</showDataEffect>'
            +'</Column2DSeries>'
            +'<Column2DSeries yField="연료전지 고온" displayName="연료전지 고온" lineToEachItems="false" showLinkLabels="true">'
            +'<showDataEffect>'
            +'<SeriesInterpolate2/>'
            +'</showDataEffect>'
            +'</Column2DSeries>'
            +'<Column2DSeries yField="계통연계" displayName="계통연계" lineToEachItems="false" showLinkLabels="true">'
            +'<showDataEffect>'
            +'<SeriesInterpolate2/>'
            +'</showDataEffect>'
            +'</Column2DSeries>'
            +'</series>'
            +'</Column2DSet>'
            +'</series>'
            +'</Column2DChart>'
            +'</rMateChart>';

        // 차트 데이터
        var chartData1 = [
            {"Date": "1", "Fault": 10, "Alarm": 15, "통신이상": 8, "가스누출": 12, "연료전지 고온": 7, "계통연계": 5}, // 합계 57
            {"Date": "2", "Fault": 20, "Alarm": 15, "통신이상": 5, "가스누출": 20, "연료전지 고온": 10, "계통연계": 5}, // 합계 75
            {"Date": "3", "Fault": 15, "Alarm": 10, "통신이상": 10, "가스누출": 15, "연료전지 고온": 10, "계통연계": 20}, // 합계 80
            {"Date": "4", "Fault": 10, "Alarm": 5, "통신이상": 15, "가스누출": 20, "연료전지 고온": 10, "계통연계": 15}, // 합계 75
            {"Date": "5", "Fault": 25, "Alarm": 20, "통신이상": 10, "가스누출": 15, "연료전지 고온": 10, "계통연계": 5}, // 합계 85
            {"Date": "6", "Fault": 10, "Alarm": 15, "통신이상": 8, "가스누출": 10, "연료전지 고온": 5, "계통연계": 12}, // 합계 60
            {"Date": "7", "Fault": 15, "Alarm": 20, "통신이상": 10, "가스누출": 15, "연료전지 고온": 10, "계통연계": 5}, // 합계 75
            {"Date": "8", "Fault": 10, "Alarm": 20, "통신이상": 15, "가스누출": 10, "연료전지 고온": 10, "계통연계": 15}, // 합계 80
            {"Date": "9", "Fault": 20, "Alarm": 15, "통신이상": 15, "가스누출": 10, "연료전지 고온": 10, "계통연계": 5}, // 합계 75
            {"Date": "10", "Fault": 25, "Alarm": 20, "통신이상": 15, "가스누출": 15, "연료전지 고온": 10, "계통연계": 5}, // 합계 90
            {"Date": "11", "Fault": 15, "Alarm": 10, "통신이상": 10, "가스누출": 15, "연료전지 고온": 10, "계통연계": 15}, // 합계 75
            {"Date": "12", "Fault": 20, "Alarm": 25, "통신이상": 15, "가스누출": 10, "연료전지 고온": 10, "계통연계": 5}, // 합계 85
            {"Date": "13", "Fault": 10, "Alarm": 10, "통신이상": 5, "가스누출": 10, "연료전지 고온": 5, "계통연계": 10}, // 합계 50
            {"Date": "14", "Fault": 15, "Alarm": 20, "통신이상": 15, "가스누출": 10, "연료전지 고온": 15, "계통연계": 10}, // 합계 85
            {"Date": "15", "Fault": 20, "Alarm": 15, "통신이상": 20, "가스누출": 15, "연료전지 고온": 5, "계통연계": 10}, // 합계 85
            {"Date": "16", "Fault": 10, "Alarm": 5, "통신이상": 10, "가스누출": 15, "연료전지 고온": 5, "계통연계": 10}, // 합계 55
            {"Date": "17", "Fault": 15, "Alarm": 15, "통신이상": 15, "가스누출": 20, "연료전지 고온": 10, "계통연계": 10}  // 합계 85
        ];

        rMateChartH5.calls("chart1", {
            "setLayout" : layoutStr1,
            "setData" : chartData1
        });

        // 스택 수치 합 사용자 정의 함수
        function totalFunc(index, data, value){
            if(index == 4)
                return insertComma(value);
            return "";
        }

        //숫자에 천단위 콤마 찍어 반환하는 함수.
        function insertComma(n) {
            var reg = /(^[+-]?\d+)(\d{3})/; // 정규식
            n += "";
            while (reg.test(n))
                n = n.replace(reg, '$1' + "," + '$2');
            return n;
        }

        rMateChartH5.registerTheme(rMateChartH5.themes);

        function rMateChartH5ChangeTheme(theme){
            document.getElementById("chart1").setTheme(theme);
        }


        rMateChartH5.create("chart2", "chartHolder2", "", "100%", "100%");

        // 스트링 형식으로 레이아웃 정의.
        var layoutStr2 =
            '<rMateChart backgroundColor="#FFFFFF" borderStyle="none">'
            +'<Options>'
            +'<Caption text="발생빈도별" paddingBottom="70"/>'
            +'<Legend defaultMouseOverAction="true" useVisibleCheck="true"/>'
            +'</Options>'
            +'<Pie2DChart innerRadius="0.5" showDataTips="true" selectionMode="single" paddingBottom="25">'
            +'<series>'
            +'<Pie2DSeries nameField="division" field="Profit" startAngle="20" renderDirection="clockwise" labelPosition="inside" color="#ffffff" itemRollOverEmphasize="true">'
            /* Pie2DChart 정의 후 Pie2DSeries labelPosition="inside"정의합니다 */
            +'<showDataEffect>'
            /* 차트 생성시에 Effect를 주고 싶을 때 shoDataEffect정의합니다 */
            +'<SeriesSlide previewColor="#eeeeee" duration="1000"/>'
            +'</showDataEffect>'
            +'</Pie2DSeries>'
            +'</series>'
            +'<backgroundElements>'
            +'<CanvasElement>'
            +'</CanvasElement>'
            +'</backgroundElements>'
            +'</Pie2DChart>'
            +'</rMateChart>';

        // 차트 데이터
        var chartData2 = [{"division":"Fault", "Profit":40},
            {"division":"Alarm", "Profit":30},
            {"division":"통신이상", "Profit":10},
            {"division":"가스누출", "Profit":15},
            {"division":"연료전지 고온", "Profit":50},
            {"division":"계통연계", "Profit":10}];

        rMateChartH5.calls("chart2", {
            "setLayout" : layoutStr2,
            "setData" : chartData2
        });

        rMateChartH5.registerTheme(rMateChartH5.themes);

        function rMateChartH5ChangeTheme(theme){
            document.getElementById("chart2").setTheme(theme);
        }
    </script>
</th:block>

</html>