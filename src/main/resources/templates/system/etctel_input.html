<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>

</style>
<th:block layout:fragment="content">

    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>비상연락망등록</h2>
                <a  title="북마크" class="bookmark toggle">
                    내메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>시스템관리</li>
                <li>비상연락망등록</li>
            </ul>
        </div>
        <!-- Select -->
        <div class="search-wrap">
            <ul>
                <li>
                    <select title="지역">
                        <option>대구</option>
                    </select>
                </li>
                <li>
                    <select title="구">
                        <option>성서산단</option>
                    </select>
                </li>
                <li>
                    <select title="동">
                        <option>성서</option>
                    </select>
                </li>
            </ul>
        </div>
        <div class="tab-wrap">
            <ul class="tab-links">
                <li>
                    <a href="#tab1" title="목록">목록</a>
                </li>
                <li>
                    <a href="#tab2" title="등록">등록</a>
                </li>
            </ul>
            <div class="tab-contents">
                <!-- Section -->
                <section class="tab-item" id="tab1">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    <label for="select1">
                                        협력사 <span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <select id="select1" class="w120">
                                        <option>전체</option>
                                        <option>대구에너지</option>
                                        <option>경북에너지</option>
                                    </select>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label for="text1">
                                        성명<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="text" id="checkusr" name="checkusr" class="input-srch">
                                        <!--                                        <a href="#a" class="btn-srch" id="searchgrid" title="검색" onclick="searchData()" onkeyup="searchData()"></a>-->
                                    </div>
                                </dd>
                            </dl>
                            <dl>
                                <dt>
                                    <label for="text2">
                                        모바일<span class="eq">*</span>
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="text" id="checkph" name="checkph" class="input-srch">
                                    </div>
                                </dd>
                            </dl>
<!--                            <dl>-->
<!--                                <dt>-->
<!--                                    <label>-->
<!--                                        확인용-->
<!--                                    </label>-->
<!--                                </dt>-->
<!--                                <dd>-->
<!--                                    <div>-->
<!--                                        <input type="hidden" id="emcontno">-->
<!--                                        <button id="deleteButton">Delete</button>-->
<!--                                    </div>-->
<!--                                </dd>-->
<!--                            </dl>-->




                        </div>
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a  class="btn btn-excell" title="엑셀다운로드">
                                        <img src="/images/icon/ico-excell.svg" alt="엑셀 아이콘">
                                        엑셀다운로드
                                    </a>
                                </li>
                                <li>
                                    <a  class="btn btn-delete" id="btnDelete" title="삭제">
                                        <img src="/images/icon/ico-delete.svg" alt="엑셀 아이콘">
                                        삭제
                                    </a>
                                </li>
                                <li>
                                    <a  class="btn btn-edit" title="수정">
                                        <img src="/images/icon/ico-edit.svg" alt="엑셀 아이콘">
                                        수정
                                    </a>
                                </li>
                                <!--                                <li>-->
                                <!--                                    <a href="#" class="btn btn-print" title="순회점검일지 출력">-->
                                <!--                                        <img src="/images/icon/ico-print.svg" alt="엑셀 아이콘">-->
                                <!--                                        순회점검일지 출력-->
                                <!--                                    </a>-->
                                <!--                                </li>-->
                            </ul>
                        </div>
                    </div> <!--//section-top end -->
                    <div class="container-fluid">
                        <p id="selectedItem"></p>
                        <div id="theGrid"></div>
                    </div>
                </section>


                <!-- Section -->
                <section class="tab-item" id="tab2">
                    <div class="section-top">
                        <div class="title-wrap">
                            <h3>비상연락망 등록</h3>
                        </div>
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a  class="btn btn-excell" title="엑셀다운로드">
                                        <img src="/images/icon/ico-plus.svg" alt="등록 아이콘">
                                        신규등록
                                    </a>
                                </li>
                                <li>
                                    <a  class="btn btn-delete" title="삭제">
                                        <img src="/images/icon/ico-delete.svg" alt="삭제 아이콘">
                                        삭제
                                    </a>
                                </li>
                                <li>
                                    <a class="btn btn-edit" id="btnSave" title="저장">
                                        <img src="/images/icon/ico-save.svg" alt="저장 아이콘">
                                        저장
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <form id="980_form">
                            <input type="hidden" id="emcontno" name="emcontno">
                            <table class="write-table">
                                <caption>비상연락망등록 테이블</caption>
                                <colgroup>
                                    <col class="wp12">
                                    <col class="wp40">
                                    <col class="wp12">
                                    <col class="wp40">
                                </colgroup>
                                <tbody>
                                <tr>
                                    <th>
                                        <label for="emconcomp">
                                            협력사명
                                        </label>
                                    </th>
                                    <td>
                                        <ul>
                                            <li>
                                                <select title="지역" id="emconcomp">
                                                    <option value="">대구</option>
                                                </select>
                                            </li>
                                        </ul>
                                    </td>
                                    <th>
                                        <label for="divinm">
                                            소속부서
                                        </label>
                                    </th>
                                    <td>
                                        <input type="text" id="divinm" name="divinm" class="wp100" maxlength="50" placeholder="유지보수" >
                                    </td>
                                </tr>

                                <tr>
                                    <th>
                                        <label for="emconper">
                                            성명
                                        </label>
                                    </th>
                                    <td>
                                        <input type="text" id="emconper" name="emconper" class="wp100" maxlength="50" placeholder="홍길동">
                                    </td>
                                    <th>
                                        <label for="emconmno">
                                            모바일
                                        </label>
                                    </th>
                                    <td>
                                        <input type="text" id="emconmno" name="emconmno" class="wp100" maxlength="50" placeholder="010-0000-0000">
                                    </td>
                                </tr>


                                <tr>
                                    <th>
                                        <label for="emconemail">
                                            이메일
                                        </label>
                                    </th>
                                    <td>
                                        <input type="text" id="emconemail" name="emconemail" class="wp100"
                                               maxlength="50" placeholder="admin@naver.com">
                                    </td>
                                    <th>
                                        <label for="emcontel">
                                            사무실전화
                                        </label>
                                    </th>
                                    <td>
                                        <input type="text" id="emcontel" name="emcontel" class="wp100" maxlength="50" placeholder="02-000-0000">
                                    </td>
                                </tr>

                                <tr>
                                    <th>
                                        <label for="spworkcd">
                                            지역
                                        </label>
                                    </th>
                                    <td>
                                        <ul>
                                            <li>
                                                <select title="지역" id="spworkcd">
                                                    <option value="">대구</option>
                                                </select>
                                            </li>
                                        </ul>
                                    </td>
                                    <th>
                                        <label for="spcompcd">
                                            산단
                                        </label>
                                    </th>
                                    <td>
                                        <ul>
                                            <li>
                                                <select title="구" id="spcompcd">
                                                    <option>성서산단</option>
                                                </select>
                                            </li>
                                        </ul>
                                    </td>
                                </tr>

                                <tr>
                                    <th>
                                        <label for="taskwork">
                                            담당업무
                                        </label>
                                    </th>
                                    <td>
                                        <input type="text" id="taskwork" name="taskwork" class="wp100" maxlength="50" placeholder="유지보수">
                                    </td>
                                    <th>
                                        <label for="indatem">
                                            생성일시
                                        </label>
                                    </th>
                                    <td>
                                        <input type="text" id="indatem" name="indatem" autocomplete="off" readonly >
                                    </td>
                                </tr>

                                </tbody>
                            </table>
                        </form>
                    </div>
                </section>
            </div> <!--//tab-contens end-->
        </div> <!--//tab-wrap end-->
    </div> <!--//layout-contents end -->

</th:block>
<th:block layout:fragment="scripts">
    <th:block th:replace="/common/approve_box :: approve_box"></th:block>
    <th:block th:replace="/common/ax5_uploader :: ax5_uploader"></th:block>
    <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box"></th:block>
    <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>
    <script type="text/javascript">

        var theGrid;
        var viewdata;


        let searchusrval = document.getElementById('emconper');
        let searchusrval2 = document.getElementById('emconmno');

        var input = document.getElementById('indatem');
        var today = new Date();
        var year = today.getFullYear();
        var month = String(today.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
        var day = String(today.getDate()).padStart(2, '0');
        var formattedDate = year + '-' + month + '-' + day;
        input.value = formattedDate;



        var columns = [
                {binding: 'rownum', header: 'NO', width: 80, align: 'center'},
                {binding: 'workcd', header: '지역명', width: 140, align: 'center'},
                {binding: 'compcd', header: '산단명', width: 140, align: 'center'},
                {binding: 'emconcomp', header: '협력사', width: 140, align: 'center'},
                {binding: 'indatem', header: '생성일시', width: 140, align: 'center'},
                {binding: 'divinm', header: '소속부서', width: 140, align: 'center'},
                {binding: 'emconper', header: '성명', width: 140, align: 'center'},
                {binding: 'taskwork', header: '담당업무', width: 160, align: 'center'},
                {binding: 'emcontel', header: '사무실전화', width: 140, align: 'center'},
                {binding: 'emconmno', header: '모바일', width: 160, align: 'center'},
                {binding: 'emconemail', header: '이메일', width: "*", align: 'center'},

            ];




        document.readyState === 'complete' ? init() : window.onload = init;


        <!-- 초반 페이지 진입시 그리드 바인딩 끝-->
        function init() {

            let data2 = [];
            let emconper = $('#emconper').val();
            let emconmno = $('#emconmno').val();
            this.base_url = '/api/system/tel_List';


            $.ajax({
                url: '/api/system/tbRp980/read',
                type: 'GET',
                data: {
                    'emconper': emconper,
                    'emconmno': emconmno
                },
                async: false,
                success: function (data) {
                    console.log('wijmo', data.data);
                    data2 = data.data;
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('Error fetching log_list data:', textStatus, errorThrown);
                }
            });

            // 데이터 배열이 비어있을 경우 여러 개의 빈 객체 추가
            if (data2.length === 0) {
                let emptyRowsCount = 8;  // 원하는 빈 행의 수
                for (let i = 0; i < emptyRowsCount; i++) {
                    data2.push({});
                }
                console.log('Grid initialized with empty data.');
            }


            viewdata = new wijmo.collections.CollectionView(data2);
            // 데이터 그리드에 바인딩
            theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                autoGenerateColumns: false,
                showMarquee: true,
                columns: columns,
                itemsSource: viewdata
            });

            // theGrid.setCellData(0,'workcd','대구');
            // theGrid.setCellData(0,'compcd','성서산단');
            // theGrid.setCellData(0,'emconcomp','레플러스');
            // theGrid.setCellData(0,'divinm','유지보수');
            // theGrid.setCellData(0,'taskwork','유지보수');




            // 선택이 변경될 때, 현재 항목 업데이트

            theGrid.rowHeaders.columns.splice(0, 1);  //맨 앞에 헤더부분 없애기


            // theGrid.setCellData(0,'rownum','1');
            // theGrid.setCellData(0,'workcd','대구');
            // theGrid.setCellData(0,'compcd','성서산단');
            // theGrid.setCellData(0,'emconcomp','성서발전소');
            // theGrid.setCellData(0,'indatem','2024-07-24');
            // theGrid.setCellData(0,'divinm', '유지보수');
            // theGrid.setCellData(0,'emconper','홍길동');
            // theGrid.setCellData(0,'taskwork','유지보수');
            // theGrid.setCellData(0,'emcontel','02-451-3321');
            // theGrid.setCellData(0,'emconmno','010-3256-3241');
            // theGrid.setCellData(0,'emconemail','admin@naver.com');
            //
            // theGrid.setCellData(1,'rownum','2');
            // theGrid.setCellData(1,'workcd','대구');
            // theGrid.setCellData(1,'compcd','성서산단');
            // theGrid.setCellData(1,'emconcomp','성서발전소');
            // theGrid.setCellData(1,'indatem','2024-07-25');
            // theGrid.setCellData(1,'divinm', '점검관리');
            // theGrid.setCellData(1,'emconper','홍동');
            // theGrid.setCellData(1,'taskwork','점검관리');
            // theGrid.setCellData(1,'emcontel','02-325-7840');
            // theGrid.setCellData(1,'emconmno','010-3125-7241');
            // theGrid.setCellData(1,'emconemail','admin1@naver.com');



            $('#btnSave').click(save);

        }

        <!-- 초반 페이지 진입시 그리드 바인딩 끝-->

        let page = null;


        // 비상연락망 저장
        function save() {
            let url ='/api/system/tbRp980/save';

            let data = FormUtil.extractForm($('#980_form'));

            // if (!data.code || !data.name) {
            //     Alert.alert('', '필수항목을 입력해주세요');
            //     return;
            // }

            let fnSuccess = function (res) {
                console.log(res, "+", data);
                if (res.success) {
                    Alert.alert('','저장되었습니다.');

                    searchDataBind();
                } else {
                    Alert.alert('', res.message);
                }
            };
            AjaxUtil.postAsyncData(url, data, fnSuccess);
        }

        //검색
        function searchDataBind() {

            let data = {
                'emconper': $('#emconper').val(),
                'emconmno' : $('#emconmno').val()
            }

            console.log("Data to send:", data);

            $.ajax({
                url: '/api/system/tbRp980/read',
                type: 'POST',
                data: data,
                success: function (result) {
                    if (result.success) {
                        console.log("Result data:", result.data);
                        grid_binding(result.data);
                    } else {
                        console.log("Error occurred");
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('Error fetching log_list data:', textStatus, errorThrown);
                }
            });
        }

        function grid_binding(data){
            console.log("Data to bind to grid:", data);

            let formattedData = data.map(item => ({
                rownum: item.rownum,
                workcd: item.workcd,
                compcd: item.compcd,
                emconcomp: item.emconcomp,
                indatem: item.indatem,
                divinm: item.divinm,
                emconper: item.emconper,
                taskwork: item.taskwork,
                emcontel: item. emcontel,
                emconmno: item.emconmno,
                emconemail: item. emconemail
            }));


            theGrid.columns.clear();
            theGrid.autoGenerateColumns = false;

            columns.forEach(colDef => {
                let col = new wijmo.grid.Column(colDef);
                theGrid.columns.push(col);
            });

            viewdata = new wijmo.collections.CollectionView(formattedData);

            theGrid.itemsSource = viewdata;
            theGrid.refresh();

        }


        // function delTel(){
        //     let _this = this;
        //
        //     let id = $('#emcontno').val();
        //     console.log("emcontno:", id); // 콘솔에 id 값을 출력
        //
        //
        //     if (!id) {
        //         console.error("ID is undefined or empty");
        //         return;
        //     }
        //
        //     let data = { emcontno: id };
        //
        //     let fnSuccess = function (res){
        //
        //         if(res.success){
        //             Notify.success("삭제되었습니다.");
        //
        //             location.reload();
        //         }else if(!res.success){
        //             Alert.alert('',res.message);
        //         }
        //     };
        //     AjaxUtil.postAsyncData(_this.base_url+'/delete', data, fnSuccess);
        //
        // }



        $(document).ready(function (e) {


            $('#btnDelete').click(function(e){
                console.log('삭제버튼클릭');
                Alert.confirm('',
                '삭제하시겠습니까?',
                function() {
                    delTel()
                },
                    function(){
                    // 취소 버튼을 눌렀을 때 수행 하는 곳
                    }
                );
            });

            function delTel() {
                let id = $('#emcontno').val();
                console.log("emcontno:", id); // 콘솔에 id 값을 출력

                if (!id) {
                    console.error("ID is undefined or empty");
                    return;
                }

                let data = { emcontno: id };

                let fnSuccess = function (res) {
                    if (res.success) {
                        Notify.success("삭제되었습니다.");
                        location.reload();
                    } else if (!res.success) {
                        Alert.alert('', res.message);
                    }
                };

                AjaxUtil.postAsyncData(this.base_url + '/delete', data, fnSuccess);
            }

            $('#deleteButton').on('click', delTel);


            // page.setUploader();


        });
    </script>
</th:block>

</html>