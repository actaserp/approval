<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
    <style>
        .input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .input-wrapper input {
            width: 100%;
            padding-right: 60px; /* 충분한 공간을 확보 */
        }

        .input-wrapper .unit {
            position: absolute;
            right: 20px;
            top: 0;
            bottom: 0;
            height: 20px;
            line-height: 20px; /* input 높이에 맞게 조절 */
            margin: auto;
            font-size: 12px;
            color: #999;
            pointer-events: none; /* 텍스트가 클릭 이벤트를 받지 않도록 설정 */
        }
    </style>
</head>
<th:block layout:fragment="content">

    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>매출등록</h2>
                <a href="#" title="북마크" class="bookmark toggle">
                    내메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>서비스분석</li>
                <li>매출등록</li>
            </ul>
        </div>
        <!-- Select -->
        <div class="search-wrap">
            <ul>
                <li>
                    <select title="지역">
                        <option>대구</option>
                    </select>
                </li>
                <li>
                    <select title="구">
                        <option>성서산단</option>
                    </select>
                </li>
                <li>
                    <select title="동">
                        <option>성서</option>
                    </select>
                </li>
            </ul>
        </div>
        <div class="tab-wrap">
            <ul class="tab-links">
                <li>
                    <a href="#tab1" title="목록">목록</a>
                </li>
                <li>
                    <a href="#tab2" title="등록">등록</a>
                </li>
            </ul>
            <div class="tab-contents">
                <!-- Section -->
                <section class="tab-item" id="tab1">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    매출년월<span class="eq">*</span>
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <input type="month" id="date1" name="startDate">
                                            <label for="date1" class="hide">시작일</label>
                                        </li>
                                        <li>
                                            <input type="month" id="date2" name="endDate">
                                            <label for="date2" class="hide">종료일</label>
                                        </li>
                                        <li>
                                            <a href="#" class="btn btn-delete" title="검색" id="btn-srch">
                                                <!-- class 쓰이는 곳 찾고 없으면 클래스명 수정하기-->
                                                <img src="/images/icon/btn-srch.svg" alt="검색 아이콘">
                                                검색
                                            </a>
                                        </li>

<!--                                        <a href="#a" class="btn-srch" title="검색" id="btn-srch"></a>-->

                                    </ul>
                                </dd>
                            </dl>

                        </div>
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a href="#" class="btn btn-excell" title="엑셀다운로드">
                                        <img src="/images/icon/ico-excell.svg" alt="엑셀 아이콘">
                                        엑셀다운로드
                                    </a>
                                </li>
<!--                                <li>-->
<!--                                    <a href="#" class="btn btn-print" title="매출등록 출력">-->
<!--                                        <img src="/images/icon/ico-print.svg" alt="엑셀 아이콘">-->
<!--                                        매출등록 출력-->
<!--                                    </a>-->
<!--                                </li>-->
                            </ul>
                        </div>
                    </div> <!--//section-top end -->
                    <div class="table-wrap">
                        <table class="list-table">
                            <caption>매출등록 테이블</caption>
                            <colgroup>
                                <col class="wp10">
                                <col class="wp10">
                                <col class="wp10">
                                <col class="wp10">
                                <col class="wp10">
                                <col class="wp10">
                                <col class="wp10">
                                <col class="wauto">
                            </colgroup>
                            <thead>
                            <tr>
                                <th>매출년월</th>
                                <th>발전량</th>
                                <th>SMP단가</th>
                                <th>SMP매출</th>
                                <th>REC단가</th>
                                <th>REC수량</th>
                                <th>REC매출</th>
                                <th>총매출</th>

                            </tr>
                            </thead>
                            <tbody id="salesData">
                            <!-- Data will be filled by JavaScript -->
                            </tbody>
                            <tfoot>
                            <tr>
                                <th>계</th>
                                <td id="sum-energyQty"></td>
                                <td id="sum-smpCost"></td>
                                <td id="sum-smpAmt"></td>
                                <td id="sum-recCost"></td>
                                <td id="sum-recQty"></td>
                                <td id="sum-recAmt"></td>
                                <td id="sum-stotAmt"></td>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="btn-wrap">
                        <div class="center">
                            <ul class="paging-wrap">
                                <li><a href="#" title="처음" class="btn-first"></a></li>
                                <li><a href="#" title="이전" class="btn-prev"></a></li>
                                <li class="on"><a href="#" title="1">1</a></li>
                                <li><a href="#" title="2">2</a></li>
                                <li><a href="#" title="3">3</a></li>
                                <li><a href="#" title="4">4</a></li>
                                <li><a href="#" title="5" class="disable">5</a></li>
                                <li><a href="#" title="다음" class="btn-next"></a></li>
                                <li><a href="#" title="마지막" class="btn-last"></a></li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section class="tab-item" id="tab2">
                    <div class="section-top">
                        <div class="title-wrap">
                            <h3>매출 등록</h3>
                        </div>
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a href="#" class="btn btn-excell" title="엑셀다운로드">
                                        <img src="/images/icon/ico-plus.svg" alt="등록 아이콘">
                                        신규등록
                                    </a>
                                </li>
                                <li>
                                    <a href="#" class="btn btn-delete" id="btnDelete" title="삭제">
                                        <img src="/images/icon/ico-delete.svg" alt="삭제 아이콘">
                                        삭제
                                    </a>
                                </li>
                                <li>
                                    <a href="#" class="btn btn-edit" title="저장" id="btnSave">
                                        <img src="/images/icon/ico-save.svg" alt="저장 아이콘">
                                        저장
                                    </a>
                                </li>
                                <li>
                                    <!-- 수정 버튼, 처음에는 숨겨져 있음 -->
                                    <a href="#" class="btn btn-edit" title="수정" id="btnEdit" style="display:none;">
                                        <img src="/images/icon/ico-edit.svg" alt="수정 아이콘">
                                        수정
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <form action="/api/sales/upload" id="saleForm" method="post">
                        <!--                                value 임의로 하드코딩함. 추후 수정하기. -->
                        <input type="hidden" id="spworkcd" name="spworkcd" value="def" maxlength="3"/>
                        <input type="hidden" id="spcompcd" name="spcompcd" value="def" maxlength="3"/>
                        <input type="hidden" id="spplancd" name="spplancd" value="def" maxlength="3"/>
                        <input type="hidden" id="spworknm" name="spworknm" value="def"/>
                        <input type="hidden" id="spcompnm" name="spcompnm" value="def"/>
                        <input type="hidden" id="spplannm" name="spplannm" value="def"/>
                        <div class="table-wrap">
                            <table class="write-table">
                                <caption>매출등록 테이블</caption>
                                <colgroup>
                                    <col class="wp12">
                                    <col class="wp40">
                                    <col class="wp12">
                                    <col class="wp40">
                                </colgroup>
                                <tbody>
                                <tr>
                                    <th>
                                        <label for="date3">
                                            매출년월
                                        </label>
                                    </th>
                                    <td>
                                        <input type="month" id="date3" name="salesym" maxlength="7" required/>
                                    </td>
                                </tr>
                                <tr>
                                    <th>
                                        <label for="test">
                                            발전량
                                        </label>
                                    </th>
                                    <td class="input-wrapper">
                                        <input type="text" id="test1" class="wp100" name="energyQty"/>
                                        <span class="unit">kWh</span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>
                                        <label for="test">
                                            SMP 매출
                                        </label>
                                    </th>
                                    <td class="input-wrapper">
                                        <input type="text" id="test2" class="wp100" name="smpAmt"/>
                                        <span class="unit">백만원</span>
                                    </td>
                                    <th>
                                        <label for="test">
                                            SMP 단가
                                        </label>
                                    </th>
                                    <td>
                                        <input type="text" id="test3" class="wp100" name="smpCost"/>
                                    </td>
                                </tr>
                                <tr>
                                    <th>
                                        <label for="test">
                                            REC 수량
                                        </label>
                                    </th>
                                    <td class="input-wrapper">
                                        <input type="text" id="test4" class="wp100" name="recQty"/>
                                        <span class="unit">백만원</span>
                                    </td>
                                    <th>
                                        <label for="test">
                                            REC 실단가
                                        </label>
                                    </th>
                                    <td>
                                        <input type="text" id="test5" class="wp100" name="recCost"/>
                                    </td>
                                </tr>
                                <tr>
                                    <th></th>
                                    <td></td>
                                    <th>
                                        <label for="test">
                                            REC 평균단가
                                        </label>
                                    </th>
                                    <td>
                                        <input type="text" id="test6" class="wp100" name="recAverageCost" disabled/>
                                    </td>
                                </tr>
                                <tr>
                                    <th>
                                        <label for="test">
                                            REC 매출
                                        </label>
                                    </th>
                                    <td class="input-wrapper">
                                        <input type="text" id="test7" class="wp100" name="recAmt"/>
                                        <span class="unit">백만원</span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>
                                        <label for="test" class="input-wrapper">
                                            총 발전 매출
                                        </label>
                                    </th>
                                    <td class="input-wrapper">
                                        <input type="text" id="test" class="wp100" name="stotAmt" disabled/>
                                        <span class="unit">백만원</span>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </form>
                </section>
            </div> <!--//tab-contens end-->
        </div> <!--//tab-wrap end-->
    </div> <!--//layout-contents end -->
    </section>
    </div>


</th:block>

<th:block layout:fragment="scripts">
    <script type="text/javascript">
        $(document).ready(function () {

            // 전역 변수로 선택된 매출 ID를 저장
            let selectedSalesId = null;

            // 검색
            $('.btn-srch').click(function () {
                var startDate = $('#date1').val();
                var endDate = $('#date2').val();
                fetchSalesData(startDate, endDate); // 데이터 가져오는 함수에 시작일과 종료일 인자 추가
            });


            $('#btnSave').click(function () {
                if (validateForm()) {
                    saveSalesInfo();
                }
            });

            function validateForm() {
                var isValid = true;
                var salesym = $('#date3').val().trim(); // 매출년월 필드 값 가져오기

                if (!salesym) { // 매출년월이 비어있는지 확인
                    alert('매출년월을 입력해주세요.');
                    $('#date3').focus(); // 매출년월 필드에 포커스 주기
                    isValid = false;
                }

                $('#saleForm').find('input[required], select[required]').each(function () {
                    if (!$(this).val()) {
                        // alert('모든 필수 항목을 입력해주세요.');
                        $(this).focus();
                        isValid = false;
                        return false; // break loop
                    }
                });
                return isValid;
            }

            // 저장
            function saveSalesInfo() {

                var formData = {
                    spworkcd: $('#spworkcd').val(),
                    spcompcd: $('#spcompcd').val(),
                    spplancd: $('#spplancd').val(),
                    spworknm: $('#spworknm').val(),
                    spcompnm: $('#spcompnm').val(),
                    spplannm: $('#spplannm').val(),
                    salesym: $('#date3').val(),
                    energyQty: $('#test1').val(),
                    smpAmt: $('#test2').val(),
                    smpCost: $('#test3').val(),
                    recQty: $('#test4').val(),
                    recCost: $('#test5').val(),
                    recAverageCost: $('#test6').val(),
                    recAmt: $('#test7').val(),
                    stotAmt: $('#test').val()
                };
                $.ajax({
                    url: 'http://localhost:8060/api/sales/upload',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        if (response.success) {
                            alert('저장되었습니다.');
                            fetchSalesData(); // 데이터 재로드
                            switchTab('#tab1'); // 목록 탭으로 전환
                        } else {
                            alert('오류: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('서버와의 통신 중 오류가 발생했습니다.');
                    }
                });
            }

            // 매출 데이터 불러오기
            // function fetchSalesData() {
            //     var startDate = $('#date1').val();
            //     var endDate = $('#date2').val();
            //     var url = '/api/sales/fetch';
            //
            //     // 날짜가 설정되었으면 URL에 쿼리 파라미터 추가
            //     if (startDate && endDate) {
            //         url += '?startDate=' + startDate + '&endDate=' + endDate;
            //     }

            function fetchSalesData(startDate, endDate) {
                var url = '/api/sales/fetch';
                if (startDate && endDate) {
                    url += '?startDate=' + startDate + '&endDate=' + endDate;
                }

                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        var rows = '';

                        var totals = {
                            energyQty: 0,
                            smpCost: 0,
                            smpAmt: 0,
                            recCost: 0,
                            recQty: 0,
                            recAmt: 0,
                            stotAmt: 0
                        };

                        response.forEach(function (sale) {
                            rows += '<tr>' +
                                '<td>' + sale.salesym + '</td>' +
                                '<td>' + sale.energyQty + '</td>' +
                                '<td>' + sale.smpCost + '</td>' +
                                '<td>' + sale.smpAmt + '</td>' +
                                '<td>' + sale.recCost + '</td>' +
                                '<td>' + sale.recQty + '</td>' +
                                '<td>' + sale.recAmt + '</td>' +
                                '<td>' + sale.stotAmt + '</td>' +
                                '</tr>';

                            // 합계 계산
                            totals.energyQty += sale.energyQty;
                            totals.smpCost += sale.smpCost;
                            totals.smpAmt += sale.smpAmt;
                            totals.recCost += sale.recCost;
                            totals.recQty += sale.recQty;
                            totals.recAmt += sale.recAmt;
                            totals.stotAmt += sale.stotAmt;
                        });

                        $('#salesData').html(rows);
                        $('#sum-energyQty').text(totals.energyQty);
                        $('#sum-smpCost').text(totals.smpCost);
                        $('#sum-smpAmt').text(totals.smpAmt);
                        $('#sum-recCost').text(totals.recCost);
                        $('#sum-recQty').text(totals.recQty);
                        $('#sum-recAmt').text(totals.recAmt);
                        $('#sum-stotAmt').text(totals.stotAmt);
                    },
                    error: function (error) {
                        console.error('데이터 로드 실패:', error);
                        alert('데이터를 불러오는 데 실패했습니다.');
                    }
                });
            }

            // 매출 데이터를 클릭했을 때 이벤트 핸들러
            $(document).on('click', '.list-table tbody tr', function () {
                // 각 행에서 데이터 가져오기
                var salesym = $(this).find('td').eq(0).text(); // 매출년월
                var energyQty = $(this).find('td').eq(1).text(); // 발전량
                var smpCost = $(this).find('td').eq(2).text(); // SMP 단가
                var smpAmt = $(this).find('td').eq(3).text(); // SMP 매출
                var recCost = $(this).find('td').eq(4).text(); // REC 단가
                var recQty = $(this).find('td').eq(5).text(); // REC 수량
                var recAmt = $(this).find('td').eq(6).text(); // REC 매출
                var stotAmt = $(this).find('td').eq(7).text(); // 총 매출

                // 폼 필드에 데이터 채우기
                $('#date3').val(salesym);
                $('#test1').val(energyQty);
                $('#test3').val(smpCost);
                $('#test2').val(smpAmt);
                $('#test5').val(recCost);
                $('#test4').val(recQty);
                $('#test7').val(recAmt);
                $('#test').val(stotAmt);

                // 버튼 상태 전환
                $('#btnSave').hide(); // 저장 버튼 숨기기
                $('#btnEdit').show(); // 수정 버튼 표시

                // 탭 전환
                switchTab('#tab2');
            });

            // 수정
            $('#btnEdit').click(function () {
                var formData = {
                    salesym: $('#date3').val(),
                    energyQty: $('#test1').val(),
                    smpAmt: $('#test2').val(),
                    smpCost: $('#test3').val(),
                    recQty: $('#test4').val(),
                    recCost: $('#test5').val(),
                    recAverageCost: $('#test6').val(),
                    recAmt: $('#test7').val(),
                    stotAmt: $('#test').val(),

                    spworkcd: $('#spworkcd').val(),
                    spcompcd: $('#spcompcd').val(),
                    spplancd: $('#spplancd').val(),
                    spworknm: $('#spworknm').val(),
                    spcompnm: $('#spcompnm').val(),
                    spplannm: $('#spplannm').val()
                };

                $.ajax({
                    url: '/api/sales/update/' + formData.salesym,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        if (response.success) {
                            alert('수정되었습니다.');
                            fetchSalesData(); // 데이터 재로드
                            switchTab('#tab1'); // 목록 탭으로 전환
                            $('#btnEdit').hide(); // 수정 버튼 숨기기
                            $('#btnSave').show(); // 저장 버튼 표시
                        } else {
                            alert('오류: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('서버와의 통신 중 오류가 발생했습니다.');
                    }
                });
            });

            // 삭제 버튼 클릭 이벤트
            $('#btnDelete').click(function () {
                if (!confirm('정말로 삭제하시겠습니까?')) {
                    return;
                }

                var salesym = $('#date3').val();

                $.ajax({
                    url: 'http://localhost:8060/api/sales/delete/' + salesym,
                    type: 'DELETE',
                    success: function (response) {
                        if (response.success) {
                            alert('삭제되었습니다.');
                            fetchSalesData(); // 데이터 재로드
                            switchTab('#tab1'); // 목록 탭으로 전환
                        } else {
                            alert('오류: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('서버와의 통신 중 오류가 발생했습니다.');
                    }
                });
            });

            // 데이터 초기 로드
            fetchSalesData();

            // 탭 전환 함수
            function switchTab(tabId) {
                $('.tab-links a[href="' + tabId + '"]').click();
            }
        });

    </script>
</th:block>
</html>