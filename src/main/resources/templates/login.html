<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <link rel="icon" type="image/png" href="/img/favicon.png">
    <link rel="stylesheet" href="/css/login_mes.css" />
    <link rel="stylesheet" href="/resource/ax5ui/ax5ui.all.css" />
    <link rel="stylesheet" href="/css/sf21_frame.css" />

    <title>SMART FOMS</title>
</head>
<body>
<section class="login_contain beta">
    <article class="layout col_6 left">
        <div class="top_title">
            <div class="logo_wrap">
                <h1><div>Fuel cell
                    Operation & <BR>Maintenance System</div>
                </h1>
            </div>
            <span> AI기반 연료전지 유지관리 시스템 </span>
            <!--테스트 주석입니다.-->
        </div>
        <div class="bg_img"></div>
    </article>
    <article class="layout col_6 right">
        <article class="login_form">
            <div class="title_wrap">
                <span>Welcome to</span>
                <h4>SMART FOMS</h4>

            </div>
            <form method="post" class="form" role="form" id="loginFrm" action="/postLogin">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <h2>ID</h2>
                <input type="text" name="username" id="loginId" class="id" placeholder="아이디" required autofocus title="아이디 입력" />
                <h2>Password</h2>
                <div class="pass_box">
                    <input type="password" name="password" id="loginPwd" class="pass" placeholder="패스워드" required title="패스워드 입력" autocomplete="off" />
                    <i class="icon ion-md-eye-off"></i>
                </div>
                <div class="sub_box">
                    <div class="input_group chk_custom">
                        <label for="login_chk">
                            <input type="checkbox" id="login_chk">
                            <span class="checkbox"></span>Remember Me
                        </label>
                    </div>
                    <!-- <div class="right_align"><a href="find_id_pass.html"><span>아이디 · 비밀번호 찾기</span></a></div> -->
                    <!-- <div class="check_div right_align" id="memberReg"><a href="#"><span data-labelCd="LABEL.L0682" data-ori="회원 가입"></span></a></div> -->
                </div>
                <div class="lang_box">
                    <button type="button" id="lang_select"><i class="fas fa-globe"></i><span class="txt">사용자그룹</span></button>
                    <ul class="lang_list" id="language">
                        <li>
                            <label for="lang1" >
                                <span class="icon"></span><input type="radio" name="language" class="hidden" id="lang1" value="ko-KR"><span class="radiobox"></span>사업관리자
                            </label>
                        </li>
                        <li>
                            <label for="lang2" >
                                <span class="icon"></span><input type="radio" name="language" class="hidden" id="lang2" value="en-US"><span class="radiobox"></span>전기안전관리자
                            </label>
                        </li>
                        <li>
                            <label for="lang3">
                                <span class="icon"></span><input type="radio" name="language" class="hidden" id="lang2" value="en-US"><span class="radiobox"></span>ESG담당자
                            </label>
                        </li>
                        <li>
                            <label for="lang4">
                                <span class="icon"></span><input type="radio" name="language" class="hidden" id="lang2" value="en-US"><span class="radiobox"></span>BloomEnergy
                            </label>
                        </li>
                        <!--
                        <li>
                            <label for="lang3" id="lang3label">
                                <span class="icon"></span><input type="radio" name="language" class="hidden" id="lang3" value="zh_CN"><span class="radiobox"></span>Chinese
                            </label>
                        </li>
                        <li>
                          <label for="lang4" id="lang4label">
                            <span class="icon"></span>
                            <input type="radio" name="language" class="hidden" id="lang4" value="ja">
                            <span class="radiobox"></span>Japanese
                          </label>
                        </li>
                        <li>
                          <label for="lang5" id="lang5label">
                            <span class="icon"></span>
                            <input type="radio" name="language" class="hidden" id="lang5" value="zh_TW">
                            <span class="radiobox"></span>Taiwanese
                          </label>
                        </li>
                       -->
                    </ul>
                </div>
                <button type="button" class="sign_btn" id="modal-open"><span data-labelCd="권한신청">권한신청</span></button>

                <button class="sign_btn" type="submit" id="login"><span>로그인</span></button>
            </form>
            <h3><span>신규가입 및 기존 등록 정보에 관한 내용은 관리자에게 문의하세요.</span></h3>
            <div class="logo_list">
                <!-- <span><img src="../img/login_haccp.png" /></span> -->
                <!-- <span><img src="../img/login_logo02.png" /></span> -->
            </div>
            <!-- <span class="mark_haccp"><img src="../img/login_haccp.png" /></span>/ -->

        </article>
    </article>
</section>

<script type="text/x-tmpl" id="createHMIItemTemplate">
    <div class="content_wrap popup">
    <!--<header>
        <h4 id="popTitle">사용자 권한 신청</h4>
        <div class="popup_close_box"><button class="btn_popup_close" id="modal-close"><i class="fas fa-times"></i></button></div>
    </header>-->
    <section class="pt-2">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <form id="bomForm">
            <div class="table_box sub">
                <div class="row">
                    <div class="col-12" style="
    width: 200px;
">
                        <div class="input-group" style="
    /* width: 50%; */
">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_t7" data-labelcd="소속사" placeholder="소속사">소속사</span>
                            </div>
                            <input class="form-control2 " type="text" id="agency" name="agency">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_t7" data-labelcd="소속부서" placeholder="소속부서">소속부서</span>
                            </div>
                            <input class="form-control2 " type="text" id="agencyDepartment" name="agencyDepartment">
                        </div>
                    </div>



                    <div class="col-12" style="
    width: 200px;
">
                        <div class="input-group" style="
    /* width: 50%; */
">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_t7" data-labelcd="직급" placeholder="직급">직급</span>
                            </div>
                            <input class="form-control2 " type="text" id="level" name="level">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_t7" data-labelcd="성명" placeholder="성명">성명</span>
                            </div>
                            <input class="form-control2 " type="text" id="name" name="name">
                        </div>
                    </div>

                    <div class="col-12" style="
    width: 200px;
">
                        <div class="input-group" style="
    /* width: 50%; */
">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_t7" data-labelcd="핸드폰" placeholder="핸드폰">핸드폰</span>
                            </div>
                            <input class="form-control2 " type="text" id="tel" name="tel">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_t7" data-labelcd="이메일" placeholder="이메일">이메일</span>
                            </div>
                            <input class="form-control2 " type="email" id="email" required
                             name="email" />
                        </div>
                    </div>


                    <div class="col-12" style="width: 200px;">
                        <div class="input-group" style="width: 64.5%;">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_t7" data-labelcd="ID" placeholder="ID">ID</span>
                            </div>
                            <input class="form-control2 " type="text" id="id" name="id">
                            <button type="button" class="btn-popup" id="btnDuplicate" style="margin-left: 10px;">
                            <span data-labelcd="중복확인" placeholder="중복확인">중복확인</span>
                            </button>
                        </div>
                    </div>



                    <div class="col-12" style="width: 200px;">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_t7" data-labelcd="비밀번호" placeholder="비밀번호">비밀번호</span>
                            </div>
                            <input class="form-control2 " type="password" id="password" name="password">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_t7" data-labelcd="비밀번호확인" placeholder="비밀번호확인">비밀번호확인</span>
                            </div>
                            <input class="form-control2 " type="password" id="passwordchk" name="passwordchk">
                        </div>
                    </div>

                    <div class="col-12" style="width: 200px;">
                        <div class="input-group">
                            <div class="input-group-prepend" style="margin-right: 10px;">
                                <span class="input-group-text fit_box_t7" data-labelcd="권한그룹" placeholder="권한그룹">권한그룹</span>
                            </div>
                            <select class="form-control2 " type="text" id="authType" name="authType">
                                <option value='bloomuser'>BloomEnergy담당자</option>
                                <option value='esguser'>ESG담당자</option>
                                <option value='admin'>관리자</option>
                                <option value='User'>사용자</option>
                                <option value='Master'>시스템마스터</option>
                                <option value='elecuser'>전기안전관리자</option>

                            </select>


                        </div>
                    </div>

                    <div class="col-12" style="width: 200px;">
    <div class="input-group">
        <div class="input-group-prepend" style="margin-right: 10px;">
            <span class="input-group-text fit_box_t7" data-labelcd="대상발전시설" placeholder="대상발전시설">대상발전시설</span>
        </div>
        <div style="margin-right: 10px;">
            <input type="radio" id="val1" name="val"  value="dgsan01" checked /><label style="margin: 5px;" required />대구(성서)</label>
        </div>
        <div style="margin-right: 10px;">
            <input type="radio" id="val2" name="val" value="dlsan01"><label style="margin: 5px;" required />대관령(창원)</label>
        </div>
        <div style="margin-right: 10px;">
            <input type="radio" id="val3" name="val" value="dksan01"><label style="margin: 5px;" required />대덕(울산)</label>
        </div>
    </div>
</div>




                    <div class="col-12" style="width: 200px;">
                        <div class="input-group">
                            <div class="input-group-prepend" style="margin-right: 10px;">
                                <span class="input-group-text fit_box_t7" data-labelcd="신청사유" placeholder="신청사유">신청사유</span>
                            </div>
                            <input class="form-control2 " type="text" id="reason" name="reason">



                        </div>
                    </div>




                </div>
            </div>
        </form>
    </section>
    <section class="popupcontent">
        <div class="align_left">
            <button type="button" class="btn-popup" id="btnSaveAuth"><span data-labelcd="권한신청" placeholder="권한신청">권한신청</span></button>
            <button type="button" class="btn-popup" id="modal-close-button"><span data-labelcd="닫기" placeholder="닫기">닫기</span></button>

        </div>
    </section>
</div>
</script>

<script type="text/javascript" src="/resource/jquery.min.js"></script>
<script type="text/javascript" src="/resource/jquery-validation/1.17.0/jquery.validate.min.js"></script>
<script type="text/javascript" src="/resource/ax5ui/ax5ui.all.min.js"></script>
<script type="text/javascript" src="/resource/moment.min.js"></script>
<script type="text/javascript" src="/js/js.cookie.js"></script>
<script type="text/javascript" src="/js/common.js?v=1050"></script>
<script type="text/javascript" src="/resource/JavaScript-Templates/tmpl.js"></script>


<script type="text/javascript" src="/js/ax5commUtil.js?v=1050"></script>

<script type="text/javascript">


    const requiredFields = ['agency', 'agencyDepartment', 'name', 'id', 'password', 'passwordchk', 'authType'];
    const requiredFields2 = ['소속사', '소속부서', '성명', 'ID', '비밀번호', '비밀번호확인', '권한그룹'];

    // TODO: 유효성검사
    function ValidateChk(param, paramNm){

        let ParamValue = document.getElementById(param).value.trim();

        if(ParamValue === '' || ParamValue === null){
            alert(paramNm + '이(가) 입력되지 않았습니다.')
            return false;

        }
        return true;
    }

    class LoginBoard {

        showModalopen(){
            let _this = this;
            let AuthCode = false;
            let content = tmpl('createHMIItemTemplate', {});
            let $content = $(content);  //제이쿼리 객체로 변환
            let modalContainer = new PopupDraggable('사용자 권한 설정');
            modalContainer.open({ width: 600, height: 420, $content });

            let _csrf = document.getElementsByName('_csrf');

            console.log(_csrf);


            let _CsrfValue = _csrf[0].value;


            //아이디 중복확인 신청
            let btnDuplicate = $content.find('#btnDuplicate');
            btnDuplicate.click(function (e){



                let userid = document.getElementById('id').value;
                if(userid.trim() === '' || userid === null){
                    alert('빈 값은 불가능합니다.');
                    return;
                }

                let data = {
                    _CsrfValue,
                    userid
                }

                let fnSuccess = function (res) {
                    if(res.success){
                        AuthCode = true;
                        Alert.alert('', res.message);
                        document.getElementById('id').readOnly = true;

                    } else if (!res.success){
                        AuthCode = false;
                        Alert.alert('', res.message);
                    }
                };
                AjaxUtil.postAsyncData("/useridchk", data, fnSuccess);

            })

            //권한신청 버튼 클릭
            let btnRegistersend = $content.find('#btnSaveAuth');
            btnRegistersend.click(function (e) {

                //유효성 검사
                for (let i = 0; i < requiredFields.length; i++) {
                    if (!ValidateChk(requiredFields[i], requiredFields2[i])) {

                        return;
                    }
                }

                if(!AuthCode){
                    alert('아이디중복 확인을 하지 않으셨습니다.');
                    return;
                }

                const emailInput = document.getElementById('email');
                const emailValue = emailInput.value.trim();

                // 이메일 형식의 정규 표현식
                const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

                if (!emailPattern.test(emailValue)) {
                    alert('유효한 이메일 주소를 입력하세요.');
                    return;
                }

                let password = document.getElementById('password').value;
                let password2 = document.getElementById('passwordchk').value;

                if(password !== password2){
                    Alert.alert('', '비밀번호가 맞지 않습니다.');
                    return;
                }

                let data = FormUtil.extractForm($('#bomForm'));
                console.log(data);

                let fnSuccess = function (res) {
                    if(res.success){
                        Alert.alert('', res.message);
                        $("#modal-close-button").trigger('click');
                    }else if (!res.success){
                        Alert.alert('', res.message);
                    }
                };
                AjaxUtil.postAsyncData("/Register/save", data, fnSuccess);
                AuthCode = false;
            })
        }
    }




    var userinfo = {
        username: '',
        login_id: '',
        group_code: '',
        read_flag: '{',
        write_flag: '',
        ip_address: '',
        crtfcKey: ''
    };

    var gui = {
        gui_code: '',
        template_key: '',
        action: '',
    };

    userinfo.can_read = function () {
        let result = false;
        if (userinfo.read_flag == 'True') {
            result = true;
        }
        return result;
    };

    userinfo.can_write = function () {
        let result = false;
        if (userinfo.write_flag == 'True') {
            result = true;
        }
        return result;
    };


</script>

<script type="text/javascript">

    /*
      Password Validator 0.1
      (c) 2007 Steven Levithan
      MIT License
     */
    function validatePassword(pw, options) {
        // default options (allows any password)
        var o = {
            lower: 0,
            upper: 0,
            alpha: 0, /* lower + upper */
            numeric: 0,
            special: 0,
            length: [0, Infinity],
            custom: [ /* regexes and/or functions */],
            badWords: [],
            badSequenceLength: 0,
            noQwertySequences: false,
            noSequential: false
        };

        for (var property in options)
            o[property] = options[property];

        var re = {
                lower: /[a-z]/g,
                upper: /[A-Z]/g,
                alpha: /[A-Z]/gi,
                numeric: /[0-9]/g,
                special: /[\W_]/g
            },
            rule, i;

        // enforce min/max length
        if (pw.length < o.length[0] || pw.length > o.length[1])
            return false;

        // enforce lower/upper/alpha/numeric/special rules
        for (rule in re) {
            if ((pw.match(re[rule]) || []).length < o[rule])
                return false;
        }

        // enforce word ban (case insensitive)
        for (i = 0; i < o.badWords.length; i++) {
            if (pw.toLowerCase().indexOf(o.badWords[i].toLowerCase()) > -1)
                return false;
        }

        // enforce the no sequential, identical characters rule
        if (o.noSequential && /([\S\s])\1/.test(pw))
            return false;

        // enforce alphanumeric/qwerty sequence ban rules
        if (o.badSequenceLength) {
            var lower = "abcdefghijklmnopqrstuvwxyz",
                upper = lower.toUpperCase(),
                numbers = "0123456789",
                qwerty = "qwertyuiopasdfghjklzxcvbnm",
                start = o.badSequenceLength - 1,
                seq = "_" + pw.slice(0, start);
            for (i = start; i < pw.length; i++) {
                seq = seq.slice(1) + pw.charAt(i);
                if (
                    lower.indexOf(seq) > -1 ||
                    upper.indexOf(seq) > -1 ||
                    numbers.indexOf(seq) > -1 ||
                    (o.noQwertySequences && qwerty.indexOf(seq) > -1)
                ) {
                    return false;
                }
            }
        }
        // enforce custom regex/function rules
        for (i = 0; i < o.custom.length; i++) {
            rule = o.custom[i];
            if (rule instanceof RegExp) {
                if (!rule.test(pw))
                    return false;
            } else if (rule instanceof Function) {
                if (!rule(pw))
                    return false;
            }
        }

        // great success!
        return true;
    }
</script>

<script type="text/javascript">
    var isChangeLang = 'N';

    let page = null;

    $(document).ready(function () {

        page = new LoginBoard();

        $('#modal-open').click(function (e){
            page.showModalopen();

        })

        var modal = new ax5.ui.modal();
        modal.setConfig({
            onStateChanged: function () {
                // console.log(this);
            }
        });




        if (top.location != window.location) {
            alert('로그아웃 되었습니다. 로그인 화면으로 이동합니다.')
            top.location.reload();

        }

        if (localStorage.getItem('theme-top') === null && localStorage.getItem('theme-left') === null) {
            dynamicLinkCss('/css/theme-top-a', '/css/theme-left-a');
        } else {
            dynamicLinkCss(localStorage.getItem('theme-top'), localStorage.getItem('theme-left'));
        }

        // Password show/hide
        $('.pass_box i').on('click', function () {
            $('.pass_box input').toggleClass('active');
            if ($('.pass_box input').hasClass('active')) {
                $(this).attr('class', "icon ion-md-eye").css({ "color": "#5567ff" }).prev('input').attr('type', "text");
            } else {
                $(this).attr('class', "icon ion-md-eye-off").css({ "color": "#989db1" }).prev('.pass_box input').attr('type', 'password');
            }
        });

        //// 로그인ID 저장 Cokiee 관련 처리
        $('#loginId').val(Cookies.get('loginId'));
        if ($('#loginId').val() != '') {
            $('#login_chk').attr('checked', true);
            $('#loginPwd').focus();
        }

        $('#login_chk').change(function () {
            if ($('#login_chk').is(':checked')) {
                Cookies.set('loginId', $('#loginId').val(), { expires: 7 });
            } else {
                Cookies.remove('loginId');
            }
        });

        $('#loginId').keyup(function () {
            if ($('#login_chk').is(':checked')) {
                Cookies.set('loginId', $('#loginId').val(), { path: '/', expires: 7 });
            }
        });

        function clearFields() {
            $('#loginId').val('');
            $('#loginPwd').val('');
            $('#loginId').focus();
        }

        function submitHandler(form) {

            // 패스워드 룰 관련 적용필요
            let passOption = {
                length: [8, 20],
                lower: 1,
                upper: 1,
                numeric: 1,
                special: 1,
                badWords: [],
                badSequenceLength: 4
            };

            let pwd = $('#loginPwd').val();
            let validationResult = validatePassword(pwd, passOption);
            if (!validationResult) {
                //Alert.alert('', '에러', clearFields);
                //return;
            }

            var submitData = $(form).serialize() + '&isChangeLang=' + isChangeLang + '&isMobile=' + isMobile();
            $.post('/login', submitData, function (result) {
                let code = result.data.code;
                var resultmsg = result.message;
                if (code == 'NOID') {
                    Alert.alert('', '아이디 또는 비밀번호가 일치하지 않습니다.', clearFields);
                }
                else if (code == 'NOPW') {
                    Alert.alert('', '비밀번호가 일치하지 않습니다', function () { $('#loginPwd').val(''); $('#loginPwd').focus(); });
                }
                else if (code == 'ETC') {
                    Alert.alert('', '로그인에 실패했습니다.&lt;br&gt;다시 시도하십시요', clearFields);
                } else if (code == 'NOAUTH') {
                    Alert.alert('', '시스템 접근 권한이 없습니다. 시스템관리자에게 확인하시기 바랍니다', clearFields);
                } else if (code == 'FIRST') {
                    Alert.alert('', '비밀번호를 변경하십시요.', function () { location.href = '/pwdchange'; });
                } else if (code == 'NOTCONFIRM') {
                    Alert.alert('', '승인되지 않은 사용자입니다.', clearFields);
                }
                else {
                    if (code == 'OK') {
                        let lang_cd = sessionStorage.getItem('lang_code');
                        let url = '/api/common/labels';
                        let pData = { lang_code: lang_cd };
                        let fnsuccess = function (result) {
                            dic = {};
                            $.each(result, function (idx, item) {
                                let storageKey = lang_cd + '_' + item.gui_code + '_' + item.template_key;
                                let data = [];
                                if (dic.hasOwnProperty(storageKey)) {
                                    data = dic[storageKey];
                                } else {
                                    dic[storageKey] = data;
                                }
                                data.push({ 'label_code': item.label_code, 'text': item.text, 'desc': item.descr });
                            });

                            $.each(dic, function (k, v) {
                                let sessionData = JSON.stringify(v);
                                sessionStorage.setItem(k, sessionData);
                            });
                            location.href = "/";
                        };

                        let fnfailure = function () {
                            location.href = "/login";
                        };
                        AjaxUtil.getAsyncData(url, pData, fnsuccess, fnfailure);
                        //location.href = "/";
                    } else {
                        location.href = '/';
                    }
                }
            }).fail(function (e) {
                Alert.alert('', JSON.parse(e.responseText).message);
            });
        }

        $('#loginFrm').validate({ submitHandler: submitHandler });



        $('#lang_select').on('click', function () {
            $('.lang_list').toggleClass('active');
            $('.lang_list li > label').on('click', function () {
                $('.lang_list').removeClass('active');
                $('.lang_list li').removeClass('on');
                $(this).parent('li').addClass('on');
                $('#lang_select .txt').text($(this).text());

                var icon = $(this).children('.icon').css('background-image');
                $('#lang_select i').css({
                    width: '16px', height: '16px',
                    background: icon + ' no-repeat',
                    color: 'transparent'
                });
            });
        });

        $('#lang1').on('click', function () {
            var langCd = $(this).val();
            sessionStorage.clear();
            sessionStorage.setItem('lang_code', langCd);
        });
        $('#lang2').on('click', function () {
            var langCd = $(this).val();
            sessionStorage.clear();
            sessionStorage.setItem('lang_code', langCd);
        });


        //$('#memberReg').click(function () { location.href = '/memberreg'; });

    });

    function getMobileToken(token) {
        $('#token').val(token);
    }

    function isMobile() {
        return (navigator.userAgent.indexOf('Mobi') > -1) ? 'F' : 'B'; // F: 모바일웹 B:PC웹
    }


</script>

</body>
</html>
