<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>

</style>
<th:block layout:fragment="content">

  <!--- (레이아웃) Contents 영역 -->
  <div class="layout-contents">
    <!-- Page Title -->
    <div class="page-title-wrap">
      <div class="left">
        <h2>주문 등록</h2>
        <!--                <a href="#" title="북마크" class="bookmark toggle">-->
        <!--                    내메뉴-->
        <!--                </a>-->
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
        <li>결재라인관리</li>
        <li>결재라인등록</li>
      </ul>
    </div>
    <!-- Select -->

    <div class="tab-wrap">
<!--      <ul class="tab-links">-->
<!--        <input type="hidden" id="checkdtParam" name="checkdtParam" th:value="${checkdt}"/>-->
<!--        <li>-->
<!--          <a href="#tab1" title="주문 등록" id="listTabLink">주문 등록</a>-->
<!--        </li>-->
<!--        <li>-->
<!--          <a href="#tab2" title="등록">주문/진행현황</a>-->
<!--        </li>-->
<!--      </ul>-->
      <div class="tab-contents">
        <!--      주문등록 탭 시작       -->
        <!-- Section -->
        <section class="tab-item" id="tab1">
          <div class="section-top">
            <div class="title-wrap">
              <h3>결재라인등록</h3>
              <!--              <img src="/images/icon/exclamation/exclamation-circle.svg"-->
              <!--                   class="zoom-img" style="margin-left: 5px"-->
              <!--                   onclick="openPopup('https://foms.atlassian.net/wiki/external/YzNmYmE3MTkyYTFlNGU2OGIwOTY5YTEyNDFiZjcwZmE')" alt="도움말">-->
            </div>
            <div class="button-wrap">
              <ul>
                <li>
                  <a id="newdataBtn" class="btn btn-excell" title="신규등록" onclick="resetFormFields()">
                    <img src="/images/icon/ico-plus.svg" alt="등록 아이콘">
                    신규등록
                  </a>
                </li>
                <li>
                  <a class="btn btn-delete" id="deleteButton" title="삭제">
                    <img src="/images/icon/ico-delete.svg" alt="삭제 아이콘">
                    삭제
                  </a>
                </li>
                <li>
                  <a class="btn btn-edit" id="btnSave" title="저장" onclick="saveOrder()">
                    <img src="/images/icon/ico-save.svg" alt="저장 아이콘">
                    저장
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <div class="table-wrap">
            <table class="write-table">
              <caption>내정보 테이블</caption>

              <tbody>
              <tr>
                <th style="text-align: center">
                  <label for="comcd">
                    문서코드
                  </label>
                </th>
                <td>
                  <select id="comcd">
                    <option></option>
                  </select>
                </td>
                <th style="text-align: center">
                  <label for="deldate">

                  </label>
                </th>
                <td>
                  <input type="date" id="deldate" name="deldate" style="width: 200px" disabled>
                  <span id="deldate_day"></span>
                </td>
                <th style="text-align: center">
                  <label for="telno">

                  </label>
                </th>
                <td>
                  <input type="text" id="telno" name="telno">
                </td>
              </tr>
              <tr>
                <th style="text-align: center">
                  <label for="perid">
                    등록사원
                  </label>
                </th>
                <td>
                  <input type="text" id="perid" name="perid" style="width: 200px" readonly>
                </td>
                <td>
                  <input type="text" id="pernm" name="perid" style="width: 200px" readonly>
                </td>
                <th style="text-align: center">
                  <label for="postno">

                  </label>
                </th>
                <td colspan="4">
                  <input type="text" id="postno" placeholder="우편번호"
                         onclick="sample4_execDaumPostcode()"
                         style="width: 100px; margin-bottom: 3px;">
                  <input type="text" id="address1" placeholder="도로명주소" style="width: 48%">
                  <input type="hidden" id="placeAddress" placeholder="지번주소">
                  <span id="guide" style="color:#999;display:none"></span>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
          <div class="container-fluid">
            <p id=""></p>
            <div id="theGrid2" style="max-height: 714px; height: 300px"></div>
          </div>
        </section>
        <!--       주문등록 탭 종료   / 주문 의뢰현황 시작       -->
        <!-- Section -->
        <!--      주문 의뢰 현황 종료          -->
      </div> <!--//tab-contens end-->
    </div> <!--//tab-wrap end-->
  </div> <!--//layout-contents end -->
  <footer style="margin-top:5px;">
    <p>Copyrightⓒ 0000 corp. All rights reserved.</p>
  </footer>
  <div style="height: 10px"></div>
</th:block>

<th:block layout:fragment="scripts">
  <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>

  <script type="text/javascript">

    var theGrid2;
    var viewdata2;
    let SelectItem;
    let csrfToken = $("[name=_csrf]").val();

    document.readyState === 'complete' ? init() : window.onload = init;

    // 오늘 날짜 설정
    const date = new Date();
    date.setHours(date.getHours() + 9); // UTC+9로 한국 시간 설정
    const today = date.toISOString().split('T')[0];

    // 현재 년도와 월을 가져옵니다
    const currentYear = date.getFullYear();
    const currentMonth = (date.getMonth() + 1).toString().padStart(2, '0'); // 1월은 0부터 시작하므로 +1 처리

    // 이번 달 1일을 설정
    const firstDayOfMonth = `${currentYear}-${currentMonth}-01`;

    <!-- 초반 페이지 진입시 그리드 바인딩 끝-->
    function init() {
      // 결재문서코드 불러오기 (comcd에 바인드)
      getComcd();
      // 선택된 문서코드 결재라인 그리드
      fetchListData2();



    }

    // DOM이 완전히 준비된 후에 특정 코드 실행
    $(document).ready(function (e) {
      // const selectElementId2 = ['exfmtypedv','infmtypedv','stframedv','stexplydv'];
      // for (const items of selectElementId2){
      //   getListCgrb(items);
      // }
    })

    // 주문현황 더블클릭 이벤트 기존탭 최신화
    document.addEventListener("DOMContentLoaded", function () {
      console.log("✅ order_request.html DOMContentLoaded 완료");

      window.addEventListener("message", function (event) {
        console.log("📩 메시지 수신! Origin:", event.origin);
        console.log("📩 메시지 내용:", event.data);

        if (event.data.action === "init") {
          console.log("📩 init 실행 요청 받음");
          init(); // `init()` 함수 실행
        }
      });

      // index.html에서 보낸 메시지가 iframe이 로드되기 전에 도착했을 경우 대비
      setTimeout(() => {
        window.parent.postMessage({ action: "requestInit" }, "*");
      }, 200);
    });
    // 문서코드 리스트 불러와 comcd(select)속성(option)으로 바인드
    function getComcd() {
      $.ajax({
        url: '/api/request/request/getComcd',
        type: 'GET',
        data: {},
        async: false,
        success: function (data) {
          data2 = data.data;
          data2.forEach(item =>{
            // 바인드
          })
        }
      })
    }

    // 주문등록 세부내용 그리드
    function fetchListData2(saupnum) {
      let data2 = [];

      $.ajax({
        url: '/api/request/request/read',
        type: 'GET',
        data: {
          'comcd': $('#comcd').val()
        },
        async: false,
        success: function (data) {
          data2 = data.data;
          data2.forEach(item =>{
          })
          // data2의 개수가 5개 미만인 경우 빈 객체 추가
          while (data2.length < 5) {
            data2.push({});
          }
        }
      })

      viewdata2 = new wijmo.collections.CollectionView(data2);

      if (!theGrid2) {

        // 데이터 그리드에 바인딩
        theGrid2 = new wijmo.grid.FlexGrid('#theGrid2', {
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          selectionMode: wijmo.grid.SelectionMode.Row,
          columns: [
            {binding: 'index', header: 'No', width: 80, align: 'right'},
            {binding: 'kcperid', header: '결재자코드', width: '*', minWidth: 100, align: 'center'},
            {binding: 'kcpernm', header: '결재자명', width: '*', minWidth: 100, align: 'right'},
            {binding: 'papercd', header: '구분', width: '*', minWidth: 100, align: 'right'},
            {binding: 'seq', header: '결재순서', width: '*', minWidth: 100, align: 'right'}
          ],
          itemsSource: viewdata2,
          itemFormatter: function (panel, r, c, cell) {
            if (panel.cellType === wijmo.grid.CellType.Cell) {
              var item = panel.rows[r].dataItem; // 현재 행의 데이터 항목
              if (panel.columns[c].binding === 'ordtext') {
                cell.innerHTML = ''; // 셀 내용 초기화
                if (item.ordtext) {
                  cell.innerHTML = '<a title="수정팝업" class="" onclick="showPopup3(\'popup2\')" style="color: #03428E">요청사항 확인</a>';
                }
              }
            }
          }
        });
        // 헤더를 중앙 정렬하는 이벤트 핸들러
        theGrid2.formatItem.addHandler(function (s, e) {
          if (e.panel === s.columnHeaders) {
            e.cell.style.textAlign = 'center';
          }
        });
        // 첫열에 selectBox 추가
        let selector = new wijmo.grid.selector.Selector(theGrid2, {
          itemChecked: (e, ctx) => {
            SelectItem = theGrid2.rows.filter(r => r.isSelected);

          }
        })
        // 더블클릭 이벤트
        theGrid2.hostElement.addEventListener('dblclick', function (e) {
          // 그리드의 셀 정보 가져오기
          let hitTest = theGrid2.hitTest(e);
          if (hitTest.cellType === wijmo.grid.CellType.Cell) {
            // 행(row), 행의 데이터(item) 정보 가져오기
            let row = hitTest.row;
            let item = theGrid2.rows[row].dataItem;

            document.getElementById('qty').value = item.qty;
            document.getElementById('panel_t').value = item.panel_t;
            document.getElementById('panel_w').value = item.panel_w;
            document.getElementById('panel_l').value = item.panel_l;
            document.getElementById('reqseq').value = item.reqseq;
            document.getElementById('isnew').value = item.isnew;
            document.getElementById('ordtext').value = item.ordtext;

            const selectHgrb = document.getElementById('hgrb');
            const selectExfmtypedv = document.getElementById('exfmtypedv');
            const selectInfmtypedv = document.getElementById('infmtypedv');
            const selectStframedv = document.getElementById('stframedv');
            const selectStexplydv = document.getElementById('stexplydv');

            const selectedItem = item;

            setSelectedIndex(selectHgrb, selectedItem.hgrb);
            setSelectedIndex(selectExfmtypedv, selectedItem.exfmtypedv);
            setSelectedIndex(selectInfmtypedv, selectedItem.infmtypedv);
            setSelectedIndex(selectStframedv, selectedItem.stframedv);
            setSelectedIndex(selectStexplydv, selectedItem.stexplydv);
          }
        })
        // FlexGrid의 최대 높이를 제한하여 스크롤바를 활성화
        theGrid2.hostElement.style.maxHeight = '300px'; // 약 5개의 행 높이에 맞게 설정
        theGrid2.hostElement.style.overflowY = 'auto';
        // 선택이 변경될 때, 현재 항목 업데이트
        new FlexGridContextMenu(theGrid2);
        window.downloadFileName = '주문등록';
      } else {
        // 이미 FlexGrid이 존재하는 경우, 데이터만 업데이트
        theGrid2.itemsSource = viewdata2;
      }
    }
    // option값 value bind
    function setSelectedIndex(selectElement, selectedValue) {
      let found = false;

      for (let i = 0; i < selectElement.options.length; i++) {
        if (selectElement.options[i].text.trim().toLowerCase() === String(selectedValue).trim().toLowerCase()) {
          selectElement.selectedIndex = i;
          found = true;
          break;
        }
      }

      // 일치하는 값이 없을 경우, 기본값 0 설정
      if (!found) {
        selectElement.selectedIndex = 0;
      }
    }

    // 셀렉트값에 따라 id 히든으로 넘기기
    function updateSelect(selectId, hiddenInputId) {
      var selectElement = document.getElementById(selectId);
      var selectedOptionText = selectElement.options[selectElement.selectedIndex].text;
      document.getElementById(hiddenInputId).value = selectedOptionText;
    }

    // 헤드정보 삭제(세부사항 존재시 안내 alert기능)
    $(document).ready(function () {
      $('#deleteButton').off('click').on('click', deletehead);
    });

    let isProcessing = false;

    function deletehead() {
      if (isProcessing) return;

      const reqnum = $('#reqnum').val();
      if (!reqnum) {
        Alert.alert('', '삭제할 항목을\n진행현황에서 선택해주세요.');
        return;
      }

      Alert.confirm('', '주문 등록정보를\n삭제하시겠습니까?', function () {
        isProcessing = true;

        let data = {
          'reqnum': reqnum,
          '_csrf': csrfToken
        };

        let fnSuccess = function (res) {
          isProcessing = false;
          if (res.success) {
            Alert.alert('', '삭제되었습니다.');
            fetchListData();
            resetFormFields();
          }
        };

        AjaxUtil.postAsyncData('/api/request/request/delete', data, fnSuccess);
      });
    }

    // 필드값 초기화
    function resetFormFields() {
      const fieldsToReset = [
        'panel_ht',
        'panel_hw', 'panel_hl', 'panel_hh', 'remark', 'hgrb',
        'qty', 'panel_t', 'panel_w', 'panel_l',
        'exfmtypedv', 'infmtypedv', 'stframedv', 'stexplydv', 'reqnum', 'reqseq'
      ];

      fieldsToReset.forEach(fieldId => {
        document.getElementById(fieldId).value = '';

      });
      document.getElementById('ordtext').value = ""
      document.getElementById('reqdate').value = today;
      document.getElementById('deldate').value = today;
      $('.filelist2').empty(); // 파일 리스트 초기화
      uploadedFiles2 = []; // 업로드된 파일 리스트 초기화
      deletedFiles2 = [];
      // 초기화된 파일 개수 업데이트
      updateFileCount2();
      resetFileInput($('.fileInput2'));
      $('.text-count').text('0/100'); // 글자 수 0으로 초기화
      // 특정 필드에 대한 btn-clear 숨김 처리
      $('#doctitle').each(function () {
        $(this).siblings('.btn-clear').hide();
      });

      let data2 = [];
      // 기존 CollectionView를 초기화하기 위해 sourceCollection을 빈 배열로 설정 후 새 데이터 할당
      if (viewdata2) {
        viewdata2.sourceCollection = data2;
        viewdata2 = new wijmo.collections.CollectionView(data2);
        theGrid2.itemsSource = viewdata2;
        viewdata2.refresh();
      } else {
        viewdata2 = new wijmo.collections.CollectionView(data2);
      }

      // 그리드도 갱신
      theGrid2.itemsSource = viewdata2;
      theGrid2.refresh();

      document.getElementById('btnSave').title = "저장";
    }


    // 내정보 불러오는 함수
    function getMyInfo(saupnum) {
      return new Promise((resolve, reject) => {
        $.ajax({
          url: '/api/request/request/getUserInfo',
          data: {'saupnum': saupnum},
          type: 'GET',
          success: function (data) {
            document.getElementById("telno").value = data.data.hptelnum;
            document.getElementById("perid").value = data.data.prenm;
            document.getElementById("postno").value = data.data.zipcd;
            document.getElementById("address1").value = data.data.cltadres.replace(/\s*\|/g, '').trim();
            document.getElementById("cltnm").value = data.data.cltnm;
            document.getElementById("searchComnm").value = data.data.cltnm;
            console.log("✅ getMyInfo 완료, searchComnm 값:", data.data.cltnm);

            resolve(); // ✅ 완료되면 resolve() 호출
          },
          error: function (error) {
            console.error("❌ getMyInfo 실패:", error);
            reject(error);
          }
        });
      });
    }

    // YYYYMMDD → Date 객체 변환
    function parseDate(dateStr) {
      let year = parseInt(dateStr.substring(0, 4), 10);
      let month = parseInt(dateStr.substring(4, 6), 10) - 1;
      let day = parseInt(dateStr.substring(6, 8), 10);
      return new Date(year, month, day);
    }

    // Date 객체 → YYYYMMDD 형식 변환
    function formatDate(date) {
      let yyyy = date.getFullYear();
      let mm = String(date.getMonth() + 1).padStart(2, '0');
      let dd = String(date.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;  // HTML input 필드와 호환되도록 수정
    }


    // // enter입력시 다음 input으로 cursor이동
    // function moveFocusOnEnter(currentId, nextId) {
    //   const currentElement = document.getElementById(currentId);
    //   currentElement.addEventListener("keydown", function(event) {
    //     if (event.key === "Enter") {
    //       event.preventDefault(); // 기본 Enter 동작 방지
    //       const nextElement = document.getElementById(nextId);
    //       if (nextElement) {
    //         nextElement.focus(); // 포커스 이동
    //       }
    //     }
    //   });
    // }
    // moveFocusOnEnter("reqdate", "deldate");
    // moveFocusOnEnter("deldate", "telno");
    // moveFocusOnEnter("telno", "perid");
    // moveFocusOnEnter("perid", "panel_ht");
    // moveFocusOnEnter("panel_ht", "panel_hw");
    // moveFocusOnEnter("panel_hw", "panel_hl");
    // moveFocusOnEnter("panel_hl", "panel_hh");
    // moveFocusOnEnter("panel_hh", "remark");
    // moveFocusOnEnter("remark", "hgrb");
    // moveFocusOnEnter("hgrb", "qty");
    // moveFocusOnEnter("qty", "panel_t");
    // moveFocusOnEnter("panel_t", "panel_w");
    // moveFocusOnEnter("panel_w", "panel_l");
    // moveFocusOnEnter("panel_l", "exfmtypedv");
    // moveFocusOnEnter("exfmtypedv", "infmtypedv");
    // moveFocusOnEnter("infmtypedv", "stframedv");
    // moveFocusOnEnter("stframedv", "stexplydv");
  </script>

</th:block>
</html>

