<html layout:decorate="~{layout_page}">

<th:block layout:fragment="content">
<style scopped>
	.background-yellow {
		background: #ffd800;
	}
	.background-skyblue {
		background: #00e0ff;
	}
	.background-white {
		background: #ffffff;
	}
	
	.standard-table { width: 100%; }
	.standard-table th { border: 1px solid #d0d8dd; background: #f5f6fa; height: 30px; text-align: center; }
	.standard-table td { border: 1px solid #d0d8dd; height: 30px; padding: 7px; line-height: 1.3; }
</style>
<div class="content_wrap">
    <input type="hidden" id="bhId" th:value="${bh_id}" />
    <input type="hidden" id="data_date" th:value="${data_date}" />
    <input type="hidden" id="search_cond" th:value="${searchcond}" />
    <input type="hidden" id="viewMode" th:value="${view_mode}" />
    <input type="hidden" id="diary_type" th:value="${diary_type}" />
    <section class="section">
        <div class="title_box ">
            <div class="left_align">
                <h3 data-labelCd="개인위생일지">개인위생일지</h3>
            </div>
            <button type="button" class="btn-default pull-right " id="btnHedaerFilter" title="필터 보이기/감추기"><i class="fas fa-filter"></i></button>
            <button type="button" class="btn-default pull-right mr-1" id="btnHeaderCompress" title="화면 확대/축소"><i class="fas fa-compress" id="iCompress"></i></button>
        </div>

        <div class="table_box search">
            <div class="row">
                <div class="col-6 col-lg-6 col-xl-6">
                    <div class="row">
                        <div class="col-12 col-lg-12 col-xl-12">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text fit_box_sm" data-labelCd="일지명">일지명</span>
                                </div>
                                <input class="form-control2 tac" type="text" id="title" name="title" />
                            </div>
                        </div>
                        <div class="col-6 col-lg-6 col-xl-6">
                            <div class="input-group" data-ax5picker="multi" id="pickerDate">
                                <div class="input-group-prepend">
                                    <span class="input-group-text fit_box_sm" data-labelCd="점검일">점검일</span>
                                </div>
                                <input class="form-control2 tac" type="text" id="dataDate" name="dataDate"/>
                                <span class="input-group-text fs-xl"><i class="fas fa-calendar-alt calendar_color"></i></span>
                            </div>
                        </div>
                        <div class="col-6 col-lg-6 col-xl-6">
		                   <div class="input-group">
		                        <div class="input-group-prepend">
		                            <span class="input-group-text fit_box_sm" style="color:red;" data-labelCd="*일지종류">*일지종류</span>
		                        </div>
		                        <select class="form-control2" type="text" id="diaryType" name="diaryType"></select>
		                    </div>
		                </div>
		                <div class="col-6 col-lg-6 col-xl-6">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text fit_box_sm" data-labelCd="작성자">작성자</span>
                                </div>
                                <input class="form-control2 tac" type="text" id="firstName" name="firstName" disabled />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-6 col-xl-6">
                    <div id="approveBox"></div>
                </div>
            </div>
        </div>
        
        <div class="title_box">
        	<span class="right_align rpt" data-labelCd="점검기준">점검기준</span>
	        <div class="left_align">
		        <label class="switch">
		            <input type="checkbox" checked id="btnToggle" /><span
		            class="slider round"
		            ></span>
		        </label>
		        점검기준 보기/감추기
	        </div>
    	</div>
		
		<div id="standardDIv">
	        <div class="row">
	        <div class="col-12">
	            <table class="standard-table">
	                <colgroup>
	                    <col style="width: 15%;" />
	                    <col style="width: 85%;" />
	                </colgroup>
	                <tr>
	                    <th scope="row">관리기준</th>
	                    <td>
	                        ▣ 건강상태 : 감기, 화농성 상처, 설사, 복통 증상 <br />
			                ▣ 위생복 청결상태 : 위생복, 위생모, 위생장화, 마스크, 앞치마 등 작업 복장을 완벽히 착용 <br />
			                ▣ 종업원 청결상태 : 손톱청결(매니큐어와 인조손톱 금지), 머리 청결상태, 짙은 화장과 향수 금지 <br />
			                ▣ 출입절차 준수 여부 : 끈끈이 롤러 - 손세척 - 손건조 - 손소독
	                    </td>
	                </tr>
	                <tr>
	                    <th scope="row">점검주기</th>
	                    <td>▣ 1회 / 일</td>
	                </tr>
	                <tr>
	                    <th scope="row">판정결과</th>
	                    <td>▣ 양호(O), 불량(X)</td>
	                </tr>
	            </table>
	        </div>
	        </div>
	    </div>
    </section>

    <section class="section">
        <div class="grid_box" id="prodListGrid">
            <div class="title_box">
                <span class="right_align rpt" data-labelCd="점검 목록">점검 목록</span>
                <!--<button type="button" class="btn-default" id="btnExcel"><i class="fas fa-file-excel"></i></button>-->
                <button type="button" class="btn-default" id="btnDiaryPrint">일지출력</button>
                <!--<button type="button" class="btn-default" id="btnAllItem">전체적합</button>-->
                <button type="button" class="btn-default" id="btnReqAppr">결재상신</button>
                <button type="button" class="btn-default" id="btnAppr" style="display:none;">승인</button>
                <button type="button" class="btn-cancel" id="btnReject" style="display:none;">반려</button>
                <button type="button" class="btn-default" id="btnSave">저장</button>
                <button type="button" class="btn-cancel" id="btnDelete">삭제</button>
                <button type="button" class="btn-default" id="btnList">목록</button>
            </div>
            <div class="title_box" id="interior_div">
	            <div class="row">
	            	<div class="col-6 col-md-2">
		                <div class="input-group">
		                    <div class="input-group-prepend">
		                        <span class="input-group-text fit_box_sm" data-labelCd="부서">부서</span>
		                    </div>
		                    <select class="form-control2" type="text" id="departType" name="departType"></select>
		                </div>
	            	</div>
	                <div class="col-6 col-md-2">
		                <button type="button" class="btn-default" id="btnInterAddRow"><i class="fas fa-plus"></i>행추가</button>
		                <button type="button" class="btn-cancel" id="btnInterDelRow"><i class="fas fa-trash"></i>행삭제</button>
	                </div>
	            </div>
            </div>
            
            <div class="title_box" id="exterior_div">
	            <div class="row">
	            	<div class="col-6 col-md-3">
		                <div class="input-group" data-ax5picker="pickerExterDate" id="pickerExterDate">
                            <div class="input-group-prepend">
                                <span class="input-group-text fit_box_sm" data-labelCd="날짜">날짜</span>
                            </div>
                            <input class="form-control2 tac" type="text" id="dataExterDate" name="dataExterDate"/>
                            <span class="input-group-text fs-xl"><i class="fas fa-calendar-alt calendar_color"></i></span>
                        </div>
	            	</div>
	            	
	                <div class="col-6 col-md-2">
		                <button type="button" class="btn-default" id="btnExterAddRow"><i class="fas fa-plus"></i>행추가</button>
		                <button type="button" class="btn-cancel" id="btnExterDelRow"><i class="fas fa-trash"></i>행삭제</button>
	                </div>
	            </div>
            </div>
            
            <div class="grid_box" id="firstList">
                <div class="h-400" data-ax5grid="check_item_first_grid" ></div>
            </div>
            <div class="grid_box" id="secondList">
                <div class="h-400" data-ax5grid="check_item_second_grid" ></div>
            </div>
        </div>
    </section>
    
    <section id="devi_section">
        <div class="grid_box" id="sub_grid">
            <div class="title_box" id="button_box2">
                <span class="right_align rpt" data-labelCd="이탈 목록">이탈 목록</span>
                <div class="left_align">
                    <button type="button" class="btn-default" id="btnDeviActionSave" style="display:none">저장</button>
                </div>
            </div>
            <div class="h-200" data-ax5grid="devi_action_grid"></div>
        </div>
    </section>
    
    <section id = "sign_section">
    <div class="row">
	     <div class="col-12">
			  <div class="input-group">
	 			   <div style = "display: block; height:auto;">
						<span class="input-group-text fit_box_t4_area" data-labelcd="점검자 정보" style="height:100% !important">점검자 정보</span>  
	   			   </div>
	   			   <div style="border: 0.5px solid lightgray;">
	   			   	<div class="p-2" style="text-align: right;">
	   			   		<button id="addRow" class="btn-popup"> 점검자 추가</button>	
	   			   	</div>
	                <table border='1' class="m-3" style="border-color:lightgray;">
					    <thead>
					      <tr class="text-center" style="background-color: #f3f3f3; border: 1px solid #E5E5E5; height:30px;">
					        <th style="width:200px;">점검자</th>
					        <th style="width:400px;">서명</th>
					        <th style="width:100px">열삭제</th>
					      </tr>
					    </thead>
					    <tbody id="table_body">
					     
					    </tbody>
				  </table>
			  </div>
			</div>
		</div>
	</div>
    </section>
</div>

</th:block>

<th:block layout:fragment="scripts">
<th:block th:replace="/common/approve_box :: approve_box"></th:block>
<th:block th:replace="/common/ax5_uploader :: ax5_uploader" ></th:block>
<th:block th:replace="/common/popup_sign.html :: popup_sign" ></th:block>
<th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>
<script type="text/javascript">
    class CheckResultDiaryPage {
        constructor() {
            this.grid = null;
            this.approveBoxUtil = null;
            this.fisrtGrid = null;
            this.secondGrid = null;
            this.uploader = null;
            this.checkMasterName = null;
            this.titleName = '개인위생일지'
            this.baseUrl = '/api/precedence/person_hygiene_check';
            this.headInfo = {State:''};
            this.init();
        }
        

        init() {
            let _this = this;
            
			this.gparam = {
				bh_id : $('#bhId').val(),
				data_date : $('#data_date').val(),
				search_cond: $('#search_cond').val(),
				view_mode: $('#viewMode').val(),
				diary_type: $('#diary_type').val(),
			};
			
            let firstGridConfig = {
                target: $('[data-ax5grid="check_item_first_grid"]'),
                frozenColumnIndex: 0, // 열 고정
                frozenRowIndex: 0,    // 행 고정
                showLineNumber: true, // 열의 번호 보이기 여부
                showRowSelector: true,  // checkbox(선택) 보이기 여부
                multipleSelect: true, // 여러행 선택 가능 여부 (false시 단독 선택)
                sortable: false, // 모든 컬럼에 정렬 아이콘 표시 (columns에서 컬럼별 소팅여부 재설정 가능)
                multiSort: false, // 다중 정렬 여부
                header: {
                    align: 'center',  // 헤더의 기본 정렬
                    columnHeight: 35  // 헤더 높이
                },
                body: {
                    columnHeight: 35, // body의 기본 높이
                    mergeCells: ["group1","group2"],
                    onClick: function (e) {
						_this.firstGrid.select(this.dindex);
						// 조회 모드가 아닐때
						if(!$('#viewMode').val()){
	                        if(e.column.editor && e.column.editor.type == 'OX'){
								switch ( e.item[e.column.key] ) {
								  case null:
								    e.item[e.column.key] = 'O';
								    break;
								  case 'O':
								    e.item[e.column.key] = 'X';
								    break;
								  case 'X':
								    e.item[e.column.key] = null;
								    break;
								    
								}
								
							}
							if (e.column.key == 'day_off' && !$('#viewMode').val()) {
								if (e.item.day_off == null) {
	                                e.item.day_off = 'O';
								}
								else if (e.item.day_off == 'O') {
	                                e.item.day_off = 'X';
								}
								else if (e.item.day_off == 'X') {
	                                e.item.day_off = null;
								}
							}
							if(e.item.item0 == 'O' && e.item.item1 == 'O' && e.item.item2 == 'O'
									&& e.item.item3 == 'O' && e.item.item4 == 'O'){
								// item5 - 판정
								e.item.item5 = 'O';
								// 서명 클릭하지 않았을 때
								if(e.item.sign_state == 'N'){
									e.item.signature = '확인(클릭)'
								}
							}else{
								e.item.item5 = 'X';
							}
							
							// 불합격이면 무조건 초기화
							if(e.item.item5 == 'X'){
								e.item.signature = undefined;
								e.item.sign_state = 'N';
							}
							
							// 서명 확인 클릭 시
							//if (e.column.key == 'signature' && e.item.sign_state=='Y' && e.item.img_src){
								//_this.editSign(e.dindex);
							//}
							
	                        _this.firstGrid.repaint();
                        }
                    },
                    onDataChanged: function () {
                    }
                },
                page: {
                    display: true,  // 페이징 보이기 여부
                    statusDisplay: true,
                },
                
                
            }
            this.firstGrid = new ax5.ui.grid(firstGridConfig);
            this.fisrt_grid_config = firstGridConfig;
            
            let secondGridConfig = {
                target: $('[data-ax5grid="check_item_second_grid"]'),
                frozenColumnIndex: 0, // 열 고정
                frozenRowIndex: 0,    // 행 고정
                showLineNumber: true, // 열의 번호 보이기 여부
                showRowSelector: true,  // checkbox(선택) 보이기 여부
                multipleSelect: true, // 여러행 선택 가능 여부 (false시 단독 선택)
                sortable: false, // 모든 컬럼에 정렬 아이콘 표시 (columns에서 컬럼별 소팅여부 재설정 가능)
                multiSort: false, // 다중 정렬 여부
                header: {
                    align: 'center',  // 헤더의 기본 정렬
                    columnHeight: 35  // 헤더 높이
                },
                body: {
                    columnHeight: 35, // body의 기본 높이
                    mergeCells: ["group1","group2"],
                    onClick: function (e) {
						_this.secondGrid.select(this.dindex);
						if(!$('#viewMode').val()){
	                        if(e.column.editor && e.column.editor.type == 'OX'){
								switch ( e.item[e.column.key] ) {
								  case (null || undefined):
								    e.item[e.column.key] = 'O';
								    break;
								  case 'O':
								    e.item[e.column.key] = 'X';
								    e.item.ox_state = 'X';
								    e.item.signature = undefined;
									e.item.sign_state = 'N';
								    break;
								  case 'X':
								    e.item[e.column.key] = undefined;
								    e.item.ox_state = 'X';
								    e.item.signature = undefined;
									e.item.sign_state = 'N';
								    break;
								}
								_this.secondGrid.repaint();
							}
							//if(e.item.day_off == 'N'){
								if(this.item.item0 == 'O' && this.item.item1 == 'O' && this.item.item2 == 'O'
										&& this.item.item3 == 'O' && this.item.item4 == 'O'){
									this.item.ox_state = 'O';
									
								}else{
									this.item.ox_state = 'X';
									//_this.secondGrid.repaint();
								}
								
								if(this.item.temperature_state == 'Y' && this.item.ox_state == 'O'){
									if(this.item.sign_state == 'N'){
										this.item.signature = '확인(클릭)'
										//if(e.column.key != 'item5'){
											_this.secondGrid.repaint();
										//}
									}
								}
                        }
                    },
                    onDataChanged: function () {
						// editor type : text 는 onDataChanged 에서 제어
						if(this.item.item5 != undefined || this.item.item5 != ''){
							this.item.temperature_state = 'Y';
						}
						if(this.item.item5 == undefined || this.item.item5 == ''){
							this.item.temperature_state = 'N';
						}
						
						if(this.item.temperature_state == 'Y' && this.item.ox_state == 'O'){
							if(this.item.sign_state == 'N'){
								this.item.signature = '확인(클릭)'
							}
						}
						_this.secondGrid.repaint();		
                    }
                },
                page: {
                    display: true,  // 페이징 보이기 여부
                    statusDisplay: true,
                },
                
                
            }

			this.secondGrid = new ax5.ui.grid(secondGridConfig);
            this.second_grid_config = secondGridConfig;
            
            // 조치내역 그리드
            let devi_action_config = {
                target: $('[data-ax5grid="devi_action_grid"]'),
                frozenColumnIndex: 0, // 열 고정
                frozenRowIndex: 0,    // 행 고정
                showLineNumber: false, // 열의 번호 보이기 여부
                showRowSelector: false,  // checkbox(선택) 보이기 여부
                multipleSelect: false, // 여러행 선택 가능 여부 (false시 단독 선택)
                sortable: false, // 모든 컬럼에 정렬 아이콘 표시 (columns에서 컬럼별 소팅여부 재설정 가능)
                multiSort: false, // 다중 정렬 여부
                header: {
                    align: 'center',  // 헤더의 기본 정렬
                    columnHeight: 25  // 헤더 높이
                },
                body: {
                    columnHeight: 25, // body의 기본 높이
                    onClick: function (e) {
                        _this.deviGrid.select(this.dindex);

                        if (e.column.key == 'action_detail' && !$('#viewMode').val()) {
                            _this.showDeviActionCodeSavePopup(e.item);
                        }
                    },
                    onDataChanged: function (e) {
                    }
                },
                page: {
                    display: true,  // 페이징 보이기 여부
                    statusDisplay: false,
                },
                columns: [
                    { key: 'id', label: '번호', width: 80, align: 'right', hidden: true },
                    { key: 'index_order', label: '순번', width: 50, align: 'center' },
                    { key: 'src_data_pk', label: '점검항목결과번호', width: 80, align: 'right', hidden: true },
                    //{ key: 'happen_date', label: '발생일', width: 80, align: 'left' },
                    { key: '_order', label: '순번', width: 50, align: 'center', hidden: true },
                    { key: 'abnormal_detail', label: '이상발생내역', width: 400, align: 'left' },
                    { key: 'action_detail', label: '<span class="editable_clr">조치내역및결과</span>', width: 250, align: 'left', editor: {} },
                    { key: 'actor_name', label: '조치자', width: 80, align: 'left' },
                    { key: 'creater_name', label: '작성자', width: 80, align: 'left' },
                    { key: 'confirm_state', label: '확인', width: 80, align: 'left', hidden: true },
                ]
            };
            this.deviGrid = new ax5.ui.grid(devi_action_config);
            
            
		    $('#table_body').on('click', "button", function(e){ 
			    let $btn = $(this);
			    let t =$btn.attr('t'); 
			    if(t=='delete'){
				    $btn.parent().parent().remove();
			    } else if (t=='editSign') {
					_this.editSign($btn)
			}
			    
	        });
        }
        
        addRow() {//행 추가
        	let first = page.firstGrid.getList("selected")[0]
        	let second = page.secondGrid.getList("selected")[0]
        	
        	let worker = '점검자명'
        	
        	if (first != undefined && $('#diaryType').val() == '개인위생일지(직원)') {
				worker = first.worker
			} else if (second != undefined && $('#diaryType').val() == '개인위생일지(외부방문자)') {
				worker = second.worker
			}
			
		    $('#table_body').append(                   
			     " <tr>"                                        
			    + "  <td class='p-2'>"
			    + "    <input type='text' name = 'studentName' class='form_control' value=" + worker + ">"
			    + "  </td>"
			    + "  <td class='text-center'>"
			    + "    <button t='editSign'> "
			    + "    <img t='editImg' name = 'signImg'></img>"
			    + "  	  <i class='fas fa-pen'></i> "
			    + "  </button>"
			    + "  </td>"
			    + "  <td class='text-center'>"
			    + "      <button t='delete'>"
			    + "     	 <i class='fas fa-trash'></i>"
			    + "      </button>"
			    + "  </td>"
			    + "</tr>"
			)

		}
		
        showDeviActionCodeSavePopup(item) {

            // 점검내역 조치내역 팝업
            let _this = this;
            let popupPage = new PopupSelectUserCodePage({

                'title': '조치내역 선택',
                'gridValueLabel': '점검항목',
                'infoData': [
                    { label: '이상발생내역', value: item.abnormal_detail },
                ],
                'parentCode': '개인위생일지조치', 'closeManual': true,
            });
            popupPage.show(function (data) {
                if (data && data.selected.Code == '직접입력') {
                    item.action_detail = data.input;
                } else {
                    item.action_detail = data.selected.Value;
                }
                popupPage.close();
                _this.deviGrid.repaint();
                if (item.action_detail) {
					_this.saveDeviAction(item.check_result_id);
                }
                
            });
        }

        saveDeviAction(id) {
            let _this = this;
			let url = '/api/common/devi_action';
            let list = _this.deviGrid.getList('selected')[0]
            if (!list) return;

            let data = {
                id : list.id,
                source_pk : list.src_data_pk,
                source_table_name : 'person_hygiene_check',
                happen_date : list.happen_date,
                abnormal_detail : list.abnormal_detail,
                action_detail : list.action_detail,
                confirm_detail : list.confirm_detail,
            }

			let fnSuccess = function () {
				Notify.success('저장되었습니다');
			}
			AjaxUtil.postAsyncData(url + '/save_dev_action', data, fnSuccess);
        }
        
        // 일지 조회
        searchMainData(diary_type) {
            let _this = this;
            $('#btnDiaryPrint').hide();
            $('#btnDelete').hide();
            $('#firstName').val(userinfo.username);
            $('#title').val(_this.titleName);
            
            if ($('#bhId').val() > 0) {
                let param = {
                    'bh_id': $('#bhId').val(),
                    'diary_type': $('#diary_type').val() == '' ? diary_type : $('#diary_type').val(),
                };
                let result = AjaxUtil.getSyncData(_this.baseUrl + '/read', param);

                if (result.data != null) {
                    let headInfo = result.data.head_info;
                    let diaryInfo = result.data.diary_info;
                    let actionInfo = result.data.action_info;
                    let studentInfo = result.data.student_info;
                    
                    _this.headInfo.State = headInfo.State;

                    $('#title').val(headInfo.Title);
                    $('#dataDate').val(headInfo.DataDate);
                    $('#firstName').val(headInfo.FirstName);
                    $('#diaryType').val(headInfo.diary_type);
					// 조회,수정 시 헤더(컬럼) 설정 후 그리드 data set
					_this.columnSetBySearchItem();
					
            		if($('#diaryType').val() == '개인위생일지(직원)'){
	                    _this.firstGrid.setData({
	                        list: diaryInfo,
	                        page: {
	                            display: true,
	                            totalElements: firstList.length,
	                        }
	                    });
                    }
	                else{
	                    _this.secondGrid.setData({
			                list: diaryInfo,
			                page: {
			                    display: true,
			                    totalElements: secondList.length,
			                }
			            });
			         }
			         _this.deviGrid.setData({
                        list: actionInfo,
                        page: {
                            display: true,
                            totalElements: actionInfo.length,
                        }
                    });
                    
                    _this.deviGrid.setHeight(actionInfo.length * 25 + 100);
                    
                   if (studentInfo != null) {
					
					$('#table_body').children().remove();
					
					for(var i = 0; i < studentInfo.length; i++) {
					    $('#table_body').append(                   
					     " <tr>"                                        
					    + "  <td class='p-2'>"
					    + "    <input type='text' name = 'studentName' class='form_control' value=" + studentInfo[i].StudentName + ">"
					    + "  </td>"
					    + "  <td class='text-center'>"
					    + "    <button t='editSign'> "
					    + "    <img t='editImg' name = 'signImg' id = 'signImg" +studentInfo[i].id +"'></img>"
					    + "  	  <i class='fas fa-pen'></i> "
					    + "  </button>"
					    + "  </td>"
					    + "  <td class='text-center'>"
					    + "      <button t='delete'>"
					    + "     	 <i class='fas fa-trash'></i>"
					    + "      </button>"
					    + "  </td>"
					    + "</tr>"
						)
						
	                	_this.setImg(studentInfo[i].id);
					}
				}
				
                } 

            }else {
				// 최초 등록 시 헤더(컬럼) 설정 , 행은 가변
                _this.columnSetBySearchItem();
            }
            

				
			_this.viewModeSetting();
            
        }
        
        columnSetBySearchItem() {
            let _this = this;

			if($('#diaryType').val()){
	            let param = {
	                'srch_check_name': $('#diaryType option:checked').val()
	            }
	            let check_master_info = AjaxUtil.getSyncData('/api/check/check_master/read', param);
	            _this.check_master_id = check_master_info.data[0].id
	
	            let data = {
	                'check_master_id': _this.check_master_id,
	                'check_date': $('#dataDate').val(),
	                'start_date': $('#dataDate').val(),
	                'end_date': $('#dataDate').val(),
	            }
	
	            _this.itemResult = AjaxUtil.getSyncData('/api/check/check_item/read', data);
	            
	            let columnConfig = [];
	            if($('#diaryType').val() == '개인위생일지(직원)'){
		            //columnConfig.push( { key: 'id', hidden:true} );
		            columnConfig.push( { key: 'img_src', hidden: true} );
		            columnConfig.push( { key: 'dept_id', hidden: true} );
		            columnConfig.push({ key: 'dept', label: '부서', width: 100, align: 'center', hidden: false});
		            columnConfig.push( { key: 'worker_id', hidden: true} );
		            columnConfig.push({ key: 'worker', label: '성명', width: 120, align: 'center', hidden: false });
		            // item5 -> 판정 컬럼
		            for(var i in _this.itemResult.data){
						columnConfig.push( { key: 'item'+i, id: _this.itemResult.data[i].id, label: _this.itemResult.data[i].item_name, width: _this.itemResult.data[i].item_name.length*10+20, align: 'center', hidden: false, editor: {type: _this.itemResult.data[i].result_type} } )
					}
					//columnConfig.push( { key: 'result', label: '판정', width: 50, align: 'center' } );
					columnConfig.push( { key: 'sign_state', label: '확인', width: 50, hidden: true} );
					columnConfig.push( { key: 'day_off', label: '휴무', width: 50, align: 'center', hidden: false } );
		            _this.firstGrid.setConfig({columns: columnConfig});

	            }else{
		            columnConfig.push({ key: 'day_getin', label: '방문날짜', width: 100, align: 'center'});
		            columnConfig.push({ key: 'worker', label: '성명', width: 80, align: 'center', editor: {type: "text"} });
		            for(var i in _this.itemResult.data){
						columnConfig.push( { key: 'item'+i, id: _this.itemResult.data[i].id, label: _this.itemResult.data[i].item_name, width: _this.itemResult.data[i].item_name.length*10+20, align: 'center', hidden: false, editor: {type: _this.itemResult.data[i].result_type=='N' ? 'number':_this.itemResult.data[i].result_type } } )
					}
					columnConfig.push( { key: 'ox_state', hidden: true} );
					columnConfig.push( { key: 'sign_state', label: '확인', width: 50, hidden: true} );
					columnConfig.push( { key: 'temperature_state', label: '체온state', hidden: true} );
					columnConfig.push( { key: 'signature', label: '서명', width: 150, align: 'center',hidden:true,
		                	//확인 클릭 전 파란 글씨
				            styleClass: function () {
								return (this.item.item5  != undefined && this.item.sign_state == 'N' && this.item.ox_state == 'O') ? 'editable_clr' : ''
							},
		             	} );
					
		            _this.secondGrid.setConfig({columns: columnConfig});
				}
            }
            _this.deviGrid.setHeight(100);
        }
        
        viewModeSetting() {
		    let _this = this;
		
		    function updateView(viewMode, diaryType) {
		        let isEmployeeDiary = diaryType === '개인위생일지(직원)';
		        let isVisitorDiary = diaryType === '개인위생일지(외부방문자)';
		        let isTrueViewMode = viewMode.toLowerCase() === 'true';
		        let isApprovalState = _this.headInfo.State === 'approval';
		        let isProcessOrReprocess = _this.headInfo.State === 'process' || _this.headInfo.State === 'reprocess';
		        let bhIdValue = parseInt($('#bhId').val(), 10);
		
		        $('#btnDiaryPrint').toggle(isTrueViewMode && isApprovalState);
		        $('#btnReqAppr, #btnSave').toggle(!isTrueViewMode && (isEmployeeDiary || isVisitorDiary));
		        $('#btnDelete, #btnAllItem').toggle(!isTrueViewMode && !isProcessOrReprocess && diaryType);
		        $('#interior_div').toggle(isEmployeeDiary && !isTrueViewMode);
		        $('#exterior_div').toggle(isVisitorDiary && !isTrueViewMode);
		        $('#firstList').toggle(isEmployeeDiary);
		        $('#secondList').toggle(isVisitorDiary);
		        $('#devi_section').toggle(isEmployeeDiary || isVisitorDiary);
		        $('#sign_section').toggle(isEmployeeDiary || isVisitorDiary);
		        
		        _this.firstGrid.setHeight(isEmployeeDiary ? "400" : "0");
		        _this.secondGrid.setHeight(isVisitorDiary ? "400" : "0");
		
		        $('#btnDelete').toggle(bhIdValue > 0 && !isTrueViewMode);
		        $('#title, #dataDate, #diaryType').prop('disabled', bhIdValue > 0);
		    }
		
		    let viewMode = $('#viewMode').val();
		    let diaryType = $('#diaryType').val();
		
		    updateView(viewMode, diaryType);
		
		    _this.approveBoxUtil = new ApproveBoxUtil(0, diaryType, $('#bhId').val(), 'bundle_head', false, false);
		    _this.approveBoxUtil.print(viewMode);
		    $('#btnAppr, #btnReject').toggle(_this.approveBoxUtil.isApprUser());
		}
		
		// 존재하는 서명 재클릭하여 수정 시 사용
		editSign(dom) {
			/**
			let resultGrid = $('#diaryType').val()=='개인위생일지(직원)' ? page.firstGrid : page.secondGrid;
            let popupPage = new SignPage();
            popupPage.show(function (data) {
				let imgUrl = data.src
				var item = resultGrid.list[index];
				item.img_src = imgUrl;
	            item.sign_state = 'Y';
	            resultGrid.repaint();
			});
			**/
			let popupPage = new SignPage();
            popupPage.show(function (data) {
				let imgUrl = data.src
				dom.children()[0].setAttribute('src',imgUrl)
			});
	    };
	    
	    setImg(id) {
			let imgUrl = this.baseUrl + '/sign/download?id=' + id; 
			$('#signImg' + id).attr('src', imgUrl);
		}
		
        // 일지 출력
        printDiary() {
            let param = {
                'title': $('#title').val(),
                'bh_id': $('#bhId').val(),
            };

            let result = AjaxUtil.postSyncData(this.baseUrl + '/print', param, function () { });
            if (result.success) {
                CommonUtil.openWindow('/api/files/pdf_viewer?file_id=' + result.file_id)
            }
            else {
                Alert.alert('', '일지 생성 중 오류가 발생했습니다. 관리자에게 문의하세요.');
            }
        }

        //결재
        appr(isAppr) {
            let _this = this;
            _this.approveBoxUtil.approval(isAppr, function () {
                $('#btnList').click();
            });
        }

        //결재상신
        reqAppr() {
            let _this = this;
            let title = $('#diaryType').val();
            let url = '/gui/' + gui.gui_code + '/edit';
            let urlParam = {
                'bh_id': $('#bhId').val(),
                'data_date': $('#dataDate').val(),
                'diary_type': $('#diaryType').val(),
            };

            let ret = _this.approveBoxUtil.request($('#bhId').val(), title, url, JSON.stringify(urlParam));
            if (ret.success) {
                Notify.success('결재상신하였습니다.');
                $('#btnList').click();
            }
        }

        //저장
        save(isAppr) {
		    let _this = this;
		
		    let resultGrid = $('#diaryType').val() == '개인위생일지(직원)' ? _this.firstGrid : _this.secondGrid;
		    let resultGridList = resultGrid.list;
		    let resultColumnList = resultGrid.columns.filter(column => column.id);
		
		    if (resultGridList.length <= 0) {
		        Alert.alert("", "행을 추가하여 결과를 모두 입력해주세요.");
		        return;
		    }
		
		    //if (_this.deviGrid.list.some(item => !item.action_detail)) {
		    //    Alert.alert("", "조치내역 및 결과를 모두 입력해주세요.");
		    //    return;
		    //}
		
			  if (isAppr) {
	                let checkGrid1 = $('#diaryType').val() == '개인위생일지(직원)' ? _this.firstGrid.getList() : _this.secondGrid.getList();
	                let checkGrid2 = _this.deviGrid.getList()
	                
	                let result = checkGrid1.filter(function(e){
					    return e.item5 == "X";
					})
	               	
	               	if (result.length > 0) {
						if(checkGrid2.length == 0) {
							Alert.alert('결재상신','조치내역을 입력해주세요.');
							return
						}
					}
					
					let result2 = checkGrid2.filter(function(e){
					    return e.action_detail == "" || e.action_detail == null;
					})
					
					if (result2.length > 0) {
						Alert.alert('결재상신','조치내역을 입력해주세요.');
						return
					}
                }
                
		    let items = resultGridList.map(obj => {
		        return Object.keys(obj)
		            .filter(key => key.startsWith("item") || key === "item6")
		            .map(key => {
		                const id = resultColumnList.find(item => item.key === key).id;
		                return { result: obj[key], id: id };
		            });
		    });
		
			let trList = $('#table_body').find('tr').length;
			
			let arrayList = [];
			             
            for(var i = 0; i < trList; i++) {
				let studentName = document.getElementsByName("studentName")[i].value;
				
				// 점검자명 체크
				if(studentName == '') {
					Alert.alert('', '점검자명을 입력해주세요');
					return
				}
				// base64로 이미지 변환
				let img = document.getElementsByName("signImg")[i];
				//이미지 체크
				if (img.src == '') {
					Alert.alert('', '서명을 작성 해주세요');
					return
				}
				
				let canvas = document.createElement('canvas');
				let ctx = canvas.getContext('2d');
				
			    canvas.width = img.width;
			    canvas.height = img.height;
			    
			    // 이미지 체크
			    if (img.complete && img.naturalHeight !== 0) {
					ctx.drawImage(img, 0, 0);
				} else {
					Alert.alert('', '서명 이미지를 확인하세요');
					return
				}
				
			    var base64 = canvas.toDataURL('image/*');
			    var strImage = "data:image/;base64," + base64.replace(/^data:image\/[a-z]+;base64,/, "");
				
				arrayList.push(
					{'studentName': studentName, 'signImg': strImage}
				)
			}
		    let data = {
		        bh_id: $('#bhId').val(),
		        check_master_id: _this.check_master_id,
		        title: $('#title').val(),
		        data_date: $('#dataDate').val(),
		        diary_type: $('#diaryType').val(),
		        rowQ: JSON.stringify(resultGridList),
		        colQ: JSON.stringify(items),
		       	tableQ: JSON.stringify(arrayList)
		    };
		
		    let fnSuccess = (resp) => {
		        if (resp.success) {
		            $('#bhId').val(resp.data.id);
		            if (isAppr) {
		                _this.reqAppr();
		            } else {
		                Notify.success('저장하였습니다.');
		                $('#btnDelete').show();
		                $('#dataDate').attr('disabled', 'disabled');
		                _this.searchMainData($('#diaryType').val());
		            }
		        } else {
		            Alert.alert('', resp.message);
		        }
		    };
		
		    let confirmMessage = isAppr ? '결재상신하시겠습니까?' : '저장하시겠습니까?';
		
		    Alert.confirm('', confirmMessage, () => {
		        AjaxUtil.postAsyncData(_this.baseUrl + '/save', data, fnSuccess);
		    });
		}

        //삭제
        delete() {
            let _this = this;
            Alert.confirm('', '삭제하시겠습니까?', function () {
                // 삭제 서비스 호출
                let param = {
                    bh_id: $('#bhId').val(),
                }
                let fnSuccess = function (resp) {
                    if (resp.success) {
                        Notify.success('삭제하였습니다.');
                        $('#btnList').click();
                    } else {
                        Alert.alert('', resp.message);
                    }
                };
                AjaxUtil.postAsyncData(_this.baseUrl + '/delete', param, fnSuccess);
            });
        }

        // 엑셀 다운로드
        exportExcel() {
            var targetview = this.resultGrid;
            targetview.exportExcel('개인위생일지.xls');
        }

    }

    let page = null;

    $(document).ready(function (e) {
        page = new CheckResultDiaryPage();

        $('#pickerDate').ax5DatePicker({ direction: 'top' });
        picker.bind({
            target: $('[data-ax5picker="multi"]'),
            direction: "top",
            content: {
                width: 206,  //130 270
                margin: 10,
                type: 'date',
                config: {
                    control: {
                        left: '<i class="fa fa-chevron-left"></i>',
                        yearTmpl: '%s',
                        monthTmpl: '%s',
                        right: '<i class="fa fa-chevron-right"></i>'
                    },
                    lang: {
                        yearTmpl: "%s년",
                        months: ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'],
                        dayTmpl: "%s"
                    }
                }
            }

        });
        
        $('#pickerExterDate').ax5DatePicker({ direction: 'top' });
        picker.bind({
            target: $('[data-ax5picker="pickerExterDate"]'),
            direction: "top",
            content: {
                width: 206,  //130 270
                margin: 10,
                type: 'date',
                config: {
                    control: {
                        left: '<i class="fa fa-chevron-left"></i>',
                        yearTmpl: '%s',
                        monthTmpl: '%s',
                        right: '<i class="fa fa-chevron-right"></i>'
                    },
                    lang: {
                        yearTmpl: "%s년",
                        months: ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'],
                        dayTmpl: "%s"
                    }
                }
            }

        });
        
        if(page.gparam.diary_type){
			AjaxUtil.fillSelectOptions($("#diaryType"), "system_code", page.gparam.diary_type, '', "person_hygiene_check_type");
		}else{
        	AjaxUtil.fillSelectOptions($("#diaryType"), "system_code", "choose", '', "person_hygiene_check_type");
		}
		
		AjaxUtil.fillSelectOptions($("#departType"), "depart", "choose", false);
			
        $('#dataDate').val(page.gparam.data_date);
        $('#dataExterDate').val(page.gparam.data_date);

        $('#btnAllItem').click(function (e) {
            page.checkAllItem();
        });

        // 일자 변경
        $('#dataDate').change(function () {
            page.searchMainData();
        });

        // 일지 출력
        $('#btnDiaryPrint').on('click', function () {
            page.printDiary();
        });

        // 결재상신
        $('#btnReqAppr').on('click', function () {
            page.save(true);
        });

        // 승인
        $('#btnAppr').on('click', function () {
            page.appr(true);
        });

        // 반려
        $('#btnReject').on('click', function () {
            page.appr(false);
        });

        // 임시저장
        $('#btnSave').on('click', function () {
			if ($('#diaryType').val() == '' || $('#diaryType').val() == null) {
                Alert.alert("", "일지종류를 선택해주세요.");
                return;
            }
            page.save(false);
        });

        // 삭제
        $('#btnDelete').on('click', function () {
            page.delete();
        });

        // 목록
        $('#btnList').on('click', function () {
            if (page.gparam.appr_view) {
                location.href = encodeURI('/gui/' + page.gparam.appr_view + '?searchcond=' + page.gparam.search_cond);
            }
            else {
                location.href = encodeURI('/gui/' + gui.gui_code + '?searchcond=' + page.gparam.search_cond);
            }
        });

        // 엑셀 다운로드
        $('#btnExcel').on('click', function () {
            page.exportExcel();
        });
        
        // 점검기준 보기/감추기 토글
        $("#btnToggle").click(function (e) {
            $("#standardDIv").toggle(300);
        });
        
        // 직원 그리드 행 추가
        $('#btnInterAddRow').click(function (e) {
	
			if ($('#departType').val() == '' || $('#departType').val() == null) {
                Alert.alert("", "부서를 선택해주세요.");
                return;
            }
			
			let param = {
				dept_id : $('#departType').val()
			}
			
			let result = AjaxUtil.getSyncData(page.baseUrl + '/read_user', param);
			
			let data = result.data
			
			if (data.length == 0) {
				Alert.alert("", "부서 인원이 없습니다.");
                return;
			}
			
			
			for(var i = 0; i < data.length; i++) {
            page.firstGrid.addRow($.extend({}, { 
				'dept_id': data[i].deptId,
				'dept': data[i].deptName,
				'worker_id': data[i].userId,
	            'worker': data[i].userName,
	            'item0' : null,
	            'item1' : null,
	            'item2' : null,
	            'item3' : null,
	            'item4' : null,
	            'item5' : null,
	            'day_off' : null,
	            'sign_state' : 'N',
				 }),"last");
	         }   
	            
        });
        
        //  직원 그리드 행삭제
        $("#btnInterDelRow").click(function (e) {
            page.firstGrid.deleteRow("selected");
        });
        
        // 방문자 그리드 행추가
        $('#btnExterAddRow').click(function (e) {
            page.secondGrid.addRow($.extend({}, { 
				'day_getin': $('#dataExterDate').val(),
	            'temperature_state': 'N',
	            'ox_state': 'X',
	            'sign_state' : 'N'  }),"last");
        });
        
        // 방문자 그리드 행삭제
        $("#btnExterDelRow").click(function (e) {
            page.secondGrid.deleteRow("selected");
        });
        
        $('#diaryType').change(function(){
			page.checkMasterName = $('#diaryType option:checked').val();
        	page.searchMainData();
    	});
    	
    	// 테이블 행추가
        $('#addRow').on('click', function () {
            page.addRow();
        });
    	// 최초 서명 시 사용
    	/**
    	window.editSign = function (index) {
			let resultGrid = $('#diaryType').val()=='개인위생일지(직원)' ? page.firstGrid : page.secondGrid;
            let popupPage = new SignPage();
            popupPage.show(function (data) {
				let imgUrl = data.src
				var item = resultGrid.list[index];
				item.img_src = imgUrl;
	            item.sign_state = 'Y';
	            resultGrid.repaint();
			});
	    };
    	**/
		page.searchMainData();
    });
</script>
</th:block>
</html>
