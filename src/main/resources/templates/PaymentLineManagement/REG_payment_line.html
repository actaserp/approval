<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>

</style>
<th:block layout:fragment="content">

  <!--- (ë ˆì´ì•„ì›ƒ) Contents ì˜ì—­ -->
  <div class="layout-contents">
    <!-- Page Title -->
    <div class="page-title-wrap">
      <div class="left">
        <h2>ì£¼ë¬¸ ë“±ë¡</h2>
        <!--                <a href="#" title="ë¶ë§ˆí¬" class="bookmark toggle">-->
        <!--                    ë‚´ë©”ë‰´-->
        <!--                </a>-->
      </div>
      <ul class="page-navi">
        <li><img src="/images/icon/ico-nav-home.svg" alt="í™ˆì•„ì´ì½˜"></li>
        <li>ê²°ì¬ë¼ì¸ê´€ë¦¬</li>
        <li>ê²°ì¬ë¼ì¸ë“±ë¡</li>
      </ul>
    </div>
    <!-- Select -->

    <div class="tab-wrap">
<!--      <ul class="tab-links">-->
<!--        <input type="hidden" id="checkdtParam" name="checkdtParam" th:value="${checkdt}"/>-->
<!--        <li>-->
<!--          <a href="#tab1" title="ì£¼ë¬¸ ë“±ë¡" id="listTabLink">ì£¼ë¬¸ ë“±ë¡</a>-->
<!--        </li>-->
<!--        <li>-->
<!--          <a href="#tab2" title="ë“±ë¡">ì£¼ë¬¸/ì§„í–‰í˜„í™©</a>-->
<!--        </li>-->
<!--      </ul>-->
      <div class="tab-contents">
        <!--      ì£¼ë¬¸ë“±ë¡ íƒ­ ì‹œì‘       -->
        <!-- Section -->
        <section class="tab-item" id="tab1">
          <div class="section-top">
            <div class="title-wrap">
              <h3>ê²°ì¬ë¼ì¸ë“±ë¡</h3>
              <!--              <img src="/images/icon/exclamation/exclamation-circle.svg"-->
              <!--                   class="zoom-img" style="margin-left: 5px"-->
              <!--                   onclick="openPopup('https://foms.atlassian.net/wiki/external/YzNmYmE3MTkyYTFlNGU2OGIwOTY5YTEyNDFiZjcwZmE')" alt="ë„ì›€ë§">-->
            </div>
            <div class="button-wrap">
              <ul>
                <li>
                  <a id="newdataBtn" class="btn btn-excell" title="ì‹ ê·œë“±ë¡" onclick="resetFormFields()">
                    <img src="/images/icon/ico-plus.svg" alt="ë“±ë¡ ì•„ì´ì½˜">
                    ì‹ ê·œë“±ë¡
                  </a>
                </li>
                <li>
                  <a class="btn btn-delete" id="deleteButton" title="ì‚­ì œ">
                    <img src="/images/icon/ico-delete.svg" alt="ì‚­ì œ ì•„ì´ì½˜">
                    ì‚­ì œ
                  </a>
                </li>
                <li>
                  <a class="btn btn-edit" id="btnSave" title="ì €ì¥" onclick="saveOrder()">
                    <img src="/images/icon/ico-save.svg" alt="ì €ì¥ ì•„ì´ì½˜">
                    ì €ì¥
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <div class="table-wrap">
            <table class="write-table">
              <caption>ë‚´ì •ë³´ í…Œì´ë¸”</caption>

              <tbody>
              <tr>
                <th style="text-align: center">
                  <label for="comcd">
                    ë¬¸ì„œì½”ë“œ
                  </label>
                </th>
                <td>
                  <select id="comcd">
                    <option></option>
                  </select>
                </td>
                <th style="text-align: center">
                  <label for="deldate">

                  </label>
                </th>
                <td>
                  <input type="date" id="deldate" name="deldate" style="width: 200px" disabled>
                  <span id="deldate_day"></span>
                </td>
                <th style="text-align: center">
                  <label for="telno">

                  </label>
                </th>
                <td>
                  <input type="text" id="telno" name="telno">
                </td>
              </tr>
              <tr>
                <th style="text-align: center">
                  <label for="perid">
                    ë“±ë¡ì‚¬ì›
                  </label>
                </th>
                <td>
                  <input type="text" id="perid" name="perid" style="width: 200px" readonly>
                </td>
                <td>
                  <input type="text" id="pernm" name="perid" style="width: 200px" readonly>
                </td>
                <th style="text-align: center">
                  <label for="postno">

                  </label>
                </th>
                <td colspan="4">
                  <input type="text" id="postno" placeholder="ìš°í¸ë²ˆí˜¸"
                         onclick="sample4_execDaumPostcode()"
                         style="width: 100px; margin-bottom: 3px;">
                  <input type="text" id="address1" placeholder="ë„ë¡œëª…ì£¼ì†Œ" style="width: 48%">
                  <input type="hidden" id="placeAddress" placeholder="ì§€ë²ˆì£¼ì†Œ">
                  <span id="guide" style="color:#999;display:none"></span>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
          <div class="container-fluid">
            <p id=""></p>
            <div id="theGrid2" style="max-height: 714px; height: 300px"></div>
          </div>
        </section>
        <!--       ì£¼ë¬¸ë“±ë¡ íƒ­ ì¢…ë£Œ   / ì£¼ë¬¸ ì˜ë¢°í˜„í™© ì‹œì‘       -->
        <!-- Section -->
        <!--      ì£¼ë¬¸ ì˜ë¢° í˜„í™© ì¢…ë£Œ          -->
      </div> <!--//tab-contens end-->
    </div> <!--//tab-wrap end-->
  </div> <!--//layout-contents end -->
  <footer style="margin-top:5px;">
    <p>Copyrightâ“’ 0000 corp. All rights reserved.</p>
  </footer>
  <div style="height: 10px"></div>
</th:block>

<th:block layout:fragment="scripts">
  <th:block th:replace="/common/columns_setting :: columns_setting"></th:block>

  <script type="text/javascript">

    var theGrid2;
    var viewdata2;
    let SelectItem;
    let csrfToken = $("[name=_csrf]").val();

    document.readyState === 'complete' ? init() : window.onload = init;

    // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
    const date = new Date();
    date.setHours(date.getHours() + 9); // UTC+9ë¡œ í•œêµ­ ì‹œê°„ ì„¤ì •
    const today = date.toISOString().split('T')[0];

    // í˜„ì¬ ë…„ë„ì™€ ì›”ì„ ê°€ì ¸ì˜µë‹ˆë‹¤
    const currentYear = date.getFullYear();
    const currentMonth = (date.getMonth() + 1).toString().padStart(2, '0'); // 1ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1 ì²˜ë¦¬

    // ì´ë²ˆ ë‹¬ 1ì¼ì„ ì„¤ì •
    const firstDayOfMonth = `${currentYear}-${currentMonth}-01`;

    <!-- ì´ˆë°˜ í˜ì´ì§€ ì§„ì…ì‹œ ê·¸ë¦¬ë“œ ë°”ì¸ë”© ë-->
    function init() {
      // ê²°ì¬ë¬¸ì„œì½”ë“œ ë¶ˆëŸ¬ì˜¤ê¸° (comcdì— ë°”ì¸ë“œ)
      getComcd();
      // ì„ íƒëœ ë¬¸ì„œì½”ë“œ ê²°ì¬ë¼ì¸ ê·¸ë¦¬ë“œ
      fetchListData2();



    }

    // DOMì´ ì™„ì „íˆ ì¤€ë¹„ëœ í›„ì— íŠ¹ì • ì½”ë“œ ì‹¤í–‰
    $(document).ready(function (e) {
      // const selectElementId2 = ['exfmtypedv','infmtypedv','stframedv','stexplydv'];
      // for (const items of selectElementId2){
      //   getListCgrb(items);
      // }
    })

    // ì£¼ë¬¸í˜„í™© ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ ê¸°ì¡´íƒ­ ìµœì‹ í™”
    document.addEventListener("DOMContentLoaded", function () {
      console.log("âœ… order_request.html DOMContentLoaded ì™„ë£Œ");

      window.addEventListener("message", function (event) {
        console.log("ğŸ“© ë©”ì‹œì§€ ìˆ˜ì‹ ! Origin:", event.origin);
        console.log("ğŸ“© ë©”ì‹œì§€ ë‚´ìš©:", event.data);

        if (event.data.action === "init") {
          console.log("ğŸ“© init ì‹¤í–‰ ìš”ì²­ ë°›ìŒ");
          init(); // `init()` í•¨ìˆ˜ ì‹¤í–‰
        }
      });

      // index.htmlì—ì„œ ë³´ë‚¸ ë©”ì‹œì§€ê°€ iframeì´ ë¡œë“œë˜ê¸° ì „ì— ë„ì°©í–ˆì„ ê²½ìš° ëŒ€ë¹„
      setTimeout(() => {
        window.parent.postMessage({ action: "requestInit" }, "*");
      }, 200);
    });
    // ë¬¸ì„œì½”ë“œ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì™€ comcd(select)ì†ì„±(option)ìœ¼ë¡œ ë°”ì¸ë“œ
    function getComcd() {
      $.ajax({
        url: '/api/request/request/getComcd',
        type: 'GET',
        data: {},
        async: false,
        success: function (data) {
          data2 = data.data;
          data2.forEach(item =>{
            // ë°”ì¸ë“œ
          })
        }
      })
    }

    // ì£¼ë¬¸ë“±ë¡ ì„¸ë¶€ë‚´ìš© ê·¸ë¦¬ë“œ
    function fetchListData2(saupnum) {
      let data2 = [];

      $.ajax({
        url: '/api/request/request/read',
        type: 'GET',
        data: {
          'comcd': $('#comcd').val()
        },
        async: false,
        success: function (data) {
          data2 = data.data;
          data2.forEach(item =>{
          })
          // data2ì˜ ê°œìˆ˜ê°€ 5ê°œ ë¯¸ë§Œì¸ ê²½ìš° ë¹ˆ ê°ì²´ ì¶”ê°€
          while (data2.length < 5) {
            data2.push({});
          }
        }
      })

      viewdata2 = new wijmo.collections.CollectionView(data2);

      if (!theGrid2) {

        // ë°ì´í„° ê·¸ë¦¬ë“œì— ë°”ì¸ë”©
        theGrid2 = new wijmo.grid.FlexGrid('#theGrid2', {
          autoGenerateColumns: false,
          showMarquee: true,
          isReadOnly: true,
          selectionMode: wijmo.grid.SelectionMode.Row,
          columns: [
            {binding: 'index', header: 'No', width: 80, align: 'right'},
            {binding: 'kcperid', header: 'ê²°ì¬ìì½”ë“œ', width: '*', minWidth: 100, align: 'center'},
            {binding: 'kcpernm', header: 'ê²°ì¬ìëª…', width: '*', minWidth: 100, align: 'right'},
            {binding: 'papercd', header: 'êµ¬ë¶„', width: '*', minWidth: 100, align: 'right'},
            {binding: 'seq', header: 'ê²°ì¬ìˆœì„œ', width: '*', minWidth: 100, align: 'right'}
          ],
          itemsSource: viewdata2,
          itemFormatter: function (panel, r, c, cell) {
            if (panel.cellType === wijmo.grid.CellType.Cell) {
              var item = panel.rows[r].dataItem; // í˜„ì¬ í–‰ì˜ ë°ì´í„° í•­ëª©
              if (panel.columns[c].binding === 'ordtext') {
                cell.innerHTML = ''; // ì…€ ë‚´ìš© ì´ˆê¸°í™”
                if (item.ordtext) {
                  cell.innerHTML = '<a title="ìˆ˜ì •íŒì—…" class="" onclick="showPopup3(\'popup2\')" style="color: #03428E">ìš”ì²­ì‚¬í•­ í™•ì¸</a>';
                }
              }
            }
          }
        });
        // í—¤ë”ë¥¼ ì¤‘ì•™ ì •ë ¬í•˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        theGrid2.formatItem.addHandler(function (s, e) {
          if (e.panel === s.columnHeaders) {
            e.cell.style.textAlign = 'center';
          }
        });
        // ì²«ì—´ì— selectBox ì¶”ê°€
        let selector = new wijmo.grid.selector.Selector(theGrid2, {
          itemChecked: (e, ctx) => {
            SelectItem = theGrid2.rows.filter(r => r.isSelected);

          }
        })
        // ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸
        theGrid2.hostElement.addEventListener('dblclick', function (e) {
          // ê·¸ë¦¬ë“œì˜ ì…€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          let hitTest = theGrid2.hitTest(e);
          if (hitTest.cellType === wijmo.grid.CellType.Cell) {
            // í–‰(row), í–‰ì˜ ë°ì´í„°(item) ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            let row = hitTest.row;
            let item = theGrid2.rows[row].dataItem;

            document.getElementById('qty').value = item.qty;
            document.getElementById('panel_t').value = item.panel_t;
            document.getElementById('panel_w').value = item.panel_w;
            document.getElementById('panel_l').value = item.panel_l;
            document.getElementById('reqseq').value = item.reqseq;
            document.getElementById('isnew').value = item.isnew;
            document.getElementById('ordtext').value = item.ordtext;

            const selectHgrb = document.getElementById('hgrb');
            const selectExfmtypedv = document.getElementById('exfmtypedv');
            const selectInfmtypedv = document.getElementById('infmtypedv');
            const selectStframedv = document.getElementById('stframedv');
            const selectStexplydv = document.getElementById('stexplydv');

            const selectedItem = item;

            setSelectedIndex(selectHgrb, selectedItem.hgrb);
            setSelectedIndex(selectExfmtypedv, selectedItem.exfmtypedv);
            setSelectedIndex(selectInfmtypedv, selectedItem.infmtypedv);
            setSelectedIndex(selectStframedv, selectedItem.stframedv);
            setSelectedIndex(selectStexplydv, selectedItem.stexplydv);
          }
        })
        // FlexGridì˜ ìµœëŒ€ ë†’ì´ë¥¼ ì œí•œí•˜ì—¬ ìŠ¤í¬ë¡¤ë°”ë¥¼ í™œì„±í™”
        theGrid2.hostElement.style.maxHeight = '300px'; // ì•½ 5ê°œì˜ í–‰ ë†’ì´ì— ë§ê²Œ ì„¤ì •
        theGrid2.hostElement.style.overflowY = 'auto';
        // ì„ íƒì´ ë³€ê²½ë  ë•Œ, í˜„ì¬ í•­ëª© ì—…ë°ì´íŠ¸
        new FlexGridContextMenu(theGrid2);
        window.downloadFileName = 'ì£¼ë¬¸ë“±ë¡';
      } else {
        // ì´ë¯¸ FlexGridì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°, ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸
        theGrid2.itemsSource = viewdata2;
      }
    }
    // optionê°’ value bind
    function setSelectedIndex(selectElement, selectedValue) {
      let found = false;

      for (let i = 0; i < selectElement.options.length; i++) {
        if (selectElement.options[i].text.trim().toLowerCase() === String(selectedValue).trim().toLowerCase()) {
          selectElement.selectedIndex = i;
          found = true;
          break;
        }
      }

      // ì¼ì¹˜í•˜ëŠ” ê°’ì´ ì—†ì„ ê²½ìš°, ê¸°ë³¸ê°’ 0 ì„¤ì •
      if (!found) {
        selectElement.selectedIndex = 0;
      }
    }

    // ì…€ë ‰íŠ¸ê°’ì— ë”°ë¼ id íˆë“ ìœ¼ë¡œ ë„˜ê¸°ê¸°
    function updateSelect(selectId, hiddenInputId) {
      var selectElement = document.getElementById(selectId);
      var selectedOptionText = selectElement.options[selectElement.selectedIndex].text;
      document.getElementById(hiddenInputId).value = selectedOptionText;
    }

    // í—¤ë“œì •ë³´ ì‚­ì œ(ì„¸ë¶€ì‚¬í•­ ì¡´ì¬ì‹œ ì•ˆë‚´ alertê¸°ëŠ¥)
    $(document).ready(function () {
      $('#deleteButton').off('click').on('click', deletehead);
    });

    let isProcessing = false;

    function deletehead() {
      if (isProcessing) return;

      const reqnum = $('#reqnum').val();
      if (!reqnum) {
        Alert.alert('', 'ì‚­ì œí•  í•­ëª©ì„\nì§„í–‰í˜„í™©ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      Alert.confirm('', 'ì£¼ë¬¸ ë“±ë¡ì •ë³´ë¥¼\nì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', function () {
        isProcessing = true;

        let data = {
          'reqnum': reqnum,
          '_csrf': csrfToken
        };

        let fnSuccess = function (res) {
          isProcessing = false;
          if (res.success) {
            Alert.alert('', 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            fetchListData();
            resetFormFields();
          }
        };

        AjaxUtil.postAsyncData('/api/request/request/delete', data, fnSuccess);
      });
    }

    // í•„ë“œê°’ ì´ˆê¸°í™”
    function resetFormFields() {
      const fieldsToReset = [
        'panel_ht',
        'panel_hw', 'panel_hl', 'panel_hh', 'remark', 'hgrb',
        'qty', 'panel_t', 'panel_w', 'panel_l',
        'exfmtypedv', 'infmtypedv', 'stframedv', 'stexplydv', 'reqnum', 'reqseq'
      ];

      fieldsToReset.forEach(fieldId => {
        document.getElementById(fieldId).value = '';

      });
      document.getElementById('ordtext').value = ""
      document.getElementById('reqdate').value = today;
      document.getElementById('deldate').value = today;
      $('.filelist2').empty(); // íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
      uploadedFiles2 = []; // ì—…ë¡œë“œëœ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
      deletedFiles2 = [];
      // ì´ˆê¸°í™”ëœ íŒŒì¼ ê°œìˆ˜ ì—…ë°ì´íŠ¸
      updateFileCount2();
      resetFileInput($('.fileInput2'));
      $('.text-count').text('0/100'); // ê¸€ì ìˆ˜ 0ìœ¼ë¡œ ì´ˆê¸°í™”
      // íŠ¹ì • í•„ë“œì— ëŒ€í•œ btn-clear ìˆ¨ê¹€ ì²˜ë¦¬
      $('#doctitle').each(function () {
        $(this).siblings('.btn-clear').hide();
      });

      let data2 = [];
      // ê¸°ì¡´ CollectionViewë¥¼ ì´ˆê¸°í™”í•˜ê¸° ìœ„í•´ sourceCollectionì„ ë¹ˆ ë°°ì—´ë¡œ ì„¤ì • í›„ ìƒˆ ë°ì´í„° í• ë‹¹
      if (viewdata2) {
        viewdata2.sourceCollection = data2;
        viewdata2 = new wijmo.collections.CollectionView(data2);
        theGrid2.itemsSource = viewdata2;
        viewdata2.refresh();
      } else {
        viewdata2 = new wijmo.collections.CollectionView(data2);
      }

      // ê·¸ë¦¬ë“œë„ ê°±ì‹ 
      theGrid2.itemsSource = viewdata2;
      theGrid2.refresh();

      document.getElementById('btnSave').title = "ì €ì¥";
    }


    // ë‚´ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
    function getMyInfo(saupnum) {
      return new Promise((resolve, reject) => {
        $.ajax({
          url: '/api/request/request/getUserInfo',
          data: {'saupnum': saupnum},
          type: 'GET',
          success: function (data) {
            document.getElementById("telno").value = data.data.hptelnum;
            document.getElementById("perid").value = data.data.prenm;
            document.getElementById("postno").value = data.data.zipcd;
            document.getElementById("address1").value = data.data.cltadres.replace(/\s*\|/g, '').trim();
            document.getElementById("cltnm").value = data.data.cltnm;
            document.getElementById("searchComnm").value = data.data.cltnm;
            console.log("âœ… getMyInfo ì™„ë£Œ, searchComnm ê°’:", data.data.cltnm);

            resolve(); // âœ… ì™„ë£Œë˜ë©´ resolve() í˜¸ì¶œ
          },
          error: function (error) {
            console.error("âŒ getMyInfo ì‹¤íŒ¨:", error);
            reject(error);
          }
        });
      });
    }

    // YYYYMMDD â†’ Date ê°ì²´ ë³€í™˜
    function parseDate(dateStr) {
      let year = parseInt(dateStr.substring(0, 4), 10);
      let month = parseInt(dateStr.substring(4, 6), 10) - 1;
      let day = parseInt(dateStr.substring(6, 8), 10);
      return new Date(year, month, day);
    }

    // Date ê°ì²´ â†’ YYYYMMDD í˜•ì‹ ë³€í™˜
    function formatDate(date) {
      let yyyy = date.getFullYear();
      let mm = String(date.getMonth() + 1).padStart(2, '0');
      let dd = String(date.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;  // HTML input í•„ë“œì™€ í˜¸í™˜ë˜ë„ë¡ ìˆ˜ì •
    }


    // // enterì…ë ¥ì‹œ ë‹¤ìŒ inputìœ¼ë¡œ cursorì´ë™
    // function moveFocusOnEnter(currentId, nextId) {
    //   const currentElement = document.getElementById(currentId);
    //   currentElement.addEventListener("keydown", function(event) {
    //     if (event.key === "Enter") {
    //       event.preventDefault(); // ê¸°ë³¸ Enter ë™ì‘ ë°©ì§€
    //       const nextElement = document.getElementById(nextId);
    //       if (nextElement) {
    //         nextElement.focus(); // í¬ì»¤ìŠ¤ ì´ë™
    //       }
    //     }
    //   });
    // }
    // moveFocusOnEnter("reqdate", "deldate");
    // moveFocusOnEnter("deldate", "telno");
    // moveFocusOnEnter("telno", "perid");
    // moveFocusOnEnter("perid", "panel_ht");
    // moveFocusOnEnter("panel_ht", "panel_hw");
    // moveFocusOnEnter("panel_hw", "panel_hl");
    // moveFocusOnEnter("panel_hl", "panel_hh");
    // moveFocusOnEnter("panel_hh", "remark");
    // moveFocusOnEnter("remark", "hgrb");
    // moveFocusOnEnter("hgrb", "qty");
    // moveFocusOnEnter("qty", "panel_t");
    // moveFocusOnEnter("panel_t", "panel_w");
    // moveFocusOnEnter("panel_w", "panel_l");
    // moveFocusOnEnter("panel_l", "exfmtypedv");
    // moveFocusOnEnter("exfmtypedv", "infmtypedv");
    // moveFocusOnEnter("infmtypedv", "stframedv");
    // moveFocusOnEnter("stframedv", "stexplydv");
  </script>

</th:block>
</html>

