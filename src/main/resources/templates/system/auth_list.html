<html layout:decorate="~{layout_page}" xmlns:layout="http://www.w3.org/1999/xhtml">
<style>

</style>

<th:block layout:fragment="content">


    <div class="layout-contents">
        <!-- Page Title -->
        <div class="page-title-wrap">
            <div class="left">
                <h2>사용자권한신청조회</h2>
                <a title="북마크" class="bookmark toggle">
                    내메뉴
                </a>
            </div>
            <ul class="page-navi">
                <li><img src="/images/icon/ico-nav-home.svg" alt="홈아이콘"></li>
                <li>시스템설정</li>
                <li>사용자권한신청조회</li>
            </ul>
        </div>
        <!-- Select -->

        <div class="tab-wrap">
            <ul class="tab-links">
                <li>
                    <a href="#tab1" title="목록">목록</a>
                </li>
                <li>
                    <a href="#tab2" title="승인" id="inputTabLink">승인</a>
                </li>
            </ul>
            <div class="tab-contents">
                <!-- Section -->
                <section class="tab-item" id="tab1">
                    <div class="section-top">
                        <div class="search-wrap">
                            <dl>
                                <dt>
                                    신청기간
                                </dt>
                                <dd>
                                    <ul class="date-box">
                                        <li>
                                            <input type="date" id="searchfrdate" name="searchfrdate">
                                            <label for="searchfrdate" class="hide">시작일</label>
                                        </li>
                                        <li>
                                            <input type="date" id="searchtodate" name="searchtodate">
                                            <label for="searchtodate" class="hide">종료일</label>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>


                            <dl>
                                <dt>
                                    <label for="flag">
                                        승인여부
                                    </label>
                                </dt>
                                <dd>
                                    <ul>
                                        <li>
                                            <select id="flag" class="w120">
                                                <option value="">전체</option>
                                                <option value="Y">승인</option>
                                                <option value="N">미승인</option>
                                            </select>
                                        </li>
                                    </ul>
                                </dd>
                            </dl>


                            <dl>
                                <dt>
                                    <label for="searchusr">
                                        신청자명
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="text" id="searchusr" name="searchusr" class="input-srch" placeholder="신청자명 검색">
                                    </div>
                                </dd>
                            </dl>

                            <dl>
                                <dt>
                                    <label for="searchuserid">
                                        ID
                                    </label>
                                </dt>
                                <dd>
                                    <div class="srch-box">
                                        <input type="text" id="searchuserid" name="searchuserid" class="input-srch" placeholder="아이디 검색">
                                        <a  class="btn-srch" id="searchgrid" title="검색" onclick="searchData()" onkeyup="searchData()"></a>
                                    </div>
                                </dd>
                            </dl>

                        </div>
                        <div class="button-wrap">
                            <ul>

                                <li>
                                    <a  class="btn btn-delete" title="승인" id="btnAppr">
                                        <img src="/images/icon/ico-save.svg" alt="엑셀 아이콘">
                                        승인
                                    </a>
                                </li>
                                <li>
                                    <a  class="btn btn-delete" title="삭제" id="btnDelete">
                                        <img src="/images/icon/ico-delete.svg" alt="엑셀 아이콘">
                                        삭제
                                    </a>
                                </li>

                            </ul>
                        </div>
                    </div> <!--//section-top end -->
                    <div class="container-fluid">
                        <p id="selectedItem"></p>
                        <div id="theGrid"></div>
                    </div>
                    <div class="btn-wrap">
                    </div>
                </section>
                <!-- Section -->
                <section class="tab-item" id="tab2">
                    <div class="section-top">
                        <div class="title-wrap">
                            <h3>사용자권한 승인</h3>
                        </div>
                        <div class="button-wrap">
                            <ul>
                                <li>
                                    <a class="btn btn-edit" id="btnSave" title="저장">
                                        <img src="/images/icon/ico-save.svg" alt="저장 아이콘">
                                        저장
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table class="write-table">
                            <caption>사용자권한신청조회 승인 테이블</caption>
                            <colgroup>
                                <col class="wp12">
                                <col class="wp40">
                                <col class="wp12">
                                <col class="wp40">
                            </colgroup>
                            <tbody>
                            <tr>
                                <th>
                                    <label for="agency">
                                       소속사
                                    </label>
                                </th>
                                <td>
                                    <input type="text" id="agency" name="agency" class="wp100" readonly>
                                    <input type="hidden" id="userid" name="userid" readonly>

                                </td>

                                <th>
                                    <label for="divinm">
                                        소속부서
                                    </label>
                                </th>
                                <td>
                                    <input type="text" id="divinm" name="divinm" class="wp100" readonly>
                                </td>
                            </tr>

                            <tr>
                                <th>
                                    <label for="rank">
                                        직급
                                    </label>
                                </th>
                                <td>
                                    <input type="text" id="rank" name="rank" class="wp100" placeholder="직급" readonly>
                                </td>
                                <th>
                                    <label for="tel">
                                        핸드폰 <span class="req">*</span>
                                    </label>
                                </th>
                                <td>
                                    <input type="text" id="tel" name="tel" class="wp100" readonly>
                                </td>
                            </tr>

                            <tr>
                                <th>
                                    <label for="email">
                                      이메일
                                    </label>
                                </th>
                                <td>
                                    <div class="input-btnbox">
                                        <input type="text" id="email" name="email" class="wp100" readonly>
                                    </div>
                                </td>
                                <th>
                                    <label for="usernm">
                                        성명 <span class="req">*</span>
                                    </label>
                                </th>
                                <td>
                                    <input type="text" id="usernm" name="usernm" class="wp100"  readonly>
                                </td>
                            </tr>


                            <tr>
                                <th>
                                    <label for="authType">
                                       권한그룹
                                    </label>
                                </th>
                                <td>
                                    <ul>
                                        <li>
                                            <select id="authType" readonly="">
                                                <option value='bloomuser'>BloomEnergy담당자</option>
                                                <option value='esguser'>ESG담당자</option>
                                                <option value='admin'>관리자</option>
                                                <option value='User'>사용자</option>
                                                <option value='Master'>시스템마스터</option>
                                                <option value='elecuser'>전기안전관리자</option>
                                            </select>
                                        </li>
                                    </ul>
                                </td>
                                <th>
                                    <label>
                                      권한상세
                                    </label>
                                </th>
                                <td>
                                    <ul>
                                        <li>
                                            <input type="text" id="spworknm" name="spworknm" class="w150" readonly>
                                            <input type="text" id="spcompnm" name="spcompnm" class="w150" readonly>
                                            <input type="text" id="spplannm" name="spplannm" class="w150" readonly>
                                        </li>
                                    </ul>
                                </td>
                            </tr>


                            <tr>
                                <th>
                                    <label for="reason">
                                        신청사유
                                    </label>
                                </th>
                                <td colspan="3">
                                    <div class="input-btnbox">
                                        <input type="text" id="reason" name="reason" class="wp100"  placeholder="유지보수" readonly>
                                    </div>
                                </td>

                            </tr>


                            <tr>
                                <th>
                                    <label for="appflag">
                                        승인
                                    </label>
                                </th>
                                <td>
                                    <ul>
                                        <li>
                                            <select class="w120" id="appflag">
                                                <option value="Y">승인</option>
                                                <option value="N">미승인</option>
                                            </select>
                                        </li>
                                    </ul>
                                </td>
                                <th>
                                    <label for="appdatem">
                                        승인일시
                                    </label>
                                </th>
                                <td>
                                    <div class="input-btnbox">
                                        <input type="text" id="appdatem" name="appdatem" class="wp100" readonly>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div> <!--//tab-contens end-->
        </div> <!--//tab-wrap end-->
    </div> <!--//layout-contents end -->
</th:block>
<th:block layout:fragment="scripts">
    <th:block th:replace="/common/approve_box :: approve_box"></th:block>
    <th:block th:replace="/common/ax5_uploader :: ax5_uploader" ></th:block>
    <th:block th:replace="/common/upload_one_image_box :: upload_one_image_box" ></th:block>
    <th:block th:replace="/common/popup_select_user_code :: popup_select_user_code"></th:block>

    <script type="text/javascript">

        var theGrid;
        var viewdata;
        let selectedFiles = [];
        let SelectItem;
        let csrfToken = $("[name=_csrf]").val();

        let columns = [
            { binding: 'userid', header: '아아디', align: 'center', width: 200 },
            { binding: 'agencycd', header: '회사', align: 'center', width: 230 },
            { binding: 'divinm', header: '부서', align: 'center', width: 200 },
            { binding: 'ranknm', header: '직급', align: 'center', width: 140 },
            { binding: 'usernm', header: '성명', align: 'center', width: 200 },
            { binding: 'askdatem', header: '신청일자', align: 'center', width:"*"},
            { binding: 'appdatem', header: '승인일자', align: 'center', width: "*" },
            { binding: 'askreason', header: '신청사유', align: 'center', width: "*", visible: false },
            { binding: 'userhp', header: '핸드폰', align: 'center', width: "*", visible: false },
            { binding: 'usermail', header: '이메일', align: 'center', width: "*", visible: false },
            { binding: 'authgrpcd', header: '권한그룹', align: 'center', width: "*", visible: false },
            { binding: 'appflag', header: '승인여부', align: 'center', width: "*", visible: false },
            { binding: 'spworknm', header: '관리대상발전시설명', align: 'center', width: "*", visible: false },
            { binding: 'spcompnm', header: '관리대상발전산단명', align: 'center', width: "*", visible: false },
            { binding: 'spplannm', header: '관리대상발전소명', align: 'center', width: "*", visible: false },








        ]


        function submitTextarea(event){
            let key = event.key || event.keyCode;

            if(key === 'Enter' || key == 13){
                searchData();
            }
        }

        let searchusrval = document.getElementById('searchuserid');
        searchusrval.addEventListener('keyup', event => submitTextarea(event))


        document.readyState === 'complete' ? init() : window.onload = init;


        <!-- 초반 페이지 진입시 그리드 바인딩 끝-->
        function init() {
            let data2 = [];
            let searchusr = $('#searchusr').val();

            $.ajax({
                url: '/api/system/auth_list/read',
                type: 'GET',
                data: {
                    'searchusr' : searchusr,
                },
                async: false,
                success: function(data){

                    let DataLength = 10 - data.data.length;

                    if(data.data.length < 10){

                        for(let i=0; i < DataLength; i++){
                            data.data.push('empty');
                        }
                    }
                    data2 = data.data;

                }
            })

            viewdata = new wijmo.collections.CollectionView(data2);

            // 데이터 그리드에 바인딩
            theGrid = new wijmo.grid.FlexGrid('#theGrid', {
                autoGenerateColumns: false,
                showMarquee: true,
                columns: columns,
                allowSorting: 'MultiColumn',
                selectionMode: wijmo.grid.SelectionMode.Row, // 행 단위 선택
                itemsSource: viewdata
            });

            console.log('grid', theGrid.columns)

            let selector = new wijmo.grid.selector.Selector(theGrid, {
                itemChecked: (e, ctx) => {
                    SelectItem = theGrid.rows.filter(r => r.isSelected);

                }
            })
        }
        <!-- 초반 페이지 진입시 그리드 바인딩 끝-->

        let page = null;

        //검색
        function searchData(){
            let data = {
                'searchusr' : $('#searchusr').val(),
                'searchfrdate': $('#searchfrdate').val(),
                'searchtodate': $('#searchtodate').val(),
                'searchflag' : $('#flag').val(),
                'searchuserid' : $('#searchuserid').val()
            }

            let result =  AjaxUtil.getSyncData('/api/system/auth_list/read', data);

            if(result.success){
                console.log(result.data);
                grid_binding(result.data);
            }
        }

        function grid_binding(data){
            var inspecDto = data;
            var inspecData = [];
            var cnt = 1;
            for (var i = 0; i < inspecDto.length; i++) {
                inspecData.push({
                    userid : inspecDto[i]["userid"],
                    agencycd: inspecDto[i]["agencycd"],
                    divinm: inspecDto[i]["divinm"],
                    ranknm: inspecDto[i]["ranknm"],
                    usernm: inspecDto[i]["usernm"],
                    askdatem: inspecDto[i]["askdatem"],
                    appdatem: inspecDto[i]["appdatem"],
                    askreason: inspecDto[i]["askreason"],
                    userhp: inspecDto[i]["userhp"],
                    usermail: inspecDto[i]["usermail"],
                    authgrpcd: inspecDto[i]["authgrpcd"],
                    appflag: inspecDto[i]["appflag"],
                    spworknm : inspecDto[i]["spworknm"],
                    spcompnm : inspecDto[i]["spcompnm"],
                    spplannm : inspecDto[i]["spplannm"],


                });
                cnt++;
            }

            theGrid.columns.clear();
            theGrid.autoGenerateColumns = false;
            viewdata.sourceCollection = inspecData;


            for (var i = 0; i < columns.length; i++) {
                var col = new wijmo.grid.Column(columns[i]);
                theGrid.columns.push(col);
            }
            SelectItem = undefined;

        }

        function SelectItemPush(){
            let selectedList = [];
            for(let i = 0; i < SelectItem.length; i++){
                selectedList.push(SelectItem[i]._data.userid);
            }
            return selectedList;
        }

        $(document).ready(function (e) {

            let bindingList = [ 'agency', 'divinm', 'rank', 'tel', 'email', 'usernm', 'reason', 'authType', 'appflag', 'spworknm', 'spcompnm', 'spplannm', 'userid'];


            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2,'0');

            let today = `${year}-${month}-${day}`;

            let appdatem = document.getElementById('appdatem');
            appdatem.value = today;


            // 저장 시작
            $('#btnSave').click(function (e){


                Alert.confirm('', '저장하시겠습니까?', function() {

                        let formData = new FormData();

                        // 다른 데이터를 FormData에 추가합니다.
                        formData.append('userid', $('#userid').val());
                        formData.append('appflag', $('#appflag').val());
                        formData.append('_csrf', $('[name=_csrf]').val());
                        formData.append('agency', $('#agency').val());
                        formData.append('divinm', $('#divinm').val());
                        formData.append('rank', $('#rank').val());
                        formData.append('tel', $('#tel').val());
                        formData.append('email', $('#email').val());
                        formData.append('usernm', $('#usernm').val());
                        formData.append('authType', $('#authType').val());
                        formData.append('usernm', $('#usernm').val());
                        formData.append('usernm', $('#usernm').val());
                        formData.append('usernm', $('#reason').val());




                        $.ajax({
                            url: '/api/system/auth_list/save',
                            type: 'POST',
                            data: formData,
                            processData: false,  // 기본적으로 jQuery는 데이터를 문자열로 변환하려고 하므로 이를 비활성화
                            contentType: false,  // 기본적으로 jQuery는 Content-Type을 설정하려고 하므로 이를 비활성화
                            success: function (response) {
                                if (response.success) {
                                    Alert.alert('', response.message);

                                    for(let i=0; i < bindingList.length; i++){
                                        ElementBinding(bindingList[i], '')
                                    }

                                    searchData();

                                }
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                Alert.alert('', '에러가발생하였습니다.');
                            }
                        });
                },

                )
            })


            //삭제
            $('#btnDelete').click(function(e){

                if(SelectItem === undefined || SelectItem.length === 0){
                    Alert.alert('', '삭제할 항목을 선택하세요.');
                    return;
                }


                let delList = [];

                delList = SelectItemPush();

                console.log('삭제확인', delList);
                Alert.confirm('', '삭제하시겠습니까?', function(){

                    let data = {
                        'userid' : JSON.stringify(delList),
                        '_csrf' :  csrfToken
                    }

                    let fnSuccess = function (res){
                        if(res.success){
                            Alert.alert('', '삭제되었습니다.');
                            searchData();
                        }
                    }

                    AjaxUtil.postAsyncData('/api/system/auth_list/delete', data, fnSuccess);


                })
            })

            $('#btnAppr').click(function (e){
                if(SelectItem === undefined || SelectItem.length === 0){
                    Alert.alert('', '승인할 항목을 선택하세요.');
                    return;
                }else if(SelectItem.length > 1){
                    Alert.alert('', '하나의 항목만 선택해주세요');
                    return;
                }
                let selectedItem = SelectItem[0];



                if(!selectedItem._data.userid){
                        Alert.alert('', '승인할 항목이 없습니다.', function () {

                        });
                        return false;
                }

                let valueList = [ selectedItem._data.agencycd, selectedItem._data.divinm, selectedItem._data.ranknm ,selectedItem._data.userhp,
                    selectedItem._data.usermail, selectedItem._data.usernm, selectedItem._data.askreason, selectedItem._data.authgrpcd, selectedItem._data.appflag,
                    selectedItem._data.spworknm, selectedItem._data.spcompnm, selectedItem._data.spplannm, selectedItem._data.userid
                ]

                for(let i=0; i < bindingList.length; i++){
                    console.log(bindingList[i], valueList[i]);
                    ElementBinding(bindingList[i], valueList[i]);
                }



                $('#inputTabLink').click();



            })

            /*//승인
            $('#btnAppr').click(function (e){
                if(SelectItem === undefined || SelectItem.length === 0){
                    Alert.alert('', '승인할 항목을 선택하세요.');
                    return;
                }

                let apprList = [];
                apprList = SelectItemPush();

                Alert.confirm('', '승인하시겠습니까?', function () {
                    let data = {
                        'userid': JSON.stringify(apprList),
                        '_csrf': csrfToken
                    }
                    let fnSuccess = function (res) {
                        if (res.success) {
                            Alert.alert('', '처리되었습니다.');
                            searchData();
                        }
                    }
                    AjaxUtil.postAsyncData('/api/system/auth_list/approve', data, fnSuccess);
                })
            })*/


        });
    </script>
</th:block>

</html>