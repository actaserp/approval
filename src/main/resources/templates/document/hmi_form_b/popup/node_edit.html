<th:block th:fragment="node_edit">
<script type="text/x-tmpl" id="nodeEditTemplate">
    <div class="content_wrap popup">
        <section class="pt-2">
            <div class="table_box">
                <form id="nodeEditForm">
                    <div class="table_box sub">
                        <div class="row">

                            <div class="col-4">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">모양</span>
                                    </div>
                                    <select class="form-control2" id="shape" name="shape">
                                        <option value="label" selected>라벨</option>
                                        <option value="leftpointinglabel">좌측 지시 라벨</option>
                                        <option value="rightpointinglabel">우측 지시 라벨</option>
                                        <option value="uppointinglabel">위 지시 라벨</option>
                                        <option value="downpointinglabel">아래 지시 라벨</option>
                                        <option value="rectangle">사각형</option>
                                        <option value="roundedrectangle">둥근사각형</option>
                                        <option value="circle">원</option>
                                        <option value="triangle">삼각형</option>
                                        <option value="rhombus">마름모</option>
                                        <option value="pentagon">오각형</option>
                                        <option value="hexagon">육각형</option>
                                        <option value="heptagon">칠각형</option>
                                        <option value="octagon">팔각형</option>
                                        <option value="image">이미지</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-4">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">모양색</span>
                                    </div>
                                    <input class="form-control2 shape-edit" type="color" id="shape_color" name="shape_color">
                                </div>
                            </div>
                            
                            <div class="col-4">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">투명여부</span>
                                    </div>
                                    <select class="form-control2 shape-edit" id="shape_transparent" name="shape_transparent">
                                        <option value="yes">예</option>
                                        <option value="no" selected>아니오</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-4">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">이미지</span>
                                    </div>
                                    <select class="form-control2" id="image" name="image" disabled></select>
                                </div>
                            </div>

                            <div class="col-4">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">외곽선 두께</span>
                                    </div>
                                    <input class="form-control2 tar shape-edit" type="number" id="outline_width" name="outline_width">
                                </div>
                            </div>

                            <div class="col-4">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">외곽선색</span>
                                    </div>
                                    <input class="form-control2 shape-edit" type="color" id="outline_color" name="outline_color">
                                </div>
                            </div>

                            <div class="col-4">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">텍스트 보기</span>
                                    </div>
                                    <select class="form-control2 shape-edit" id="textview_option" name="textview_option">
                                        <option value="none">없음</option>
                                        <option value="name">DAS설정명</option>
                                        <option value="user">사용자 입력</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-4">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">텍스트</span>
                                    </div>
                                    <input class="form-control2 shape-edit" type="text" id="text_value" name="text_value" readonly>
                                </div>
                            </div>

                            <div class="col-4">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">텍스트색</span>
                                    </div>
                                    <input class="form-control2 shape-edit" type="color" id="text_color" name="text_color">
                                </div>
                            </div>

                            <div class="col-3">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">텍스트 크기</span>
                                    </div>
                                    <input class="form-control2 tar shape-edit" type="number" id="text_size" name="text_size">
                                </div>
                            </div>

                             <div class="col-3">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">줄바꿈</span>
                                    </div>
                                    <select class="form-control2 shape-edit" id="linebreak" name="linebreak">
                                        <option value="yes">예</option>
                                        <option value="no" selected>아니오</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-3">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">굵게</span>
                                    </div>
                                    <select class="form-control2 shape-edit" id="text_bold" name="text_bold">
                                        <option value="yes">예</option>
                                        <option value="no" selected>아니오</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-3">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">기울임</span>
                                    </div>
                                    <select class="form-control2 shape-edit" id="text_italic" name="text_italic">
                                        <option value="yes">예</option>
                                        <option value="no" selected>아니오</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-4">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">연동여부</span>
                                    </div>
                                    <select class="form-control2" id="binding_option" name="binding_option">
                                        <option value="yes">예</option>
                                        <option value="no" selected>아니오</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-4">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">DAS설정</span>
                                    </div>
                                    <select class="form-control2" id="das_config" name="das_config" disabled></select>
                                </div>
                            </div>
                            
                            <div class="col-4">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text fit_box_t5">태그</span>
                                    </div>
                                    <select class="form-control2" id="tag" name="tag" disabled></select>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </section>

        <section class="popupcontent" >
            <div class="align_left">
                <button type="button" class="btn-popup" id="btnSave"><span>저장</span></button>
                <button type="button" class="btn-popup" id="modal-close-button"><span>닫기</span></button>
            </div>
        </section>
    </div>
</script>

<script type="text/javascript">

    class PopupNodeEdit {
        constructor() {
            this.callback = null;
            this.modalContainer = new PopupDraggable('노드 설정');
        }

        show(action, data, callback) {
            let _this = this;

            this.callback = callback;

            let content = tmpl('nodeEditTemplate', data);
            let $content = $(content);
            this.modalContainer.open({ width: 750, height: 280, $content });

            AjaxUtil.fillSelectOptions($content.find('#das_config'), 'das_config', 'choose', null);

            if (data.das_config) {
                AjaxUtil.fillSelectOptions($content.find('#tag'), 'tag', 'choose', null, null, null, data.das_config);
            } else {
                AjaxUtil.fillSelectOptions($content.find('#tag'), 'tag', 'choose', null);
            }

            // 이미지 리스트 조회
            let param = { 'action': 'image_list' };
            let $image = $content.find('#image');
            let imageList = AjaxUtil.getSyncData('/api/support/hmi_b/image_list', param);
			
            $.each(imageList.data, function (index, image) {
                let option = $('<option>',
                    {
                        value: image['value'],
                        text: image['text'],
                    });
                $image.append(option);
            });

            FormUtil.BindDataForm(data, $content.find('#nodeEditForm'));

            this.setControlState($content);

            if (action == 'create') $content.find('#shape').removeAttr('disabled');
            else $content.find('#shape').attr('disabled', 'disabled');

            if ($content.find('#shape').val() == 'image') {
                $content.find('#image').removeAttr('disabled');
                $content.find('.shape-edit').attr('disabled', 'disabled');
            }

            // 모양 변경
            $content.find('#shape').change(function () {
                if ($content.find('#shape').val() == 'image') {
                    $content.find('#image').removeAttr('disabled');
                    $content.find('.shape-edit').attr('disabled', 'disabled');
                } else {
                    $content.find('#image').attr('disabled', 'disabled');
                    $content.find('.shape-edit').removeAttr('disabled');
                }
            });

            // 연동 여부 변경
            $content.find('#binding_option').change(function () {
                if ($content.find('#binding_option').val() == 'no') {
                    $content.find('#das_config').val('');
                    $content.find('#tag').val('');
                }
                _this.setControlState($content);
            });

            // 설비 변경
            $content.find('#das_config').change(function () {
                if ($content.find('#das_config').val()) {
                    AjaxUtil.fillSelectOptions($content.find('#tag'), 'tag', 'choose', null, null, null, $content.find('#das_config').val());
                } else {
                    AjaxUtil.fillSelectOptions($content.find('#tag'), 'tag', 'choose', null);
                }
                _this.setText($content);
            });

            // 텍스트 보기 옵션 변경
            $content.find('#textview_option').change(function () {
                _this.setControlState($content);
                _this.setText($content);
            });

            // 저장버튼 클릭
            $content.find('#btnSave').click(function () {
                let formData = FormUtil.extractForm($('#nodeEditForm'));
                _this.saveData(formData);
            });
        }

        // control 활성화 설정
        setControlState($content) {
            let _this = this;
            let $bindingOption = $content.find('#binding_option');
            let $dasConfig = $content.find('#das_config');
            let $tag = $content.find('#tag');

            let $textView = $content.find('#textview_option');
            let $textValue = $content.find('#text_value');

            if ($bindingOption.val() == 'yes') {
                $dasConfig.removeAttr('disabled');
                $tag.removeAttr('disabled');
            } else {
                $dasConfig.attr('disabled', 'disabled');
                $tag.attr('disabled', 'disabled');
            }

            if ($textView.val() == 'user') {
                $textValue.removeAttr('readonly');
            } else {
                $textValue.attr('readonly', 'readonly');
            }
        }

        // 텍스트 설정
        setText($content) {
            let _this = this;
            let textViewOption = $content.find('#textview_option option:selected').val();
            let textValue = $content.find('#text_value');
            let selectedDASConfig = $content.find('#das_config option:selected');

            if (textViewOption == 'none' || textViewOption == 'user') {
                textValue.val('');
            } else {
                if (selectedDASConfig.val()) {
                    if (textViewOption == 'name') {
                        textValue.val(selectedDASConfig.text());
                    }
                }
            }
        }

        // 저장
        saveData(formData) {
            let _this = this;

            if (formData.binding_option == 'yes') {
                if (!formData.das_config) {
                    Alert.alert('', 'DAS설정을 선택해주세요.');
                    return;
                }
            }

            if (typeof this.callback !== 'undefined' && this.callback!=null) {
                this.callback(formData);
            } 

            this.close();
        }

        close() {
            this.modalContainer.close();
        }
    }

</script>
